import{Class as t,Schema as e,Template as n,Rinn as s}from"rinn";var r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{};function l(t,e,i,n){Object.defineProperty(t,e,{get:i,set:n,enumerable:!0,configurable:!0})}const a=(t,e)=>2147483647&(t^e),o=(t,e)=>t<<e&2147483647
//!class Random;
var h=t.extend({state:null,index:0,seed:0,__ctor:function(t=3672614355){this.index=0,this.setSeed(t)},setSeed:function(t){this.seed=t,this.state=[2784440588,4017298675,4202185506,2016738353,3652155411,3732450579,2017408024,2853319030,2266821841,1933651883,3135686416,116864129,2299580181,2457663507,3170337615,1945506195];for(let t=0;t<this.state.length;t++)this.state[t]=a(this.state[t],this.seed);return this},nextInt32:function(){let t,e,i,n;return t=this.state[this.index],i=this.state[this.index+13&15],e=a(a(a(t,i),o(t,16)),o(i,15)),i=this.state[this.index+9&15],i=a(i,i>>>11&2147483647),t=this.state[this.index]=a(e,i),n=a(t,3661901092&o(t,5)),this.index=this.index+15&15,t=this.state[this.index],this.state[this.index]=a(a(a(a(a(t,e),n),o(t,2)),o(e,18)),o(i,28)),2147483647&this.state[this.index]},nextInt16:function(){return 65535&this.nextInt32()},nextInt8:function(){return 255&this.nextInt32()},nextFloat:function(){return this.nextInt32()/2147483647}}),
//!enum KeyCode
u={BACKSPACE:8,
//!BACKSPACE
TAB:9,
//!TAB
ENTER:13,
//!ENTER
SHIFT:16,
//!SHIFT
CTRL:17,
//!CTRL
ESC:27,
//!ESC
SPACE:32,
//!SPACE
PGUP:33,
//!PGUP
PGDN:34,
//!PGDN
END:35,
//!END
HOME:36,
//!HOME
INS:45,
//!INS
DEL:46,
//!DEL
LEFT:37,
//!LEFT
UP:38,
//!UP
RIGHT:39,
//!RIGHT
DOWN:40,
//!DOWN
NUM_PLUS:107,
//!NUM_PLUS
NUM_MINUS:109,
//!NUM_MINUS
NUM_ASTERISK:106,
//!NUM_ASTERISK
NUM_SLASH:111,
//!NUM_SLASH
NUM_DOT:110,
//!NUM_DOT
NUM_0:96,
//!NUM_0
NUM_1:97,
//!NUM_1
NUM_2:98,
//!NUM_2
NUM_3:99,
//!NUM_3
NUM_4:100,
//!NUM_4
NUM_5:101,
//!NUM_5
NUM_6:102,
//!NUM_6
NUM_7:103,
//!NUM_7
NUM_8:104,
//!NUM_8
NUM_9:105,
//!NUM_9
D0:48,
//!D0
D1:49,
//!D1
D2:50,
//!D2
D3:51,
//!D3
D4:52,
//!D4
D5:53,
//!D5
D6:54,
//!D6
D7:55,
//!D7
D8:56,
//!D8
D9:57,
//!D9
A:65,
//!A
B:66,
//!B
C:67,
//!C
D:68,
//!D
E:69,
//!E
F:70,
//!F
G:71,
//!G
H:72,
//!H
I:73,
//!I
J:74,
//!J
K:75,
//!K
L:76,
//!L
M:77,
//!M
N:78,
//!N
O:79,
//!O
P:80,
//!P
Q:81,
//!Q
R:82,
//!R
S:83,
//!S
T:84,
//!T
U:85,
//!U
V:86,
//!V
W:87,
//!W
X:88,
//!X
Y:89,
//!Y
Z:90};const c={};let d=0;const f={};r.Recycler=f;var p=f;
//!namespace Recycler
f.attachTo=function(t,e=8192,i=null){if(!t.prototype.className)throw new Error("Unable to attach recycler methods to an unnamed class.");if(!("__dtor"in t.prototype))throw new Error("Recycler: Class "+t.prototype.className+" requires `__dtor` method.");if(!("init"in t.prototype))throw new Error("Recycler: Class "+t.prototype.className+" requires `init` method.");null===i&&(i=int(.375*e)),c[t.prototype.className]=t,t.recyclerPool=[],t.recyclerPoolMax=e,t.prototype.objectId=0,t.recyclerNextObjectId=0,t.recyclerCreated=0,t.recyclerRecycled=0,t.recyclerMissed=0,t.recyclerLength=0,t.recyclerActive=0;let n=!1;t.preallocate=function(e=null){if(n)return;let s=null===e?i:Math.min(e,i);for(let e=0;e<s;e++)t.recyclerPool.push(new t),t.recyclerLength++,d++;n=!0},t.allocate=function(){let e;return this.recyclerLength?(e=this.recyclerPool[--this.recyclerLength],t.recyclerRecycled++):(e=new t,t.recyclerCreated++),t.recyclerActive++,e.objectId=++this.recyclerNextObjectId,this.recyclerNextObjectId&=2147483647,e},t.alloc=function(e=null,i=null,n=null,s=null,r=null,l=null,a=null,o=null,h=null,u=null){return t.allocate().init(e,i,n,s,r,l,a,o,h,u)},t.prototype.free=function(){return this.objectId<0?this:0==this.objectId?(console.error("ERROR: Already released instance of "+t.prototype.className),this):(this.__dtor(),this.objectId=0,t.recyclerLength>=e?t.recyclerMissed++:t.recyclerPool[t.recyclerLength++]=this,t.recyclerActive--,this)},t.prototype.lockInstance=function(t){return this.objectId=Math.abs(this.objectId),t&&(this.objectId=-this.objectId),this}},f.showStats=function(t=null){let e=c;if(console.log("Total Preallocated: "+d),!0!==t){if(null!==t){if("string"==typeof t){let e=c[t];return void console.debug(t+": "+(e.recyclerCreated/e.recyclerPoolMax*100).toFixed(1)+"%  =>  overhead="+e.recyclerCreated+", active="+e.recyclerActive+", array="+e.recyclerPool.length+", recycled="+e.recyclerRecycled+", in-recycler="+e.recyclerLength+", missed="+e.recyclerMissed+", space="+(e.recyclerPoolMax-e.recyclerLength))}e=t}console.group("Recycling Facilities");for(let t in e){let i=e[t];console.debug(t+": "+(i.recyclerCreated/i.recyclerPoolMax*100).toFixed(1)+"%  =>  overhead="+i.recyclerCreated+", active="+i.recyclerActive+", array="+i.recyclerPool.length+", recycled="+i.recyclerRecycled+", in-recycler="+i.recyclerLength+", missed="+i.recyclerMissed+", space="+(i.recyclerPoolMax-i.recyclerLength))}console.groupEnd()}else{console.group("Recycling Facilities");for(let t in e){let i=e[t];i.recyclerCreated&&console.debug(t+": "+(i.recyclerCreated/i.recyclerPoolMax*100).toFixed(1)+"%  =>  overhead="+i.recyclerCreated+", active="+i.recyclerActive+", array="+i.recyclerPool.length+", recycled="+i.recyclerRecycled+", in-recycler="+i.recyclerLength+", missed="+i.recyclerMissed+", space="+(i.recyclerPoolMax-i.recyclerLength))}console.groupEnd()}},f.createPool=function(t,e=8192,i=null){const n=t.prototype.className;if(!n)throw new Error("Unable to create pool sub-class on an unnamed class.");const s=t.extend({className:t.prototype.className,__ctor:function(){},init:function(t=null,e=null,i=null,s=null,r=null,l=null,a=null,o=null,h=null,u=null){return this._super[n].__ctor(t,e,i,s,r,l,a,o,h,u),this}});return f.attachTo(s,e,i),t.Pool=s,t},f.preallocate=function(t=null){d=0;for(let e in c)c[e].preallocate(t);return d};
//![import "./recycler"]
//!class Linkable
const g=t.extend({className:"Linkable",prev:null,next:null,value:null,__ctor:function(t){this.value=t,this.clear()},__dtor:function(){this.unlink()},clear:function(){return this.next=this.prev=null,this},linkAfter:function(t){this.prev=t,this.next=t?t.next:null,t&&(t.next&&(t.next.prev=this),t.next=this)},linkBefore:function(t){this.prev=t?t.prev:null,this.next=t,t&&(t.prev&&(t.prev.next=this),t.prev=this)},unlink:function(){return this.prev&&(this.prev.next=this.next),this.next&&(this.next.prev=this.prev),this.clear()}});
//!/class
//!namespace Linkable
//!namespace Pool
p.createPool(g,16384,6144);var m=g;
//![import "./linkable"]
//![import "./recycler"]
//!class List
const y=t.extend({className:"List",top:null,bottom:null,length:0,__ctor:function(){this.top=null,this.bottom=null,this.length=0},__dtor:function(){this.reset()},clone:function(){let t=y.Pool.alloc();for(let e=this.top;e;e=e.next)t.push(s.clone(e.value));return t},clear:function(){let t,e;for(t=this.top;t;t=e)e=t.next,dispose(t.free().value);return this.top=this.bottom=null,this.length=0,this},reset:function(){let t,e;for(t=this.top;null!=t;t=e)e=t.next,t.free();return this.top=this.bottom=null,this.length=0,this},first:function(){return null!==this.top?this.top.value:null},last:function(){return null!==this.bottom?this.bottom.value:null},getAt:function(t){let e=null;for(e=this.top;e&&t-- >0;e=e.next);return null!=e?e.value:null},getNodeAt:function(t){let e=null;for(e=this.top;e&&t--;e=e.next);return e},sgetNode:function(t){for(let e=this.top;e;e=e.next)if(e.value===t)return e;return null},remove:function(t){return null==t||m.isInstance(t)||(t=this.sgetNode(t)),t?(t.prev||(this.top=t.next),t.next||(this.bottom=t.prev),this.length--,t.free().value):null},insertBefore:function(t,e){if(!t)return this;let i=m.Pool.alloc(e);return i.linkBefore(t),t==this.top&&(this.top=i),this.length++,e},insertAfter:function(t,e){if(!t)return this;let i=m.Pool.alloc(e);return i.linkAfter(t),t==this.bottom&&(this.bottom=i),this.length++,e},unshift:function(t){let e=m.Pool.alloc(t);return e.linkBefore(this.top),this.bottom||(this.bottom=e),this.top=e,this.length++,t},shift:function(){let t=this.top;return t?((this.top=t.next)||(this.bottom=null),this.length--,t.free().value):null},push:function(t){let e=m.Pool.alloc(t);return e.linkAfter(this.bottom),this.top||(this.top=e),this.bottom=e,this.length++,t},pop:function(){let t=this.bottom;return t?((this.bottom=t.prev)||(this.top=null),this.length--,t.free().value):null},append:function(t){for(let e=t.top;e;e=e.next)this.push(e.value);return this},forEach:function(t,e=null){let i;for(let n=this.top;n;n=i)if(i=n.next,!1===t(n.value,n,this,e))return!1;return!0},forEachRev:function(t,e=null){let i;for(let n=this.bottom;n;n=i)if(i=n.prev,!1===t(n.value,n,this,e))return!1;return!0},find:function(t,e=null){for(let i=this.top;i;i=i.next)if(t(i.value,e))return i.value;return null},filter:function(t,e=null){let i=y.Pool.alloc();for(let n=this.top;n;n=n.next)t(n.value,e)&&i.push(n.value);return i},toArray:function(){let t=[];for(let e=this.top;e;e=e.next)t.push(e.value);return t}});
//!/class
//!namespace List
//!namespace Pool
p.createPool(y,16384,6144);var _=y;
//!class Timer
const x=function(t,e,i){this.callback=i,this.interval=e,this.vsync=t,this.handle=null,this.isRunning=!1,this.startTime=0,this.rTime=0,this.sTime=0,this.lTime=0,this.tDelta=0,this._onTimeout=()=>{this.onTimeout()},this._onTimeout_b=()=>{this.runNow()}};x.prototype.onTimeout=function(){if(!this.isRunning)return;this.rTime=hrnow()-this.startTime;let t=this.rTime-(this.sTime+this.interval);t<0?this.runAfter(-t):(this.sTime+=this.interval*(1+int(t/this.interval)),this.tDelta=t<0?this.interval:this.rTime-this.lTime,this.lTime=this.rTime,this.runAfter(this.sTime+this.interval-(hrnow()-this.startTime)),this.callback(this.tDelta,this))},x.prototype.start=function(t=!1,e=1){this.isRunning||(this.startTime=hrnow(),this.isRunning=!0,this.sTime=0,this.lTime=0,this.onStarted(),t&&this.callback(0,this),this.runAfter(this.interval*e))},x.prototype.runAfter=function(t){this.vsync?requestAnimationFrame(this._onTimeout_b):(this.handle&&clearTimeout(this.handle),this.handle=setTimeout(this._onTimeout,t))},x.prototype.runNow=function(){this.handle&&clearTimeout(this.handle),this.handle=setTimeout(this._onTimeout,0)},x.prototype.stop=function(){this.isRunning&&(this.handle&&(clearTimeout(this.handle),this.handle=null),this.isRunning=!1,this.onStopped())},x.prototype.onStarted=function(){},x.prototype.onStopped=function(){};var v=x;
//![import "../utils/recycler"]
//!class Vec2
const b=t.extend({className:"Vec2",x:0,y:0,__ctor:function(t=null,e=null){return this.set(t,e)},clone:function(){return b.Pool.alloc(this)},set:function(t,e=null){if(null===t)t=0,e=0;else if(null===e){let i=t;t=i.x,e=i.y}return this.x=t,this.y=e,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},zero:function(){return this.set(0,0)},isZero:function(){return 0==this.x&&0==this.y},equals:function(t,e=null){if(null===e){let i=t;t=i.x,e=i.y}return this.x==t&&this.y==e},neg:function(){return this.x=-this.x,this.y=-this.y,this},inv:function(){return this.x=1/this.x,this.y=1/this.y,this},abs:function(){return this.x=this.x<0?-this.x:this.x,this.y=this.y<0?-this.y:this.y,this},translate:function(t,e=null){if(null===e){let i=t;t=i.x,e=i.y}return this.x+=t,this.y+=e,this},rotate:function(t,e=0,i=0){let n=(this.x-e)*Math.cos(t)+(this.y-i)*Math.sin(t),s=(this.y-i)*Math.cos(t)-(this.x-e)*Math.sin(t);return this.x=n+e,this.y=s+i,this},add:function(t,e=null){if(null===e){let i=t;t=i.x,e=i.y}return this.x+=t,this.y+=e,this},sub:function(t,e=null){if(null===e){let i=t;t=i.x,e=i.y}return this.x-=t,this.y-=e,this},scale:function(t,e=null){if(null===e)if(b.isInstance(t)){let i=t;t=i.x,e=i.y}else e=t;return this.x*=t,this.y*=e,this},floor:function(){return this.x=int(this.x),this.y=int(this.y),this},fract:function(){return this.x=this.x-int(this.x),this.y=this.y-int(this.y),this},dot:function(t,e=null){if(null===e){let i=t;t=i.x,e=i.y}return this.x*t+this.y*e},magnitude:function(t=!1){return t?this.x*this.x+this.y*this.y:Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.isZero()?this:this.scale(1/this.magnitude())},majorAxis:function(){return Math.abs(this.x)>Math.abs(this.y)?this.y=0:this.x=0,this},minorAxis:function(){return Math.abs(this.x)<Math.abs(this.y)?this.y=0:this.x=0,this},sign:function(){return this.x=this.x?this.x<0?-1:1:0,this.y=this.y?this.y<0?-1:1:0,this},toString:function(){return`(${this.x}, ${this.y})`}});
//!/class
//!namespace Vec2
//!namespace Pool
p.createPool(b,4096,2048);var E=b;
//![import "../utils/recycler"]
//![import "./vec2"]
const w=new Float32Array(9).fill(0),T=new Float32Array(9).fill(0),R=t.extend({className:"Matrix",data:null,__ctor:function(t=null){null===this.data&&(this.data=new Float32Array(9)),null!==t?this.set(t):this.identity()},zero:function(){return this.data.fill(0),this},fill:function(t){return this.data.fill(t),this},set:function(t){if(R.isInstance(t))for(let e=0;e<9;e++)this.data[e]=t.data[e];else for(let e=0;e<9;e++)this.data[e]=t[e];return this},identity:function(t=null){return null===t&&(t=this.data),t.fill(0),t[0]=t[4]=t[8]=1,this},scalef:function(t){for(let e=0;e<9;e++)this.data[e]*=t;return this},clone:function(){return R.Pool.alloc(this)},append:function(t){t instanceof R&&(t=t.data);for(let t=0;t<9;t++)w[t]=this.data[t];return this.data[0]=t[0]*w[0]+t[1]*w[3]+t[2]*w[6],this.data[1]=t[0]*w[1]+t[1]*w[4]+t[2]*w[7],this.data[2]=t[0]*w[2]+t[1]*w[5]+t[2]*w[8],this.data[3]=t[3]*w[0]+t[4]*w[3]+t[5]*w[6],this.data[4]=t[3]*w[1]+t[4]*w[4]+t[5]*w[7],this.data[5]=t[3]*w[2]+t[4]*w[5]+t[5]*w[8],this.data[6]=t[6]*w[0]+t[7]*w[3]+t[8]*w[6],this.data[7]=t[6]*w[1]+t[7]*w[4]+t[8]*w[7],this.data[8]=t[6]*w[2]+t[7]*w[5]+t[8]*w[8],this},translate:function(t,e){if(0==t&&0==e)return this;for(let t=0;t<9;t++)w[t]=this.data[t];return this.data[6]=t*w[0]+e*w[3]+w[6],this.data[7]=t*w[1]+e*w[4]+w[7],this.data[8]=t*w[2]+e*w[5]+w[8],this},rotate:function(t){if(0==t)return this;this.identity(T);let e=Math.cos(t),i=Math.sin(t);return T[0]=e,T[1]=-i,T[3]=i,T[4]=e,this.append(T)},scale:function(t,e){return 1==t&&1==e?this:(this.identity(T),T[0]=t,T[4]=e,this.append(T))},applyTo:function(t,e=null){if(null===e){const i=t;t=i.x,e=i.y}let i=this.data[0]*t+this.data[3]*e+this.data[6],n=this.data[1]*t+this.data[4]*e+this.data[7];return E.Pool.alloc(i,n)},transpose:function(){w.fill(0);for(let t=0;t<3;t++)for(let e=0;e<3;e++)w[3*t+e]=this.data[3*e+t];for(let t=0;t<9;t++)this.data[t]=w[t];return this},det:function(){return this.data[0]*(this.data[4]*this.data[8]-this.data[5]*this.data[7])-this.data[1]*(this.data[3]*this.data[8]-this.data[5]*this.data[6])+this.data[2]*(this.data[3]*this.data[7]-this.data[4]*this.data[6])},adj:function(){throw new Error("NOT IMPLEMENTED")},inverse:function(){let t=this.det();return t?this.adj().scalef(1/t):null},toString:function(){return`[${this.data[0]}, ${this.data[3]}, ${this.data[6]}]\n[${this.data[1]}, ${this.data[4]}, ${this.data[7]}]\n[${this.data[2]}, ${this.data[5]}, ${this.data[8]}]\n`}});R.loadIdentity=function(t){t.fill(0),t[0]=t[4]=t[8]=1},
//!/class
//!namespace Matrix
//!namespace Pool
p.createPool(R,4096,1024);var I=R;
//!namespace glx
//!enum BufferTarget
//!/enum
//!enum BufferUsage
//!STATIC_DRAW
//!DYNAMIC_DRAW
//!STREAM_DRAW
//!STATIC_READ
//!DYNAMIC_READ
//!STREAM_READ
//!STATIC_COPY
//!DYNAMIC_COPY
//!STREAM_COPY
//!/enum
//!/namespace
//!class glx
const P={BufferTarget:{},BufferUsage:{},gl:null,setContext:function(t){return this.gl=t,this.BufferTarget.ARRAY_BUFFER=this.gl.ARRAY_BUFFER,this.BufferTarget.ELEMENT_ARRAY_BUFFER=this.gl.ELEMENT_ARRAY_BUFFER,this.BufferTarget.COPY_READ_BUFFER=this.gl.COPY_READ_BUFFER,this.BufferTarget.COPY_WRITE_BUFFER=this.gl.COPY_WRITE_BUFFER,this.BufferTarget.TRANSFORM_FEEDBACK_BUFFER=this.gl.TRANSFORM_FEEDBACK_BUFFER,this.BufferTarget.UNIFORM_BUFFER=this.gl.UNIFORM_BUFFER,this.BufferTarget.PIXEL_PACK_BUFFER=this.gl.PIXEL_PACK_BUFFER,this.BufferTarget.PIXEL_UNPACK_BUFFER=this.gl.PIXEL_UNPACK_BUFFER,this.BufferUsage.STATIC_DRAW=this.gl.STATIC_DRAW,this.BufferUsage.DYNAMIC_DRAW=this.gl.DYNAMIC_DRAW,this.BufferUsage.STREAM_DRAW=this.gl.STREAM_DRAW,this.BufferUsage.STATIC_READ=this.gl.STATIC_READ,this.BufferUsage.DYNAMIC_READ=this.gl.DYNAMIC_READ,this.BufferUsage.STREAM_READ=this.gl.STREAM_READ,this.BufferUsage.STATIC_COPY=this.gl.STATIC_COPY,this.BufferUsage.DYNAMIC_COPY=this.gl.DYNAMIC_COPY,this.BufferUsage.STREAM_COPY=this.gl.STREAM_COPY,this},getParameter:function(t){return this.gl.getParameter(this.gl[t])},getFloat32Array:function(t,e,i){if(0===e&&i===t.length&&t instanceof Float32Array)return t;let n=new Float32Array(i);for(let s=0;s<i;s++)n[s]=t[s+e];return n},createBufferFrom:function(t,e=null,i=null,n=null,s=null){e=e??P.BufferTarget.ARRAY_BUFFER,i=i??P.BufferUsage.STATIC_DRAW;let r=this.gl.createBuffer();return this.gl.bindBuffer(e,r),this.gl.bufferData(e,this.getFloat32Array(t,n??0,s??t.length),i),r}};var//!/class
A=P;
//!class glsl
const S={snippets:{},set:function(t,e){this.snippets[t]=e},get:function(t){return this.snippets.hasOwnProperty(t)?this.snippets[t]:""},replace:function(t,e){t=t.split("\n");for(let i=0;i<t.length;i++){let n=t[i].trim();if(n.startsWith("//@use ")){let s="";for(let t of n.substring(7).split(","))t=t.trim(),e.hasOwnProperty(t)||(e[t]=!0,s+=S.replace(S.get(t),e)+"\n");t[i]=s}}return t.join("\n")},process:function(t){return-1===(t=t.trim()).indexOf("precision")&&(t="precision highp float;\n"+t),-1===t.indexOf("#version")&&(t="#version 300 es\n"+t),this.replace(t,{})}};var//!/class
k=S;S.set("vert-defs","\n\tuniform mat3 m_transform;\n\tuniform mat3 m_quad;\n\tuniform mat3 m_texture;\n\tuniform vec4 v_resolution;\n\tuniform vec4 v_frame_size;\n\tuniform float f_scale;\n\tuniform float f_time;\n\tuniform float f_depth;\n\n\tin vec3 location;\n\tout vec2 texcoords;\n"),S.set("frag-defs","\n\tuniform vec4 v_resolution;\n\tuniform vec4 v_frame_size;\n\tuniform float f_scale;\n\tuniform float f_time;\n\tuniform float f_alpha;\n\tuniform sampler2D texture0;\n\n\tin vec2 texcoords;\n\tout vec4 color;\n"),S.set("invertX","\n\tvec2 invertX (vec2 value) {\n\t\treturn value * vec2(-1.0, 1.0);\n\t}\n"),S.set("invertY","\n\tvec2 invertY (vec2 value) {\n\t\treturn value * vec2(1.0, -1.0);\n\t}\n"),S.set("norm","\n\tvec2 norm (vec2 value) {\n\t\treturn (value + 1.0) * 0.5;\n\t}\n\n\tvec3 norm (vec3 value) {\n\t\treturn (value + 1.0) * 0.5;\n\t}\n"),S.set("snorm","\n\tvec2 snorm (vec2 value) {\n\t\treturn value * 2.0 - 1.0;\n\t}\n\n\tvec3 snorm (vec3 value) {\n\t\treturn value * 2.0 - 1.0;\n\t}\n"),S.set("location2d","\n\t//@use invertY, snorm\n\n\tvec4 location2d (vec3 location, float depth)\n\t{\n\t\tvec2 loc = vec2(m_transform * m_quad * location) / v_resolution.xy;\n\t\treturn vec4(invertY(snorm(loc)), depth/16777216.0, 1.0);\n\t}\n"),S.set("frameTexCoords","\n\tflat out vec2 v_frame_offset;\n\n\tvec2 frameTexCoords (vec3 location) {\n\t\tv_frame_offset = vec2(m_texture[2][0], m_texture[2][1]);\n\t\treturn mat2(m_texture * m_quad) * location.xy / (v_frame_size.xy * v_frame_size.zw);\n\t}\n"),S.set("frameTex","\n\tflat in vec2 v_frame_offset;\n\n\tvec4 frameTex (vec2 texcoords) {\n\t\treturn texture(texture0, fract(texcoords)*v_frame_size.xy + v_frame_offset);\n\t}\n"),S.set("rand","\n\tfloat rand (vec2 value) {\n\t\treturn fract(sin(dot(value, vec2(12.9898, 78.233))) * 43758.5453);\n\t}\n"),S.set("align","\n\tfloat align (float value, float step) {\n\t\treturn floor(value/step)*step;\n\t}\n");
//![import "./glx"]
//![import "./glsl"]
//!class Shader
const F=t.extend({id:null,type:0,shaderId:null,__ctor:function(t,e=null,i=null){null===i&&null!==e&&"string"==typeof e&&(i=e,e=null),null===e&&(e=t,t=null),F.put(this.id=t,this),this.type=e,this.shaderId=null,null!==i&&this.compile(i)},__dtor:function(){A.gl.deleteShader(this.shaderId),F.remove(this.id)},compile:function(t){let e=A.gl;this.shaderId=e.createShader(this.type===F.Type.VERTEX?e.VERTEX_SHADER:this.type===F.Type.FRAGMENT?e.FRAGMENT_SHADER:e.GEOMETRY_SHADER),t=k.process(t),e.shaderSource(this.shaderId,t),e.compileShader(this.shaderId);let i=e.getShaderInfoLog(this.shaderId);if(i)throw console.error(t.split("\n").map(((t,e)=>e+": "+t)).join("\n")),new Error((this.id?"["+this.id+"] ":"")+i);return this}});
//!/class
F.shaders={},F.put=function(t,e){t&&(this.shaders[t]=e)},F.get=function(t){return this.shaders[t]},F.remove=function(t){delete this.shaders[t]},
//!namespace Shader
//!enum Type
F.Type={VERTEX:0,
//!VERTEX
FRAGMENT:1,
//!FRAGMENT
GEOMETRY:2};var//!/enum
N=F;
//![import "./shader"]
//![import "./globals"]
//![import "./glx"]
//!class ShaderProgram
const D=t.extend({locations:null,id:null,shaders:null,programId:null,__ctor:function(t=null){this.id=t,this.shaders=[],this.programId=null,this.locations={},this._uniformSetter=null,D.put(t,this)},__dtor:function(){let t=A.gl;if(!t)return this;t.deleteProgram(this.programId),D.remove(this.id)},uniformSetter:function(t){return this._uniformSetter=t,this},attach:function(t){if("string"==typeof t&&(t=N.get(t)),!t)throw new Error("Unable to attach shader, argument is null.");return this.shaders.push(t),this},bindLocations:function(){A.gl.bindAttribLocation(this.programId,0,"location")},getAttribLocation:function(t){return this.locations.hasOwnProperty(t)||(this.locations[t]=A.gl.getAttribLocation(this.programId,t)),this.locations[t]},getUniformLocation:function(t){return this.locations.hasOwnProperty(t)||(this.locations[t]=A.gl.getUniformLocation(this.programId,t)),this.locations[t]},getUniformBlockLocation:function(t){return this.locations.hasOwnProperty(t)||(this.locations[t]=A.gl.getUniformBlockIndex(this.programId,t)),this.locations[t]},getUniformBlockSize:function(t){return"string"==typeof t&&(t=this.getUniformBlockLocation(t)),A.gl.getActiveUniformBlockParameter(this.programId,t,A.gl.UNIFORM_BLOCK_DATA_SIZE)},createUniformBlockBuffer:function(t){"string"==typeof t&&(t=this.getUniformBlockLocation(t));let e=this.getUniformBlockSize(t),i=A.createBufferFrom(new Float32Array(e).fill(0),A.BufferTarget.UNIFORM_BUFFER,A.BufferUsage.DYNAMIC_DRAW);A.gl.bindBufferBase(A.BufferTarget.UNIFORM_BUFFER,0,i)},preloadLocations:function(){this.getUniformLocation("f_time"),this.getUniformLocation("f_scale"),this.getUniformLocation("m_transform"),this.getUniformLocation("m_texture"),this.getUniformLocation("m_quad"),this.getUniformLocation("v_resolution"),this.getUniformLocation("v_frame_size"),this.getUniformLocation("f_depth"),this.getUniformLocation("f_alpha"),this.getUniformLocation("v_base_color"),this.getUniformLocation("texture0"),this.getAttribLocation("location")},link:function(){let t=A.gl;if(!t)return this;this.programId=t.createProgram();for(let e of this.shaders)t.attachShader(this.programId,e.shaderId);return this.bindLocations(),t.linkProgram(this.programId),this.preloadLocations(),this},activate:function(){let t=A.gl;t&&(t.useProgram(this.programId),null!==this._uniformSetter&&this._uniformSetter(this,t))},getStatus:function(){let t=A.gl;return!t||t.getProgramParameter(this.programId,t.LINK_STATUS)},getError:function(){let t=A.gl;return t?null===this.programId?"Program has not been linked.":t.getProgramInfoLog(this.programId):""},uniform1f:function(t,e){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform1f(t,e),this},uniform1fv:function(t,e){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform1fv(t,e),this},uniform1i:function(t,e){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform1i(t,e),this},uniform1iv:function(t,e){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform1iv(t,e),this},uniform2f:function(t,e,i){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform2f(t,e,i),this},uniform2fv:function(t,e){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform2fv(t,e),this},uniform2i:function(t,e,i){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform2i(t,e,i),this},uniform2iv:function(t,e){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform2iv(t,e),this},uniform3f:function(t,e,i,n){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform3f(t,e,i,n),this},uniform3fv:function(t,e){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform3fv(t,e),this},uniform3i:function(t,e,i,n){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform3i(t,e,i,n),this},uniform3iv:function(t,e){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform3iv(t,e),this},uniform4f:function(t,e,i,n,s){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform4f(t,e,i,n,s),this},uniform4fv:function(t,e){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform4fv(t,e),this},uniform4i:function(t,e,i,n,s){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform4i(t,e,i,n,s),this},uniform4iv:function(t,e){return"string"==typeof t&&(t=this.getUniformLocation(t)),A.gl.uniform4iv(t,e),this}});D.programs={},D.create=function(t,e){let i=null,n=null,s=null,r=null,l=null,a=null,o=null;for(let t of e.split("\n")){let e=t.trim();if(e.startsWith("//")){if(e=e.split(" ").map((t=>t.trim())),"//@vert"===e[0]){e.length>1&&(n=e[1]),null===i&&(i=[]),o=i;continue}if("//@frag"===e[0]){e.length>1&&(r=e[1]),null===s&&(s=[]),o=s;continue}if("//@geom"===e[0]){e.length>1&&(a=e[1]),null===l&&(l=[]),o=l;continue}}null!==o&&o.push(t)}let h=new D(t);if(null!==i&&(i=i.join("\n").trim()),null!==s&&(s=s.join("\n").trim()),null!==l&&(l=l.join("\n").trim()),null!==i&&0===i.length){if(i=N.get(n),null===i)throw new Error("Vertex shader not found: "+n)}else null!==i&&0!==i.length||(i=null);if(null!==s&&0===s.length){if(s=N.get(r),null===s)throw new Error("Fragment shader not found: "+r)}else null!==s&&0!==s.length||(s=null);if(null!==l&&0===l.length){if(l=N.get(a),null===l)throw new Error("Geometry shader not found: "+a)}else null!==l&&0!==l.length||(l=null);return null===i&&(i=N.get("def-vert")),null===s&&(s=N.get("def-frag")),null!==i&&"string"==typeof i&&(i=new N(n,N.Type.VERTEX,i)),null!==s&&"string"==typeof s&&(s=new N(r,N.Type.FRAGMENT,s)),null!==l&&"string"==typeof l&&(l=new N(a,N.Type.GEOMETRY,l)),null!==i&&h.attach(i),null!==s&&h.attach(s),null!==l&&h.attach(l),h.link()},D.put=function(t,e){t&&(this.programs[t]=e)},D.get=function(t){return this.programs[t]},D.remove=function(t){delete this.programs[t]};var M=D,//!namespace Texture
//!/namespace
//!class Texture
L=t.extend({className:"Texture",textureId:null,width:0,height:0,targetWidth:0,targetHeight:0,rscale:1,filter:"LINEAR",wrap:"CLAMP_TO_EDGE",mipmap:0,allocated:!1,__ctor:function(t,e,i=null,n=null){this.textureId=null,this.width=t,this.height=e,this.targetWidth=i??t,this.targetHeight=n??e,this.rscale=this.width/this.targetWidth,this.filter="LINEAR",this.wrap="CLAMP_TO_EDGE",this.mipmap=0},bind:function(){const t=A.gl;return null===this.textureId&&(this.textureId=t.createTexture()),t.bindTexture(t.TEXTURE_2D,this.textureId),!1===this.allocated&&(this.allocated=null,this.allocate()),t},allocate:function(){if(!0===this.allocated)return this;const t=this.bind();return this.mipmap>0?t.texStorage2D(t.TEXTURE_2D,this.mipmap,t.RGBA8,this.width,this.height):t.texStorage2D(t.TEXTURE_2D,1,t.RGBA8,this.width,this.height),this.allocated=!0,t},applyFilter:function(t=null){const e=t??this.bind();return this.mipmap>0?"NEAREST"===this.filter?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST_MIPMAP_LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR)):"NEAREST"===this.filter?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR)),this},applyWrap:function(t=null){const e=t??this.bind();return"REPEAT"===this.wrap?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)):"MIRRORED_REPEAT"===this.wrap?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.MIRRORED_REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.MIRRORED_REPEAT)):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)),this},setFilter:function(t){return this.filter=t,null!==this.textureId&&this.applyFilter(),this},setWrap:function(t){return this.wrap=t,null!==this.textureId&&this.applyWrap(),this},setMipmap:function(t){if(this.mipmap=t,null!==this.textureId&&!0===this.allocated&&this.mipmap>0){const t=this.bind();t.generateMipmap(t.TEXTURE_2D)}return this},upload:function(t,e=0,i=0){const n=this.bind();return n.texSubImage2D(n.TEXTURE_2D,0,e,i,Math.min(t.width,this.width),Math.min(t.height,this.height),n.RGBA,n.UNSIGNED_BYTE,t),this.mipmap>0&&n.generateMipmap(n.TEXTURE_2D),this.applyFilter(n),this.applyWrap(n),this}});
//![import "../math/matrix"]
//![import "./system"]
//![import "../utils/list"]
//![import "./shader-program"]
//![import "./shader"]
//![import "./globals"]
//![import "./log"]
//![import "./glx"]
//![import "./texture"]
//!namespace Canvas
//!type Options =
//!/type
//!/namespace
//!class Canvas
const B=function(t=null){let e={elem:null,gl:!1,background:"#000000",width:0,height:0,hidden:!0,absolute:!1,antialias:!1,...t};const i=!r.document;null==e.elem?(this.elem=i?s.clone(B.passThruCanvas):r.document.createElement("canvas"),r.document&&1!=e.hidden&&(r.document.body.appendChild(this.elem),!0===e.absolute&&(this.elem.style.position="absolute",this.elem.style.left="0",this.elem.style.top="0"))):this.elem=e.elem,this.elem.getContext&&(!0!==e.gl||i?(this.context=this.elem.getContext("2d",{desynchronized:!1}),this.gl=null):(this.gl=this.elem.getContext("webgl2",{desynchronized:!1,alpha:!1,stencil:!0}),Y.gl=this.gl,Y.shaderProgram=null,A.setContext(this.gl),this.context=null,W.write(A.getParameter("VERSION")+", "+A.getParameter("SHADING_LANGUAGE_VERSION"))),this.matrixStack=_.Pool.alloc(),this.alphaStack=_.Pool.alloc(),this.depthFlagStack=_.Pool.alloc(),this.shaderProgramStack=_.Pool.alloc(),this.matr=I.Pool.alloc(),this.transform=I.Pool.alloc(),this._globalScale=1,this._alpha=1,this._depthFlag=!0,this.updateTransform(),this.strokeStyle("#fff"),this.fillStyle("#fff"),e.width&&e.height&&this.resize(e.width,e.height),null!==this.gl&&this.initGl(),this.antialias=e.antialias,this.setBackground(e.background))};B.passThruCanvas={parentNode:null,imageSmoothingEnabled:!0,style:{},width:960,height:540,getContext:function(t){return this},pushClip:function(){},popClip:function(){},scale:function(t,e){},rotate:function(t){},translate:function(t,e){},setTransform:function(t,e,i,n,s,r){},updateTransform:function(){},toDataURL:function(t,e){return""},beginPath:function(){},moveTo:function(t,e){},closePath:function(){},lineTo:function(){},rect:function(t,e,i,n){},fill:function(){},stroke:function(){},fillRect:function(t,e,i,n){},strokeRect:function(t,e,i,n){},clip:function(){},quadraticCurveTo:function(t,e,i,n){},bezierCurveTo:function(t,e,i,n,s,r){},arc:function(t,e,i,n,s,r){},arcTo:function(t,e,i,n,s){},fillText:function(t,e,i,n){},strokeText:function(t,e,i,n){},measureText:function(t){return{width:0}},createImageData:function(t,e){return{width:t,height:e}},getImageData:function(t,e,i,n){return{width:i,height:n,data:[]}},putImageData:function(t,e,i){},drawImage:function(t,e=0,i=0,n=null,s=null,r=null,l=null,a=null,o=null,h=null,u=null,c=null,d=null){},getBoundingClientRect:function(){return{left:0,top:0}}},B.prototype.initGl=function(){let t=this.gl;if(this.glFWrapProgram=new M("fwrap"),new N("fwrap-vert",N.Type.VERTEX,"\n\t\tuniform mat3 m_transform;\n\t\tuniform mat3 m_quad;\n\t\tuniform mat3 m_texture;\n\t\tuniform vec4 v_resolution;\n\t\tuniform vec4 v_frame_size;\n\t\tuniform float f_depth;\n\n\t\tin vec3 location;\n\t\tout vec2 texcoords;\n\n\t\t//@use location2d, frameTexCoords\n\n\t\tvoid main ()\n\t\t{\n\t\t\tgl_Position = location2d (location, f_depth);\n\t\t\ttexcoords = frameTexCoords(location);\n\t\t}\n\t"),new N("fwrap-frag",N.Type.FRAGMENT,"\n\t\tuniform sampler2D texture0;\n\t\tuniform vec4 v_frame_size;\n\t\tuniform float f_alpha;\n\n\t\tin vec2 texcoords;\n\t\tout vec4 color;\n\n\t\t//@use frameTex\n\n\t\tvoid main ()\n\t\t{\n\t\t\tcolor = frameTex(texcoords);\n\n\t\t\tcolor.a *= f_alpha;\n\t\t\tif (color.a <= 0.0) discard;\n\t\t}\n\t"),this.glDefaultProgram=new M("def"),new N("def-vert",N.Type.VERTEX,"\n\t\tuniform mat3 m_transform;\n\t\tuniform mat3 m_quad;\n\t\tuniform mat3 m_texture;\n\t\tuniform vec4 v_resolution;\n\t\tuniform float f_depth;\n\n\t\tin vec3 location;\n\t\tout vec2 texcoords;\n\n\t\t//@use location2d\n\n\t\tvoid main ()\n\t\t{\n\t\t\tgl_Position = location2d (location, f_depth);\n\t\t\ttexcoords = vec2(m_texture * location);\n\t\t}\n\t"),new N("def-frag",N.Type.FRAGMENT,"\n\t\tuniform sampler2D texture0;\n\t\tuniform float f_alpha;\n\n\t\tin vec2 texcoords;\n\t\tout vec4 color;\n\n\t\tvoid main()\n\t\t{\n\t\t\tcolor = texture(texture0, texcoords);\n\n\t\t\tcolor.a *= f_alpha;\n\t\t\tif (color.a <= 0.0) discard;\n\t\t}\n\t"),this.glBlitProgram=new M("blit"),new N("blit-vert",N.Type.VERTEX,"\n\t\tuniform vec4 v_resolution;\n\t\tuniform mat3 m_quad;\n\t\tuniform mat3 m_texture;\n\n\t\tin vec3 location;\n\t\tout vec2 texcoords;\n\n\t\t//@use snorm\n\n\t\tvoid main() {\n\t\t\tgl_Position = vec4(snorm(vec2(m_quad * location) / v_resolution.xy), 0.0, 1.0);\n\t\t\ttexcoords = vec2(m_texture * location);\n\t\t}\n\t"),new N("blit-frag",N.Type.FRAGMENT,"\n\t\tuniform sampler2D texture0;\n\t\tin vec2 texcoords;\n\n\t\tout vec4 color;\n\n\t\tvoid main() {\n\t\t\tcolor = texture(texture0, texcoords);\n\t\t}\n\t"),this.glDefaultProgram.attach("def-vert"),this.glDefaultProgram.attach("def-frag"),this.glFWrapProgram.attach("fwrap-vert"),this.glFWrapProgram.attach("fwrap-frag"),this.glBlitProgram.attach("blit-vert"),this.glBlitProgram.attach("blit-frag"),this.glDefaultProgram.link(),this.glFWrapProgram.link(),this.glBlitProgram.link(),!this.glDefaultProgram.getStatus())throw new Error(this.glDefaultProgram.getAllErrors());if(!this.glFWrapProgram.getStatus())throw new Error(this.glFWrapProgram.getAllErrors());if(!this.glBlitProgram.getStatus())throw new Error(this.glBlitProgram.getAllErrors());this.setShaderProgram(M.get("def")),this.vao0=t.createVertexArray(),t.bindVertexArray(this.vao0),A.createBufferFrom([0,0,1,0,1,1,1,0,1,1,1,1],A.BufferTarget.ARRAY_BUFFER,A.BufferUsage.STATIC_DRAW),t.vertexAttribPointer(Y.shaderProgram.getAttribLocation("location"),3,t.FLOAT,t.FALSE,3*Float32Array.BYTES_PER_ELEMENT,0*Float32Array.BYTES_PER_ELEMENT),t.enableVertexAttribArray(Y.shaderProgram.getAttribLocation("location")),t.clearColor(0,0,0,1),t.enable(t.DEPTH_TEST),t.clearDepth(0),t.depthFunc(t.GEQUAL),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.m_quad=new Float32Array(9).fill(0),this.m_texture=new Float32Array(9).fill(0),this.v_resolution=new Float32Array(4).fill(0),this.zvalue=0,I.loadIdentity(this.m_quad),I.loadIdentity(this.m_texture),this.drawImage=function(t,e,i,n,s,r,l,a,o,h=null,u=null,c=null,d=null){if(!t.textureId)return;let f=this.gl,p=Y.shaderProgram;null===h&&(h=t.width,u=t.height),null===c&&(c=t.targetWidth,d=t.targetHeight),p.uniform4fv("v_resolution",this.v_resolution),p.uniform1f("f_time",Y.time),p.uniform1f("f_scale",this._globalScale),p.uniform1f("f_alpha",this._alpha),this.activeTextureId===t.textureId&&this.activeShader===p||(f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,t.textureId),p.uniform1i("texture0",0),p.uniform4f("v_frame_size",c*t.rscale/h,d*t.rscale/u,c,d),this.activeTextureId=t.textureId,this.activeShader=p),this.m_quad[0]=a,this.m_quad[4]=o,this.m_quad[6]=r,this.m_quad[7]=l,this.m_texture[0]=n/h,this.m_texture[4]=s/u,this.m_texture[6]=e/h,this.m_texture[7]=i/u,f.uniformMatrix3fv(p.getUniformLocation("m_transform"),!1,this.transform.data),f.uniformMatrix3fv(p.getUniformLocation("m_quad"),!1,this.m_quad),f.uniformMatrix3fv(p.getUniformLocation("m_texture"),!1,this.m_texture),f.uniform1f(p.getUniformLocation("f_depth"),this.zvalue),f.drawArrays(f.TRIANGLE_STRIP,0,4)},this.drawRect=function(t,e,i,n,s=null){let r=this.gl,l=Y.shaderProgram;l.uniform4fv("v_resolution",this.v_resolution),l.uniform1f("f_time",Y.time),l.uniform1f("f_scale",this._globalScale),l.uniform1f("f_alpha",this._alpha),this.activeTextureId=null,this.m_quad[0]=i,this.m_quad[4]=n,this.m_quad[6]=t,this.m_quad[7]=e,this.m_texture[0]=1,this.m_texture[4]=1,this.m_texture[6]=0,this.m_texture[7]=0,r.uniformMatrix3fv(l.getUniformLocation("m_transform"),!1,this.transform.data),r.uniformMatrix3fv(l.getUniformLocation("m_quad"),!1,this.m_quad),r.uniformMatrix3fv(l.getUniformLocation("m_texture"),!1,this.m_texture),r.uniform1f(l.getUniformLocation("f_depth"),this.zvalue),r.drawArrays(r.TRIANGLE_STRIP,0,4)}},B.prototype.prepareImage=function(e){t.mutate(L,e,{width:e.width,height:e.height}).upload(e)},B.prototype.createTexture=function(t,e,i="NEAREST",n=0){return console.log("createTexture"),new L(t,e).setFilter(i).setMipmap(n).allocate()},B.prototype.applyConfig=function(){0==this.antialias?(null!=this.context&&(this.context.imageSmoothingEnabled=!1),this.elem.style.imageRendering="crisp-edges"):(null!=this.context&&(this.context.imageSmoothingEnabled=!0),this.elem.style.imageRendering="auto")},B.prototype.dispose=function(){this.elem.parentNode&&this.elem.parentNode.removeChild(this.elem),this.matrixStack.free(),this.alphaStack.free(),this.depthFlagStack.free(),this.shaderProgramStack.free(),this.matr=null,this.context=null,this.elem=null},B.prototype.setBackground=function(t){if(this.elem.style.background=t,this.backgroundColor=t,null!==this.gl){if(7!=t.length)throw new Error("Canvas.setBackground: color parameter should be CSS-style hex-rgb with 6 digits.");let e=parseInt(t.substr(1,2),16)/255,i=parseInt(t.substr(3,2),16)/255,n=parseInt(t.substr(5,2),16)/255;this.gl.clearColor(e,i,n,1)}},B.prototype.resize=function(t,e){let i=this.elem.getBoundingClientRect();t||(t=i.width),e||(e=i.height),this.elem.width=t,this.elem.height=e,this.width=this.elem.width,this.height=this.elem.height,this._width=int(this.width/this._globalScale),this._height=int(this.height/this._globalScale);let n=this.gl;return null!=n&&(n.enable(n.SCISSOR_TEST),n.scissor(0,0,this.width,this.height),n.viewport(0,0,this.width,this.height),this.v_resolution&&(this.v_resolution[0]=this.width,this.v_resolution[1]=this.height,this.v_resolution[2]=this.width,this.v_resolution[3]=this.height)),this.applyConfig(),this},B.prototype.globalScale=function(t){return this._globalScale=t,this._width=int(this.width/this._globalScale),this._height=int(this.height/this._globalScale),this.loadIdentity(),this.scale(t,t),this},B.prototype.flipped=function(t){return t?(this._width=int(this.height/this._globalScale),this._height=int(this.width/this._globalScale)):(this._width=int(this.width/this._globalScale),this._height=int(this.height/this._globalScale)),null!=this.gl&&this.v_resolution&&(this.v_resolution[0]=this.width,this.v_resolution[1]=this.height,this.v_resolution[2]=t?this.height:this.width,this.v_resolution[3]=t?this.width:this.height),this.isFlipped=t,this},B.prototype.pushClip=function(){return this},B.prototype.popClip=function(){return null!=this.gl&&this.gl.scissor(0,0,this.width,this.height),this},B.prototype.toDataUrl=function(t="image/png",e=null){return this.elem.toDataURL(t,e)},B.prototype.toPngBase64=function(){return this.elem.toDataURL("image/png").substr(22)},B.prototype._contextAttribute=function(t,e=null){if(this.context)return null!==e?(this.context[t]=e,this):this.context[t]},B.prototype.fillStyle=function(t){return this._contextAttribute("fillStyle",t)},B.prototype.strokeStyle=function(t){return this._contextAttribute("strokeStyle",t)},B.prototype.lineCap=function(t){return this._contextAttribute("lineCap",t)},B.prototype.lineJoin=function(t){return this._contextAttribute("lineJoin",t)},B.prototype.lineWidth=function(t){return this._contextAttribute("lineWidth",t)},B.prototype.miterLimit=function(t){return this._contextAttribute("miterLimit",t)},B.prototype.shadowColor=function(t){return this._contextAttribute("shadowColor",t)},B.prototype.shadowOffsetX=function(t){return this._contextAttribute("shadowOffsetX",t)},B.prototype.shadowOffsetY=function(t){return this._contextAttribute("shadowOffsetY",t)},B.prototype.shadowBlur=function(t){return this._contextAttribute("shadowBlur",t)},B.prototype.font=function(t){return this._contextAttribute("font",t)},B.prototype.textAlign=function(t){return this._contextAttribute("textAlign",t)},B.prototype.textBaseline=function(t){return this._contextAttribute("textBaseline",t)},B.prototype.globalAlpha=function(t=null){return null===t?this._alpha:(this._alpha=t,this.alpha(1))},B.prototype.globalCompositeOperation=function(t){return this._contextAttribute("globalCompositeOperation",t)},B.prototype.updateTransform=function(){return this.setTransform(this.matr.data[0],this.matr.data[1],this.matr.data[3],this.matr.data[4],this.matr.data[6],this.matr.data[7]),this},B.prototype.setTransform=function(t,e,i,n,s,r){return null===this.context?(this.transform.data[0]=t,this.transform.data[1]=e,this.transform.data[2]=0,this.transform.data[3]=i,this.transform.data[4]=n,this.transform.data[5]=0,this.transform.data[6]=int(s),this.transform.data[7]=int(r),this.transform.data[8]=1,this):(this.context.setTransform(t,e,i,n,int(s),int(r)),this)},B.prototype.fillRect=function(t,e,i,n){return this.context.fillRect(t,e,i,n),this},B.prototype.strokeRect=function(t,e,i,n){return this.context.strokeRect(t,e,i,n),this},B.prototype.clearRect=function(t,e,i,n){return this.context.clearRect(t,e,i,n),this},B.prototype.beginPath=function(){return this.context.beginPath(),this},B.prototype.moveTo=function(t,e){return this.context.moveTo(t,e),this},B.prototype.closePath=function(){return this.context.closePath(),this},B.prototype.lineTo=function(t,e){return this.context.lineTo(t,e),this},B.prototype.rect=function(t,e,i,n){return this.context.rect(t,e,i,n),this},B.prototype.fill=function(t=null){return t&&this.fillStyle(t),this.context.fill(),this},B.prototype.stroke=function(t=null){return t&&this.strokeStyle(t),this.context.stroke(),this},B.prototype.clip=function(t,e,i,n){return null!==this.gl&&(t*=this._globalScale,e*=this._globalScale,i*=this._globalScale,n*=this._globalScale,this.isFlipped?this.gl.scissor(this.width-e-n-1,this.height-t-i-1,n,i):this.gl.scissor(t,this.height-e-n-1,i,n)),this},B.prototype.quadraticCurveTo=function(t,e,i,n){return this.context.quadraticCurveTo(t,e,i,n),this},B.prototype.bezierCurveTo=function(t,e,i,n,s,r){return this.context.bezierCurveTo(t,e,i,n,s,r),this},B.prototype.arc=function(t,e,i,n,s,r){return this.context.arc(t,e,i,n,s,r),this},B.prototype.arcTo=function(t,e,i,n,s){return this.context.arcTo(t,e,i,n,s),this},B.prototype.fillText=function(t,e,i,n=1e3){return this.context.fillText(t,e,i,n),this},B.prototype.strokeText=function(t,e,i,n=1e3){return this.context.strokeText(t,e,i,n),this},B.prototype.measureText=function(t){return this.context.measureText(t).width},B.prototype.createImageData=function(t,e){return this.context.createImageData(t,e)},B.prototype.getImageData=function(t,e,i,n){return this.context.getImageData(t,e,i,n)},B.prototype.putImageData=function(t,e,i){return this.context.putImageData(t,e,i),this},B.prototype.drawImage=function(t,e=0,i=0,n=null,s=null,r=null,l=null,a=null,o=null){if(null===n)this.context.drawImage(t,int(e),int(i));else if(null===r)this.context.drawImage(t,int(e),int(i),int(n),int(s));else{let h=int(n),u=int(s);if(!h||!u)return this;let c=int(a),d=int(o);if(!c||!d)return this;this.context.drawImage(t,int(e),int(i),h,u,int(r),int(l),c,d)}return this},B.prototype.clear=function(t=null){return null!=this.gl?(this.gl.clear(this.gl.STENCIL_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT|this.gl.COLOR_BUFFER_BIT),this.activeTextureId=null,this):(t?this.globalCompositeOperation("source-over").globalAlpha(1).fillStyle(!0!==t?t:this.backgroundColor).fillRect(0,0,this._width,this._height):(this.elem.width=this.width,this.applyConfig()),this.updateTransform(),this)},B.prototype.start=function(){},B.prototype.end=function(){},B.prototype.flush=function(){let t=this.gl;null!==t&&(t.colorMask(!1,!1,!1,!0),t.clear(t.COLOR_BUFFER_BIT),t.colorMask(!0,!0,!0,!0))},B.prototype.blit=function(t,e,i,n=null){let s=this.gl;null!==s&&(n=n||this.glBlitProgram,this.setShaderProgram(n),s.disable(s.DEPTH_TEST),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,t),n.uniform1i("texture0",0),n.uniform4fv("v_resolution",this.v_resolution),n.uniform1f("f_time",Y.time),n.uniform1f("f_scale",this._globalScale),n.uniform1f("f_alpha",this._alpha),this.m_quad[0]=this.width,this.m_quad[4]=this.height,this.m_quad[6]=0,this.m_quad[7]=0,this.m_texture[0]=this.width/e,this.m_texture[4]=this.height/i,this.m_texture[6]=0,this.m_texture[7]=0,s.uniformMatrix3fv(n.getUniformLocation("m_quad"),!1,this.m_quad),s.uniformMatrix3fv(n.getUniformLocation("m_texture"),!1,this.m_texture),s.drawArrays(s.TRIANGLE_STRIP,0,4),this.setShaderProgram(M.get("def")),s.enable(s.DEPTH_TEST))},B.prototype.reset=function(t=!1){return this.fillStyle("#000000").strokeStyle("#000000").lineCap("butt").lineJoin("miter").lineWidth("1").miterLimit("10").shadowColor("#000000").shadowOffsetX("0").shadowOffsetY("0").shadowBlur("0").globalAlpha("1.0").globalCompositeOperation("source-over"),t&&this.beginPath().closePath(),this},B.prototype.pushMatrix=function(){return this.matrixStack.push(this.matr),this.matr=this.matr.clone(),this},B.prototype.popMatrix=function(){return this.matr.free(),this.matr=this.matrixStack.pop(),this.updateTransform()},B.prototype.alpha=function(t){return this._alpha*=t,this.context&&null===this.gl&&(this.context.globalAlpha=this._alpha),this},B.prototype.pushAlpha=function(){return this.alphaStack.push(this.globalAlpha()),this},B.prototype.popAlpha=function(){return this.globalAlpha(this.alphaStack.pop()),this},B.prototype.setDepthFlag=function(t){let e=this.gl;null!==e&&(t?(e.enable(e.DEPTH_TEST),this._depthFlag=!0):(e.disable(e.DEPTH_TEST),this._depthFlag=!1))},B.prototype.getDepthFlag=function(){return this._depthFlag},B.prototype.pushDepthFlag=function(t=null){if(null!==t)return(t=!!t)!==this._depthFlag&&(this.depthFlagStack.push(this._depthFlag),this.setDepthFlag(t),!0);this.depthFlagStack.push(this._depthFlag)},B.prototype.popDepthFlag=function(){this.setDepthFlag(this.depthFlagStack.pop())},B.prototype.setShaderProgram=function(t){null!==this.gl&&(Y.shaderProgram=t,Y.shaderProgram.activate())},B.prototype.getShaderProgram=function(){return Y.shaderProgram},B.prototype.pushShaderProgram=function(t=null){if(null!==t)return t!==Y.shaderProgram&&(this.shaderProgramStack.push(Y.shaderProgram),this.setShaderProgram(t),!0);this.shaderProgramStack.push(Y.shaderProgram)},B.prototype.popShaderProgram=function(){this.setShaderProgram(this.shaderProgramStack.pop())},B.prototype.loadIdentity=function(){return this.matr.identity(),this.updateTransform()},B.prototype.loadMatrix=function(t){return this.matr.set(t),this.updateTransform()},B.prototype.getMatrix=function(t=!1){return t?this.matr.clone():this.matr},B.prototype.appendMatrix=function(t){return this.matr.append(t),this.updateTransform()},B.prototype.scale=function(t,e,i=!1){return i?(this.context.scale(t,e),this):(this.matr.scale(t,e),this.updateTransform())},B.prototype.rotate=function(t,e=!1){return e?(this.context.rotate(t),this):(this.matr.rotate(t),this.updateTransform())},B.prototype.translate=function(t,e,i=!1){return i?(this.context.translate(t,e),this):(this.matr.translate(t,e),this.updateTransform())},B.prototype.ellipse=function(t,e,i,n){var s=i/2*.5522848,r=n/2*.5522848,l=t+i-1,a=e+n-1,o=t+i/2,h=e+n/2;return this.beginPath().moveTo(t,h),this.bezierCurveTo(t,h-r,o-s,e,o,e),this.bezierCurveTo(o+s,e,l,h-r,l,h),this.bezierCurveTo(l,h+r,o+s,a,o,a),this.bezierCurveTo(o-s,a,t,h+r,t,h),this.closePath(),this},B.prototype.circle=function(t,e,i,n){return this.beginPath(),this.arc(t,e,i,0,2*Math.PI),this.closePath(),n&&this.stroke(n),this},B.prototype.line=function(t,e,i,n,s){return this.beginPath(),this.moveTo(t,e),this.lineTo(i,n),this.closePath(),s&&this.stroke(s),this},B.prototype.enablePointerEvents=function(){if(this.pointerHandler)return this;this.pointerScale={sx:1,sy:1},this.pointerOffset={x:0,y:0};var t=this,e={action:"",buttons:0,lbuttons:0,x:0,y:0,containedBy:function(t,e,i,n){return this.x>=t&&this.x<=t+i-1&&this.y>=e&&this.y<=e+n-1}};return this.pointerHandlers=[],this.pointerHandler=function(i,n){var s=this.elem.getBoundingClientRect();e.action=i,e.buttons=n.buttons,e.x=e.rx=int(n.clientX-s.left),e.y=e.ry=int(n.clientY-s.top),e.x=(e.x-t.pointerOffset.x-0*t.pointerScale.sx)/t.pointerScale.sx,e.y=(e.y-t.pointerOffset.y-0*t.pointerScale.sy)/t.pointerScale.sy,e.dragging=!1,e.buttons&&!e.lbuttons&&(e.sx=e.x,e.sy=e.y,e.ldx=e.ldy=0),e.buttons&&e.lbuttons&&(e.dragging=!0,e.dx=e.x-e.sx,e.dy=e.y-e.sy,e.ddx=e.dx-e.ldx,e.ddy=e.dy-e.ldy,e.ldx=e.dx,e.ldy=e.dy),e.lbuttons=e.buttons;for(var r=0;r<this.pointerHandlers.length&&!1!==this.pointerHandlers[r][1](e,this.pointerHandlers[r][2]);r++);},this.elem.onmousedown=function(e){t.pointerHandler("DOWN",e)},this.elem.onmouseup=function(e){t.pointerHandler("UP",e)},this.elem.onmousemove=function(e){t.pointerHandler("MOVE",e)},this},B.prototype.setPointerScale=function(t,e){return this.pointerScale={sx:t,sy:e},this},B.prototype.setPointerOffset=function(t,e){return this.pointerOffset={x:t,y:e},this},B.prototype.addPointerHandler=function(t,e){return this.enablePointerEvents(),this.pointerHandlers.push([this.pointerHandlers.length+"_"+int(1e6*Math.random()),t,e]),this.pointerHandlers[this.pointerHandlers.length-1][0]},B.prototype.removePointerHandler=function(t){if(this.pointerHandlers)for(var e=0;e<this.pointerHandlers.length;e++)if(this.pointerHandlers[e][0]==t){this.pointerHandlers.splice(e,1);break}},B.renderImage=function(t,e,i,n){let s=new B({hidden:!0,width:t,height:e,antialias:H.options.antialias});i(s);let r=s.toDataUrl(),l=new Image;l.onload=()=>{l.filter=H.options.antialias?"LINEAR":"NEAREST",l.rscale=1,l.targetWidth=t,l.targetHeight=e,H.renderer.prepareImage(l),n(l,r)},l.src=r,s.dispose()},B.renderImageMipmap=function(t,e,i,n,s){let r=new B({hidden:!0,width:e,height:i,antialias:H.options.antialias});n(r);let l=r.toDataUrl(),a=new Image;a.onload=()=>{a.filter=H.options.antialias?"LINEAR":"NEAREST",a.rscale=1,a.targetWidth=e,a.targetHeight=i,a.mipmap=t,H.renderer.prepareImage(a),s(a,l)},a.src=l,r.dispose()};var U=B;
//![import "./keycode"]
//![import "../utils/list"]
//![import "../utils/linkable"]
//![import "./timer"]
//![import "./canvas"]
//![import "./globals"]
const O={
//!namespace System
//!enum KeyboardEventType
KeyboardEventType:{KEY_DOWN:1,KEY_UP:2},
//!/enum
//!enum PointerEventType
PointerEventType:{POINTER_DOWN:16,POINTER_UP:17,POINTER_MOVE:18,POINTER_DRAG_START:19,POINTER_DRAG_MOVE:20,POINTER_DRAG_STOP:21,POINTER_WHEEL:22}};
//!/enum
//!type KeyboardState =
//!/type
//!type Pointer =
//!/type
//!type Options =
//!/type
//!/namespace
//!class System
Object.assign(O,{flags:{renderingEnabled:!1,renderingPaused:!1},defaultOptions:{background:"#000000",gl:!0,log:!1,overdraw:!1,antialias:!0,orientation:0,fps:144,minFps:15,vsync:!0,screenWidth:null,screenHeight:null,extraScaleFactor:1,maxScaleFactor:null,fullscreen:!1},screenWidth:0,screenHeight:0,orientation:0,offsX:0,offsY:0,devicePixelRatio:1,backingStoreRatio:1,canvasPixelRatio:1,canvasScaleFactor:1,scaleFactor:1,initialMatrix:null,renderer:null,displayBuffer2:null,displayBuffer3:null,tempDisplayBuffer:null,keyState:{time:0,shift:!1,ctrl:!1,alt:!1,keyCode:0},pointers:{},updateQueue:null,drawQueue:null,timeScale:1,frameInterval:0,fixedFrameInterval:0,maxFrameInterval:0,frameDelta:0,frameTime:0,frameNumber:0,perf:{startTime:0,lastTime:0,numFrames:0,numSamples:0,updateTimeTotal:0,drawTimeTotal:0,extraTimeTotal:0,fps:0,averageFps:0,averageUpdateTime:0,averageDrawTime:0,averageExtraTime:0},init:function(t=null){let e=this,i={...this.defaultOptions,...t};this.options=i,!1!==this.options.preallocate&&(!0===this.options.preallocate?p.preallocate():p.preallocate(this.options.preallocate)),i.screenWidth&&i.screenHeight&&"default"==i.orientation&&(i.orientation=i.screenWidth>i.screenHeight?"landscape":"portrait"),this.orientation=i.orientation,this.updateQueue=_.Pool.alloc(),this.drawQueue=_.Pool.alloc(),this.frameInterval=1e3/i.fps,this.maxFrameInterval=1e3/i.minFps,r.onresize=function(){e.onWindowResized()},this.frameTimer=new v(i.vsync,this.frameInterval,(t=>this.onFrame(t))),this.renderer=new U({gl:i.gl,elem:null,absolute:!0,hidden:!1,antialias:i.antialias,background:i.background}),this.displayBuffer2=new U({gl:!1,elem:null,absolute:!0,hidden:!1,antialias:i.antialias,background:"none"}),this.displayBuffer2.elem.style.pointerEvents="none",this.displayBuffer3=new U({gl:!1,elem:null,absolute:!0,hidden:!1,antialias:i.antialias,background:"none"}),this.displayBuffer3.elem.style.pointerEvents="none",this.tempDisplayBuffer=new U({hidden:!0,antialias:i.antialias}).resize(640,480);let n=this.renderer.elem;this.devicePixelRatio=r.devicePixelRatio||1,this.backingStoreRatio=!0===i.gl?1:this.renderer.context.webkitBackingStorePixelRatio||this.renderer.context.mozBackingStorePixelRatio||this.renderer.context.msBackingStorePixelRatio||this.renderer.context.oBackingStorePixelRatio||this.renderer.context.backingStorePixelRatio||1,this.canvasPixelRatio=this.devicePixelRatio/this.backingStoreRatio,O.onWindowResized(!0),r.onkeydown=function(t){if(t.target===r.document.body){if(e.keyState[t.keyCode])return!1;switch(e.keyState[t.keyCode]=!0,e.keyState.keyCode=t.keyCode,e.keyState.startTime=hrnow(),t.keyCode){case 16:e.keyState.shift=!0;break;case 17:e.keyState.ctrl=!0;break;case 18:e.keyState.alt=!0}return e.keyState.ctrl&&t.keyCode==u.TAB?(e.keyState[t.keyCode]=!1,!0):!1!==e.onKeyboardEvent(e.KeyboardEventType.KEY_DOWN,t.keyCode,e.keyState)&&void 0}},r.onkeyup=function(t){if(t.target===r.document.body){if(!e.keyState[t.keyCode])return!1;switch(e.keyState[t.keyCode]=!1,e.keyState.endTime=hrnow(),e.keyState.keyCode=t.keyCode,t.keyCode){case 16:e.keyState.shift=!1;break;case 17:e.keyState.ctrl=!1;break;case 18:e.keyState.alt=!1}return!1!==e.onKeyboardEvent(e.KeyboardEventType.KEY_UP,t.keyCode,e.keyState)&&void 0}};const s=function(t,e){return O.reverseRender?int(O.screenWidth-1-(e-O.offsY)/O.canvasScaleFactor):int((t-O.offsX)/O.canvasScaleFactor)},l=function(t,e){return O.reverseRender?int((t-O.offsX)/O.canvasScaleFactor):int((e-O.offsY)/O.canvasScaleFactor)};"ontouchstart"in r?(n.ontouchstart=function(t){t.preventDefault();let e=t.changedTouches;for(let t=0;t<e.length;t++){O.pointers[e[t].identifier]||(O.pointers[e[t].identifier]={id:e[t].identifier,isActive:!1,isDragging:!1,sx:0,sy:0,x:0,y:0,dx:0,dy:0,button:0,wheelDelta:0,wheelAccum:0});let i=O.pointers[e[t].identifier];i.isActive=!0,i.isDragging=!1,i.button=1,i.startTime=hrnow(),i.x=i.sx=s(e[t].clientX,e[t].clientY),i.y=i.sy=l(e[t].clientX,e[t].clientY),O.onPointerEvent(O.PointerEventType.POINTER_DOWN,i,O.pointers)}return!1},n.ontouchend=function(t){t.preventDefault();let e=t.changedTouches;for(let t=0;t<e.length;t++){if(!O.pointers[e[t].identifier])continue;let i=O.pointers[e[t].identifier];i.endTime=hrnow(),i.deltaTime=i.endTime-i.startTime,i.x=s(e[t].clientX,e[t].clientY),i.y=l(e[t].clientX,e[t].clientY),i.isDragging&&O.onPointerEvent(O.PointerEventType.POINTER_DRAG_STOP,i,O.pointers),O.onPointerEvent(O.PointerEventType.POINTER_UP,i,O.pointers),i.isActive=!1,i.isDragging=!1,i.button=0}return!1},n.ontouchcancel=function(t){t.preventDefault();let e=t.changedTouches;for(let t=0;t<e.length;t++){if(!O.pointers[e[t].identifier])continue;let i=O.pointers[e[t].identifier];i.x=s(e[t].clientX,e[t].clientY),i.y=l(e[t].clientX,e[t].clientY),O.onPointerEvent(i.isDragging?O.PointerEventType.POINTER_DRAG_STOP:O.PointerEventType.POINTER_UP,i,O.pointers),i.isActive=!1,i.isDragging=!1,i.button=0}return!1},n.ontouchmove=function(t){t.preventDefault();let e=t.changedTouches;for(let t=0;t<e.length;t++){if(!O.pointers[e[t].identifier])continue;let i=O.pointers[e[t].identifier];i.isActive&&!i.isDragging&&(O.onPointerEvent(O.PointerEventType.POINTER_DRAG_START,i,O.pointers),i.isDragging=!0),i.x=s(e[t].clientX,e[t].clientY),i.y=l(e[t].clientX,e[t].clientY),i.dx=i.x-i.sx,i.dy=i.y-i.sy,O.onPointerEvent(i.isDragging?O.PointerEventType.POINTER_DRAG_MOVE:O.PointerEventType.POINTER_MOVE,i,O.pointers)}return!1}):(n.oncontextmenu=function(t){return t.preventDefault(),!1},n.onwheel=function(t){t.preventDefault(),O.pointers[0]||(O.pointers[0]={id:0,isActive:!1,isDragging:!1,sx:0,sy:0,x:0,y:0,dx:0,dy:0,button:0,wheelDelta:0,wheelAccum:0});let e=O.pointers[0];return e.x=s(t.clientX,t.clientY),e.y=l(t.clientX,t.clientY),e.wheelDelta=t.deltaY,e.wheelAccum+=t.deltaY,O.onPointerEvent(O.PointerEventType.POINTER_WHEEL,e,O.pointers),!1},n.onmousedown=function(t){t.preventDefault(),O.pointers[0]||(O.pointers[0]={id:0,isActive:!1,isDragging:!1,sx:0,sy:0,x:0,y:0,dx:0,dy:0,button:0,wheelDelta:0,wheelAccum:0});let e=O.pointers[0];return e.isActive=!0,e.isDragging=!1,e.button=t.which,e.x=e.sx=s(t.clientX,t.clientY),e.y=e.sy=l(t.clientX,t.clientY),O.onPointerEvent(O.PointerEventType.POINTER_DOWN,e,O.pointers),!1},n.onmouseup=function(t){if(t.preventDefault(),!O.pointers[0])return!1;let e=O.pointers[0];e.x=s(t.clientX,t.clientY),e.y=l(t.clientX,t.clientY),e.isDragging&&O.onPointerEvent(O.PointerEventType.POINTER_DRAG_STOP,e,O.pointers),O.onPointerEvent(O.PointerEventType.POINTER_UP,e,O.pointers),e.isActive=!1,e.isDragging=!1,e.button=0},n.onmousemove=function(t){if(t.preventDefault(),!O.pointers[0])return!1;let e=O.pointers[0];return e.isActive&&!e.isDragging&&(O.onPointerEvent(O.PointerEventType.POINTER_DRAG_START,e,O.pointers),e.isDragging=!0),e.x=s(t.clientX,t.clientY),e.y=l(t.clientX,t.clientY),e.dx=e.x-e.sx,e.dy=e.y-e.sy,O.onPointerEvent(e.isDragging?O.PointerEventType.POINTER_DRAG_MOVE:O.PointerEventType.POINTER_MOVE,e,O.pointers),!1}),!0===i.log&&W.enable()},time:function(){return this.frameTime},start:function(){this.onWindowResized(),this.flags.renderingPaused=!1,this.frameTimer.start()},stop:function(){this.flags.renderingPaused=!0,this.frameTimer.stop()},pause:function(){this.flags.renderingPaused=!0},resume:function(){this.flags.renderingPaused=!1,this.resetPerf()},onFrame:function(t){let e,i=hrnow();t>this.maxFrameInterval&&(t=this.maxFrameInterval),0!==this.fixedFrameInterval&&(t=this.fixedFrameInterval),this.flags.renderingEnabled&&!this.flags.renderingPaused?(t*=this.timeScale,this.frameDelta=t/1e3,this.frameTime+=this.frameDelta,Y.time=this.frameTime,this.frameNumber++,e=hrnow(),this.update(this.frameDelta),this.perf.updateTimeTotal+=hrnow()-e,e=hrnow(),this.draw(),this.perf.drawTimeTotal+=hrnow()-e,this.perf.lastTime=i,this.perf.numFrames++,(t=this.perf.lastTime-this.perf.startTime)>1e3&&(this.perf.fps=int(1e3*this.perf.numFrames/t),this.perf.averageFps=int((this.perf.averageFps*this.perf.numSamples+this.perf.fps)/(this.perf.numSamples+1)),this.perf.averageUpdateTime=int((this.perf.averageUpdateTime*this.perf.numSamples+1e3*this.perf.updateTimeTotal/this.perf.numFrames)/(this.perf.numSamples+1)),this.perf.averageDrawTime=int((this.perf.averageDrawTime*this.perf.numSamples+1e3*this.perf.drawTimeTotal/this.perf.numFrames)/(this.perf.numSamples+1)),this.perf.averageExtraTime=int((this.perf.averageExtraTime*this.perf.numSamples+1e3*this.perf.extraTimeTotal/this.perf.numFrames)/(this.perf.numSamples+1)),this.perf.numSamples++,this.perf.startTime=i,this.perf.lastTime=i,this.perf.numFrames=0,this.perf.updateTimeTotal=0,this.perf.drawTimeTotal=0,this.perf.extraTimeTotal=0)):this.draw()},onWindowResized:function(t=!1){if("document"in r)this.options.fullscreen?(this._screenWidth=int(r.screen.width),this._screenHeight=int(r.screen.height)):(this._screenWidth=r.innerWidth,this._screenHeight=r.innerHeight);else if(this._screenWidth=this.options.screenWidth,this._screenHeight=this.options.screenHeight,null==this.options.screenWidth&&null==this.options.screenHeight)throw new Error("At least one screen dimension must be specified in headless mode.");this._screenWidth<this._screenHeight&&"landscape"==this.orientation||this._screenWidth>this._screenHeight&&"portrait"==this.orientation?(this.screenWidth=this._screenHeight,this.screenHeight=this._screenWidth,this.reverseRender=!0):(this.screenWidth=this._screenWidth,this.screenHeight=this._screenHeight,this.reverseRender=!1);let e=this.options.screenWidth,i=this.options.screenHeight;null!==e&&null!==i||(null===e&&null===i?(e=this.screenWidth,i=this.screenHeight):null===e?e=int(.5+this.screenWidth*(this.options.screenHeight/this.screenHeight)):null===i&&(i=int(.5+this.screenHeight*(this.options.screenWidth/this.screenWidth))));let n=e,s=i;"automatic"===this.orientation&&n&&s&&(n>s&&this.screenWidth<this.screenHeight||n<s&&this.screenWidth>this.screenHeight)&&(n=s,s=e),this.canvasScaleFactor=1,n&&s?this.canvasScaleFactor=Math.min(this.screenWidth/n,this.screenHeight/s):n?this.canvasScaleFactor=this.screenWidth/n:s&&(this.canvasScaleFactor=this.screenHeight/s);let l=this.screenWidth,a=this.screenHeight;if(n&&(this.screenWidth=n),s&&(this.screenHeight=s),this.offsX=int(.5*(l-this.screenWidth*this.canvasScaleFactor)),this.offsY=int(.5*(a-this.screenHeight*this.canvasScaleFactor)),this.reverseRender){let t=this.offsX;this.offsX=this.offsY,this.offsY=t}this.scaleFactor=this.canvasScaleFactor*this.canvasPixelRatio,this.scaleFactor=int(.7+this.scaleFactor),this.options.maxScaleFactor>0&&this.scaleFactor>this.options.maxScaleFactor&&(this.scaleFactor=this.options.maxScaleFactor),this.flags.renderingEnabled=!1,"document"in r&&(r.document.body.style.backgroundColor=this.renderer.backgroundColor),this.reverseRender?(this.renderer.resize(this.screenHeight*this.scaleFactor,this.screenWidth*this.scaleFactor),this.renderer.elem.style.width=int(this.screenHeight*this.canvasScaleFactor+.5)+"px",this.renderer.elem.style.height=int(this.screenWidth*this.canvasScaleFactor+.5)+"px",this.displayBuffer2.resize(this.screenHeight*this.scaleFactor,this.screenWidth*this.scaleFactor),this.displayBuffer2.elem.style.width=int(this.screenHeight*this.canvasScaleFactor+.5)+"px",this.displayBuffer2.elem.style.height=int(this.screenWidth*this.canvasScaleFactor+.5)+"px",this.displayBuffer3.resize(a,l),this.displayBuffer3.elem.style.width=a+"px",this.displayBuffer3.elem.style.height=l+"px"):(this.renderer.resize(this.screenWidth*this.scaleFactor,this.screenHeight*this.scaleFactor),this.renderer.elem.style.width=int(this.screenWidth*this.canvasScaleFactor+.5)+"px",this.renderer.elem.style.height=int(this.screenHeight*this.canvasScaleFactor+.5)+"px",this.displayBuffer2.resize(this.screenWidth*this.scaleFactor,this.screenHeight*this.scaleFactor),this.displayBuffer2.elem.style.width=int(this.screenWidth*this.canvasScaleFactor+.5)+"px",this.displayBuffer2.elem.style.height=int(this.screenHeight*this.canvasScaleFactor+.5)+"px",this.displayBuffer3.resize(l,a),this.displayBuffer3.elem.style.width=l+"px",this.displayBuffer3.elem.style.height=a+"px"),this.renderer.elem.style.marginLeft=this.offsX+"px",this.renderer.elem.style.marginTop=this.offsY+"px",this.displayBuffer2.elem.style.marginLeft=this.offsX+"px",this.displayBuffer2.elem.style.marginTop=this.offsY+"px",this.renderer.loadIdentity(),this.displayBuffer2.loadIdentity(),this.displayBuffer3.loadIdentity(),1!=this.scaleFactor&&(this.renderer.globalScale(this.scaleFactor),this.displayBuffer2.globalScale(this.scaleFactor)),this.reverseRender?(this.renderer.rotate(Math.PI/2),this.renderer.translate(-this.screenWidth,0),this.renderer.flipped(!0),this.displayBuffer2.rotate(Math.PI/2),this.displayBuffer2.translate(-this.screenWidth,0),this.displayBuffer2.flipped(!0),this.displayBuffer3.rotate(Math.PI/2),this.displayBuffer3.translate(-l,0),this.displayBuffer3.flipped(!0)):(this.renderer.flipped(!1),this.displayBuffer2.flipped(!1),this.displayBuffer3.flipped(!1)),this.scaleFactor*=this.options.extraScaleFactor,this.options.maxScaleFactor>0&&this.scaleFactor>this.options.maxScaleFactor&&(this.scaleFactor=this.options.maxScaleFactor),this.integerScaleFactor=int(this.scaleFactor+.5),this.resetPerf(),this.initialMatrix&&this.initialMatrix.free(),this.initialMatrix=this.renderer.getMatrix(!0),1!=t&&(this.flags.renderingEnabled=!0,this.onCanvasResized(this.screenWidth,this.screenHeight))},onCanvasResized:function(t,e){},resetPerf:function(){this.perf.startTime=hrnow(),this.perf.lastTime=hrnow(),this.perf.numFrames=0,this.perf.updateTimeTotal=0,this.perf.drawTimeTotal=0,this.perf.extraTimeTotal=0,this.perf.numSamples=0,this.perf.fps=0,this.perf.averageFps=0,this.perf.averageUpdateTime=0,this.perf.averageDrawTime=0,this.perf.averageExtraTime=0},updateQueueAdd:function(t){return this.updateQueue.push(t),this.updateQueue.bottom},updateQueueRemove:function(t){this.updateQueue.remove(m.isInstance(t)?t:this.updateQueue.sgetNode(t))},drawQueueAdd:function(t){return this.drawQueue.push(t),this.drawQueue.bottom},drawQueueRemove:function(t){this.drawQueue.remove(m.isInstance(t)?t:this.drawQueue.sgetNode(t))},queueAdd:function(t){this.updateQueue.push(t),this.drawQueue.push(t)},queueRemove:function(t){this.updateQueue.remove(this.updateQueue.sgetNode(t)),this.drawQueue.remove(this.drawQueue.sgetNode(t))},update:function(t){try{let e;for(let i=this.updateQueue.top;i;i=e)e=i.next,!1===i.value.update(t)&&this.updateQueueRemove(i)}catch(t){throw O.stop(),t}},draw:function(){null!==this.renderer.gl&&this.renderer.start(),this.options.overdraw||(this.renderer.clear(),this.displayBuffer2.clear(),this.displayBuffer3.clear());try{let t;for(let e=this.drawQueue.top;e;e=t)t=e.next,e.value.draw(this.renderer);null!==this.renderer.gl&&(this.renderer.flush(),this.renderer.end())}catch(t){throw O.stop(),t}},interpolate:function(t,e,i,n,s){let r={},l={},a=0;for(let e in t)r[e]=0,l[e]=t[e],a++;let o={update:function(o){for(let s in r){if(r[s]==i[s])continue;r[s]+=o,r[s]>=i[s]&&(r[s]=i[s],a--);let h=n[s](r[s]/i[s]);l[s]=(1-h)*t[s]+h*e[s]}if(s(l,0==a),0==a)return!1}};O.updateQueueAdd(o),o.update(0)},onKeyboardEvent:function(t,e,i){return!0},onPointerEvent:function(t,e,i){return!0}});var//!/class
H=O;
//![import "./system"]
//![import "../utils/list"]
//!namespace Log
const X={enabled:!1,paused:!1,maxsize:30,data:_.Pool.alloc(),count:0,debugEcho:!1,color:"#fff",background:"#cf266a",vars:{},write:function(t){for(this.data.push(t),this.count++;this.data.length>this.maxsize;)this.data.shift();this.debugEcho&&console.debug(this.count+": "+t)},clear:function(){this.data.reset(),this.count=0},enable:function(t=0,e=0,i=9.5,n=!0,s=!0){if(this.enabled)return;this.enabled=!0,n||(e-=16);let r=e;H.drawQueueAdd({draw:function(){if(X.paused)return;let l=hrnow();const a=H.displayBuffer3;a.font("bold "+i+"pt Monospace"),a.textBaseline("top");let o="";e=r,!1!==n&&0!=H.perf.fps&&(o="fps: "+H.perf.fps+"/"+H.perf.averageFps+", update: "+H.perf.averageUpdateTime+", draw: "+H.perf.averageDrawTime+", extra: "+H.perf.averageExtraTime,X.background&&(a.fillStyle(X.background),a.fillRect(t-3,e-1,a.measureText(o)+6,i+5)),a.fillStyle(X.color),a.fillText(o,t,e)),o="";for(let t in X.vars)o+=t+": "+X.vars[t]+"  ";""!==o&&(e+=24,X.background&&(a.fillStyle(X.background),a.fillRect(t-3,e-1,a.measureText(o)+6,i+5)),a.fillStyle(X.color),a.fillText(o,t,e));let h=0;for(let n=X.data.top;n;n=n.next,h++)o=(s?"#"+(X.count-X.data.length+h+1)+": ":"> ")+n.value,X.background&&(a.fillStyle(X.background),a.fillRect(t-3,e-1+7+(i+5)*(h+1)-1,a.measureText(o)+6,i+5)),a.fillStyle(X.color),a.fillText(o,t,e-1+7+(i+5)*(h+1));l=hrnow()-l,H.perf.drawTimeTotal-=l,H.perf.extraTimeTotal+=l}})},pause:function(){this.paused=!0},resume:function(){this.paused=!1}};var W=X;
//![import "./random"]
//![import "./log"]
//![import "../flow/viewport"]
//!namespace globals
const G={gl:null,shaderProgram:null,time:0,viewport:null,debugBounds:!1,debugMasks:!1,rand0:new h,rand1:new h,rand2:new h};var Y=G;
//!/namespace
//!declare global
r.px=function(t){return t*C.SCALE},r.dispose=function(t){if(null!==t&&"object"==typeof t)return"free"in t?t.free():"dispose"in t?t.dispose():void("__dtor"in t&&t.__dtor())},"AudioContext"in r?(r.audioContext=new AudioContext({latencyHint:"interactive",sampleRate:44100}),W.write("AudioContext: baseLatency="+~~(1e3*r.audioContext.baseLatency)+" ms")):r.audioContext=null,r.fetchd=function(t,e){return new Promise(((i,n)=>{e||(e={}),"responseType"in e||(e.responseType="arraybuffer");let s=new XMLHttpRequest;s.open("GET",t,!0);for(let t in e)s[t]=e[t];s.onload=function(){i(s.response)},s.onerror=function(){n("Unable to fetch specified resource.")},s.send()}))},r.fetchAudioBuffer=function(t){return new Promise(((e,i)=>{r.audioContext?fetchd(t).then((t=>audioContext.decodeAudioData(t))).then((t=>e(t))).catch((t=>i(t))):i("AudioContext is not available.")}))},r.int=function(t){return t>>0},r.bool=function(t){return!0===t||!1===t?t:"true"==t||"false"!=t&&!!t},r.float=function(t){return parseFloat(t)},r.float2=function(t){return int(100*t)/100},r.float3=function(t){return int(1e3*t)/1e3},r.float4=function(t){return int(1e4*t)/1e4},r.rad=function(t){return t*Math.PI/180},r.deg=function(t){return t/Math.PI*180},r.rand=function(){return G.rand0.nextInt16()},r.randf=function(){return G.rand0.nextFloat()},r.randrf=function(t,e){let i=G.rand0.nextFloat();return i*e+(1-i)*t},r.randr=function(t,e){let i=G.rand0.nextFloat();return Math.round(i*e+(1-i)*t)},r.randt=function(t,e,i,n=!0){let s=[],r=t;for(let n=0;n<i;n++,r++)s.push(r),r+1>e&&(r=t-1);const l=i>>>1;for(let e=0;e<l;e++){t=randr(e+1,i-1);let n=s[e];s[e]=s[t],s[t]=n}if(!n)return s;let a=i-1;for(let t=1;t<i;t++){if(s[t]!==s[t-1])continue;for(;s[t]===s[a];)--a<0&&(a=i-1,console.log("!!"));let e=s[t];s[t]=s[a],s[a]=e}return s},r.randtf=function(t,e,i){for(var n=[],s=0;s<i;s++)n.push(randrf(t,e));return n},r.hrnow=function(){return performance.now()},r.randvar=function(t,e){return function(){return randr(t,e)}},r.randitem=function(t,e=null,i=null){return null===e&&(e=0),null===i&&(i=t.length-1),function(){return t[randr(e,i)]}},r.getLineSegmentIntersection=function(t,e,i,n,s,r,l,a){if(t==s&&e==r&&i==l&&n==a)return 0;var o=n-e,h=i-t,u=a-r,c=l-s;if(0==o&&0==u){if(e!=r)return 2;var d=Math.max(t,s);return d>Math.min(i,l)?2:(d-t)/h}if(0==h&&0==c){if(t!=s)return 2;var f=Math.max(e,r);return f>Math.min(n,a)?2:(f-e)/o}if(0==h)return 0>(g=(u*(t-s)+c*(r-e))/(c*o))||g>1||0>(p=(t-s)/c)||p>1?2:g;var p,g,m=u*h-c*o;return 0==m||0>(p=(o*(s-t)+h*(e-r))/m)||p>1||0>(g=(c*p+s-t)/h)||g>1?2:g},r.lineSegmentIntersects=function(t,e,i,n,s,r,l,a){let o=getLineSegmentIntersection(t,e,i,n,s,r,l,a);return o>=0&&o<=1},r.rotatePoint=function(t,e,i,n=0,s=0){return{x:n+(e-n)*Math.cos(t)+(i-s)*Math.sin(t),y:s+(i-s)*Math.cos(t)-(e-n)*Math.sin(t)}},r.stepValue=function(t,e,i,n){return Math.round(n*(t-e)/(i-e))/n*(i-e)+e},r.alignValue=function(t,e){return Math.round(t/e)*e},r.FIXED_POINT_BITS=8,r.upscale=function(t){return t*(1<<FIXED_POINT_BITS)>>0},r.downscale=function(t){return t>>FIXED_POINT_BITS},r.downscalef=function(t){return t/(1<<FIXED_POINT_BITS)},r.falign=function(t){return downscalef(upscale(t))},r.fract=function(t){return t-~~t},r.absmin=function(t,e){return Math.abs(t)<Math.abs(e)?t:e},r.absmax=function(t,e){return Math.abs(t)>Math.abs(e)?t:e},r.repeat=function(t,e){let i="";for(;e-- >0;)i+=t;return i},r.lpad=function(t,e,i="0"){return t=t.toString(),repeat(i.charAt(0),e-t.length)+t},r.rpad=function(t,e,i="0"){return(t=t.toString())+repeat(i.charAt(0),e-t.length)},r.norm=function(t){return.5*(t+1)},r.snorm=function(t){return 2*t-1},r.clamp=function(t,e=0,i=1){return t<e?e:t>i?i:t},r.map=function(t,e,i,n,s){return(t-e)*(s-n)/(i-e)+n},r.mix=function(t,e,i){return t*(1-i)+e*i};
//!class Perf
const V=function(t,e=null){this.data=[],this.accumSize=t,this.expectedValue=e,this.lastFeed=0,this.lastUpdate=0,this.stdSum=0,this.stdCount=0};var q=V;V.prototype.begin=function(){this.startTime=performance.now()},V.prototype.end=function(){this.feed(performance.now()-this.startTime)},V.prototype.feed=function(t){this.data.push(t),this.lastFeed++,this.data.length==this.accumSize&&(this.report(),this.data=[])},V.prototype.update=function(){let t=null,e=null,i=0,n=0;for(let n=0;n<this.data.length;n++)t=null===t?this.data[n]:Math.min(t,this.data[n]),e=null===e?this.data[n]:Math.max(e,this.data[n]),i+=this.data[n];i/=this.data.length;let s=null!==this.expectedValue?this.expectedValue:i;for(let t=0;t<this.data.length;t++)n+=Math.pow(this.data[t]-s,2);return n=Math.sqrt(n/this.data.length),this.stdSum+=n,this.stdCount++,this.min=t,this.max=e,this.avg=i,this.std=n,this.lastUpdate=this.lastFeed,this},V.prototype.report=function(t=255){let e="";return this.lastUpdate!=this.lastFeed&&this.update(),t&V.Flags.SAMPLES&&(e+="n: "+this.stdCount),t&V.Flags.MIN&&(e+=(""!=e?", ":"")+"min: "+this.min),t&V.Flags.MAX&&(e+=(""!=e?", ":"")+"max: "+this.max),t&V.Flags.AVG&&(e+=(""!=e?", ":"")+"avg: "+this.avg.toFixed(2)),t&V.Flags.EXPECTED&&(e+=(""!=e?", ":"")+(void 0!==this.expectedValue?"e: "+this.expectedValue:"")),t&V.Flags.STDDEV&&(e+=(""!=e?", ":"")+"stddev: "+this.std.toFixed(2)),t&V.Flags.AVG_STDDEV&&(e+=(""!=e?", ":"")+"avg_stddev: "+(this.stdSum/this.stdCount).toFixed(2)),e},
//!/class
//!namespace Perf
//!enum Flags
V.Flags={SAMPLES:1,
//!SAMPLES
MIN:2,
//!MIN
MAX:4,
//!MAX
AVG:8,
//!AVG
EXPECTED:16,
//!EXPECTED
STDDEV:32,
//!STDDEV
AVG_STDDEV:64,
//!AVG_STDDEV
ALL:255};//!/enum
//![import "./globals"]
//![import "./system"]
const z=t.extend({framebufferId:null,attachments:null,attachmentTypes:null,width:0,height:0,drawBuffers:null,drawBufferIds:null,__ctor:function(t=null,e=null){null!==Y.gl&&(null===K[0]&&j(Y.gl),this.framebufferId=Y.gl.createFramebuffer(),this.drawBuffers=[],this.drawBufferIds=[],this.width=t||H.renderer.width,this.height=e||H.renderer.height,this.attachments=new Array(z.MAX_ATTACHMENT_POINTS).fill(null),this.attachmentTypes=new Array(z.MAX_ATTACHMENT_POINTS).fill(null))},__dtor:function(){let t=Y.gl;if(null!==t){for(let e=0;e<this.attachments.length;e++)null!==this.attachments[e]&&(this.attachmentTypes[e]===z.TEXTURE?t.deleteTexture(this.attachments[e]):t.deleteRenderbuffer(this.attachments[e]));t.deleteFramebuffer(this.frameBufferId)}},attach:function(t,e,i=null){let n=Y.gl;if(null===n)return;null===i&&(i=t<z.DEPTH?z.TEXTURE:z.RENDERBUFFER),this.attachments[t]=e,this.attachmentTypes[t]=i,t<z.DEPTH&&-1===this.drawBuffers.indexOf(t)&&(this.drawBuffers.push(t),this.drawBufferIds.push(K[t]));let s=n.getParameter(n.FRAMEBUFFER_BINDING);switch(n.bindFramebuffer(n.FRAMEBUFFER,this.framebufferId),i){case z.TEXTURE:n.framebufferTexture2D(n.FRAMEBUFFER,K[t],n.TEXTURE_2D,e,0);break;case z.RENDERBUFFER:n.framebufferRenderbuffer(n.FRAMEBUFFER,K[t],n.RENDERBUFFER,e)}n.bindFramebuffer(n.FRAMEBUFFER,s)},createColorBuffer:function(t,e=null,i=null){let n=Y.gl;if(null===n)return null;null===e&&(e=this.width),null===i&&(i=this.height);let s=n.createTexture();return n.bindTexture(n.TEXTURE_2D,s),n.texStorage2D(n.TEXTURE_2D,1,n.RGBA8,e,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),this.attach(t,s),s},createDepthBuffer:function(t=null,e=null){let i=Y.gl;if(null===i)return null;null===t&&(t=this.width),null===e&&(e=this.height);let n=i.createRenderbuffer();return i.bindRenderbuffer(i.RENDERBUFFER,n),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT24,t,e),this.attach(z.DEPTH,n),n},createStencilBuffer:function(t=null,e=null){let i=Y.gl;if(null===i)return null;null===t&&(t=this.width),null===e&&(e=this.height);let n=i.createTexture();return i.bindTexture(i.TEXTURE_2D,n),i.texStorage2D(i.TEXTURE_2D,1,i.DEPTH_STENCIL,t,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),this.attach(z.DEPTH_STENCIL,n),n},getTexture:function(t){return this.attachmentTypes[t]!==z.TEXTURE?null:this.attachments[t]},getRenderBuffer:function(t){return this.attachmentTypes[t]!==z.RENDERBUFFER?null:this.attachments[t]},bind:function(){let t=Y.gl;null!==t&&(t.bindFramebuffer(t.FRAMEBUFFER,this.framebufferId),t.drawBuffers(this.drawBufferIds),t.viewport(0,0,this.width,this.height))},unbind:function(){let t=Y.gl;null!==t&&(t.bindFramebuffer(t.FRAMEBUFFER,null),t.drawBuffers(Q),t.viewport(0,0,H.renderer.width,H.renderer.height))},isComplete:function(){let t=Y.gl;if(null===t)return!0;let e=t.getParameter(t.FRAMEBUFFER_BINDING);t.bindFramebuffer(t.FRAMEBUFFER,this.framebufferId);let i=t.checkFramebufferStatus(t.FRAMEBUFFER);return t.bindFramebuffer(t.FRAMEBUFFER,e),i===t.FRAMEBUFFER_COMPLETE}});z.TEXTURE=1,z.RENDERBUFFER=2,z.COLOR0=0,z.COLOR1=1,z.COLOR2=2,z.COLOR3=3,z.COLOR4=4,z.COLOR5=5,z.COLOR6=6,z.COLOR7=7,z.DEPTH=8,z.STENCIL=9,z.DEPTH_STENCIL=10,z.MAX_ATTACHMENT_POINTS=11;const K=new Array(z.MAX_ATTACHMENT_POINTS).fill(null),Q=new Array(1).fill(null),j=function(t){Q[0]=t.BACK,K[z.COLOR0]=t.COLOR_ATTACHMENT0,K[z.COLOR1]=t.COLOR_ATTACHMENT1,K[z.COLOR2]=t.COLOR_ATTACHMENT2,K[z.COLOR3]=t.COLOR_ATTACHMENT3,K[z.COLOR4]=t.COLOR_ATTACHMENT4,K[z.COLOR5]=t.COLOR_ATTACHMENT5,K[z.COLOR6]=t.COLOR_ATTACHMENT6,K[z.COLOR7]=t.COLOR_ATTACHMENT7,K[z.DEPTH]=t.DEPTH_ATTACHMENT,K[z.STENCIL]=t.STENCIL_ATTACHMENT,K[z.DEPTH_STENCIL]=t.DEPTH_STENCIL_ATTACHMENT};var Z=z,$={};l($,"Drawable",(()=>Et)),l($,"Custom",(()=>wt)),l($,"Spritesheet",(()=>Tt)),l($,"SpritesheetAnimation",(()=>Rt)),l($,"SpriteFont",(()=>It)),l($,"Sound",(()=>Pt)),l($,"SoundArray",(()=>At));
//!class Drawable
const J=t.extend({className:"Drawable",resource:null,width:0,height:0,sx:0,sy:0,swidth:0,sheight:0,__ctor:function(t=null,e=null,i=null){if(s.isInstanceOf(t,J)){let n=t;this.resource=n.resource,this.width=e??n.width,this.height=i??n.height,this.sx=n.sx,this.sy=n.sy,this.swidth=n.swidth,this.sheight=n.sheight}else this.resource=t,this.sx=0,this.sy=0,this.resource?(this.width=e??t.targetWidth,this.height=i??t.targetHeight,this.swidth=t.width,this.sheight=t.height):(this.width=e,this.height=i,this.swidth=e,this.sheight=i)},getDrawable:function(){return this},getImage:function(){return this.resource},getTexture:function(){return this.resource},resize:function(t,e){return t=null!==t?!0===t||t:this.width,e=null!==e?!0===e||e:this.height,!0===t?t=e*(this.width/this.height):!0===e&&(e=t*(this.height/this.width)),this.width=t,this.height=e,this},draw:function(t,e,i,n=null,s=null){n=n??this.width,s=s??this.height,this.drawf(t,this.sx,this.sy,this.swidth,this.sheight,e,i,n,s)},drawf:function(t,e,i,n,s,r,l,a,o,h=null,u=null){t.drawImage(this.resource,e,i,n,s,r,l,a,o,null,null,h??a,u??o)},render:function(t,e){this.draw(t,e.bounds.x1,e.bounds.y1,e.bounds.width(),e.bounds.height())}}),tt=J.extend({className:"DrawableNineSlice",ss:null,startingIndex:0,__ctor:function(e,i){if(this._super.Drawable.__ctor(e),null===e||!t.instanceOf(e,"Spritesheet"))throw new Error("NineSlice: spritesheet required");this.ss=e,this.startingIndex=i},__dtor:function(){dispose(this.ss)},getTexture:function(){return this.ss.getTexture()},draw:function(t,e,i,n,s){const r=this.startingIndex;let l=this.ss.getFrame(r+0).width,a=this.ss.getFrame(r+2).width,o=this.ss.getFrame(r+1).width,h=this.ss.getFrame(r+0).height,u=this.ss.getFrame(r+6).height,c=this.ss.getFrame(r+3).height,d=int((n-l-a)/o),f=int((s-h-u)/c),p=e,g=i;this.ss.getFrame(r+0).draw(t,p,g),this.ss.getFrame(r+2).draw(t,p+l+d*o,g),this.ss.getFrame(r+6).draw(t,p,g+h+f*c),this.ss.getFrame(r+8).draw(t,p+l+d*o,g+h+f*c);for(let e=0;e<d;e++)this.ss.getFrame(r+1).draw(t,p+l+e*o,g),this.ss.getFrame(r+7).draw(t,p+l+e*o,g+h+f*c);for(let e=0;e<f;e++)this.ss.getFrame(r+3).draw(t,p,g+h+e*c),this.ss.getFrame(r+5).draw(t,p+l+d*o,g+h+e*c);for(let e=0;e<f;e++)for(let i=0;i<d;i++)this.ss.getFrame(r+4).draw(t,p+l+i*o,g+h+e*c)}});Recycler.createPool(tt,512);const et=J.extend({className:"DrawableRepeated",drawable:null,__ctor:function(t){this._super.Drawable.__ctor(t),this.drawable=t},__dtor:function(){dispose(this.drawable)},drawf:function(t,e,i,n,s,r,l,a,o,h=null,u=null){this.drawable.drawf(t,e,i,n,s,r,l,a,o,this.width,this.height)}});Recycler.createPool(et,512);const it=J.extend({className:"DrawableClipped",drawable:null,__ctor:function(t){this._super.Drawable.__ctor(t),this.drawable=t},__dtor:function(){dispose(this.drawable)},draw:function(t,e,i,n=null,s=null){let r=this.getTexture();n=n??this.width,s=s??this.height,this.drawable.drawf(t,this.drawable.sx,this.drawable.sy,n*r.rscale,s*r.rscale,e,i,n,s)}});Recycler.createPool(it,512);const nt=J.extend({className:"DrawableCentered",drawable:null,offsX:0,offsY:0,__ctor:function(t,e,i){this._super.Drawable.__ctor(t),this.drawable=t,this.offsX=e,this.offsY=i},__dtor:function(){dispose(this.drawable)},draw:function(t,e,i,n=null,s=null){n=n??this.width,s=s??this.height,this.drawable.draw(t,e+this.offsX+.5*(n-this.width),i+this.offsY+.5*(s-this.height),this.width,this.height)}});Recycler.createPool(nt,512);const st=J.extend({className:"DrawableStatic",drawable:null,offsX:0,offsY:0,__ctor:function(t,e,i){this._super.Drawable.__ctor(t),this.drawable=t,this.offsX=e,this.offsY=i},__dtor:function(){dispose(this.drawable)},draw:function(t,e,i,n=null,s=null){this.drawable.draw(t,e+this.offsX,i+this.offsY,n,s)}});Recycler.createPool(st,512);const rt=J.extend({className:"DrawableGroup",list:null,__ctor:function(t){this._super.Drawable.__ctor(),this.list=t,this.width=0,this.height=0;for(let t=0;t<this.list.length;t++)this.list[t].width>this.width&&(this.width=this.list[t].width),this.list[t].height>this.height&&(this.height=this.list[t].height);this.swidth=this.width,this.sheight=this.height},__dtor:function(){if(null!==this.list){for(let t=0;t<this.list.length;t++)dispose(this.list[t]);this.list=null}},draw:function(t,e,i,n=null,s=null){for(let r=0;r<this.list.length;r++)this.list[r].draw(t,e,i,n,s)},render:function(t,e){for(let i=0;i<this.list.length;i++)this.list[i].render(t,e)}});Recycler.createPool(rt,512);const lt=J.extend({className:"DrawableMirrorX",drawable:null,__ctor:function(t){this._super.Drawable.__ctor(t),this.drawable=t},__dtor:function(){dispose(this.drawable)},drawf:function(t,e,i,n,s,r,l,a,o,h=null,u=null){t.pushMatrix(),t.translate(r+a,l),t.scale(-1,1),this.drawable.drawf(t,e,i,n,s,0,0,a,o,h,u),t.popMatrix()}});Recycler.createPool(lt,512);const at=J.extend({className:"DrawableMirrorY",drawable:null,__ctor:function(t){this._super.Drawable.__ctor(t),this.drawable=t},__dtor:function(){dispose(this.drawable)},drawf:function(t,e,i,n,s,r,l,a,o,h=null,u=null){t.pushMatrix(),t.translate(r,l+o),t.scale(1,-1),this.drawable.drawf(t,e,i,n,s,0,0,a,o,h,u),t.popMatrix()}});Recycler.createPool(at,512),J.nineSlice=function(t,e=0){return tt.Pool.alloc(t,e)},J.prototype.nineSlice=function(t=0){return tt.Pool.alloc(this,t)},J.repeated=function(t){return et.Pool.alloc(t)},J.prototype.repeated=function(){return et.Pool.alloc(this)},J.clipped=function(t){return it.Pool.alloc(t)},J.prototype.clipped=function(){return it.Pool.alloc(this)},J.centered=function(t,e,i){return nt.Pool.alloc(t,e,i)},J.prototype.centered=function(t,e){return nt.Pool.alloc(this,t,e)},J.static=function(t,e,i){return st.Pool.alloc(t,e,i)},J.prototype.static=function(t,e){return st.Pool.alloc(this,t,e)},J.group=function(...t){return rt.Pool.alloc(t)},J.mirrorX=function(t){return lt.Pool.alloc(t)},J.prototype.mirrorX=function(){return lt.Pool.alloc(this)},J.mirrorY=function(t){return at.Pool.alloc(t)},J.prototype.mirrorY=function(){return at.Pool.alloc(this)},
//!/class
//!namespace Drawable
//!namespace Pool
Recycler.createPool(J,512);var ot=J,ht=ot.extend({className:"DrawableResource",r:null,__ctor:function(t){if("image"!==t.type)throw new Error("Resource is not an image.");this._super.Drawable.__ctor(t.data,t.width,t.height),this.r=t,this.r.wrapper=this}}),//![import "../system/canvas"]
ut=ot.extend({className:"DrawableCustom",__ctor:function(t){if("object"!=t.type)throw new Error("Resource is not an object.");this._super.Drawable.__ctor(null,t.width,t.height),this.r=t,this.r.wrapper=this},init:function(t){U.renderImage(this.r.width,this.r.height,(t=>{null!==this.r.draw&&"function"==typeof this.r.draw?this.r.draw(t,this.r):(t.fillStyle(this.r.color),t.fillRect(0,0,this.r.width,this.r.height))}),(e=>{this.resource=e,this.swidth=this.resource.width,this.sheight=this.resource.height,t()}))}});const ct=ot.extend({spritesheet:null,frameIndex:0,__ctor:function(t,e,i,n,s,r,l,a=null,o=null){this._super.Drawable.__ctor(null,a??t.width,o??t.height),this.spritesheet=t,this.frameIndex=e,this.sx=n,this.sy=s,this.swidth=r,this.sheight=l,this.resource=i}});var dt=ot.extend({className:"Spritesheet",frameCache:null,numFrames:0,frameWidth:0,frameHeight:0,__ctor:function(t){if(this._super.Drawable.__ctor(),"image"!=t.type&&"images"!=t.type)throw new Error("Resource is not a sprite sheet.");let e,i,n,s;if("image"==t.type){if(!(t.config.sheetWidth||t.config.numFrames&&t.config.frameWidth||t.config.coords))throw new Error(t.resName+": required `sheetWidth` or `numFrames` with `frameWidth` or `coords` array.");t.config.sheetWidth||(t.config.sheetWidth=t.width),t.config.frameHeight||(t.config.frameHeight=t.data.height),e=t.data.width/t.config.sheetWidth,i=t.width/t.config.sheetWidth}else t.config||(t.config={}),t.config.frameWidth||(t.config.frameWidth=t.data[0].width),t.config.frameHeight||(t.config.frameHeight=t.data[0].height),e=t.data[0].data.width/t.config.frameWidth,i=t.data[0].width/t.config.frameWidth;this.frameWidth=t.config.frameWidth*e,this.frameHeight=t.config.frameHeight*e,this.width=t.config.frameWidth*i,this.height=t.config.frameHeight*i,"image"==t.type?(n=int(t.data.width/this.frameWidth),s=Math.ceil(t.data.height/this.frameHeight),t.config.coords?this.numFrames=t.config.coords.length:this.numFrames=t.config.numFrames||n*s):(n=s=0,this.numFrames=t.data.length),this.r=t,this.r.wrapper=this,this.frameCache={};for(let t=0;t<this.numFrames;t++){let s;s=this.r.config.coords?new ct(this,t,this.r.data,this.r.config.coords[t][0]*e,this.r.config.coords[t][1]*e,this.r.config.coords[t][2]*e,this.r.config.coords[t][3]*e,this.r.config.coords[t][2]*i,this.r.config.coords[t][3]*i):0!=this.numCols?new ct(this,t,this.r.data,t%n*this.frameWidth,int(t/n)*this.frameHeight,this.frameWidth,this.frameHeight):new ct(this,t,this.r.data[t].data,0,0,this.frameWidth,this.frameHeight),this.frameCache[t]=s}},getFrame:function(t){if(t<0||t>=this.numFrames)throw new Error("frameIndex out of range");return this.frameCache[t]},getTexture:function(){return this.getFrame(0).getTexture()},getDrawable:function(){return this.getFrame(0)}});const ft=ot.extend({className:"Animation",seq:null,seq_i:0,n_seq:null,queue:null,fps:0,frameDuration:0,time:0,frameNumber:-1,finished:!1,_paused:!1,finishedCallback:null,finishedCallbackHandler:null,finishedCallbackContext:null,frameCallback:null,__ctor:function(t,e,i){this._super.Drawable.__ctor(t.getTexture(),t.width,t.height),this.anim=t,this.queue=_.Pool.alloc(),this.seq=e,this.seq_i=0,this.n_seq=null,this.frameNumber=-1,this.finished=!1,this._paused=!1,this.finishedCallback=null,this.finishedCallbackHandler=null,this.finishedCallbackContext=null,this.frameCallback=null,this.fps=i,this.setFps(this.seq.fps||this.fps)},__dtor:function(){this.queue.free(),this.finishedCallbackHandler&&this.finishedCallbackHandler.free(),this.finishedCallbackContext&&this.finishedCallbackContext.free()},setFps:function(t){return this.frameDuration=1/t,this.time=0,this},paused:function(t=null){return null===t?this._paused:(this._paused=t,this)},initialDelay:function(t){return this.time=-t,this},onFinished:function(t){return this.finishedCallback=t,this},then:function(t,e=null){return!1===t&&this.finishedCallback===this.thenCallback&&(this.finishedCallbackHandler.clear(),this.finishedCallbackContext.clear()),t?(this.finishedCallback!==this.thenCallback&&(this.finishedCallback=this.thenCallback,this.finishedCallbackHandler=_.Pool.alloc(),this.finishedCallbackContext=_.Pool.alloc()),this.finishedCallbackHandler.push(t),this.finishedCallbackContext.push(e),this):this},thenCallback:function(){if(!this.finishedCallbackHandler.length)return!1;let t=this.finishedCallbackContext.shift();this.finishedCallbackHandler.shift()(this,t)},onFrame:function(t){return this.frameCallback=t,this},setFrame:function(t){return this.seq_i=int(t)%this.seq.group.length,this},getFrame:function(t){return!0===t?this.seq_i/(this.seq.group.length-1):this.seq_i},getLength:function(){return this.seq.group.length},draw:function(t,e=0,i=0,n=null,s=null){if(this._paused||(this.time+=this.frameNumber===H.frameNumber?0:H.frameDelta),this.time<0)return void(this.frameNumber=H.frameNumber);if(null!==this.n_seq&&this.frameNumber!==H.frameNumber&&(this.seq=this.n_seq,this.seq_i=0,this.n_seq=null,this.time=0,this.finished=!1,this.setFps(this.seq.fps||this.fps)),this.time>=this.frameDuration&&this.frameNumber!==H.frameNumber&&!this.finished){const t=this.seq_i;this.time-=this.frameDuration,this.seq_i++,this.seq_i===this.seq.group.length&&(this.seq.loop?this.seq_i=0:(this.finished=!0,this.finishedCallback&&!1===this.finishedCallback(this)&&(this.finishedCallback=null)),this.queue.length&&this.use(this.queue.shift(),!0)),this.frameCallback&&!1===this.frameCallback(t,this.seq.group.length-1,this)&&(this.frameCallback=null)}let r=this.seq.group[this.seq_i===this.seq.group.length?this.seq_i-1:this.seq_i];for(let l=0;l<r.length;l++)this.anim.getFrame(r[l]).draw(t,e,i,n,s);this.frameNumber=H.frameNumber},getTexture:function(){return this.anim.getTexture()},getDrawable:function(){return this},advance:function(){this.paused(!1),this.draw(null,0,0)},getSequenceName:function(){return null===this.n_seq?this.seq.name:this.n_seq.name},use:function(t,e=!1){return!(this.seq.name===t&&!this.finished&&!0!==e)&&(this.n_seq=this.anim.a.seq[t],this.finished=!1,!0)},play:function(t,e=!1){return this.use(t,e),this},setQueue:function(t){if(!_.isInstance(t))throw new Error("setQueue: Parameter must be an instance of List");null!=this.queue&&this.queue.clear().free(),this.queue=t,this.use(this.queue.shift(),!0)},enqueue:function(t,e=!1){let i=this.seq,n=this.queue.length>0?this.queue[this.queue.length-1]:i.name;return i.name===t&&i.loop?this:n!==t||e?i.loop||this.finished?(this.use(t,!0),this):(this.queue.push(t),this):this}});p.createPool(ft);var pt=dt.extend({className:"SpritesheetAnimation",defaultDrawable:null,sharedAnim:null,r:null,a:null,__ctor:function(t){if(!t.anim)throw new Error("Animation descriptors not found.");this._super.Spritesheet.__ctor(t),this.r=t,this.r.wrapper=this;let e=this.a=this.r.anim;if(e.initialized)return;if(e.def||(e.def="def"),e.seq||(e.seq={}),!e.seq[e.def]&&("def"==e.def||"defloop"==e.def)){let t={loop:"def"!=e.def,group:[]};for(let e=0;e<this.numFrames;e++)t.group.push([e]);e.seq[e.def]=t}if(!e.seq[e.def])throw new Error("Undefined default sequence: "+e.def);e.fps||(e.fps=25),e.def=e.seq[e.def];let i=0;for(let t in e.seq)if(e.seq[t].name=t,e.seq[t].loop||(e.seq[t].loop=!1),"string"==typeof e.seq[t].group){let n,s,r;if(-1!=e.seq[t].group.indexOf(" ")){n=e.seq[t].group.split(" "),e.seq[t].group=[];for(let i in n)e.seq[t].group.push([int(n[i])])}else if(-1!=e.seq[t].group.indexOf("-"))if(r=e.seq[t].group.split("-"),n=int(r[0]),s=int(r[1]),e.seq[t].group=[],n<s)for(r=n;r<=s;r++)e.seq[t].group.push([r]);else for(r=n;r>=s;r--)e.seq[t].group.push([r]);else for(n=int(e.seq[t].group),e.seq[t].group=[];n--;)e.seq[t].group.push([i++]);e.seq[t].count=e.seq[t].group.length}e.initialized=!0},getSharedAnimation:function(t=null){return null===this.sharedAnim?(this.sharedAnim=ft.Pool.alloc(this,t?this.a.seq[t]:this.a.def,this.a.fps),this.sharedAnim.lockInstance(!0),this.sharedAnim):this.sharedAnim.play(t||this.a.def.name)},getAnimation:function(t=null,e=null){return ft.Pool.alloc(this,t?this.a.seq[t]:this.a.def,e||this.a.fps)},getSequence:function(t){return this.a.seq[t]},getDrawable:function(){return null===this.defaultDrawable&&(this.defaultDrawable=this.getAnimation()),this.defaultDrawable}}),//![import "../system/canvas"]
gt=t.extend({__ctor:function(t){if("image"!=t.type||!t.font)throw new Error("Resource is not a sprite font.");t.font.sheetWidth||(t.font.sheetWidth=t.width);let e=t.data.width/t.font.sheetWidth,i=t.width/t.font.sheetWidth;this.r_charWidth=t.font.charWidth*e,this.r_charHeight=t.font.charHeight*e,this.charWidth=t.font.charWidth*i,this.charHeight=t.font.charHeight*i,this.paddingX=(t.font.paddingX||0)*i,this.paddingY=(t.font.paddingY||0)*i,this.spacingX=(t.font.spacingX||0)*i,this.spacingY=(t.font.spacingY||0)*i,this.reverseDraw=t.font.reverseDraw||!1;let n=int(t.font.sheetWidth/t.font.charWidth);this.r=t,this.r.wrapper=this;let s=t.font.charset.length,r=0,l=0;for(this.charTable={};r<s;){let e=0;for(let i=0;i<n&&r<s;i++){let i=t.font.charset[r++];this.charTable[i]={hidden:!1,x:e,y:l,charWidth:this.charWidth,r_charWidth:this.r_charWidth,spacingX:0},e+=this.r_charWidth}l+=this.r_charHeight}if(" "in this.charTable||(this.charTable[" "]={hidden:!0,charWidth:int(2*(this.charWidth+this.paddingX)/3),r_charWidth:this.r_charWidth,spacingX:0}),t.font.widths){s=t.font.widths.length;for(let e=0;e<s;e+=2){let n=t.font.widths[e+1]*i,s=t.font.widths[e];"number"==typeof s&&(s=String.fromCharCode(s));for(let t=0;t<s.length;t++)s[t]in this.charTable&&(this.charTable[s[t]].spacingX=n-this.charTable[s[t]].charWidth)}}},drawText:function(t,e,i,n){let s=n.length,r=-2*this.paddingX+this.spacingX;if(e-=this.paddingX,i-=this.paddingY,this.reverseDraw){for(let t=0;t<s-1;t++){let i=this.charTable[n[t]];i&&(e+=i.charWidth+r)}for(let l=s-1;l>=0;l--){let s=this.charTable[n[l]];s&&(s.hidden||t.drawImage(this.r.data,s.x,s.y,s.r_charWidth,this.r_charHeight,e,i,s.charWidth,this.charHeight,null,null,s.charWidth,this.charHeight),e-=s.charWidth+r+s.spacingX)}}else for(let l=0;l<s;l++){let s=this.charTable[n[l]];s&&(s.hidden||t.drawImage(this.r.data,s.x,s.y,s.r_charWidth,this.r_charHeight,e,i,s.charWidth,this.charHeight,null,null,s.charWidth,this.charHeight),e+=s.charWidth+r+s.spacingX)}},measureWidth:function(t){let e=t.length,i=0,n=-2*this.paddingX+this.spacingX;for(let s=0;s<e;s++){let e=this.charTable[t[s]];e&&(i+=e.charWidth+n+e.spacingX)}return i},measureHeight:function(t){return this.charHeight-2*this.paddingY+this.spacingY}});U.prototype.drawText=function(t,e,i,n){t.drawText(this,e,i,n)},U.prototype.drawTextAligned=function(t,e,i,n,s,r,l,a){0==r?e+=n-t.measureWidth(a)>>1:r<0?e=e-r-1:r>0&&(e=e+n-r+1-t.measureWidth(a)),0==l?i+=s-t.measureHeight(a)>>1:l<0?i=i-l-1:l>0&&(i=i+s-l+1-t.measureHeight(a)),t.drawText(this,e,i,a)},U.prototype.drawTextAligned2=function(t,e,i,n,s){this.drawTextAligned(t,e.x1,e.y1,e.width(),e.height(),i,n,s)};const mt={};let yt=!1;
//!namespace Resources
//!type ConfigOptions =
//!/type
//!/namespace
//!class Resources
Object.assign(mt,{integerScalingEnabled:!0,pixelated:!1,filter:"LINEAR",original:!1,config:function(t){null!==t&&Object.assign(this,t)},load:function(t,e,i,n,l){if(!n){n=Object.keys(t);for(let e in n)"__loaded"in t[n[e]]||(t[n[e]].__clone=s.clone(t[n[e]]));l=0}for(;l<n.length&&"__loaded"in t[n[l]];)l++;if(e&&e(l,n.length,l/n.length,l<n.length?n[l]:null),l==n.length)return void(i&&i(t));let a,o,h,u,c,d=t[n[l]];switch(d.resName=n[l],d.type){case"image":d.data=new Image,d.data.onload=async function(){const s=d.data.width/d.data.height;d.scale&&(d.width=int(d.data.width*d.scale),d.height=int(d.data.height*d.scale)),d.hasOwnProperty("extraScale")||(d.extraScale=0),d.width||d.height?d.width&&!d.height?d.height=int(d.width/s):!d.width&&d.height&&(d.width=int(s*d.height)):(d.width=d.data.width,d.height=d.data.height),d.hasOwnProperty("filter")||(d.filter=d.hasOwnProperty("pixelated")&&!0===d.pixelated?"NEAREST":mt.filter),d.hasOwnProperty("pixelated")||(d.pixelated=mt.pixelated),d.hasOwnProperty("original")||(d.original=mt.original),d.data.width==d.width&&d.data.height==d.height&&0==d.extraScale||!0===d.original||(d.data=await mt.resizeImage(d,d.width*(d.extraScale+(d.pixelated?H.integerScaleFactor:H.scaleFactor)),d.height*(d.extraScale+(d.pixelated?H.integerScaleFactor:H.scaleFactor)),d.pixelated,!0)),d.rscale=d.data.width/d.width,d.data.rscale=d.rscale,d.data.filter=d.filter,d.data.targetWidth=d.width,d.data.targetHeight=d.height,d.hasOwnProperty("mipmap")&&d.mipmap>0&&(d.data.mipmap=d.mipmap),H.tempDisplayBuffer.drawImage(d.data,0,0),H.renderer.prepareImage(d.data),mt.onLoaded(t,n[l],(()=>{mt.load(t,e,i,n,l+1)}))},d.data.onerror=function(){console.error("Error: Unable to load: "+d.resName)},d.data.src=d.src+"?r="+Math.random();break;case"images":if(a=d.src,o=a.indexOf("#"),h=a.lastIndexOf("#"),u=h-o+1,-1==o)return void console.error("Unable to load: "+d.resName+"\nError: The 'src' attribute requires one or more '#' marks.");if(!d.count)return void console.error("Unable to load: "+d.resName+"\nError: The 'count' attribute was not found.");d._i=0,d.data=[],c=function(){if(d._i==d.count)return void mt.onLoaded(t,n[l],(()=>{mt.load(t,e,i,n,l+1)}));let s={type:"image",width:d.width,height:d.height,scale:d.scale};s.src=d.src.substr(0,o)+(d._i++/Math.pow(10,u)).toFixed(u).substr(2)+d.src.substr(h+1),s.data=new Image,s.resName=d.resName+"#"+(d._i-1),e&&e(l,n.length,l/n.length+(d._i-1)/d.count*(1/n.length),d.resName+"/"+(d._i-1)),s.data.onload=async function(){let t=s.data.width/s.data.height;s.scale&&(s.width=int(s.data.width*s.scale),s.height=int(s.data.height*s.scale)),s.width||s.height?s.width&&!s.height?s.height=int(s.width/t):!s.width&&s.height&&(s.width=int(t*s.height)):(s.width=s.data.width,s.height=s.data.height),1==d._i&&(d.owidth=s.data.width,d.oheight=s.data.height,d.hasOwnProperty("filter")||(d.filter=d.hasOwnProperty("pixelated")&&!0===d.pixelated?"NEAREST":mt.filter),d.hasOwnProperty("pixelated")||(d.pixelated=mt.pixelated),d.hasOwnProperty("original")||(d.original=mt.original)),s.pixelated=d.pixelated,s.filter=d.filter,s.original=d.original,s.data.width==s.width&&s.data.height==s.height||!0===s.original||(s.data=await mt.resizeImage(s,s.width*(d.pixelated?H.integerScaleFactor:H.scaleFactor),s.height*(s.pixelated?H.integerScaleFactor:H.scaleFactor),s.pixelated,!0)),s.rscale=s.data.width/s.width,s.data.rscale=s.rscale,s.data.filter=s.filter,s.data.targetWidth=s.width,s.data.targetHeight=s.height,d.hasOwnProperty("mipmap")&&d.mipmap>0&&(s.data.mipmap=d.mipmap),1==d._i&&(d.width=s.width,d.height=s.height,d.rscale=s.rscale),H.tempDisplayBuffer.drawImage(s.data,0,0),H.renderer.prepareImage(s.data),d.data.push(s),c()},s.data.onerror=function(){console.error("Error: Unable to load: "+s.resName)},s.data.src=s.src+"?r="+Math.random()},c();break;case"audio":if(d.track||(d.track="sfx"),r.plugins&&r.plugins.NativeAudio&&"sfx"==d.track){yt||(W.write("ENGINE_NATIVEAUDIO"),yt=!0),d.engine=$.Sound.ENGINE_NATIVEAUDIO,d.data="snd_"+l,r.plugins.NativeAudio.preloadSimple(d.data,d.src,(function(){mt.onLoaded(t,n[l],(()=>{mt.load(t,e,i,n,l+1)}))}),(function(t){console.error("Error: Unable to load (sfx): "+d.resName+"\n"+t)}));break}if(r.audioContext){yt||(W.write("ENGINE_WEBAUDIO"),yt=!0),d.engine=$.Sound.ENGINE_WEBAUDIO,fetchAudioBuffer(d.src+"?r="+Math.random()).then((s=>{d.data=s,mt.onLoaded(t,n[l],(()=>{mt.load(t,e,i,n,l+1)}))})).catch((t=>{console.error("Error: Unable to load: "+d.resName+"\n"+t)}));break}yt||(W.write("ENGINE_HTML5"),yt=!0),d.data=new Audio,d.engine=$.Sound.ENGINE_HTML5,d.data.oncanplaythrough=function(){mt.onLoaded(t,n[l],(()=>{mt.load(t,e,i,n,l+1)}))},d.data.onerror=function(){console.error("Error: Unable to load: "+d.resName)},d.data.src=d.src+"?r="+Math.random();break;case"audios":if(a=d.src,o=a.indexOf("#"),h=a.lastIndexOf("#"),u=h-o+1,-1==o)return void console.error("Unable to load: "+d.resName+"\nError: The 'src' attribute requires one or more '#' marks.");if(!d.count)return void console.error("Unable to load: "+d.resName+"\nError: The 'count' attribute was not found.");d._i=0,d.data=[],c=function(){if(d._i==d.count)return void mt.onLoaded(t,n[l],(()=>{mt.load(t,e,i,n,l+1)}));let s={type:"audio",track:d.track};return s.src=d.src.substr(0,o)+(d._i++/Math.pow(10,u)).toFixed(u).substr(2)+d.src.substr(h+1),s.resName=d.resName+"#"+(d._i-1),s.track||(s.track="sfx"),r.plugins&&r.plugins.NativeAudio&&"sfx"==s.track?(s.engine=$.Sound.ENGINE_NATIVEAUDIO,s.data="snd_"+l+"_"+d._i,void r.plugins.NativeAudio.preloadSimple(s.data,s.src,(function(){d.data.push(s),c()}),(function(t){console.error("Error: Unable to load (sfx): "+s.resName+"\n"+t)}))):r.audioContext?(s.engine=$.Sound.ENGINE_WEBAUDIO,void fetchAudioBuffer(s.src+"?r="+Math.random()).then((t=>{s.data=t,d.data.push(s),c()})).catch((t=>{console.error("Error: Unable to load: "+s.resName+"\n"+t)}))):(s.data=new Audio,s.engine=$.Sound.ENGINE_HTML5,s.data.oncanplaythrough=function(){d.data.push(s),c()},s.data.onerror=function(){console.error("Error: Unable to load: "+s.resName)},void(s.data.src=s.src+"?r="+Math.random()))},c();break;case"json":fetchd(d.src+"?r="+Math.random(),{responseType:"json"}).then((function(s){d.data=s,mt.onLoaded(t,n[l],(()=>{mt.load(t,e,i,n,l+1)}))})).catch((function(t){console.error("Error: Unable to load: "+d.resName+"\n"+t)}));break;case"data":fetchd(d.src+"?r="+Math.random()).then((function(s){d.data=s,mt.onLoaded(t,n[l],(()=>{mt.load(t,e,i,n,l+1)}))})).catch((function(t){console.error("Error: Unable to load: "+d.resName+"\n"+t)}));break;case"text":fetchd(d.src+"?r="+Math.random()).then((function(s){d.data=String.fromCharCode.apply(null,new Uint8Array(s)),mt.onLoaded(t,n[l],(()=>{mt.load(t,e,i,n,l+1)}))})).catch((function(t){console.error("Error: Unable to load: "+d.resName+"\n"+t)}));break;case"object":d.data={},mt.onLoaded(t,n[l],(()=>{mt.load(t,e,i,n,l+1)}))}},unload:function(t){throw new Error("IMPLEMENTED UNLOAD!")},onLoaded:function(t,e,i){let n=t[e];n.wrapper&&n.wrapper in $?(t[e]=new $[n.wrapper](n),"init"in t[e]?t[e].init((()=>{t[e].__loaded=!0,i()})):(t[e].__loaded=!0,i())):i()},loadImage:function(t){return new Promise(((e,i)=>{const n=new Image;n.onload=()=>e(n),n.onerror=()=>i(new Error("Unable to load image")),n.src=t}))},resizeImage:async function(t,e,i,n,s){let r=t.data.width,l=t.data.height;if(e=int(e),i=int(i),r==e&&l==i)return t.data;if(!this.integerScalingEnabled&&n&&(n=null),n){if(int(e/r)>0){let n=int(e/r+.9),s=(e=n*r)/r,a=(i=n*l)/l,o=new U({hidden:!0,antialias:!1}).resize(e,i),h=new U({hidden:!0,antialias:!1}).resize(r,l);h.drawImage(t.data,0,0);for(let t=0;t<l;t++){let e=h.getImageData(0,t,r,1).data,i=0;for(let n=0;n<r&&i<e.length;n++,i+=4)o.fillStyle("rgba("+e[i]+","+e[i+1]+","+e[i+2]+","+e[i+3]/255+")"),o.fillRect(n*s,t*a,s,a)}return h.dispose(),await this.loadImage(o.toDataUrl())}return this.resizeImage(t,e,i,null,s)}{let a=new U({hidden:!0,antialias:n=null!==n}).resize(r,l);for(a.drawImage(t.data,0,0);;){let t=r>>1,s=l>>1;if(t<=e||s<=i)break;let o=new U({hidden:!0,antialias:n}).resize(t,s);o.drawImage(a.elem,0,0,t,s),a.dispose(),r=t,l=s,a=o}let o=new U({hidden:!0,antialias:n}).resize(e,i);return o.drawImage(a.elem,0,0,e,i),a.dispose(),s&&dispose(t.data),await this.loadImage(o.toDataUrl())}},flipImageHorz:function(t){let e=new U({hidden:!0}).resize(t.data.width,t.data.height);return e.translate(t.data.width,0),e.scale(-1,1),e.drawImage(t.data,0,0),e.elem},flipImageVert:function(t){let e=new U({hidden:!0}).resize(t.data.width,t.data.height);return e.translate(0,t.data.height),e.scale(1,-1),e.drawImage(t.data,0,0),e.elem},showDownload:function(t,e){let i=document.createElement("a");i.href=e,i.style.display="none",i.download=t,i.target="_blank",document.body.appendChild(i),i.click(),document.body.removeChild(i)},showFilePicker:function(t,e,i){let n=document.createElement("input");n.type="file",n.accept=e,n.style.display="none",n.multiple=t,document.body.appendChild(n),n.onchange=function(){i(n.files)},document.body.onfocus=function(){document.body.onfocus=null,document.body.removeChild(n)},n.click()},loadAsDataURL:function(t,e){let i=new FileReader;i.onload=function(t){e(t.target.result)},i.readAsDataURL(t)},loadAsText:function(t,e){let i=new FileReader;i.onload=function(t){e(t.target.result)},i.readAsText(t)},loadAsArrayBuffer:function(t,e){let i=new FileReader;i.onload=function(t){e(t.target.result)},i.readAsArrayBuffer(t)},loadAllAsDataURL:function(t,e){let i=[];if(!t||!t.length)return void e(i);let n=function(s){s!=t.length?mt.loadAsDataURL(t[s],(function(e){i.push({name:t[s].name,size:t[s].size,url:e}),n(s+1)})):e(i)};n(0)}});var//!/class
_t=mt;
//![import "./resources"]
const xt=t.extend({r:null,__ctor:function(t){if("audio"!=t.type)throw new Error("Resource is not audio.");this.r=t,this.r.wrapper=this,this.track=xt[this.r.track.toUpperCase()]},play:function(t,e){return xt.play(this,t,e)},playLoop:function(t,e){return xt.playLoop(this,t,e)}});xt.ENGINE_HTML5=1,xt.ENGINE_WEBAUDIO=2,xt.ENGINE_NATIVEAUDIO=3,Object.assign(xt,{MASTER:{enabled:!0,volume:1},SFX:{enabled:!0,volume:1},MUSIC:{enabled:!0,volume:.8},VOICE:{enabled:!0,volume:1},MAX_POOL_SIZE:100,pool:[],active:[],register:function(t){t.registered||(t.registered=!0,this.active.push(t))},unregister:function(t){if(t.registered){t.registered=!1;var e=xt.active.indexOf(t);-1!=e&&xt.active.splice(e,1)}},updateNode:function(t,e){switch(t.snd.r.engine){case xt.ENGINE_WEBAUDIO:return this.updateNode_webaudio(t,e);case xt.ENGINE_NATIVEAUDIO:return this.updateNode_nativeaudio(t,e)}return this.updateNode_audio(t,e)},alloc_webaudio:function(t){t.gainNode=audioContext.createGain(),t.gainNode.gain.value=0,t.gainNode.connect(audioContext.destination),t.res=audioContext.createBufferSource(),t.res.buffer=t.snd.r.data,t.res.loop=!1,t.res.connect(t.gainNode),t.res.node=t},free_webaudio:function(t){t.res&&(t.gainNode.disconnect(),t.res=null,t.gainNode=null)},alloc_nativeaudio:function(t){t.res=!0},free_nativeaudio:function(t){t.res=!1},alloc_audio:function(t){return this.pool.length?item=this.pool.pop():item=t.cloneNode(),item._src=t.src,item},free_audio:function(t){this.pool.length!=this.MAX_POOL_SIZE&&this.pool.push(t)},updateNode_webaudio:function(t,e){if(!t)return null;var i=xt.MASTER.volume*t.snd.track.volume*t.volume;switch(e){case"play":if(t.playing)break;t.res||xt.alloc_webaudio(t),t.playTime=hrnow(),t.playing=!0,t.pause=!1,t.res.onended=xt.onended_webaudio,t.gainNode.gain.value=i;try{t.res.start(0,t.startTime/1e3)}catch(e){return xt.free_webaudio(t),null}xt.register(t);break;case"setvolume":if(!t.res)break;t.gainNode.gain.value=i;break;case"stop":if(!t.playing&&t.paused){t.startTime=0,t.paused=!1,xt.free_webaudio(t),t.callback&&t.callback();break}if(!t.res)break;t.startTime=0,t.playing=!1,t.pause=!1,t.res.onended=null,xt.unregister(t),t.res.stop(),xt.free_webaudio(t),t.callback&&t.callback();break;case"pause":if(!t.playing||!t.res)break;t.startTime+=hrnow()-t.playTime,t.playing=!1,t.pause=!0,t.res.onended=null,xt.unregister(t),t.res.stop(),xt.free_webaudio(t);break;case"softstop":if(!t.playing&&t.paused){t.startTime=0,t.paused=!1;break}if(!t.playing||!t.res)break;t.startTime=0,t.playing=!1,t.pause=!1,t.res.loop=!1}return t},onended_webaudio:function(t){var e=t.currentTarget.node;if(e.playing&&0!=e.loop)return xt.free_webaudio(e),-1!=e.loop&&e.loop--,e.startTime=0,e.playing=!1,e.pause=!1,void xt.updateNode_webaudio(e,"play");e.res.onended=null,e.res.volume=0,xt.updateNode_webaudio(e,"stop")},updateNode_nativeaudio:function(t,e){if(!t)return null;switch(e){case"play":if(t.playing)break;t.res||xt.alloc_nativeaudio(t),t.playing=!0,t.pause=!1;try{r.plugins.NativeAudio.play(t.snd.r.data,null,null,(function(){xt.onended_nativeaudio(t)}))}catch(e){return xt.free_nativeaudio(t),null}xt.register(t);break;case"setvolume":case"pause":case"softstop":break;case"stop":if(!t.res)break;t.playing=!1,t.pause=!1,xt.unregister(t),r.plugins.NativeAudio.stop(t.snd.r.data,null),xt.free_nativeaudio(t),t.callback&&t.callback()}return t},onended_nativeaudio:function(t){xt.updateNode_nativeaudio(t,"stop")},updateNode_audio:function(t,e){if(!t)return null;var i=xt.MASTER.volume*t.snd.track.volume*t.volume;switch(e){case"play":if(t.playing)break;t.res||(t.res=xt.alloc_audio(t.snd.r.data),t.res.node=t,t.res.src=t.res._src),t.playTime=hrnow(),t.playing=!0,t.pause=!1,t.res.onended=xt.onended_audio,t.res.currentTime=t.startTime/1e3,t.res.volume=i;try{t.res.play()}catch(e){return xt.free_audio(t.res),t.res=null,null}xt.register(t);break;case"setvolume":if(!t.res)break;t.res.volume=i;break;case"stop":if(!t.playing&&t.paused){t.startTime=0,t.paused=!1,xt.free_audio(t.res),t.res=null,t.callback&&t.callback();break}if(!t.res)break;t.startTime=0,t.playing=!1,t.pause=!1,xt.unregister(t),t.res.pause(),xt.free_audio(t.res),t.res=null,t.callback&&t.callback();break;case"pause":if(!t.playing||!t.res)break;t.startTime+=hrnow()-t.playTime,t.playing=!1,t.pause=!0,xt.unregister(t),t.res.pause();break;case"softstop":if(!t.playing&&t.paused){t.startTime=0,t.paused=!1;break}if(!t.playing||!t.res)break;t.startTime=0,t.playing=!1,t.pause=!1}return t},onended_audio:function(t){var e=t.currentTarget.node;if(e.playing&&0!=e.loop)return-1!=e.loop&&e.loop--,e.startTime=0,e.playing=!1,e.pause=!1,void xt.updateNode_audio(e,"play");e.res.onended=null,e.res.volume=0,xt.updateNode_audio(e,"stop")},enableTrack:function(t){t&&(t.enabled=!0)},disableTrack:function(t){t&&(t.enabled=!1)},setVolume:function(t,e){t&&(t.volume=e)},createNode:function(t,e){var i={};return i.startVolume=e,i.volume=e,i.snd=t,i.loop=0,i.playing=!1,i.paused=!1,i.startTime=0,i.playTime=0,i.callback=null,i.timer=null,i.res=null,i},play:function(t,e,i){if(!this.MASTER.enabled||!t||!t.track.enabled)return null;i=null!=i?i:1;var n=this.createNode(t,i);return n.callback=e,this.updateNode(n,"play")},playLoop:function(t,e,i){if(!this.MASTER.enabled||!t||!t.track.enabled)return null;i=null!=i?i:1;var n=this.createNode(t,i);return n.callback=e,n.loop=-1,this.updateNode(n,"play")},stop:function(t,e){return t?(e&&!0!==e&&(t.callback=e),this.updateNode(t,!0===e?"stop":"softstop")):null},pause:function(t){return t?this.updateNode(t,"pause"):null},resume:function(t){return t?this.updateNode(t,"play"):null},fadeOut:function(t,e,i){if(t)if(t.playing&&!t.timer){var n=hrnow();t.startVolume=t.volume,t.timer=setInterval((function(){var s=(hrnow()-n)/e;s>1&&(s=1),t.volume=t.startVolume*(1-s),xt.updateNode(t,"setvolume"),1==s&&(clearInterval(t.timer),t.timer=null,!0===i?xt.updateNode(t,"stop"):xt.updateNode(t,"pause"),i&&!0!==i&&i())}),50)}else i&&i()},fadeIn:function(t,e,i){if(t)if(t.playing||t.timer)i&&i();else{var n=hrnow();t.volume=0,this.updateNode(t,"play"),t.timer=setInterval((function(){var s=(hrnow()-n)/e;s>1&&(s=1),t.volume=t.startVolume*s,xt.updateNode(t,"setvolume"),1==s&&(clearInterval(t.timer),t.timer=null,i&&i())}),50)}}}),_t.Audio=function(t,e=null){return{type:"audio",wrapper:"Sound",src:t,...e}};var vt=xt,//![import "./sound.js"]
bt=t.extend({r:null,__ctor:function(t){if("audios"!=t.type)throw new Error("Resource is not audios.");this.r=t,this.r.wrapper=this,this.r.track||(this.r.track="sfx"),this.r.mode||(this.r.mode="random"),this.track=vt[this.r.track.toUpperCase()],this.sounds=[],this.lastIndex=-1;for(var e=0;e<this.r.data.length;e++)this.sounds.push(new vt(Object.assign(this.r.data[e],{track:this.r.track})))},getRandomSound:function(){return"random"==this.r.mode?this.sounds[randr(0,this.sounds.length-1)]:(this.lastIndex=++this.lastIndex%this.sounds.length,this.sounds[this.lastIndex])},play:function(t,e){return vt.play(this.getRandomSound(),t,e)},playLoop:function(t,e){return vt.playLoop(this.getRandomSound(),t,e)},playAt:function(t,e,i){return vt.play(this.sounds[t%this.sounds.length],e,i)},playLoopAt:function(t,e,i){return vt.playLoop(this.sounds[t%this.sounds.length],e,i)}});const Et=ht,wt=ut,Tt=dt,Rt=pt,It=gt,Pt=vt,At=bt;var//!class PriorityQueue
St=t.extend({className:"PriorityQueue",queue:null,queueKeys:null,order:null,__ctor:function(){this.queue={},this.queueKeys=[]},add:function(t){return null==t?null:("priority"in t||(t.priority=50),t.priority in this.queue||(this.queue[t.priority]={is_dirty:!1,list:[]},this.queueKeys.push(t.priority),this.order=Object.keys(this.queue).sort(((t,e)=>t-e))),-1===this.queue[t.priority].list.indexOf(t)&&this.queue[t.priority].list.push(t),t)},remove:function(t){if(null==t)return null;if("priority"in t||(t.priority=50),!(t.priority in this.queue))return t;let e=this.queue[t.priority].list.indexOf(t);return-1===e||(this.queue[t.priority].is_dirty=!0,this.queue[t.priority].list[e]=null),t},cleanup:function(){for(let t=0;t<this.queueKeys.length;t++){let e=this.queue[this.queueKeys[t]];if(e.is_dirty){for(let t=0;t<e.list.length;t++)null==e.list[t]&&e.list.splice(t--,1);e.is_dirty=!1}}},forEach:function(t){let e=!1,i=!1;for(let n=0;!i&&n<this.order.length;n++){let s=this.queue[this.order[n]].list;for(let n=0;!i&&n<s.length;n++)null!=s[n]&&!1===t(s[n])&&(i=!0),null==s[n]&&(e=!0)}e&&this.cleanup()},forEachRev:function(t){let e=!1,i=!1;for(let n=this.order.length-1;!i&&n>=0;n--){let s=this.queue[this.order[n]].list;for(let n=s.length-1;!i&&n>=0;n--)null!=s[n]&&!1===t(s[n])&&(i=!0),null==s[n]&&(e=!0)}e&&this.cleanup()},forEachAsync:function(t,e=null){let i=this,n=!1,s=!1,r=-1,l=-1,a=null,o=function(){l++,!s&&l<a.length?(null!=a[l]&&!1===t(a[l],o)&&(s=!0),null==a[l]&&(n=!0),s&&o()):h()},h=function(){r++,!s&&r<i.order.length?(a=i.queue[i.order[r]].list,l=-1,o()):(n&&i.cleanup(),e&&e())};h()},forEachRevAsync:function(t){alert("NOT IMPLEMENTED: forEachRevAsync")}});
//![import "./recycler"]
//!class Callback
const kt=t.extend({className:"Callback",callback:null,arg0:null,arg1:null,arg2:null,arg3:null,arg4:null,arg5:null,prev:null,next:null,__ctor:function(t,e=null,i=null,n=null,s=null,r=null,l=null){this.callback=t,this.arg0=e,this.arg1=i,this.arg2=n,this.arg3=s,this.arg4=r,this.arg5=l,this.prev=null,this.next=null},__dtor:function(){this.callback=null,this.arg0=null,this.arg1=null,this.arg2=null,this.arg3=null,this.arg4=null,this.arg5=null,this.prev=null,this.next=null},isEqual:function(t=null,e=null,i=null,n=null,s=null,r=null,l=null){return null!==t&&kt.isInstance(t)?t===this:(null===t||this.callback===t)&&((null===e||this.arg0===e)&&((null===i||this.arg1===i)&&((null===n||this.arg2===n)&&((null===s||this.arg3===s)&&((null===r||this.arg4===r)&&(null===l||this.arg5===l))))))},exec:function(t){return null===this.callback||this.callback(t,this.arg0,this.arg1,this.arg2,this.arg3,this.arg4,this.arg5)}});
//!/class
//!namespace Callback
//!namespace Pool
p.createPool(kt,16384,6144);var Ft=kt;
//![import "./recycler"]
//![import "./callback"]
//!class Handler
const Ct=t.extend({className:"Handler",host:null,top:null,bottom:null,__ctor:function(t=null){return this.host=t,this.top=null,this.bottom=null,this},__dtor:function(){this.remove()},add:function(t,e=null,i=null,n=null,s=null,r=null,l=null){let a=Ft.isInstance(t)?t:Ft.Pool.alloc(t,e,i,n,s,r,l);return a.prev=this.bottom,null!==this.bottom&&(this.bottom.next=a),this.bottom=a,null===this.top&&(this.top=a),a},unlink:function(t){return t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),this.top===t&&(this.top=t.next),this.bottom===t&&(this.bottom=t.prev),t.prev=null,t.next=null,dispose(t),this},remove:function(t=null,e=null,i=null,n=null,s=null,r=null,l=null){if(null!==t&&Ft.isInstance(t))return this.unlink(t),this;let a=this.top;for(;null!==a;){let o=a.next;a.isEqual(t,e,i,n,s,r,l)&&this.unlink(a),a=o}return this},find:function(t,e=null,i=null,n=null,s=null,r=null,l=null){let a=this.top;for(;null!==a;){if(a.isEqual(t,e,i,n,s,r,l))return a;a=a.next}return null},exec:function(t=null){let e=this.top;for(t=t??this.host;null!==e;){let i=e.next,n=e.exec(t);if(null===n)break;!1===n&&this.unlink(e),e=i}},execf:function(t=null,e=null,i=null,n=null,s=null,r=null,l=null){let a=this.top;for(;null!==a;){let o=a.next;if(a.isEqual(t,e,i,n,s,r,l)){!1===a.exec(this.host)&&this.unlink(a);break}a=o}},execc:function(t,e=null){!1===t.exec(e??this.host)&&this.unlink(t)}});
//!/class
//!namespace Handler
//!namespace Pool
p.createPool(Ct,16384,6144);var Nt=Ct;
//![import "../utils/recycler"]
//![import "./vec2"]
//!class Rect
const Dt=t.extend({className:"Rect",cx:0,cy:0,x1:0,y1:0,x2:0,y2:0,__ctor:function(t=null,e=null,i=null,n=null){return null===t?(this.x1=this.y1=this.x2=this.y2=this.cx=this.cy=0,this):null===i?(this.set(0,0,0,0),this.resize(t,e),this):this.set(t,e,i,n)},__dtor:function(){},clone:function(){return Dt.Rool.alloc(this.x1,this.y1,this.x2,this.y2)},zero:function(){return this.cx=0,this.cy=0,this.x1=0,this.y1=0,this.x2=0,this.y2=0,this},reset:function(){return this.cx=null,this.cy=null,this.x1=null,this.y1=null,this.x2=null,this.y2=null,this},extendWithPoint:function(t,e=null){if(null===e){const i=t;t=i.x,e=i.y}return(null===this.x1||t<this.x1)&&(this.x1=t),(null===this.y1||e<this.y1)&&(this.y1=e),(null===this.x2||t>this.x2)&&(this.x2=t),(null===this.y2||e>this.y2)&&(this.y2=e),this.cx=(this.x1+this.x2)/2,this.cy=(this.y1+this.y2)/2,this},translate:function(t,e){return this.x1+=t,this.y1+=e,this.x2+=t,this.y2+=e,this.cx+=t,this.cy+=e,this},centerAt:function(t,e,i=!1){return 1==i&&(t=this.x1+t*(this.x2-this.x1),e=this.y1+e*(this.y2-this.y1)),this.translate(t-this.cx,e-this.cy)},set:function(t,e=null,i=null,n=null){if(null===e){const s=t;t=s.x1,e=s.y1,i=s.x2,n=s.y2}return this.cx=(t+i)/2,this.cy=(e+n)/2,this.x1=t,this.y1=e,this.x2=i,this.y2=n,this},equals:function(t,e=null,i=null,n=null){if(null===e){const s=t;t=s.x1,e=s.y1,i=s.x2,n=s.y2}return t==this.x1&&i==this.x2&&e==this.y1&&n==this.y2},contains:function(t,e=null,i=null,n=null){if(null===e){const s=t;t=s.x1,e=s.y1,i=s.x2,n=s.y2}return t==Math.max(this.x1,t)&&e==Math.max(this.y1,e)&&i==Math.min(this.x2,i)&&n==Math.min(this.y2,n)},setAsUnion:function(t,e=null,i=null,n=null){if(null===e){const s=t;t=s.x1,e=s.y1,i=s.x2,n=s.y2}return this.x1=Math.min(this.x1,t),this.y1=Math.min(this.y1,e),this.x2=Math.max(this.x2,i),this.y2=Math.max(this.y2,n),this},intersects:function(t,e=null,i=null,n=null){if(null===e){const s=t;t=s.x1,e=s.y1,i=s.x2,n=s.y2}let s=Math.max(this.x1,t),r=Math.max(this.y1,e),l=Math.min(this.x2,i),a=Math.min(this.y2,n);return Math.max(0,a-r)*Math.max(0,l-s)>0},setAsIntersection:function(t,e=null,i=null,n=null){if(null===e){const s=t;t=s.x1,e=s.y1,i=s.x2,n=s.y2}return this.x1=Math.max(this.x1,t),this.y1=Math.max(this.y1,e),this.x2=Math.min(this.x2,i),this.y2=Math.min(this.y2,n),Math.max(0,this.y2-this.y1)*Math.max(0,this.x2-this.x1)>0},resize:function(t,e,i=!1,n=!1){return 1==n&&(t*=this.x2-this.x1,e*=this.y2-this.y1),1==i?(this.x2=this.x1+t,this.y2=this.y1+e):(t/=2,e/=2,this.x1=this.cx-t,this.y1=this.cy-e,this.x2=this.cx+t,this.y2=this.cy+e),this},resizeBy:function(t,e,i=!1){return 1==i?(this.x2+=t,this.y2+=e):(t/=2,e/=2,this.x1-=t,this.y1-=e,this.x2+=t,this.y2+=e),this},width:function(){return this.x2-this.x1},height:function(){return this.y2-this.y1},ncx:function(){return(this.cx-this.x1)/(this.x2-this.x1)},ncy:function(){return(this.cy-this.y1)/(this.y2-this.y1)},isRight:function(){return this.x1<=this.x2&&this.y1<=this.y2},containsPoint:function(t,e,i=0){return this.x1-i<=t&&t<=this.x2+i&&this.y1-i<=e&&e<=this.y2+i},area:function(t){return t?this.isRight()?(this.y2-this.y1)*(this.x2-this.x1):0:(this.y2-this.y1)*(this.x2-this.x1)},floor:function(){return this.x1=Math.floor(this.x1),this.y1=Math.floor(this.y1),this.x2=Math.floor(this.x2),this.y2=Math.floor(this.y2),this.cx=Math.floor(this.cx),this.cy=Math.floor(this.cy),this},ceil:function(){return this.x1=Math.ceil(this.x1),this.y1=Math.ceil(this.y1),this.x2=Math.ceil(this.x2),this.y2=Math.ceil(this.y2),this.cx=Math.ceil(this.cx),this.cy=Math.ceil(this.cy),this},toString:function(){return"("+this.x1.toFixed(2)+", "+this.y1.toFixed(2)+", "+this.x2.toFixed(2)+", "+this.y2.toFixed(2)+")"},flatten:function(){return[this.x1,this.y1,this.x2,this.y2]},unflatten:function(t){return this.set(t[0],t[1],t[2],t[3]),this}});
//!/class
//!namespace Rect
//!namespace Pool
p.createPool(Dt,4096,2048);var Mt=Dt;
//!class TFunction
const Lt=t.extend({className:"TFunction",t:null,y:null,f:null,__ctor:function(t=0){this.reset(t)},reset:function(t=0){return this.t=[0],this.y=[t],this.f=[null],this},copyFrom:function(t,e,i){if(this.t=[],this.y=[],this.f=[],null==e&&null==i){for(let e=0;e<t.t.length;e++)this.t.push(t.t[e]),this.y.push(t.y[e]),this.f.push(t.f[e]);return this}null==e&&(e=t.t[0]),null==i&&(i=t.t[t.t.length-1]),e<t.t[0]&&(e=t.t[0]);let n=t.find(e),s=t.find(i);if(null==n)return null;if(null==s)return null;t.t[n]!=e&&(this.set(e,t.getAt(e),t.f[n]),n++);for(let e=n;e<=s;e++)this.set(t.t[e],t.y[e],t.f[e]);if(t.t[s]!=i){let e=(i-t.t[s])/Math.ceil(Math.log(i-t.t[s])),n=this.t[this.t.length-1];for(e<=0&&(e=1),e=i-n;n!=i;)n+e>i&&(e=i-n),n+=e,this.set(float4(n),t.getAt(n),t.f[s])}return this},clone:function(t,e){return(new Lt).copyFrom(this,t,e)},endTime:function(t=0){return this.t[this.t.length-1]+t},startTime:function(t=0){return this.t[0]+t},find:function(t){if(t<this.t[0])return null;const e=this.t.length;for(let i=1;i<e;i++)if(t<this.t[i])return i-1;return e-1},set:function(t,e,i=null){let n=this.find(t);return null!=n&&(this.t[n]==t?(this.y[n]=e,null!=i&&(this.f[n]=i)):(n++,this.t.splice(n,0,t),this.y.splice(n,0,e),this.f.splice(n,0,i)),!0)},get:function(){return this.y[this.y.length-1]},getAt:function(t){let e=this.find(t);if(null==e)return 0;let i=e+1;if(this.t[e]==t||i>=this.t.length||this.y[e]==this.y[i]||null==this.f[e])return this.y[e];if(null==this.f[e])return this.y[e];let n=t,s=this.t[e],r=this.t[i],l=this.y[e],a=this.y[i];return t=(n-s)/(r-s),(t=this.f[e](t))*a+(1-t)*l},integral:function(t=null,e=null,i=0){null==t&&(t=this.t[0]),null==e&&(e=this.t[this.t.length-1]),t<this.t[0]&&(t=this.t[0]);let n=1;if(t>e){let i;i=t,t=e,e=i,n=-1}let s=i;for(let i=t;i<e;){let t=this.find(i);if(null==t)return 0;let n=t+1,r=Math.max(this.t[t],i),l=Math.min(n<this.t.length?this.t[n]:e,e),a=this.getAt(r),o=l-r,h=this.getAt(l)-a;null==this.f[t]?s+=a*o:s+=.5*h*(l+r)-r*h+a*o,i+=o}return n*s},second_integral:function(t=null,e=null,i=0){null==t&&(t=this.t[0]),null==e&&(e=this.t[this.t.length-1]);let n=Lt.Temp1.copyFrom(this,this.t[0],t).integrate(i).integral();return Lt.Temp2.copyFrom(this,this.t[0],e).integrate(i).integral()-n},integrate:function(t=0){let e=[];e.push(t);for(let t=1;t<this.t.length;t++)e.push(e[t-1]+this.integral(this.t[t-1],this.t[t]));return this.y=e,this},accumulate:function(t=0){this.y[0]+=t;for(let t=1;t<this.t.length;t++)this.y[t]+=this.y[t-1];return this},chopLeft:function(t){return this.t.splice(0,t),this.f.splice(0,t),this.y.splice(0,t),this},chopRight:function(t){return this.t.splice(t+1,this.t.length-t-1),this.f.splice(t+1,this.f.length-t-1),this.y.splice(t+1,this.y.length-t-1),this},map:function(t){for(let e=0;e<this.y.length;e++)this.y[e]=t(this.y[e],this.t[e],e);return this},toString:function(t=0){let e="",i=10;const n=function(t,e,i){for(t=t.toString(),null==i&&(i=" "),i=i[0];t.length<e;)t+=i;return t};e+="\n",e+=n(" Time",i)+" "+n(" Value",i)+" "+n(" Integral",i)+"\n",e+=n("",i,"-")+" "+n("",i,"-")+" "+n("",i,"-")+"\n";for(let s=0;s<this.t.length;s++)e+=n(" "+float4(this.t[s]),i)+" "+n(" "+float4(this.y[s]),i)+" "+n(" "+float4(this.integral(this.t[0],this.t[s],t)),i)+"\n";return e}});Lt.Temp1=new Lt,Lt.Temp2=new Lt;var Bt=Lt;
//![import "../utils/recycler"]
//![import "./vec2"]
//!class Point2
const Ut=t.extend({className:"Point2",ux:0,uy:0,x:0,y:0,__ctor:function(t=null,e=null){return this.set(t,e)},downscale:function(){return this.x=downscale(this.ux),this.y=downscale(this.uy),this},clone:function(){return Ut.Pool.alloc(this)},set:function(t,e=null,i=!1){return null===t?(t=0,e=0):null===e?Ut.isInstance(t)?(e=t.uy,t=t.ux):(e=upscale(t.y),t=upscale(t.x)):!0!==i&&(t=upscale(t),e=upscale(e)),this.ux=t,this.uy=e,this.downscale(this)},setX:function(t){return this.ux=upscale(t),this.downscale(this)},setY:function(t){return this.uy=upscale(t),this.downscale(this)},zero:function(){return this.set(0,0)},isZero:function(){return 0==this.x&&0==this.y},equals:function(t,e=null){return null===e?Ut.isInstance(t)?(e=t.y,t=t.x):(e=int(t.y),t=int(t.x)):(t=int(t),e=int(e)),this.x==t&&this.y==e},add:function(t,e=null,i=!1){return null===e?Ut.isInstance(t)?(e=t.uy,t=t.ux):(e=upscale(t.y),t=upscale(t.x)):!0!==i&&(t=upscale(t),e=upscale(e)),this.ux+=t,this.uy+=e,this.downscale()},sub:function(t,e,i=!1){return null===e?Ut.isInstance(t)?(e=t.uy,t=t.ux):(e=upscale(t.y),t=upscale(t.x)):!0!==i&&(t=upscale(t),e=upscale(e)),this.ux-=t,this.uy-=e,this.downscale()},toString:function(){return`(${this.x}, ${this.y})`}});
//!/class
//!namespace Point2
//!namespace Pool
p.createPool(Ut,2048,1024);var Ot=Ut;
//![import "../utils/recycler"]
//![import "./point2"]
//![import "./rect"]
//!class Bounds2
const Ht=t.extend({className:"Bounds2",cx:0,cy:0,x1:0,y1:0,x2:0,y2:0,ucx:0,ucy:0,ux1:0,uy1:0,ux2:0,uy2:0,__ctor:function(t=null,e=null,i=null,n=null,s=!1){return null===t?(this.ux1=this.uy1=this.ux2=this.uy2=this.ucx=this.ucy=0,this.downscale()):null!==e&&null===i?this.set(0,0,0,0).resize(t,e):this.set(t,e,i,n,s)},downscale:function(){return this.x1=downscale(this.ux1),this.y1=downscale(this.uy1),this.x2=downscale(this.ux2),this.y2=downscale(this.uy2),this.cx=downscale(this.ucx),this.cy=downscale(this.ucy),this},trunc:function(){return this.ux1=upscale(this.x1),this.uy1=upscale(this.y1),this.ux2=upscale(this.x2),this.uy2=upscale(this.y2),this.ucx=upscale(this.cx),this.ucy=upscale(this.cy),this},clone:function(){return Ht.Pool.alloc(this.ux1,this.uy1,this.ux2,this.uy2,!0)},zero:function(){return this.ux1=0,this.uy1=0,this.ux2=0,this.uy2=0,this.ucx=0,this.ucy=0,this.downscale()},reset:function(){return this.ux1=null,this.uy1=null,this.ux2=null,this.uy2=null,this.ucx=null,this.ucy=null,this.x1=null,this.y1=null,this.x2=null,this.y2=null,this.cx=null,this.cy=null,this},translate:function(t,e=null,i=!1){return null===e?Ot.isInstance(t)?(e=t.uy,t=t.ux):(e=upscale(t.y),t=upscale(t.x)):!0!==i&&(t=upscale(t),e=upscale(e)),this.ux1+=t,this.uy1+=e,this.ux2+=t,this.uy2+=e,this.ucx+=t,this.ucy+=e,this.downscale()},set:function(t,e=null,i=null,n=null,s=!1){return null===e?Ht.isInstance(t)?(n=t.uy2,i=t.ux2,e=t.uy1,t=t.ux1):(n=upscale(t.y2),i=upscale(t.x2),e=upscale(t.y1),t=upscale(t.x1)):!0!==s&&(t=upscale(t),e=upscale(e),i=upscale(i),n=upscale(n)),this.ux1=t,this.uy1=e,this.ux2=i,this.uy2=n,this.ucx=t+i>>1,this.ucy=e+n>>1,this.downscale()},add:function(t,e=null,i=null,n=null,s=!1){return null===e?Ht.isInstance(t)?(n=t.uy2,i=t.ux2,e=t.uy1,t=t.ux1):(n=upscale(t.y2),i=upscale(t.x2),e=upscale(t.y1),t=upscale(t.x1)):!0!==s&&(t=upscale(t),e=upscale(e),i=upscale(i),n=upscale(n)),this.ux1+=t,this.uy1+=e,this.ux2+=i,this.uy2+=n,this.ucx+=t+i>>1,this.ucy+=e+n>>1,this.downscale()},equals:function(t,e=null,i=null,n=null){return null===e?Ht.isInstance(t)?(n=t.y2,i=t.x2,e=t.y1,t=t.x1):(n=int(t.y2),i=int(t.x2),e=int(t.y1),t=int(t.x1)):(t=int(t),e=int(e),i=int(i),n=int(n)),t==this.x1&&i==this.x2&&e==this.y1&&n==this.y2},contains:function(t,e=null,i=null,n=null){return null===e?Ht.isInstance(t)?(n=t.y2,i=t.x2,e=t.y1,t=t.x1):(n=int(t.y2),i=int(t.x2),e=int(t.y1),t=int(t.x1)):(t=int(t),e=int(e),i=int(i),n=int(n)),t==Math.max(this.x1,t)&&e==Math.max(this.y1,e)&&i==Math.min(this.x2,i)&&n==Math.min(this.y2,n)},setAsUnion:function(t,e=null,i=null,n=null){if(null===e){if(Ht.isInstance(t))return this.setAsUnion(t.ux1,t.uy1,!0),this.setAsUnion(t.ux2,t.uy2,!0),this;if(Mt.isInstance(t))return this.setAsUnion(t.x1,t.y1),this.setAsUnion(t.x2,t.y2),this;Ot.isInstance(t)?(e=t.uy,t=t.ux):(e=upscale(t.y),t=upscale(t.x))}else{if(null!==n)return this.setAsUnion(t,e),this.setAsUnion(i,n),this;!0!==i&&(t=upscale(t),e=upscale(e))}return(null===this.ux1||t<this.ux1)&&(this.ux1=t),(null===this.uy1||e<this.uy1)&&(this.uy1=e),(null===this.ux2||t>this.ux2)&&(this.ux2=t),(null===this.uy2||e>this.uy2)&&(this.uy2=e),this.ucx=this.ux1+this.ux2>>1,this.ucy=this.uy1+this.uy2>>1,this.downscale()},intersects:function(t,e=null,i=null,n=null){null===e?Ht.isInstance(t)?(n=t.y2,i=t.x2,e=t.y1,t=t.x1):(n=int(t.y2),i=int(t.x2),e=int(t.y1),t=int(t.x1)):(t=int(t),e=int(e),i=int(i),n=int(n));let s=Math.max(this.x1,t),r=Math.max(this.y1,e),l=Math.min(this.x2,i),a=Math.min(this.y2,n);return Math.max(0,a-r)*Math.max(0,l-s)>0},setAsIntersection:function(t,e=null,i=null,n=null){return null===e?Ht.isInstance(t)?(n=t.y2,i=t.x2,e=t.y1,t=t.x1):(n=int(t.y2),i=int(t.x2),e=int(t.y1),t=int(t.x1)):(t=int(t),e=int(e),i=int(i),n=int(n)),this.ux1=upscale(Math.max(this.x1,t)),this.uy1=upscale(Math.max(this.y1,e)),this.ux2=upscale(Math.min(this.x2,i)),this.uy2=upscale(Math.min(this.y2,n)),this.ucx=this.ux1+this.ux2>>1,this.ucy=this.uy1+this.uy2>>1,this.downscale(),Math.max(0,this.uy2-this.uy1)*Math.max(0,this.ux2-this.ux1)>0},resize:function(t,e,i=!1){return t=null!==t?!0===t||upscale(t):this.ux2-this.ux1,e=null!==e?!0===e||upscale(e):this.uy2-this.uy1,!0===t?t=e*this.ratio():!0===e&&(e=t/this.ratio()),!0===i?(this.ux2=this.ux1+t,this.uy2=this.uy1+e,this.ucx=this.ux1+this.ux2>>1,this.ucy=this.uy1+this.uy2>>1):(t>>=1,e>>=1,this.ux1=this.ucx-t,this.uy1=this.ucy-e,this.ux2=this.ucx+t,this.uy2=this.ucy+e),this.downscale()},resizeBy:function(t,e,i=!1){return t=!0===t||upscale(t),e=!0===e||upscale(e),!0===t?t=e*this.ratio():!0===e&&(e=t/this.ratio()),!0===i?(this.ux2+=t,this.uy2+=e,this.ucx=this.ux1+this.ux2>>1,this.ucy=this.uy1+this.uy2>>1):(t>>=1,e>>=1,this.ux1-=t,this.uy1-=e,this.ux2+=t,this.uy2+=e),this.downscale()},width:function(){return this.x2-this.x1},height:function(){return this.y2-this.y1},ratio:function(){return(this.x2-this.x1)/(this.y2-this.y1)},isForward:function(){return this.ux1<=this.ux2&&this.uy1<=this.uy2},containsPoint:function(t,e,i=0){return t=upscale(t),e=upscale(e),i=upscale(i),this.ux1-i<=t&&t<=this.ux2+i&&this.uy1-i<=e&&e<=this.uy2+i},area:function(t=!1){return t?this.isForward()?(this.y2-this.y1)*(this.x2-this.x1):0:(this.y2-this.y1)*(this.x2-this.x1)},toString:function(){return"("+this.x1+", "+this.y1+", "+this.x2+", "+this.y2+")"},flatten:function(){return[this.ux1,this.uy1,this.ux2,this.uy2]},unflatten:function(t){return this.ux1=t[0],this.uy1=t[1],this.ux2=t[2],this.uy2=t[3],this.ucx=this.ux1+this.ux2>>1,this.ucy=this.uy1+this.uy2>>1,this.downscale()}});
//!/class
//!namespace Rect
//!namespace Pool
p.createPool(Ht,8192,3072);var Xt=Ht;
//!namespace Easing
const Wt={//!namespace Linear
Linear:{IN:function(t){return t},OUT:function(t){return t},IN_OUT:function(t){return t}},
//!/namespace
//!namespace Back
Back:{k:1.70158,IN:function(t,e=null){return null===e&&(e=Wt.Back.k),t*t*((e+1)*t-e)},OUT:function(t,e=null){return 1-Wt.Back.IN(1-t,e)},IN_OUT:function(t,e=null){return t<.5?Wt.Back.IN(2*t,e)/2:Wt.Back.OUT(2*(t-.5),e)/2+.5}},
//!/namespace
//!namespace Bounce
Bounce:{getConst:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},IN:function(t){return 1-Wt.Bounce.getConst(1-t)},OUT:function(t){return Wt.Bounce.getConst(t)},IN_OUT:function(t){return t<.5?(1-Wt.Bounce.getConst(1-2*t))/2:Wt.Bounce.getConst(2*(t-.5))/2+.5}},
//!/namespace
//!namespace Circ
Circ:{IN:function(t){return 1-Math.sqrt(1-t*t)},OUT:function(t){return 1-Wt.Circ.IN(1-t)},IN_OUT:function(t){return t<.5?Wt.Circ.IN(2*t)/2:Wt.Circ.OUT(2*(t-.5))/2+.5}},
//!/namespace
//!namespace Cubic
Cubic:{IN:function(t){return t*t*t},OUT:function(t){return 1-Wt.Cubic.IN(1-t)},IN_OUT:function(t){return t<.5?Wt.Cubic.IN(2*t)/2:Wt.Cubic.OUT(2*(t-.5))/2+.5}},
//!/namespace
//!namespace Expo
Expo:{IN:function(t){return Math.pow(2,12*(t-1))},OUT:function(t){return 1-Math.pow(2,-12*t)},IN_OUT:function(t){return(t*=2)<1?Math.pow(2,12*(t-1))/2:(2-Math.pow(2,-12*(t-1)))/2}},
//!/namespace
//!namespace Power
Power:{IN:function(t,e=12){return Math.pow(t,e)},OUT:function(t,e=12){return 1-Wt.Power.IN(1-t,e)},IN_OUT:function(t,e=12){return t<.5?Wt.Power.IN(2*t,e)/2:Wt.Power.OUT(2*(t-.5),e)/2+.5}},
//!/namespace
//!namespace Quad
Quad:{IN:function(t){return t*t},OUT:function(t){return 1-Wt.Quad.IN(1-t)},IN_OUT:function(t){return t<.5?Wt.Quad.IN(2*t)/2:Wt.Quad.OUT(2*(t-.5))/2+.5}},
//!/namespace
//!namespace Quartic
Quartic:{IN:function(t){return t*t*t*t},OUT:function(t){return 1-Wt.Quartic.IN(1-t)},IN_OUT:function(t){return t<.5?Wt.Quartic.IN(2*t)/2:Wt.Quartic.OUT(2*(t-.5))/2+.5}},
//!/namespace
//!namespace Quintic
Quintic:{IN:function(t){return t*t*t*t*t},OUT:function(t){return 1-Wt.Quintic.IN(1-t)},IN_OUT:function(t){return t<.5?Wt.Quintic.IN(2*t)/2:Wt.Quintic.OUT(2*(t-.5))/2+.5}},
//!/namespace
//!namespace Sine
Sine:{IN:function(t){return 1-Math.sin(1.5708*(1-t))},OUT:function(t){return Math.sin(1.5708*t)},IN_OUT:function(t){return(Math.cos(3.1416*t)-1)/-2}},
//!/namespace
//!namespace Step
Step:{IN:function(t){return 1!=t?0:1},OUT:function(t){return 1!=t?0:1},IN_OUT:function(t){return 1!=t?0:1}}};var Gt=Wt;
//![import "../utils/priority-queue"]
//!class Boot
const Yt={modules:new St,register:function(t){return this.modules.add(t)},unregister:function(t){this.modules.remove(t),this.modules.cleanup()},startup:function(t=null){this.modules.forEachAsync(((t,e)=>{!1!==t.onStartup(e)&&e()}),t)},shutdown:function(t=null){this.modules.forEachAsyncRev(((t,e)=>{!1!==t.onShutdown(e)&&e()}),t)}};
//!/class
//!namespace Boot
//!interface Module
Yt.Module=t.extend({className:"Module",priority:5,__ctor:function(){Yt.register(this)},__dtor:function(){Yt.unregister(this)},onStartup:function(t){},onShutdown:function(t){}});var//!/interface
//!/namespace
Vt=Yt;
//!class sys
const qt={initialized:!1,screenWidth:0,screenHeight:0,renderer:null,time:0,dt:0,_timeout:null,_interval:null,_span:null,update:null,draw:null,onPaused:null,onResumed:null,options:{gl:!0,log:!1,antialias:!1,background:"#000000",orientation:"automatic",screenWidth:null,screenHeight:null,fps:144,minFps:24,preallocate:!1},init:function(t){return new Promise(((e,i)=>{if(this.initialized)return e();Object.assign(this.options,t),_t.config({pixelated:!this.options.antialias,filter:this.options.antialias?"LINEAR":"NEAREST"}),H.init(this.options),H.updateQueueAdd({update:function(t){qt.time=H.frameTime,qt.dt=t,qt._timeout.exec(t),qt._interval.exec(t),qt._span.exec(t),qt.update.exec(t)}}),H.drawQueueAdd({draw:function(t){qt.draw.exec(t)}}),Vt.startup((function(){H.start(),qt.screenWidth=H.screenWidth,qt.screenHeight=H.screenHeight,qt.renderer=H.renderer,qt._timeout=Nt.Pool.alloc(),qt._interval=Nt.Pool.alloc(),qt._span=Nt.Pool.alloc(),qt.update=Nt.Pool.alloc(),qt.draw=Nt.Pool.alloc(),window.onblur=function(){qt.pause(!0)},window.onfocus=function(){qt.resume(!0)},qt.initialized=!0,e()}))}))},pause:function(t=!1){null!==qt.onPaused&&qt.onPaused(t)},resume:function(t=!1){null!==qt.onResumed&&qt.onResumed(t)},timeout:function(t,e,i=null,n=null,s=null,r=null){return this._timeout.add(this._updateTimeout,t,e,i,n,s,r)},cancelTimeout:function(t){this._timeout.remove(t)},_updateTimeout:function(t,e,i,n,s,r,l){return this.arg0-=t,this.arg0>0||(i(n,s,r,l),!1)},interval:function(t,e,i=null,n=null,s=null){return this._interval.add(this._updateInterval,0,t,e,i,n,s)},cancelInterval:function(t){this._interval.remove(t)},_updateInterval:function(t,e,i,n,s,r,l){return this.arg0+=t,this.arg0<this.arg1||(this.arg0-=this.arg1,n(s,r,l))},span:function(t,e,i=null,n=null,s=null){return this._span.add(this._updateSpan,0,t,e,i,n,s)},cancelSpan:function(t){this._span.remove(t)},_updateSpan:function(t,e,i,n,s,r,l){return this.arg0+=t,this.arg0>this.arg1&&(t-=this.arg0-this.arg1,this.arg0=this.arg1),!1!==n(this.arg0/this.arg1,t,s,r,l)&&this.arg0!==this.arg1}};var zt=qt;
//!class Block
const Kt=t.extend({className:"Anim:Block",commands:null,isFirst:!0,current:!1,stamp:0,time:0,init:function(){return this.commands=_.Pool.alloc(),this.reset(0),this},__dtor:function(){this.clear(),this.commands.free()},count:function(){return this.commands.length},add:function(t){return this.commands.push(t),!1===this.isFirst&&null===this.current&&(this.current=this.commands.bottom,this.stamp=rand()),t},clone:function(){let t=Kt.alloc();for(let e=this.commands.top;null!==e;e=e.next)t.commands.push(e.value.clone());return t},clear:function(){return this.commands.clear(),this.reset(0),this},reset:function(t=0){return this.isFirst=!0,this.current=null,this.time=t,this.stamp=rand(),this},restart:function(){return this.isFirst=!0,this.stamp=rand(),this},isFinished:function(){return!0===this.isFirst&&(this.current=this.commands.top,this.isFirst=!1),null===this.current},update:function(t){for(;!this.isFinished();){let e=this.current.value.update(t,this);if(!0!==e)return e;this.current=this.current.next}return!0}});p.attachTo(Kt,2048);var Qt=Kt;
//!class Command
const jt=t.extend({className:"Anim:Command",op:null,started:!1,time:0,field:null,value:null,duration:0,_duration:0,count:0,_count:0,startValue:0,_startValue:0,endValue:0,_endValue:0,easing:null,_cur:null,_last:null,block:null,blocks:null,table:null,snd:null,fn:null,init:function(t,e){return this.op=t,this.started=!1,this.block=null,this.blocks=null,this.table=null,this.snd=null,this.fn=null,!1!==e&&t.init(this,!1),this},__dtor:function(){null!==this.block&&this.block.clear().free(),null!==this.blocks&&this.blocks.clear().free()},clone:function(){let t=jt.alloc(this.op,!1);if(t.field=this.field,t.value=this.value,t.duration=this.duration,t.count=this.count,t.startValue=this.startValue,t.endValue=this.endValue,t.easing=this.easing,t.table=this.table,t.snd=this.snd,t.fn=this.fn,null!==this.block&&(t.block=this.block.clone()),null!==this.blocks){t.blocks=_.Pool.alloc();for(let e=this.blocks.top;null!==e;e=e.next)t.blocks.push(e.value.clone())}return t},ready:function(){this.op.init(this,!0)},update:function(t,e){return this.op.update(t,e,this)}});p.attachTo(jt);var Zt=jt,$t={init:function(t,e=!1){if(!e)return t.block=Qt.alloc(),void(t.blocks=_.Pool.alloc());let i;for(;null!=(i=t.block.commands.shift());){let e=Qt.alloc();e.add(i),t.blocks.push(e)}t.block.free(),t.block=null},update:function(t,e,i){if(!1===i.started){for(let t=i.blocks.top;null!==t;t=t.next)t.value.reset(e.time);i.started=!0}let n=e.time,s=0,r=0;for(let e=i.blocks.top;null!==e;e=e.next){let i=e.value.update(t);!0===i?s++:null===i&&r++,e.value.time>n&&(n=e.value.time)}return s+r==i.blocks.length&&(i.started=!1,e.time=n,!0)}},Jt={init:function(t,e=!1){e||(t.block=Qt.alloc())},update:function(t,e,i){!1===i.started&&(i.block.reset(e.time),i.started=!0);let n=i.block.update(t);return!0!==n?n:(i.started=!1,e.time=i.block.time,!0)}},te={init:function(t,e=!1){e||(t.block=Qt.alloc())},update:function(t,e,i){!1===i.started&&(i.block.reset(e.time),i._count=i.count,i.started=!0);let n=i.block.update(t);return!0!==n?n:i._count<=1?(i.started=!1,e.time=i.block.time,!0):(i.block.restart(),i._count--,!1)}},ee={init:function(t,e=!1){},update:function(t,e,i){return t.setValue(i.field,t.getValue(i.field,i.value)),!0}},ie={init:function(t,e=!1){},update:function(t,e,i){return e.restart(),!0}},ne={init:function(t,e=!1){},update:function(t,e,i){return!1===i.started&&(i._duration="string"===s.typeOf(i.duration)?t.getValue(i.duration):i.duration,i.started=!0),!(t.time<e.time+i._duration)&&(i.started=!1,e.time+=i._duration,!0)}},se={init:function(t,e=!1){},update:function(t,e,i){!1===i.started&&(i._startValue=t.getValue(i.field,i.startValue),i._duration="string"===s.typeOf(i.duration)?t.getValue(i.duration):i.duration,i.started=!0),i._endValue=t.getValue(i.field,i.endValue,i._startValue);let n=1;return t.time<e.time+i._duration&&(n=(t.time-e.time)/i._duration),i.easing&&1!=n?t.setValue(i.field,i.easing(n)*(i._endValue-i._startValue)+i._startValue):t.setValue(i.field,n*(i._endValue-i._startValue)+i._startValue),1==n&&(i.started=!1,e.time+=i._duration,!0)}},re={init:function(t,e=!1){},update:function(t,e,n){!1===n.started&&(n._duration="string"===s.typeOf(n.duration)?t.getValue(n.duration):n.duration,n._last=null,n.started=!0);let r=1;if(t.time<e.time+n._duration&&(r=(t.time-e.time)/n._duration),n.easing&&1!=r?n._cur=int(n.easing(r)*n.count):n._cur=int(r*n.count),n._cur!=n._last){let e=t.getValue(n.field);for(;;){if(int(Math.random()*(n.endValue-n.startValue+1))+n.startValue!=e)break}t.setValue(n.field,i),n._last=n._cur}return 1==r&&(n.started=!1,e.time+=n._duration,!0)}},le={init:function(t,e=!1){if(!e)return;let i=[];for(let e=0;e<t.count;e++)i.push(e%(t.endValue-t.startValue+1)+t.startValue);for(let e=t.count>>2;e>0;e--){let e=int(Math.random()*t.count),n=int(Math.random()*t.count),s=i[n];i[n]=i[e],i[e]=s}t.table=i},update:function(t,e,i){!1===i.started&&(i._duration="string"===s.typeOf(i.duration)?t.getValue(i.duration):i.duration,i.started=!0);let n,r=1;return t.time<e.time+i._duration&&(r=(t.time-e.time)/i._duration),n=i.easing&&1!=r?i.easing(r)*(i.count-1):r*(i.count-1),t.setValue(i.field,i.table[int((n+i.count)%i.count)]),1==r&&(i.started=!1,e.time+=i._duration,!0)}},ae={init:function(t,e=!1){},update:function(t,e,i){!1===i.started&&(i._last=t.time,i.started=!0,i.time=t.time);let n=t.time-i._last;return i._last=t.time,i.time+=n,!0!==i.fn(n,t.data,i,t)&&(i.started=!1,!0)}},oe={init:function(t,e=!1){},update:function(t,e,i){return i.snd.play(),!0}};
//!class Anim
const he=t.extend({className:"Anim",initialData:null,blockStack:null,cmdStack:null,block:null,finishedCallback:null,finishedCallbackHandler:null,finishedCallbackContext:null,data:null,timeScale:1,time:0,paused:!1,finished:!1,running:!1,autoDispose:!1,__ctor:function(){return this.initialData={},this.data={},this.block=Qt.alloc(),this.blockStack=_.Pool.alloc(),this.cmdStack=_.Pool.alloc(),this.running=!1,this.autoDispose=!1,this.finishedCallback=null,this.finishedCallbackHandler=null,this.finishedCallbackContext=null,this.reset()},__dtor:function(){this.block.free(),this.blockStack.clear().free(),this.cmdStack.clear().free(),null!==this.finishedCallbackHandler&&(this.finishedCallbackHandler.free(),this.finishedCallbackHandler=null),null!==this.finishedCallbackContext&&(this.finishedCallbackContext.free(),this.finishedCallbackContext=null)},copyTo:function(t){return t.clear(),dispose(t.block),t.block=this.block.clone(),t.initialData=this.initialData,t.reset()},clone:function(t=!1){let e=new he;return e.autoDispose=t,this.copyTo(e),e},onFinished:function(t){return this.finishedCallback=t,this},then:function(t,e=null){return t?(this.finishedCallback!==this.thenCallback&&(this.finishedCallback=this.thenCallback,null===this.finishedCallbackHandler?(this.finishedCallbackHandler=_.Pool.alloc(),this.finishedCallbackContext=_.Pool.alloc()):(this.finishedCallbackHandler.reset(),this.finishedCallbackContext.reset())),this.finishedCallbackHandler.push(t),this.finishedCallbackContext.push(e),this):this},thenCallback:function(t,e){if(!e.finishedCallbackHandler.length)return!1;let i=e.finishedCallbackContext.shift();return e.finishedCallbackHandler.shift()(e,i)},clear:function(){return this.blockStack.clear(),this.cmdStack.clear(),this.block.clear(),this.paused=!1,this.finished=!1,this.time=0,this.timeScale=1,null!==this.finishedCallbackHandler&&(this.finishedCallbackHandler.free(),this.finishedCallbackHandler=null),null!==this.finishedCallbackContext&&(this.finishedCallbackContext.free(),this.finishedCallbackContext=null),this.finishedCallback=null,this},reset:function(){return this.blockStack.clear(),this.cmdStack.clear(),this.block.reset(),this.paused=!1,this.finished=!1,this.time=0,this.timeScale=1,Object.assign(this.data,this.initialData),this},cleanup:function(){return this.blockStack.clear(),this.cmdStack.clear(),this.block.clear(),this.paused=!1,this.finished=!1,this.time=0,this.timeScale=1,this},initial:function(t=null){return null!==t&&(this.initialData=t),Object.assign(this.data,this.initialData),this},speed:function(t){return this.timeScale=t>0?t:1,this},output:function(t){return this.data=t,this},pause:function(){return this.paused||(this.paused=!0),this},resume:function(){return this.finished=!1,this.paused=!1,this.running||this.run(!1),this},run:function(t=!0){return this.running||(1==t&&this.reset(),zt.update.add(this.update,this),this.running=!0),this},setValue:function(t,e){let i=this.data;if("string"!=typeof t)if("function"==typeof t)t(this,e);else{let n=0;for(;null!==i&&n<t.length-1;)i=i[t[n++]];i[t[n]]=e}else i[t]=e},getValue:function(t,e=null,i=null){let n=this.data;if("string"!=typeof t)if("function"==typeof t)n=t(this,null);else{let e=0;for(;null!==n&&e<t.length;)n=n[t[e++]]}else n=n[t];if(null===e&&(e=n),null===i&&(i=n),"string"==typeof e)switch(e[0]){case"+":e=i+Number(e.substr(1));break;case"-":e=i-Number(e.substr(1));break;default:e=Number(e)}else"function"==typeof e&&(e=e(n,i,this));return e},update:function(t,e=null){if(null===e&&(e=this),e.paused||e.block.isFinished())return e.running=!1,!1;if(e.time+=t*e.timeScale*he.timeScale,!0!==e.block.update(e))return!0;let i=e.finished,n=e.block.stamp,s=e.block;return e.finished=!0,i||null===e.finishedCallback||(!1===e.finishedCallback(e.data,e)&&(e.finishedCallback=null),e.block===s&&e.block.stamp==n)?(e.running=!1,e.autoDispose&&dispose(e),!1):(e.resume(),!0)},prepareFieldName:function(t){return"function"==typeof t?t:-1!=t.indexOf(".")?t.split("."):t},parallel:function(){let t=this.block.add(Zt.alloc($t));return this.blockStack.push(this.block),this.cmdStack.push(t),this.block=t.block,this},serial:function(){let t=this.block.add(Zt.alloc(Jt));return this.blockStack.push(this.block),this.cmdStack.push(t),this.block=t.block,this},repeat:function(t){let e=this.block.add(Zt.alloc(te));return e.count=t,this.blockStack.push(this.block),this.cmdStack.push(e),this.block=e.block,this},end:function(){return this.cmdStack.pop().ready(),this.block=this.blockStack.pop(),this},set:function(t,e){let i=this.block.add(Zt.alloc(ee));return i.field=this.prepareFieldName(t),i.value=e,this},restart:function(){return this.block.add(Zt.alloc(ie)),this},wait:function(t){return this.block.add(Zt.alloc(ne)).duration=t,this},range:function(t,e,i,n,s=null){let r=this.block.add(Zt.alloc(se));return r.field=this.prepareFieldName(t),r.duration=e,r.startValue=i,r.endValue=n,r.easing=s,this},rangeTo:function(t,e,i,n=null){let s=this.block.add(Zt.alloc(se));return s.field=this.prepareFieldName(t),s.duration=e,s.startValue=null,s.endValue=i,s.easing=n,this},rand:function(t,e,i,n,s,r=null){let l=this.block.add(Zt.alloc(re));return l.field=this.prepareFieldName(t),l.duration=e,l.count=i,l.startValue=n,l.endValue=s,l.easing=r,this},randt:function(t,e,i,n,s,r){let l=this.block.add(Zt.alloc(le));return l.field=this.prepareFieldName(t),l.duration=e,l.count=i,l.startValue=n,l.endValue=s,l.easing=r,l.ready(),this},play:function(t){return this.block.add(Zt.alloc(oe)).snd=t,this},exec:function(t){return this.block.add(Zt.alloc(ae)).fn=t,this},_bounds_x1:function(t,e){if(null===e)return t.data.bounds.x1;t.data.translate(int(e)-t.data.bounds.x1,0)},_bounds_y1:function(t,e){if(null===e)return t.data.bounds.y1;t.data.translate(0,int(e)-t.data.bounds.y1)},setX:function(t){return this.set(this._bounds_x1,t)},setY:function(t){return this.set(this._bounds_y1,t)},position:function(t,e){return this.set(this._bounds_x1,t).set(this._bounds_y1,e)},translateX:function(t,e,i){return this.range(this._bounds_x1,t,null,(e<0?"-":"+")+Math.abs(e),i)},translateY:function(t,e,i){return this.range(this._bounds_y1,t,null,(e<0?"-":"+")+Math.abs(e),i)},translate:function(t,e,i,n,s=null){return this.parallel().range(this._bounds_x1,t,null,(e<0?"-":"+")+Math.abs(e),n).range(this._bounds_y1,t,null,(i<0?"-":"+")+Math.abs(i),s||n).end()},moveTo:function(t,e,i,n=null,s=null){return this.parallel().range(this._bounds_x1,t,null,e,n).range(this._bounds_y1,t,null,i,s||n).end()},moveX:function(t,e,i=null){return this.range(this._bounds_x1,t,null,e,i)},moveY:function(t,e,i=null){return this.range(this._bounds_y1,t,null,e,i)},scaleX:function(t,e,i){return this.range("sx",t,null,e,i)},scaleY:function(t,e,i){return this.range("sy",t,null,e,i)},scale:function(t,e,i,n,s=null){return this.parallel().range("sx",t,null,e,n).range("sy",t,null,i,s||n).end()},rotate:function(t,e,i){return this.range("angle",t,null,(e<0?"-":"+")+Math.abs(e),i)}});he.timeScale=1,he.speed=function(t){he.timeScale=t>0?t:1},p.createPool(he,2048);var ue=he;
//![import "../math/bounds2"]
//![import "../utils/handler"]
//!class GridElement
const ce=t.extend({className:"GridElement",id:null,bounds:null,flags:0,data:null,ext:null,container:null,_grid_remove_node:null,remover:null,__ctor:function(t,e,i,n){this.bounds=Xt.Pool.alloc(),this.bounds.translate(t,e),this.bounds.resize(i,n,!0),this.flags=ce.ALIVE|ce.VISIBLE|ce.DIRTY|ce.DEPTH_FLAG,this.data=null,this.ext=null,this.remover=Nt.Pool.alloc(this)},__dtor:function(){this.alive(!1),null!==this.data&&(dispose(this.data),this.data=null),this.remover.exec(),this.remover.free(),this.bounds.free()},setId:function(t){return this.id=t,this},setFlags:function(t){return this.flags|=t,this},clearFlags:function(t){return this.flags&=~t,this},getFlags:function(t,e=null){return null===e?(this.flags&t)===t:(this.flags&t)===e},setData:function(t){return this.data=t,null!==this.data&&(this.data.host=this),this},getData:function(){return this.data},setExt:function(t){return this.ext=t,this},getExt:function(){return this.ext},exec:function(t,e=null,i=null,n=null,s=null,r=null,l=null,a=null,o=null,h=null,u=null){return!(null===this.ext||!this.ext.hasOwnProperty(t))&&this.ext[t](this,e,i,n,s,r,l,a,o,h,u)},visible:function(t=null,e=!1){return null===t?!!(this.flags&ce.VISIBLE):(!e&&this.flags&ce.VISIBLE_LOCK||(this.flags&=~ce.VISIBLE,t&&(this.flags|=ce.VISIBLE)),this)},visibleLock:function(t=null){return null===t?!!(this.flags&ce.VISIBLE_LOCK):(this.flags&=~ce.VISIBLE_LOCK,t&&(this.flags|=ce.VISIBLE_LOCK),this)},alive:function(t=null){return null===t?!!(this.flags&ce.ALIVE):(this.flags&=~ce.ALIVE,t&&(this.flags|=ce.ALIVE),this)},dirty:function(t=null){return null===t?!!(this.flags&ce.DIRTY):(this.flags&=~ce.DIRTY,t&&(this.flags|=ce.DIRTY),this)},depthFlagEnabled:function(t=null){return null===t?!!(this.flags&ce.DEPTH_FLAG_ENABLED):(this.flags&=~ce.DEPTH_FLAG_ENABLED,t&&(this.flags|=ce.DEPTH_FLAG_ENABLED),this)},depthFlag:function(t=null){return null===t?!!(this.flags&ce.DEPTH_FLAG):(this.flags&=~ce.DEPTH_FLAG,t&&(this.flags|=ce.DEPTH_FLAG),this)},remove:function(){return this.remover.exec(),this},sync:function(){return null!==this.container&&this.getFlags(ce.ALIVE|ce.DIRTY)?(this.container.sync(this),this):this},resize:function(t,e){return this.flags|=ce.DIRTY,this.bounds.resize(t,e,!0),this},resizeBy:function(t,e){return this.flags|=ce.DIRTY,this.bounds.resizeBy(t,e,!0),this},translate:function(t,e,i=!1){return this.flags|=ce.DIRTY,this.bounds.translate(t,e,i),this},setPosition:function(t,e=!1){return!1===e&&(e=t.y,t=t.x),this.translate(null!==t?upscale(t)-this.bounds.ux1:0,null!==e?upscale(e)-this.bounds.uy1:0,!0)}});ce.ALIVE=1,ce.VISIBLE=2,ce.VISIBLE_LOCK=4,ce.DIRTY=8,ce.DEPTH_FLAG_ENABLED=16,ce.DEPTH_FLAG=32,ce.WRAP_EXTENTS=64,ce.USERDEF=256,ce.LAST_FLAG=128,ce.allocFlag=function(){let t=ce.LAST_FLAG;if(1073741824===t)throw new Error("allocFlag: out of bit space to allocate another flag");return t<<=1,ce.LAST_FLAG=t,t};var de=ce;
//![import "./grid-element"]
//![import "../utils/list"]
//!class Grid
var fe=t.extend({className:"Grid",grid:null,count:0,offsx:0,offsy:0,kx:0,ky:0,stride:0,verifyIntersection:!0,__ctor:function(t,e,i,n=null){t=1<<Math.ceil(Math.log2(t)),e=1<<Math.ceil(Math.log2(e)),this.offsx=t>>1,this.offsy=e>>1,null===n&&(n=i),i=Math.floor(Math.log2(i)),n=Math.floor(Math.log2(n)),this.kx=i,this.ky=n;let s=t>>i,r=e>>n;s||(i=Math.log2(t),s=1),r||(n=Math.log2(e),r=1),this.grid=new Array(s*r).fill(null),this.stride=s},__dtor:function(){this.clear(),this.grid=null},clear:function(){for(let t=0;t<this.grid.length;t++){if(null===this.grid[t])continue;let e;for(;null!==(e=this.grid[t].shift());)e.remover.remove(this._remove,this),e.container=null,dispose(e);this.grid[t].free(),this.grid[t]=null}this.count=0},reset:function(){for(let t=0;t<this.grid.length;t++){if(null===this.grid[t])continue;let e;for(;null!==(e=this.grid[t].shift());)e.remover.remove(this._remove,this),e.container=null;this.grid[t].free(),this.grid[t]=null}this.count=0},add:function(t){if(!de.isInstance(t))throw new Error("argument must be a GridElement");let e=int(t.bounds.y1+this.offsy>>this.ky)*this.stride+int(t.bounds.x1+this.offsx>>this.kx);return!(e<0||e>=this.grid.length)&&(null===this.grid[e]&&(this.grid[e]=_.Pool.alloc()),this.grid[e].push(t),this.count++,t.container=this,t._grid_remove_node=t.remover.add(this._remove,this,e,this.grid[e].bottom),!0)},_remove:function(t,e,i,n){return e.grid[i].remove(n),e.count--,t.container=null,!1},remove:function(t){return t.remover.execc(this._grid_remove_node),t},sync:function(t){t.clearFlags(de.DIRTY);let e=t._grid_remove_node,i=int(t.bounds.y1+this.offsy>>this.ky)*this.stride+int(t.bounds.x1+this.offsx>>this.kx);return i<0||i>=this.grid.length?(t.remover.execc(e),!1):(e.arg1===i||(this.grid[e.arg1].remove(e.arg2),null===this.grid[i]&&(this.grid[i]=_.Pool.alloc()),this.grid[i].push(t),e.arg1=i,e.arg2=this.grid[i].bottom),!0)},forEachInRegion:function(t,e,i,n,s){let r=(t.y1+this.offsy-(1<<this.ky-1)>>this.ky)*this.stride,l=(t.y2+this.offsy+(1<<this.ky-1)>>this.ky)*this.stride,a=t.x1+this.offsx-(1<<this.kx-1)>>this.kx,o=t.x2+this.offsx+(1<<this.kx-1)>>this.kx,h=this.grid.length-1;r<0&&(r=0),l<0&&(l=0),a<0&&(a=0),o<0&&(o=0),r>h&&(r=h),l>h&&(l=h),a>h&&(a=h),o>h&&(o=h);for(let u=r;u<=l;u+=this.stride)for(let c=a;c<=o;c++){let d=u+c;if(!(d>h||null===this.grid[d]))for(let h=this.grid[d].top;h;h=h.next)if(h.value.getFlags(e,i)&&(!this.verifyIntersection||!(u<=r+1||c<=a+1||u>=l-1||c>=o-1)||h.value.bounds.intersects(t))&&!1===n(h.value,s))return}},selectInRegion:function(t,e,i){let n=(t.y1+this.offsy-(1<<this.ky-1)>>this.ky)*this.stride,s=(t.y2+this.offsy+(1<<this.ky-1)>>this.ky)*this.stride,r=t.x1+this.offsx-(1<<this.kx-1)>>this.kx,l=t.x2+this.offsx+(1<<this.kx-1)>>this.kx,a=this.grid.length-1;n<0&&(n=0),s<0&&(s=0),r<0&&(r=0),l<0&&(l=0),n>a&&(n=a),s>a&&(s=a),r>a&&(r=a),l>a&&(l=a);let o=_.Pool.alloc();for(let h=n;h<=s;h+=this.stride)for(let u=r;u<=l;u++){let c=h+u;if(!(c>a||null===this.grid[c]))for(let a=this.grid[c].top;a;a=a.next)a.value.getFlags(e,i)&&(this.verifyIntersection&&(h<=n+1||u<=r+1||h>=s-1||u>=l-1)&&!a.value.bounds.intersects(t)||o.push(a.value))}return o},countInRegion:function(t,e,i){let n=(t.y1+this.offsy-(1<<this.ky-1)>>this.ky)*this.stride,s=(t.y2+this.offsy+(1<<this.ky-1)>>this.ky)*this.stride,r=t.x1+this.offsx-(1<<this.kx-1)>>this.kx,l=t.x2+this.offsx+(1<<this.kx-1)>>this.kx,a=this.grid.length-1;n<0&&(n=0),s<0&&(s=0),r<0&&(r=0),l<0&&(l=0),n>a&&(n=a),s>a&&(s=a),r>a&&(r=a),l>a&&(l=a);let o=0;for(let h=n;h<=s;h+=this.stride)for(let u=r;u<=l;u++){let c=h+u;if(!(c>a||null===this.grid[c]))for(let a=this.grid[c].top;a;a=a.next)a.value.getFlags(e,i)&&(this.verifyIntersection&&(h<=n+1||u<=r+1||h>=s-1||u>=l-1)&&!a.value.bounds.intersects(t)||o++)}return o},selectFirst:function(t,e,i){let n=(t.y1+this.offsy-(1<<this.ky-1)>>this.ky)*this.stride,s=(t.y2+this.offsy+(1<<this.ky-1)>>this.ky)*this.stride,r=t.x1+this.offsx-(1<<this.kx-1)>>this.kx,l=t.x2+this.offsx+(1<<this.kx-1)>>this.kx,a=this.grid.length-1;n<0&&(n=0),s<0&&(s=0),r<0&&(r=0),l<0&&(l=0),n>a&&(n=a),s>a&&(s=a),r>a&&(r=a),l>a&&(l=a);for(let o=n;o<=s;o+=this.stride)for(let h=r;h<=l;h++){let u=o+h;if(!(u>a||null===this.grid[u]))for(let a=this.grid[u].top;a;a=a.next)if(a.value.getFlags(e,i)&&(!this.verifyIntersection||!(o<=n+1||h<=r+1||o>=s-1||h>=l-1)||a.value.bounds.intersects(t)))return a.value}return null}});
//!class Container
const pe=t.extend({className:"Container",viewportBounds:null,width:0,height:0,zvalue:0,scene:null,flags:0,g:null,elementCount:0,drawCount:0,ldraw:null,__ctor:function(t=32768,e=32768){this.width=t,this.height=e,this.flags=pe.VISIBLE|pe.DEPTH_FLAG,this.ldraw=Nt.Pool.alloc(this)},__dtor:function(){this.ldraw.free()},visible:function(t=null){return null===t?!!(this.flags&pe.VISIBLE):(this.flags&=~pe.VISIBLE,t&&(this.flags|=pe.VISIBLE),this)},depthFlag:function(t=null){return null===t?!!(this.flags&pe.DEPTH_FLAG):(this.flags&=~pe.DEPTH_FLAG,t&&(this.flags|=pe.DEPTH_FLAG),this)},setViewportBounds:function(t){return this.viewportBounds=t,this},drawElement:function(t,e){return e.drawCount++,t.draw(e.g)},syncZ:function(t){t.__zvalue=this.zvalue+(t._zvalue+t.bounds.y2&262143)},sync:function(t){throw new Error("Container::sync not implemented")},clear:function(){throw new Error("Container::clear not implemented")},reset:function(){throw new Error("Container::reset not implemented")},add:function(t){throw new Error("Container::add not implemented")},remove:function(t){throw new Error("Container::remove not implemented")},draw:function(t){if(!this.visible())return;let e=t.pushDepthFlag(this.flags&pe.DEPTH_FLAG);t.zvalue=this.zvalue,this.drawCount=0,this.g=t,this.render(),this.ldraw.exec(t),e&&t.popDepthFlag()},render:function(){throw new Error("Container::render not implemented")}});pe.VISIBLE=1,pe.DEPTH_FLAG=2;var ge=pe;
//![import "../math/point2"]
//![import "../math/bounds2"]
//![import "../math/rect"]
//![import "../system/canvas"]
//!class Viewport
const me=t.extend({className:"Viewport",width:0,initialWidth:0,height:0,initialHeight:0,sx:0,sy:0,x:0,y:0,centerRatioX:0,centerRatioY:0,offset:null,container:null,focusFactorX:0,focusFactorY:0,focusRect:null,focusOffsX:0,focusOffsY:0,focusAxisX:!0,focusAxisY:!0,flags:0,scale:1,globalScale:1,bounds:null,padding:null,focusBounds:null,screenBounds:null,tmpPoint:null,__ctor:function(t,e,i,n,s,r){this.focusFactorX=.4,this.focusFactorY=.4,this.focusRect=null,this.sx=t,this.sy=e,this.width=this.initialWidth=i,this.height=this.initialHeight=n,this.x=0,this.y=0,this.bounds=Xt.Pool.alloc(),this.padding=null,this.focusBounds=Xt.Pool.alloc(),this.screenBounds=Xt.Pool.alloc(),this.container=Xt.Pool.alloc(),this.offset=Ot.Pool.alloc(),this.flags=me.ENABLED,this.tmpPoint=Ot.Pool.alloc(),this.setContainerBounds(-s>>1,-r>>1,s>>1,r>>1),this.updateScreenBounds(),this.updateBounds()},__dtor:function(){this.bounds.free(),this.focusBounds.free(),this.screenBounds.free(),this.container.free(),this.tmpPoint.free(),null!==this.padding&&this.padding.free()},enabled:function(t=null){return null===t?!!(this.flags&me.ENABLED):(this.flags&=~me.ENABLED,t&&(this.flags|=me.ENABLED),this)},topLeft:function(t=null){return null===t?!!(this.flags&me.TOP_LEFT):(this.flags&=~me.TOP_LEFT,t&&(this.flags|=me.TOP_LEFT),this)},setContainerBounds:function(t,e=null,i=null,n=null){return null===e&&(n=t.y2,i=t.x2,e=t.y1,t=t.x1),this.width=this.initialWidth,this.height=this.initialHeight,this.width>i-t&&(this.width=i-t),this.height>n-e&&(this.height=n-e),this.container.set(t,e,i,n),this},setPadding:function(t,e=null,i=null,n=null){return null===this.padding&&(this.padding=Xt.Pool.alloc()),null===e&&(i=n=t,t=e=-t),this.padding.set(t,e,i,n),this},updateBounds:function(t=!1){let e,i,n,s,r,l,a,o;e=this.width>>1,i=this.height>>1,n=e/this.scale,s=i/this.scale,r=this.x-n+this.offset.x,l=this.y-s+this.offset.y,a=this.x+n+this.offset.x,o=this.y+s+this.offset.y,t&&(r<this.container.x1?this.offset.setX(this.container.x1-this.x+n):a>this.container.x2&&this.offset.setX(this.container.x2-this.x-n),l<this.container.y1?this.offset.setY(this.container.y1-this.y+s):o>this.container.y2&&this.offset.setY(this.container.y2-this.y-s),r=this.x-n+this.offset.x,l=this.y-s+this.offset.y,a=this.x+n+this.offset.x,o=this.y+s+this.offset.y),this.bounds.set(r,l,a,o),null!==this.padding&&this.bounds.add(this.padding),this.focusBounds.set(this.x-(this.focusFactorX*e+this.centerRatioX*e)/this.scale,this.y-(this.focusFactorY*i+this.centerRatioY*i)/this.scale,this.x+(this.focusFactorX*e+this.centerRatioX*e)/this.scale,this.y+(this.focusFactorY*i+this.centerRatioY*i)/this.scale)},updateScreenBounds:function(){this.screenBounds.set(this.sx,this.sy,this.sx+this.width,this.sy+this.height)},resize:function(t,e){return this.width=this.initialWidth=t??this.width,this.height=this.initialHeight=e??this.height,this.updateScreenBounds(),this.updateBounds(),this},resizeBy:function(t,e){return this.width+=t,this.height+=e,this.initialWidth=this.width,this.initialHeight=this.height,this.updateScreenBounds(),this.updateBounds(),this},setPosition:function(t,e){return this.x=t??this.x,this.y=e??this.y,this.offset.set(0,0),this.updateBounds(),this},setOffsets:function(t,e){return this.offset.set(t,e),this.updateBounds(),this},setScale:function(t){return this.scale=t,this.updateBounds(),this},getScale:function(){return this.scale},setGlobalScale:function(t){return this.globalScale=t,this},getGlobalScale:function(){return this.globalScale},setCenter:function(t,e){return this.centerRatioX=t,this.centerRatioY=e,this},translate:function(t,e,i=!1){return this.offset.add(t,e),this.updateBounds(i),this},setScreenPosition:function(t,e){return this.sx=t,this.sy=e,this.updateScreenBounds(),this},getX:function(t=!1){return this.x+(t?0:this.offset.x)},getY:function(t=!1){return this.y+(t?0:this.offset.y)},getOffsetX:function(){return this.offset.x},getOffsetY:function(){return this.offset.y},getWidth:function(){return this.width},getHeight:function(){return this.height},focusX:function(t,e=null,i=null){null===i&&(i=this.focusFactorX),null===e&&(e=t);let n=this.width>>1,s=this.x-int((i*n+this.centerRatioX*n)/this.scale),r=this.x+int((i*n+this.centerRatioX*n)/this.scale);s==r&&(t=e=t+e>>1);let l=this.x;return t<s?l+=t-s:e>r&&(l+=e-r),s=l-n,r=l+n,s<this.container.x1&&(l=this.container.x1+n),r>this.container.x2&&(l=this.container.x2-n),this.x=l,this},focusY:function(t,e=null,i=null){null===i&&(i=this.focusFactorY),null===e&&(e=t);let n=this.height>>1,s=this.y-int((i*n+this.centerRatioY*n)/this.scale),r=this.y+int((i*n+this.centerRatioY*n)/this.scale);s==r&&(t=e=t+e>>1);let l=this.y;return t<s?l+=t-s:e>r&&(l+=e-r),s=l-n,r=l+n,s<this.container.y1&&(l=this.container.y1+n),r>this.container.y2&&(l=this.container.y2-n),this.y=l,this},update:function(t=0){null!==this.focusRect&&(this.focusAxisX&&this.focusX(this.focusRect.x1+this.focusOffsX,this.focusRect.x2+this.focusOffsX),this.focusAxisY&&this.focusY(this.focusRect.y1+this.focusOffsY,this.focusRect.y2+this.focusOffsY),this.updateBounds())},updateForced:function(t=0){null!==this.focusRect&&(this.focusX(this.focusRect.x1+this.focusOffsX,this.focusRect.x2+this.focusOffsX),this.focusY(this.focusRect.y1+this.focusOffsY,this.focusRect.y2+this.focusOffsY),this.updateBounds())},setFocusRect:function(t,e=0,i=0){return this.focusRect=t,this.focusOffsX=e,this.focusOffsY=i,this.update(0),this},setFocusOffsets:function(t,e){return this.focusOffsX=t,this.focusOffsY=e,this},setFocusAxes:function(t,e){return this.focusAxisX=t,this.focusAxisY=e,this},setFocusFactor:function(t,e){return this.focusFactorX=t,this.focusFactorY=void 0===e?t:e,this},applyClip:function(t){t.clip(this.screenBounds.x1,this.screenBounds.y1,this.screenBounds.width(),this.screenBounds.height())},applyTransform:function(t){this.flags&me.TOP_LEFT?t.translate(this.screenBounds.x1,this.screenBounds.y1):t.translate(this.screenBounds.cx,this.screenBounds.cy),1!=this.scale&&t.scale(this.scale,this.scale),1!=this.globalScale&&t.scale(this.globalScale,this.globalScale),this.flags&me.TOP_LEFT?t.translate(-this.bounds.x1,-this.bounds.y1):t.translate(-this.bounds.cx,-this.bounds.cy),t.updateTransform()},toWorldSpace:function(t,e=null,i=!1){let n,s;return null!==e&&!0!==e||(i=!0===e,e=t.y,t=t.x),this.flags&me.TOP_LEFT?(n=this.screenBounds.x1,s=this.screenBounds.y1,i?(t=(t-int(n))/this.scale+int(this.bounds.x1),e=(e-int(s))/this.scale+int(this.bounds.y1)):(t=(t-n)/this.scale+this.bounds.x1,e=(e-s)/this.scale+this.bounds.y1)):(n=this.screenBounds.cx,s=this.screenBounds.cy,i?(t=(t-int(n))/this.scale+int(this.bounds.cx),e=(e-int(s))/this.scale+int(this.bounds.cy)):(t=(t-n)/this.scale+this.bounds.cx,e=(e-s)/this.scale+this.bounds.cy)),this.tmpPoint.set(t,e)},toScreenSpace:function(t,e=null,i=!1){let n,s;return null!==e&&!0!==e||(i=!0===e,e=t.y,t=t.x),this.flags&me.TOP_LEFT?(n=this.screenBounds.x1,s=this.screenBounds.y1,i?(t=(t-int(this.bounds.x1))*this.scale+int(n),e=(e-int(this.bounds.y1))*this.scale+int(s)):(t=(t-this.bounds.x1)*this.scale+n,e=(e-this.bounds.y1)*this.scale+s)):(n=this.screenBounds.cx,s=this.screenBounds.cy,i?(t=(t-int(this.bounds.cx))*this.scale+int(n),e=(e-int(this.bounds.cy))*this.scale+int(s)):(t=(t-this.bounds.cx)*this.scale+n,e=(e-this.bounds.cy)*this.scale+s)),this.tmpPoint.set(t,e)}});me.ENABLED=1,me.TOP_LEFT=2;var ye=me;
//![import "./grid-element"]
//![import "../system/globals"]
//![import "../utils/recycler"]
//![import "../system/system"]
//![import "../system/canvas"]
//![import "../system/shader-program"]
//!class Element extends GridElement
const _e=de.extend({className:"Element",group:null,img:null,debugBounds:!1,_zvalue:0,__zvalue:0,_alpha:1,_shaderProgram:null,_uniformSetter:null,render:null,__ctor:function(t,e,i=null,n=null,s=null){null===i&&(i=n=0),null===n&&(i=(s=i).width,n=s.height),this._super.GridElement.__ctor(t,e,i,n),this.img=null!==s?s.getDrawable():s,this.group=null,this.debugBounds=!1,this._zvalue=0,this.__zvalue=0,this._alpha=1,this._shaderProgram=null,this._uniformSetter=null,this.render=null},__dtor:function(){null!==this.img&&(dispose(this.img),this.img=null),this._super.GridElement.__dtor()},destroyLater:function(){this.alive()&&(null!==this.container?this.container.scene.disposeLater(this):dispose(this))},debug:function(t=null){return null===t?this.debugBounds:(this.debugBounds=0===t||t,this)},root:function(){let t=this;for(;null!==t.group;)t=t.group;return t},alpha:function(t=null){return null===t?this._alpha:(this._alpha=t,this)},zvalue:function(t=null){return null===t?this._zvalue:(this._zvalue=t,this)},shaderProgram:function(t=!1){return!1===t?this._shaderProgram:("string"==typeof t&&(t=M.get(t)),this._shaderProgram=t,this)},uniformSetter:function(t){return this._uniformSetter=t,this},draw:function(t){if(!(this._alpha<=0)){if(null!==this.img||null!==this.render){let e=null!==this._shaderProgram&&t.pushShaderProgram(this._shaderProgram),i=!!this.depthFlagEnabled()&&t.pushDepthFlag(this.depthFlag());null!==this._shaderProgram&&null!==this._uniformSetter&&null!==t.gl&&this._uniformSetter(t.getShaderProgram(),this,t.gl),t.zvalue=this.__zvalue,1!=this._alpha&&(t.pushAlpha(),t.alpha(this._alpha)),null!==this.render?this.render(t,this,this.img):this.img.render(t,this),i&&t.popDepthFlag(),e&&t.popShaderProgram(),1!=this._alpha&&t.popAlpha()}if(Y.debugBounds||this.debugBounds){let e=t.getMatrix();(t=H.displayBuffer2).pushMatrix(),t.loadMatrix(e),t.fillStyle(_e.getDebugColor(this.debugBounds)),t.fillRect(this.bounds.x1,this.bounds.y1,this.bounds.width(),this.bounds.height()),t.popMatrix()}}},renderWith:function(t){return this.render=t??null,this}});_e.debugColors=["rgba(0,255,255,0.35)","rgba(255,255,0,0.35)","rgba(255,0,255,0.35)","rgba(255,255,255,0.35)","rgba(255,0,0,0.35)","rgba(0,255,0,0.35)","rgba(0,0,255,0.35)","rgba(128,128,128,0.35)"],_e.getDebugColor=function(t){return!0!==t&&!1!==t||(t=0),_e.debugColors[7&~~t]},
//!/class
//!namespace Element
//!namespace Pool
p.createPool(_e);var xe=_e;
//![import "./element"]
//![import "../utils/list"]
//![import "../math/point2"]
//![import "../utils/recycler"]
const ve=Ot.Pool.alloc(),be=xe.extend({className:"Group",children:null,ref:null,__ctor:function(t=null){this._super.Element.__ctor(0,0,0,0),this.children=_.Pool.alloc(),this.bounds.reset(),this.ref=Ot.Pool.alloc(),this.setId(t)},__dtor:function(){this.clear(),this.children.free(),this.ref.free(),this._super.Element.__dtor()},destroyLater:function(){if(!this.alive())return;let t;for(;null!=(t=this.children.shift());)t.remover.remove(this._remove,this),t.group=null,t.destroyLater();this._super.Element.destroyLater()},clear:function(){let t;for(;null!=(t=this.children.shift());)t.remover.remove(this._remove,this),t.group=null,dispose(t);return this},reset:function(){let t;for(;null!=(t=this.children.shift());)t.remover.remove(this._remove,this),t.group=null;return this},wrapExtents:function(t=null){return null===t?!!(this.flags&de.WRAP_EXTENTS):(this.flags&=~de.WRAP_EXTENTS,t&&(this.flags|=de.WRAP_EXTENTS),this)},addChild:function(t,e=!1){if(!t)return t;let i=null===this.bounds.x1;return(i||this.flags&de.WRAP_EXTENTS)&&((i||t.bounds.x1<this.bounds.x1)&&this.ltranslate(t.bounds.x1-this.bounds.x1,0),(i||t.bounds.y1<this.bounds.y1)&&this.ltranslate(0,t.bounds.y1-this.bounds.y1),(i||t.bounds.x2>this.bounds.x2)&&this.resizeBy(t.bounds.x2-this.bounds.x2,0),(i||t.bounds.y2>this.bounds.y2)&&this.resizeBy(0,t.bounds.y2-this.bounds.y2)),this.children.push(t),null!==t.id&&(this[t.id]=t),!0===e&&t.translate(this.bounds.x1,this.bounds.y1),t.group=this,t.remover.add(this._remove,this,this.children.bottom),t},getChild:function(t){return this[t]||null},_remove:function(t,e,i){return e.children.remove(i),t.group=null,null!==t.id&&(e[t.id]=null),!1},removeChild:function(t){return t&&t.group===this?(t.remover.execf(this._remove,this),t):t},sync:function(){for(let t=this.children.top;t;t=t.next)t.value.sync();return this._super.Element.sync()},ltranslate:function(t,e,i=!1){return this._super.Element.translate(t,e,i)},translate:function(t,e,i=!1){let n=this.bounds.x1,s=this.bounds.y1;this._super.Element.translate(t,e,i),this.ref.add(t,e,i),n=this.bounds.x1-n,s=this.bounds.y1-s;for(let t=this.children.top;t;t=t.next)t.value.translate(n,s);return this},getOffsets:function(t,e,i=!1){ve.set(this.bounds.ux1,this.bounds.uy1,!0);let n=ve.x,s=ve.y;return ve.add(t,e,i),n=ve.x-n,s=ve.y-s,ve.set(n,s),ve.x-=t,ve.y-=e,ve},setFlags:function(t){for(let e=this.children.top;e;e=e.next)e.value.setFlags(t);return this._super.Element.setFlags(t)},clearFlags:function(t){for(let e=this.children.top;e;e=e.next)e.value.clearFlags(t);return this._super.Element.clearFlags(t)},visible:function(t=null,e=!1){if(null===t)return this._super.Element.visible();for(let i=this.children.top;i;i=i.next)i.value.visible(t,e);return this._super.Element.visible(t,e)},alpha:function(t=null){if(null===t)return this._super.Element.alpha();for(let e=this.children.top;e;e=e.next)e.value.alpha(t);return this._super.Element.alpha(t)}});
//!class Group extends Element
//!/class
//!namespace Group
//!namespace Pool
p.createPool(be);var Ee=be;
//![import "./container"]
//![import "./viewport"]
//![import "./group"]
//![import "../math/bounds2"]
//![import "../utils/list"]
//![import "../utils/handler"]
//![import "../system/globals"]
//!class Scene
const we=t.extend({className:"Scene",minWidth:null,minHeight:null,maxWidth:null,maxHeight:null,containers:null,viewports:null,viewportBounds:null,groupList:null,groups:null,disposalQueue:null,fupdater:null,updater:null,synchronizer:null,lupdater:null,destroyer:null,dt:0,flags:0,drawCount:0,scene:null,zvalue:null,name:null,__ctor:function(t,e=null){this.containers=[],this.zvalue=(3&t)<<22,this.name=null!==e?e:"SCENE_"+t,this.viewports=[],this.viewportBounds=Xt.Pool.alloc(),this.groupList=_.Pool.alloc(),this.groups={},this.disposalQueue=_.Pool.alloc(),this.fupdater=Nt.Pool.alloc(this),this.updater=Nt.Pool.alloc(this),this.synchronizer=Nt.Pool.alloc(this),this.lupdater=Nt.Pool.alloc(this),this.destroyer=Nt.Pool.alloc(this),this.flags=we.VISIBLE,this.scene=this},__dtor:function(){let t;for(this.disposeQueued(),this.disposalQueue.free(),this.destroyer.exec(),this.destroyer.free(),this.fupdater.free(),this.updater.free(),this.synchronizer.free(),this.lupdater.free();null!==(t=this.groupList.shift());)t.remover.remove(this._remove,this),t.container=null,dispose(t);for(t=0;t<this.containers.length;t++)this.containers[t]&&(this.containers[t].scene=null,dispose(this.containers[t]),this.containers[t]=null);for(t=0;t<this.viewports.length;t++)this.viewports[t]&&(dispose(this.viewports[t]),this.viewports[t]=null);this.viewportBounds.free(),this.groupList.free()},clear:function(){let t;for(this.disposeQueued();null!==(t=this.groupList.shift());)t.remover.remove(this._remove,this),t.container=null,dispose(t);for(t=0;t<this.containers.length;t++)this.containers[t]&&this.containers[t].clear()},visible:function(t=null){return null===t?!!(this.flags&we.VISIBLE):(this.flags&=~we.VISIBLE,t&&(this.flags|=we.VISIBLE),this)},setContainer:function(t,e){if(t<0)return this;if(t&=15,null===e)return this.containers[t].scene=null,this.containers[t]=null,this;if(!ge.isInstance(e))throw new Error("Scene: Unable to set container at index "+t+": argument is not a Container");return(null===this.minWidth||e.width<this.minWidth)&&(this.minWidth=e.width),(null===this.minHeight||e.height<this.minHeight)&&(this.minHeight=e.height),(null===this.maxWidth||e.width>this.maxWidth)&&(this.maxWidth=e.width),(null===this.maxHeight||e.height>this.maxHeight)&&(this.maxHeight=e.height),e.scene=this,e.zvalue=this.zvalue+(t<<18),this.containers[t]=e,this},getContainer:function(t){return t<0||t>=this.containers.length?null:this.containers[t]},setViewport:function(t,e){if(t<0)return this;if(null!==e&&!ye.isInstance(e))throw new Error("Scene: Unable to set viewport at index "+t+": argument is not a Viewport.");return this.viewports[t]=e,this},getViewport:function(t){return t<0||t>=this.viewports.length?null:this.viewports[t]},disposeLater:function(t){t.alive()&&(this.disposalQueue.push(t),t.alive(!1))},disposeQueued:function(){let t;for(;null!==(t=this.disposalQueue.shift());)dispose(t)},addGroup:function(t){if(!Ee.isInstance(t))throw new Error("argument must be a Group");return this.groupList.push(t),null!==t.id&&(this.groups[t.id]=t),t.container=this,t.remover.add(this._removeGroup,this,this.groupList.bottom),!0},_removeGroup:function(t,e,i){return t.container=null,e.groupList.remove(i),null!==t.id&&(e.groups[t.id]=null),!1},removeGroup:function(t){return t.remover.execf(this._remove,this),t},sync:function(t){return!0},draw:function(t){if(this.visible()){if(this.drawCount=0,this.viewports.length)for(let e=0;e<this.viewports.length;e++){let i=this.viewports[e];i&&i.enabled()&&(Y.viewport=i,t.pushClip(),t.pushMatrix(),i.applyClip(t),i.applyTransform(t),this.viewportBounds.set(i.bounds),this.drawContainers(t,this.viewportBounds),t.popMatrix(),t.popClip())}else this.drawContainers(t,null);W.enabled&&(W.vars[this.name]=this.drawCount)}},drawContainers:function(t,e){try{for(let i=0;i<this.containers.length;i++)this.containers[i]&&(this.containers[i].setViewportBounds(e),this.containers[i].draw(t),this.drawCount+=this.containers[i].drawCount)}catch(t){if("FRAME_END"!==t.message)throw t}},updateViewports:function(){for(let t=0;t<this.viewports.length;t++)this.viewports[t]&&this.viewports[t].update(this.dt)},update:function(t){this.dt=t,this.fupdater.exec(),this.updater.exec(),this.disposeQueued(),this.synchronizer.exec(),this.updateViewports(),this.lupdater.exec()}});we.VISIBLE=1;var Te=we;
//![import "../utils/list"]
//![import "./element"]
//!class Updater
var Re=t.extend({className:"Updater",scene:null,list:null,__update:null,__context:null,__preupdate:null,__postupdate:null,__ctor:function(t,e=null,i=null){this.list=_.Pool.alloc(),this.scene=t,this.__update=e,this.__context=i,this.__preupdate=null,this.__postupdate=null,this.scene.updater.add(this._update,this),this.scene.synchronizer.add(this._sync,this),this.scene.destroyer.add(this._destroy,this)},__dtor:function(){let t;for(this.scene.updater.remove(this._update,this),this.scene.synchronizer.remove(this._sync,this),this.scene.destroyer.remove(this._destroy,this);null!==(t=this.list.shift());)t.remover.remove(this._remove,this);this.list.free()},_destroy:function(t,e){dispose(e)},reset:function(){for(;null!==(i=this.list.shift());)i.remover.remove(this._remove,this);return this},clear:function(){for(;null!==(i=this.list.shift());)i.remover.remove(this._remove,this),dispose(i);return this},preUpdate:function(t){return this.__preupdate=t,this},postUpdate:function(t){return this.__postupdate=t,this},add:function(t){if(!xe.isInstance(t))throw new Error("argument must be of type: Element");return this.list.push(t),t.remover.add(this._remove,this,this.list.bottom),t},_remove:function(t,e,i){return e.list.remove(i),!1},remove:function(t){return t.remover.execf(this._remove,this),t},_sync:function(t,e){for(let t=e.list.top;t;t=t.next)t.value.sync()},_update:function(t,e){e.update(t.dt)},update:function(t){if(null!==this.__preupdate&&this.__preupdate(this.list,t,this.__context),null!==this.__update){let e=null;for(let i=this.list.top;i;i=e)e=i.next,!1===this.__update(i.value,t,this.__context)&&this.remove(i.value)}null!==this.__postupdate&&this.__postupdate(this.list,t,this.__context)}}),//![import "./container"]
//![import "./grid-element"]
//![import "./element"]
//![import "../utils/list"]
//!class SimpleContainer extends Container
Ie=ge.extend({className:"SimpleContainer",list:null,__ctor:function(t=0,e=0){this._super.Container.__ctor(t,e),this.list=_.Pool.alloc(),this.depthFlag(!1)},__dtor:function(){this.clear(),this.list.free(),this._super.Container.__dtor()},sync:function(t){return this.syncZ(t),!0},clear:function(){let t;for(;null!==(t=this.list.shift());)t.remover.remove(this._remove,this),t.container=null,dispose(t);this.elementCount=0},reset:function(){let t;for(;null!==(t=this.list.shift());)t.remover.remove(this._remove,this),t.container=null;this.elementCount=0},add:function(t){if(!xe.isInstance(t))throw new Error("argument must be an Element");return this.list.push(t),this.elementCount++,t.container=this,t.remover.add(this._remove,this,this.list.bottom),this.syncZ(t),t},_remove:function(t,e,i){return e.list.remove(i),e.elementCount--,t.container=null,!1},remove:function(t){return t.remover.execf(this._remove,this),t},render:function(){let t=de.ALIVE|de.VISIBLE;for(let e=this.list.top;e&&(!e.value.getFlags(t)||!1!==this.drawElement(e.value,this));e=e.next);}}),//![import "./container"]
//![import "./grid"]
//![import "./grid-element"]
//![import "./element"]
//![import "../system/globals"]
//![import "../system/system"]
//!class GridContainer extends Container
Pe=ge.extend({className:"GridContainer",grid:null,debugBounds:!1,__ctor:function(t=32768,e=32768,i=64,n=null){this._super.Container.__ctor(t,e),this.grid=new fe(t,e,i,n)},__dtor:function(){this.clear(),this._super.Container.__dtor()},sync:function(t){return this.syncZ(t),this.grid.sync(t)},clear:function(){this.grid.clear()},reset:function(){this.grid.reset()},add:function(t){if(!xe.isInstance(t))throw new Error("argument must be an Element");return this.grid.add(t)?(t.container=this,this.elementCount=this.grid.count,this.syncZ(t),t):null},remove:function(t){return this.grid.remove(t),this.elementCount=this.grid.count,t},render:function(){if(this.grid.forEachInRegion(this.viewportBounds,de.ALIVE|de.VISIBLE,de.ALIVE|de.VISIBLE,this.drawElement,this),!this.debugBounds||null===this.viewportBounds)return;let t=H.displayBuffer2;t.pushMatrix(),t.loadMatrix(this.g.getMatrix());let e=(this.viewportBounds.y1+this.grid.offsy-(1<<this.grid.ky-1)>>this.grid.ky)*this.grid.stride,i=(this.viewportBounds.y2+this.grid.offsy+(1<<this.grid.ky-1)>>this.grid.ky)*this.grid.stride,n=this.viewportBounds.x1+this.grid.offsx-(1<<this.grid.kx-1)>>this.grid.kx,s=this.viewportBounds.x2+this.grid.offsx+(1<<this.grid.kx-1)>>this.grid.kx;e=(int(e/this.grid.stride)<<this.grid.ky)-this.grid.offsy,i=(int(i/this.grid.stride)<<this.grid.ky)-this.grid.offsy+(1<<this.grid.ky),n=(n<<this.grid.kx)-this.grid.offsx,s=(s<<this.grid.kx)-this.grid.offsx+(1<<this.grid.kx),t.fillStyle("rgba(255,0,0,0.2)"),t.fillRect(n,e,s-n+1,i-e+1),e=this.viewportBounds.y1,i=this.viewportBounds.y2,n=this.viewportBounds.x1,s=this.viewportBounds.x2,t.lineWidth(1/H.canvasScaleFactor),t.strokeStyle("#fff"),t.strokeRect(n,e,s-n+1,i-e+1),t.lineWidth(1/H.canvasScaleFactor),t.strokeStyle("#008");for(let e=Y.viewport.container.y1+this.grid.offsy;e<Y.viewport.container.y2+this.grid.offsy;e+=1<<this.grid.ky)for(let i=Y.viewport.container.x1+this.grid.offsx;i<Y.viewport.container.x2+this.grid.offsx;i+=1<<this.grid.kx)t.strokeRect(i-this.grid.offsx,e-this.grid.offsy,1<<this.grid.kx,1<<this.grid.ky);t.popMatrix()},forEachInRegion:function(t,e,i,n,s){this.grid.forEachInRegion(t,e,i,n,s)},selectInRegion:function(t,e,i){return this.grid.selectInRegion(t,e,i)},countInRegion:function(t,e,i){return this.grid.countInRegion(t,e,i)},selectFirst:function(t,e,i){return this.grid.selectFirst(t,e,i)}});
//![import "./element"]
//![import "../system/system"]
//![import "../utils/recycler"]
//!class Mask extends Element
const Ae=xe.extend({className:"Mask",type:0,__ctor:function(t,e,i,n,s){this._super.Element.__ctor(e,i,n,s),this.type=t},draw:function(t){if(!Y.debugMasks&&!this.debugBounds)return;let e=t.getMatrix();(t=H.displayBuffer2).pushMatrix(),t.loadMatrix(e),t.fillStyle(xe.getDebugColor(this.debugBounds)),t.fillRect(this.bounds.x1,this.bounds.y1,this.bounds.width(),this.bounds.height()),t.popMatrix()}});
//!/class
//!namespace Mask
//!namespace Pool
p.createPool(Ae);var Se=Ae;
//![import "./element"]
//![import "../utils/recycler"]
//!class Label extends Element
const ke=xe.extend({className:"Label",sx:0,sy:0,text:null,font:null,_dirty:!1,textWidth:null,textHeight:null,_align:-1,_valign:-1,textOffsetX:null,textOffsetY:null,__ctor:function(t,e,i,n){this._super.Element.__ctor(this.sx=t,this.sy=e,1,1),this.text=null,this.font=i,this._align=-1,this._valign=-1,this.renderWith(this.renderText),this.setText(n)},align:function(t){return this._align===t?this:(this._align=t,this.textOffsetX=null,this.update())},valign:function(t){return this._valign===t?this:(this._valign=t,this.textOffsetY=null,this.update())},setText:function(t){return this.text===t?this:(this.text=t,this._dirty=!0,this.update())},setFont:function(t){return this.font===t?this:(this.font=t,this._dirty=!0,this.update())},update:function(){return!0===this._dirty&&(this.textOffsetX=null,this.textOffsetY=null,this.textWidth=this.font.measureWidth(this.text),this.textHeight=this.font.measureHeight(this.text),this._dirty=!1),null===this.textOffsetX&&(this._align<0?this.textOffsetX=0:0===this._align?this.textOffsetX=-this.textWidth>>1:this.textOffsetX=-this.textWidth,this.bounds.translate(-this.bounds.x1+this.sx+this.textOffsetX,0),this.bounds.resize(this.textWidth,null,!0)),null===this.textOffsetY&&(this._valign<0?this.textOffsetY=0:0===this._valign?this.textOffsetY=-this.textHeight>>1:this.textOffsetY=-this.textHeight,this.bounds.translate(0,-this.bounds.y1+this.sy+this.textOffsetY),this.bounds.resize(null,this.textHeight,!0)),this},translate:function(t,e,i=!1){return this.sx+=!0===i?downscale(t):t,this.sy+=!0===i?downscale(e):e,this._super.Element.translate(t,e,i)},renderText:function(t,e,i){e.font.drawText(t,e.bounds.x1,e.bounds.y1,e.text)}});
//!/class
//!namespace Label
//!namespace Pool
p.createPool(ke);var Fe=ke,//![import "../utils/priority-queue"]
//![import "./boot"]
//![import "../system/system"]
//!namespace KeyboardHandler
//!type Handler =
//!/type
//!/namespace
//!class KeyboardHandler
Ce=Vt.Module.create({handlers:null,__ctor:function(){const t=this;this._super.Module.__ctor(),this.handlers=new St,this._callOnKeyboardEvent=function(e){return t.callOnKeyboardEvent(e)}},register:function(t){try{this.handlers.add(t),"init"in t&&t.init()}catch(t){throw new Error("KeyboardHandler (register): "+t.message)}return t},unregister:function(t){try{this.handlers.remove(t),this.handlers.cleanup()}catch(t){throw new Error("KeyboardHandler (unregister): "+t.message)}},callOnKeyboardEvent:function(t){return t.onKeyboardEvent(this._action,this._keyCode,this._keyState)},onStartup:function(){H.onKeyboardEvent=(t,e,i)=>{this._action=t,this._keyCode=e,this._keyState=i,this.handlers.forEach(this._callOnKeyboardEvent)}},onShutdown:function(){H.onKeyboardEvent=null}}),//![import "../utils/priority-queue"]
//![import "./boot"]
//![import "../system/system"]
//!namespace PointerHandler
//!type Handler =
//!/type
//!/namespace
//!class PointerHandler
Ne=Vt.Module.create({handlers:null,__ctor:function(){const t=this;this._super.Module.__ctor(),this.handlers=new St,this._callOnPointerEvent=function(e){return t.callOnPointerEvent(e)}},register:function(t){try{this.handlers.add(t),"init"in t&&t.init()}catch(t){throw new Error("PointerHandler (register): "+t.message)}return t},unregister:function(t){try{this.handlers.remove(t),this.handlers.cleanup()}catch(t){throw new Error("PointerHandler (unregister): "+t.message)}},callOnPointerEvent:function(t){return t.onPointerEvent(this._action,this._p,this._pointers)},onStartup:function(){H.onPointerEvent=(t,e,i)=>{this._action=t,this._p=e,this._pointers=i,this.handlers.forEach(this._callOnPointerEvent)}},onShutdown:function(){H.onPointerEvent=null}});
//![import "./keyboard-handler"]
//![import "./pointer-handler"]
//![import "../system/system"]
//!namespace ScreenControls
//!type Handler =
//!/type
//!/namespace
//!class ScreenControls
const De={priority:5,Handler:Nt,list:[],hoverFlag:!1,zindexFlag:!1,lastFrame:0,add:function(t){-1===this.list.indexOf(t)&&this.list.push(t)},remove:function(t){let e=this.list.indexOf(t);-1!==e&&this.list.splice(e,1)},hover:function(t=null){if(null===t)return this.hoverFlag;this.hoverFlag=t},zindex:function(t=null){if(null===t)return this.zindexFlag;this.zindexFlag=t},findTarget:function(t,e,i=null){if(this.zindexFlag&&this.lastFrame!=H.frameNumber){let t=this.list[0].zindex;for(let e of this.list){if(e.zindex>t){this.list=this.list.sort(((t,e)=>e.zindex-t.zindex));break}t=e.zindex}this.lastFrame=H.frameNumber}for(let n=0;n<this.list.length;n++)if(this.list[n]&&(null===i||!1!==i(this.list[n]))&&this.list[n].containsPoint(t,e))return this.list[n];return null},filterHover:function(t){return"hover"in t},onPointerEvent:function(t,e,i){let n=!0,s=null;switch(t){case H.PointerEventType.POINTER_DOWN:null!=e._ref&&(s=e._ref,e._ref=null,s.pointerDeactivate(e)),s=this.findTarget(e.x,e.y),null!=s&&((e._ref=s).pointerActivate(e),n=!1);break;case H.PointerEventType.POINTER_DRAG_START:null!=e._ref&&(n=!1);break;case H.PointerEventType.POINTER_DRAG_MOVE:this.hoverFlag&&(null!=e._refh?e._refh.containsPoint(e.x,e.y)||(s=e._refh,e._refh=null,s.hover(!1,e),s=this.findTarget(e.x,e.y,this.filterHover),null!=s&&(e._refh=s).hover(!0,e)):(s=this.findTarget(e.x,e.y,this.filterHover),null!=s&&(e._refh=s).hover(!0,e))),null!=e._ref?e._ref.containsPoint(e.x,e.y)||1==e._ref.focusLock?(e._ref.pointerUpdate(e.x,e.y,e),n=!1):(s=e._ref,e._ref=null,s.pointerDeactivate(e),s=this.findTarget(e.x,e.y),null!=s&&((e._ref=s).pointerActivate(e),n=!1)):(s=this.findTarget(e.x,e.y),null!=s&&((e._ref=s).pointerActivate(e),n=!1));break;case H.PointerEventType.POINTER_MOVE:if(this.hoverFlag&&(null!=e._refh?e._refh.containsPoint(e.x,e.y)||(s=e._refh,e._refh=null,s.hover(!1,e),s=this.findTarget(e.x,e.y,this.filterHover),null!=s&&(e._refh=s).hover(!0,e)):(s=this.findTarget(e.x,e.y,this.filterHover),null!=s&&(e._refh=s).hover(!0,e))),null==e._ref)break;e._ref.containsPoint(e.x,e.y)||1==e._ref.focusLock?(e._ref.pointerUpdate(e.x,e.y,e),n=!1):(s=e._ref,e._ref=null,s.pointerDeactivate(e));break;case H.PointerEventType.POINTER_DRAG_STOP:null!=e._ref&&(n=!1);break;case H.PointerEventType.POINTER_UP:null!=e._ref&&(s=e._ref,e._ref=null,s.pointerDeactivate(e),n=!1)}return n},onKeyboardEvent:function(t,e,i){switch(t){case H.KeyboardEventType.KEY_DOWN:for(let t=0;t<this.list.length&&(!this.list[t]||!this.list[t].keyboardEvents||!1!==this.list[t].keyDown(e,i));t++);break;case H.KeyboardEventType.KEY_UP:for(let t=0;t<this.list.length&&(!this.list[t]||!this.list[t].keyboardEvents||!1!==this.list[t].keyUp(e,i));t++);}return!0}};
//!/class
Ne.register(De),Ce.register(De);var Me=De,//![import "./group.js"]
//![import "./mask.js"]
//![import "./screen-controls.js"]
//!class Button extends Group
Le=Ee.extend({focusLock:!1,keyboardEvents:!0,isPressed:!1,wasPressed:!1,unpressedImg:null,pressedImg:null,keyCode:null,hitbox:null,_onButtonDown:null,_onButtonUp:null,_onTap:null,_onChange:null,__ctor:function(t,e,i,n=null,s=null){this._super.Group.__ctor(),this.unpressedImg=n,this.pressedImg=s??n,this.hitbox=null;let r=Se.Pool.alloc(0,e,i,this.unpressedImg?this.unpressedImg.width:16,this.unpressedImg?this.unpressedImg.height:16).visible(!1).visibleLock(!0).debug(2);this.addChild(r),t.add(r),t.add(this),this.hitbox=r,this._onButtonDown=null,this._onButtonUp=null,this._onTap=null,this._onChange=this._default_onChange,this.reset(),Me.add(this)},__dtor:function(){this._super.Group.__dtor(),Me.remove(this)},resize:function(t,e){return this._super.Group.resize(t,e),null!==this.hitbox&&this.hitbox.resize(t,e),this},resizeBy:function(t,e){return this._super.Group.resizeBy(t,e),null!==this.hitbox&&this.hitbox.resizeBy(t,e),this},setImage:function(t,e=null){return this.unpressedImg=t,this.pressedImg=e||t,this.reset(),this},setKeyCode:function(t){return this.keyCode=t,this},reset:function(){return this.img=this.unpressedImg,this._onChange(this.isPressed=!1,this.wasPressed=!1,this),this},pointerUpdate:function(t,e,i){},setStatus:function(t){return this.isPressed===t||(this.updateStatus(t),this.img=this.isPressed?this.pressedImg:this.unpressedImg,this._onChange(this.isPressed,this.wasPressed,this)),this},updateStatus:function(t=null){return this.wasPressed=this.isPressed,this.isPressed=null===t?this.isPressed:t,this},pointerActivate:function(t){this.setStatus(!0)},pointerDeactivate:function(t){this.setStatus(!1)},containsPoint:function(t,e){return!(!this.visible()||this.alpha()<=0)&&this.hitbox.bounds.containsPoint(t,e)},_default_onChange:function(t,e,i){t!==e&&(t&&this._onButtonDown?this._onButtonDown():!t&&this._onButtonUp&&this._onButtonUp()),!t&&e&&this._onTap&&this._onTap()},keyDown:function(t,e){if(t===this.keyCode)return this.pointerActivate(),!1},keyUp:function(t,e){if(t===this.keyCode)return this.pointerDeactivate(),!1},onChange:function(t){return this._onChange=null===t?this._default_onChange:t,this},onButtonDown:function(t=!0){if(!0!==t)return this._onButtonDown=t,this;this._onButtonDown&&this._onButtonDown()},onButtonUp:function(t=!0){if(!0!==t)return this._onButtonUp=t,this;this._onButtonUp&&this._onButtonUp()},onTap:function(t=!0){if(!0!==t)return this._onTap=t,this;this._onTap&&this._onTap()}}),//![import "./group"]
//![import "./mask"]
//![import "./screen-controls"]
//![import "../system/keycode"]
//!class Stick extends Group
Be=Ee.extend({focusLock:!0,keyboardEvents:!0,isPressed:!1,wasPressed:!1,unpressedImg:null,pressedImg:null,unpressedImgInner:null,pressedImgInner:null,angleSteps:0,radiusSteps:0,refX:null,refY:null,rdirx:0,rdiry:0,dirx:0,diry:0,magnitude:0,angle:0,frdirx:0,frdiry:0,fdirx:0,fdiry:0,fmagnitude:0,fangle:0,dispx:0,dispy:0,radius:0,maxRadius:0,deadZoneX:0,deadZoneY:0,hitbox:0,_onChange:null,__ctor:function(t,e,i,n,s,r,l=null,a=null){this._super.Group.__ctor(),this.unpressedImg=s,this.pressedImg=l||s,this.unpressedImgInner=r,this.pressedImgInner=a||r,this.maxRadius=n,this.deadZoneX=0,this.deadZoneY=0,this.hitbox=Se.Pool.alloc(0,e,i,(this.unpressedImg??this.unpressedImgInner).width,(this.unpressedImg??this.unpressedImgInner).height).visible(!1).visibleLock(!0).debug(2),this.addChild(this.hitbox),t.add(this.hitbox),t.add(this),this._onChange=null,this.renderWith(this.renderStick),Me.add(this)},__dtor:function(){this._super.Group.__dtor(),Me.remove(this)},setImage:function(t,e=null){return this.unpressedImg=t,this.pressedImg=e||t,this},setImageInner:function(t,e=null){return this.unpressedImgInner=t,this.pressedImgInner=e||t,this},setAngleSteps:function(t){return this.angleSteps=t,this},setRadiusSteps:function(t){return this.radiusSteps=t,this},setDeadZone:function(t,e){return this.deadZoneX=t,this.deadZoneY=e,this},reset:function(){return this.dispx=0,this.dispy=0,this.rdirx=0,this.rdiry=0,this.dirx=0,this.diry=0,this.magnitude=0,this._onChange&&this._onChange(this.dirx,this.diry,this.magnitude,this.angle,this),this},renderStick:function(t,e,i){e.isPressed?(e.pressedImg&&e.pressedImg.draw(t,e.bounds.x1,e.bounds.y1),e.pressedImgInner&&e.pressedImgInner.draw(t,e.bounds.x1+e.dispx,e.bounds.y1+e.dispy)):(e.unpressedImg&&e.unpressedImg.draw(t,e.bounds.x1,e.bounds.y1),e.unpressedImgInner&&e.unpressedImgInner.draw(t,e.bounds.x1,e.bounds.y1))},pointerUpdate:function(t,e){let i,n;if(i=t-this.refX,n=e-this.refY,this.angle=Math.atan2(-n,i),this.radius=Math.sqrt(i*i+n*n),this.radius>this.maxRadius&&(this.radius=this.maxRadius),this.angleSteps){let t=2*Math.PI/this.angleSteps;this.angle=int((this.angle+Math.PI+t/2)/t)*t-Math.PI}if(this.radiusSteps){let t=this.maxRadius/this.radiusSteps;this.radius=int((this.radius+t/2)/t)*t}this.rdirx=Math.min(1,Math.max(i/this.maxRadius,-1)),this.rdiry=Math.min(1,Math.max(n/this.maxRadius,-1)),this.dispx=this.radius*Math.cos(this.angle),this.dispy=this.radius*-Math.sin(this.angle),this.radius>0?(this.dirx=this.dispx/this.radius,this.diry=this.dispy/this.radius,this.magnitude=this.radius/this.maxRadius):(this.dirx=0,this.diry=0,this.magnitude=0),Math.abs(this.rdirx)<this.deadZoneX&&(this.rdirx=0,this.dirx=0),Math.abs(this.rdiry)<this.deadZoneY&&(this.rdiry=0,this.diry=0),this._onChange&&this._onChange(this.dirx,this.diry,this.magnitude,this.angle,this)},pointerActivate:function(t){this.wasPressed=this.isPressed,this.isPressed=1,this.refX=t.x,this.refY=t.y,this.pointerUpdate(t.x,t.y)},pointerDeactivate:function(t){this.wasPressed=this.isPressed,this.isPressed=0,this.reset()},containsPoint:function(t,e){return!(!this.visible()||this.alpha()<=0)&&this.hitbox.bounds.containsPoint(t,e)},setDirection:function(t,e,i=.1,n=.1){return Math.abs(t)<i&&(t=0),Math.abs(e)<n&&(e=0),this.wasPressed=this.isPressed,this.isPressed=0==t&&0==e?0:1,this.pointerUpdate(this.bounds.cx+t*this.maxRadius,this.bounds.cy+e*this.maxRadius),!1},freezeState:function(t=!1){return this.frdirx=t?0!=this.rdirx?this.rdirx:this.frdirx:this.rdirx,this.frdiry=t?0!=this.rdiry?this.rdiry:this.frdiry:this.rdiry,this.fdirx=t?0!=this.dirx?this.dirx:this.fdirx:this.dirx,this.fdiry=t?0!=this.diry?this.diry:this.fdiry:this.diry,this.fmagnitude=t?0!=this.magnitude?this.magnitude:this.fmagnitude:this.magnitude,this.fangle=t?0!=this.angle?this.angle:this.fangle:this.angle,this},keyDown:function(t,e){let i=0,n=0;if(!0===e[u.UP]&&(n=-this.maxRadius),!0===e[u.LEFT]&&(i=-this.maxRadius),!0===e[u.DOWN]&&(n=this.maxRadius),!0===e[u.RIGHT]&&(i=this.maxRadius),t===u.UP||t===u.LEFT||t===u.DOWN||t===u.RIGHT)return i=this.bounds.cx+i,n=this.bounds.cy+n,this.wasPressed=this.isPressed,this.isPressed=1,this.pointerUpdate(i,n),!1},keyUp:function(t,e){let i=0,n=0;if(!0===e[u.UP]&&(n=-this.maxRadius),!0===e[u.LEFT]&&(i=-this.maxRadius),!0===e[u.DOWN]&&(n=this.maxRadius),!0===e[u.RIGHT]&&(i=this.maxRadius),t===u.UP||t===u.LEFT||t===u.DOWN||t===u.RIGHT)return this.pointerUpdate(this.bounds.cx+i,this.bounds.cy+n),0===i&&0===n&&(this.wasPressed=this.isPressed,this.isPressed=0),!1},onChange:function(t){return this._onChange=t,this}}),Ue={};l(Ue,"sys",(()=>ze)),l(Ue,"world",(()=>Ke)),l(Ue,"r",(()=>Qe)),l(Ue,"res",(()=>je)),l(Ue,"input",(()=>Ze)),l(Ue,"collider",(()=>$e));
//!/**
//! * 	World system allows to manage scenes, containers, viewports and display elements.
//! */
//!class world
const Oe={SCENE_MAIN:0,SCENE_HUD:1,LAYER_BG0:0,LAYER_BG1:1,LAYER_BG2:2,LAYER_BG3:3,LAYER_BG4:4,LAYER_MAIN:5,LAYER_FG0:6,LAYER_FG1:7,LAYER_FG2:8,LAYER_FG3:9,LAYER_FG4:10,LAYER_MASK:11,LAYER_HUD_BG0:0,LAYER_HUD_BG1:1,LAYER_HUD_BG2:2,LAYER_HUD_MAIN:3,LAYER_HUD_FG0:4,LAYER_HUD_FG1:5,LAYER_HUD_FG2:6,_scenes:[],activeScene:null,_viewports:[],activeViewport:null,activeContainer:null,activeGroup:null,lastGroup:null,lastElement:null,bounds:Xt.Pool.alloc(),init:function(t=32768,e=32768,i=null,n=null){0===this._scenes.length&&(null===i&&(i=Math.max(t,e)/512),i<16&&(i=16),null!==n&&n<16&&(n=16),this.bounds.zero().resize(t,e),this.createScene(Oe.SCENE_MAIN,"SCENE_MAIN"),this.setContainer(Oe.LAYER_BG0,new Pe(t,e,i,n)),this.setContainer(Oe.LAYER_BG1,new Pe(t,e,i,n)),this.setContainer(Oe.LAYER_BG2,new Pe(t,e,i,n)),this.setContainer(Oe.LAYER_BG3,new Pe(t,e,i,n)),this.setContainer(Oe.LAYER_BG4,new Pe(t,e,i,n)),this.setContainer(Oe.LAYER_MAIN,new Pe(t,e,i,n)),this.setContainer(Oe.LAYER_FG0,new Pe(t,e,i,n)),this.setContainer(Oe.LAYER_FG1,new Pe(t,e,i,n)),this.setContainer(Oe.LAYER_FG2,new Pe(t,e,i,n)),this.setContainer(Oe.LAYER_FG3,new Pe(t,e,i,n)),this.setContainer(Oe.LAYER_FG4,new Pe(t,e,i,n)),this.setContainer(Oe.LAYER_MASK,new Pe(t,e,i,n)),this.getContainer(Oe.LAYER_MASK).visible(!1),this.createViewport(0),this.createScene(Oe.SCENE_HUD,"SCENE_HUD"),this.setContainer(Oe.LAYER_HUD_BG0,new Ie(zt.screenWidth,zt.screenHeight)),this.setContainer(Oe.LAYER_HUD_BG1,new Ie(zt.screenWidth,zt.screenHeight)),this.setContainer(Oe.LAYER_HUD_BG2,new Ie(zt.screenWidth,zt.screenHeight)),this.setContainer(Oe.LAYER_HUD_MAIN,new Ie(zt.screenWidth,zt.screenHeight)),this.setContainer(Oe.LAYER_HUD_FG0,new Ie(zt.screenWidth,zt.screenHeight)),this.setContainer(Oe.LAYER_HUD_FG1,new Ie(zt.screenWidth,zt.screenHeight)),this.setContainer(Oe.LAYER_HUD_FG2,new Ie(zt.screenWidth,zt.screenHeight)))},createScene:function(t,e=null){return this._scenes[t]&&(H.queueRemove(this._scenes[t]),r.dispose(this._scenes[t])),this._scenes[t]=new Te(t,e),H.queueAdd(this._scenes[t]),this.selectScene(t),this._scenes[t]},getScene:function(t=null){return null===t?this.activeScene:t<0||t>=this._scenes.length?null:this._scenes[t]},selectScene:function(t){return!(t<0||t>=this._scenes.length||!this._scenes[t])&&(this.activeScene=this._scenes[t],this.activeContainer=null,!0)},createViewport:function(t){if(null===this.activeScene)throw new Error("createViewport: use `selectScene` first to select the active scene.");this._viewports[t]&&(r.dispose(this._viewports[t]),this.activeScene.setViewport(t,null)),this._viewports[t]=new ye(0,0,zt.screenWidth,zt.screenHeight,this.activeScene.maxWidth,this.activeScene.maxHeight),this.activeScene.setViewport(t,this._viewports[t]),this.selectViewport(t)},getViewport:function(t=null){return null===t?this.activeViewport:t<0||t>=this._viewports.length?null:this._viewports[t]},selectViewport:function(t){return!(t<0||t>=this._viewports.length||!this._viewports[t])&&(this.activeViewport=this._viewports[t],!0)},setContainer:function(t,e){if(null===this.activeScene)throw new Error("setContainer: use `selectScene` first to select the active scene.");return this.activeScene.setContainer(t,e),e},getContainer:function(t=null,e=!1){if(null===t){if(null===this.activeContainer&&e)throw new Error("getContainer: container index not specified and default container not set.");return this.activeContainer}if(null===this.activeScene)throw new Error("getContainer: use `selectScene` first to select the active scene.");let i=this.activeScene.getContainer(t);if(null===i&&e)throw new Error("getContainer: container index out of bounds.");return i},selectContainer:function(t){return this.activeContainer=this.getContainer(t,!0),null!==this.activeContainer},showMasks:function(t,e=!0){Oe.getScene(Oe.SCENE_MAIN).getContainer(Oe.LAYER_MASK).visible(t),Y.debugMasks=e},createGroup:function(t=null){if(null===this.activeScene)throw new Error("createGroup: use selectScene first to select the active scene.");return this.activeGroup=Ee.Pool.alloc(t),this.activeScene.addGroup(this.activeGroup),this.activeGroup},endGroup:function(t=null,e=null){return null!==t&&null!==e&&this.activeGroup.translate(t,e),this.lastGroup=this.activeGroup,this.activeGroup=null,this.lastGroup.sync()},createElement:function(t,e,i,n=null,s=null){"string"!=typeof t&&(s=n,n=i,i=e,e=t,t=null);let r=this.getContainer(s),l=xe.Pool.alloc(e,i,n);return r.add(l.setId(t)),null!==this.activeGroup&&this.activeGroup.addChild(l),this.lastElement=l,l},createMask:function(t,e,i=null,n=null,s=null,r=null,l=null){let a=this.getContainer(l||Oe.LAYER_MASK);if(null===i){if(null===this.activeGroup)throw new Error("createMask: create a group first to use default masks.");i=this.activeGroup.bounds.x1,n=this.activeGroup.bounds.y1,s=this.activeGroup.bounds.width(),r=this.activeGroup.bounds.height()}let o=Se.Pool.alloc(e,i,n,s,r);return a.add(o.setId(t)),null!==this.activeGroup&&this.activeGroup.addChild(o),o},createLabel:function(t,e,i,n,s,r=null){"string"!=typeof t&&(r=s,s=n,n=i,i=e,e=t,t=null);let l=this.getContainer(r),a=Fe.Pool.alloc(e,i,n,s);return l.add(a.setId(t)),null!==this.activeGroup&&this.activeGroup.addChild(a),this.lastElement=a,a},createUpdater:function(t=null,e=null){if(null===this.activeScene)throw new Error("createUpdater: use selectScene first to select the active scene.");return new Re(this.activeScene,t,e)}};var//!/class
He=Oe;
//!/**
//! * Registered resources. Initially these are resource descriptors, but after a call to `res.load` these will be fully loaded resources.
//! */
var Xe={};
//!namespace res
//!type AnimationResource =
//!/type
//!type SpritesheetResource =
//!/type
//!/namespace
//!class res
var We={config:function(t){_t.config(t)},load:function(t=null){return new Promise((function(e,i){_t.load(Xe,(function(e,i,n,s){t&&t(n,s)}),(function(){e()}))}))},get:function(t){if(!Xe.hasOwnProperty(t))throw new Error("Resource not found: "+t);return Xe[t]},__resIdMustNotExist:function(t){if(Xe.hasOwnProperty(t))throw new Error("Resource identifier `"+t+"` is already in use")},color:function(t,e,i,n){return this.__resIdMustNotExist(t),Xe[t]={type:"object",wrapper:"Custom",color:e,width:i,height:n}},custom:function(t,e,i,n,s=null){return this.__resIdMustNotExist(t),Xe[t]={type:"object",wrapper:"Custom",width:e,height:i,draw:n,...s}},image:function(t,e,i=null){return this.__resIdMustNotExist(t),Xe[t]={type:"image",wrapper:"Drawable",src:e,...i}},images:function(t,e,i,n=null,s=null,r=null,l=null){return this.__resIdMustNotExist(t),Xe[t]={type:"images",wrapper:"Spritesheet",src:e,count:i,width:n,height:s,config:{frameWidth:n,frameHeight:s,...r},...l}},spritesheet:function(t,e,i,n,s=0,r=null,l=null){return this.__resIdMustNotExist(t),Xe[t]={type:"image",wrapper:"Spritesheet",src:e,config:{frameWidth:i,frameHeight:n,numFrames:"number"==typeof s?s:0,coords:"number"==typeof s?null:s,...r},...l,frame:function(t,e,i,n){return this.config.coords||(this.config.coords=[]),this.config.coords.push([t,e,i,n]),this}}},animation:function(t,e,i,n,s=null,r=null,l=null){return this.__resIdMustNotExist(t),Xe[t]={type:"image",wrapper:"SpritesheetAnimation",src:e,config:{frameWidth:i,frameHeight:n,numFrames:s,...r},anim:{def:null,fps:15,seq:{},trans:{}},...l,fps:function(t){return this.anim.fps=t,this},seq:function(t,e,i,n=null){return this.anim.seq[t]={loop:e,group:i},null!==n&&(this.anim.seq[t].fps=n),this},trans:function(t,e,i){return t in this.anim.trans||(this.anim.trans[t]={}),this.anim.trans[t][e]=i,this},def:function(t){return this.anim.def=t,this}}},spritefont:function(t,e,i,n,s,r=null,l=null){return this.__resIdMustNotExist(t),Xe[t]={type:"image",wrapper:"SpriteFont",src:e,font:{charWidth:i,charHeight:n,charset:s,...r},...l}},json:function(t,e,i=null){return this.__resIdMustNotExist(t),Xe[t]={type:"json",src:e,...i}},data:function(t,e,i=null){return this.__resIdMustNotExist(t),Xe[t]={type:"data",src:e,...i}},text:function(t,e,i=null){return this.__resIdMustNotExist(t),Xe[t]={type:"text",src:e,...i}},sfx:function(t,e,i=null){return this.__resIdMustNotExist(t),Xe[t]={type:"audio",wrapper:"Sound",src:e,track:"sfx",...i}},sfxm:function(t,e,i,n="sequential"){return this.__resIdMustNotExist(t),Xe[t]={type:"audios",wrapper:"SoundArray",src:e,count:i,track:"sfx",mode:n}},music:function(t,e){return this.__resIdMustNotExist(t),Xe[t]={type:"audio",wrapper:"Sound",src:e,track:"music"}}};
//![import '../flow/stick.js']
//![import '../flow/button.js']
//!class Gamepad
var//!/class
Ge=t.extend({sticks:null,buttons:null,scene:null,container:null,_visible:!0,group:null,__ctor:function(t,e){this.sticks={},this.buttons={},this.scene=t,this.layer=t.getContainer(e),this.group=Ee.Pool.alloc()},addStick:function(t,e,i,n,s,r=0){0==r&&(r=n.width-s.width);let l=new Be(this.layer,e,i,r,n,s);return this.sticks[t]=l,this[t]=l,this.group.addChild(l),l},addButton:function(t,e,i,n=null,s=null){let r=new Le(this.layer,e,i,n,s);return this.buttons[t]=r,this[t]=r,this.group.addChild(r),r},visible:function(t=null){if(null===t)return this._visible;this._visible=t;for(let e in this.sticks)this.sticks[e].visible(t);for(let e in this.buttons)this.buttons[e].visible(t);return this},showMasks:function(t){for(let e in this.sticks)this.sticks[e].hitbox.visible(t,!0);for(let e in this.buttons)this.buttons[e].hitbox.visible(t,!0);return this}});
//!namespace input
//!/namespace
//!class input
const Ye={_gamepads:[],activeGamepad:null,lastButton:null,lastStick:null,cursor:{_enabled:null,_handler:null,_element:null,pointer:null,element:function(t=!1){return!1===t?this._element:(this._element=t,this)},native:function(t){t||"none"===zt.renderer.elem.style.cursor?t&&"none"===zt.renderer.elem.style.cursor&&zt.renderer.elem.style.removeProperty("cursor"):zt.renderer.elem.style.cursor="none"},enabled:function(t=null){return null===t?this._enabled:(this._enabled===t||(this._enabled=t,!0===t?(null!==this._element&&(zt.renderer.elem.style.cursor="none"),Ne.register(this.pointerHandler)):(zt.renderer.elem.style.removeProperty("cursor"),Ne.unregister(this.pointerHandler))),this)},handler:function(t){return this._handler=t,this},pointerHandler:{priority:50,onPointerEvent:function(t,e,i){Ye.cursor._enabled&&(Ye.cursor.pointer=e,null!==Ye.cursor._element&&Ye.cursor._element.setPosition(e.x,e.y),null!==Ye.cursor._handler&&Ye.cursor._handler(t,e))}}},pointer:{_handler:null,context:null,init:function(){null===this._handler&&(this._handler=Nt.Pool.alloc(),this.context={action:null,pointer:null,pointers:null},Ne.register(this))},onPointerEvent:function(t,e,i){this.context.action=t,this.context.pointer=e,this.context.pointers=i,this._handler.exec(this.context)},add:function(t,e=null,i=null,n=null){return null===this._handler&&this.init(),this._handler.add(this._handler_callback,t,e,i,n)},remove:function(t){hthis._handler.remove(t)},_handler_callback:function(t,e,i,n,s){return e(t.action,t.pointer,i,n,s)}},
//!};
keyboard:{_handler:null,context:null,init:function(){null===this._handler&&(this._handler=Nt.Pool.alloc(),this.context={action:null,keyCode:null,keybState:null},Ce.register(this))},onKeyboardEvent:function(t,e,i){this.context.action=t,this.context.keyCode=e,this.context.keybState=i,this._handler.exec(this.context)},add:function(t,e=null,i=null,n=null){return null===this._handler&&this.init(),this._handler.add(this._handler_callback,t,e,i,n)},remove:function(t){this._handler.remove(t)},_handler_callback:function(t,e,i,n,s){return e(t.action,t.keyCode,t.keybState,i,n,s)}},
//!};
createGamepad:function(t,e=null){return e=null!==e?e:He.LAYER_HUD_MAIN,He.selectScene(He.SCENE_HUD),He.selectContainer(e),this._gamepads[t]=new Ge(He.activeScene,e),this.selectGamepad(t),this.activeGamepad},getGamepad:function(t){return t<0||t>=this._gamepads.length?null:this._gamepads[t]||null},selectGamepad:function(t){return this.activeGamepad=this.getGamepad(t),!0},debugGamepad:function(t,e){if(null!==t)this._gamepads[t].debug(e);else for(let t=0;t<this._gamepads.length;t++)this._gamepads[t]&&this.debugGamepad(t,e)},stick:function(t,e,i,n,s,r=0){if(null===this.activeGamepad)throw new Error("input.addStick: use input.selectGamepad first to select the active gamepad.");return this.lastStick=this.activeGamepad.addStick(t,e,i,n,s,r)},button:function(t,e,i,n=null,s=null){if(null===this.activeGamepad)throw new Error("input.addButton: use input.selectGamepad first to select the active gamepad.");return this.lastButton=this.activeGamepad.addButton(t,e,i,n,s)}};var//!/class
Ve=Ye;const qe={FLAG_EXCLUDE:de.allocFlag(),contactRules:{},truncationRules:{},scene:null,maskLayer:null,fupdater:null,lupdater:null,flagsAnd:0,flagsValue:0,state:{contact:Xt.Pool.alloc(),flags:0,dx:0,dy:0,bounds:Xt.Pool.alloc(),x:new Array(32).fill(0),y:new Array(32).fill(0),v0x:new Array(32).fill(0),v0y:new Array(32).fill(0),v1x:new Array(32).fill(0),v1y:new Array(32).fill(0),v2x:new Array(32).fill(0),v2y:new Array(32).fill(0),count:0,target:0,v0:0,w0:0,delta0:0,v1:0,w1:0,delta1:0,w2:0,t_dx:0,t_dy:0},enable:function(t=null,e=null){this.scene=He.getScene(t||He.SCENE_MAIN),this.maskLayer=this.scene.getContainer(e||He.LAYER_MASK),this.flagsAnd=de.ALIVE|de.VISIBLE|qe.FLAG_EXCLUDE,this.flagsValue=de.ALIVE|de.VISIBLE,this.scene.fupdater.add(this.firstUpdate,this),this.scene.lupdater.add(this.lastUpdate,this),this.fupdater=Nt.Pool.alloc(this),this.lupdater=Nt.Pool.alloc(this)},disable:function(){this.scene.fupdater.remove(this.update,this),this.maskLayer=null,this.fupdater.free(),this.lupdater.free()},firstUpdate:function(t,e){e.fupdater.exec()},lastUpdate:function(t,e){e.lupdater.exec()},later:{run:function(t,e,i,n,s){qe.fupdater.add(this._run,t,e,i,n,s)},setVisible:function(t,e){qe.fupdater.add(this._setVisible,t,e)},setValue:function(t,e,i){qe.fupdater.add(this._setValue,t,e,i)},setFlags:function(t,e){qe.fupdater.add(this._setFlags,t,e)},clearFlags:function(t,e){qe.fupdater.add(this._clearFlags,t,e)},_run:function(t,e,i,n,s,r){return i(t,e,n,s,r),!1},_setVisible:function(t,e,i){return e.visible(i),!1},_setValue:function(t,e,i,n){return e[i]=n,!1},_setFlags:function(t,e,i){return e.setFlags(i),!1},_clearFlags:function(t,e,i){return e.clearFlags(i),!1}},
//!}
contact:function(t,e,i,n=null){return t in this.contactRules||(this.contactRules[t]={}),this.contactRules[t][e]={callback:i,context:n},this},truncate:function(t,e,i=null,n=null){return t in this.truncationRules||(this.truncationRules[t]={}),this.truncationRules[t][e]={callback:i,context:n},this},getContactFlags:function(t,e){this.state.contact.set(t).setAsIntersection(e);let i=this.state.contact;return this.state.flags=0,this.state.numFlags=0,i.x1==e.x1&&(this.state.flags|=qe.Contact.LEFT,this.state.numFlags++),i.x2==e.x2&&(this.state.flags|=qe.Contact.RIGHT,this.state.numFlags++),i.y1==e.y1&&(this.state.flags|=qe.Contact.TOP,this.state.numFlags++),i.y2==e.y2&&(this.state.flags|=qe.Contact.BOTTOM,this.state.numFlags++),this.state.flags},calc:function(t,e,i,n,s,r){let l=this.state.count,a=null,o=0;if(e>0)for(let t=0;t<l;t++)!n[t]||!s[t]||i[t]<0||((null===a||i[t]>a)&&(a=i[t]),s[t]=r[t]=0,o+=n[t]);else for(let t=0;t<l;t++)!n[t]||!s[t]||i[t]>0||((null===a||i[t]<a)&&(a=i[t]),s[t]=r[t]=0,o+=n[t]);null===a&&(a=0),t?(this.state.v0=o,this.state.w0=Math.abs(a),this.state.delta0=a):(this.state.v1=o,this.state.w1=Math.abs(a),this.state.delta1=a)},attemptSelect:function(t){this.state.v1+this.state.v0===this.state.target&&(null===this.state.w2||this.state.w1+this.state.w0<this.state.w2)&&(this.state.w2=this.state.w1+this.state.w0,t?(this.state.t_dx=this.state.delta0,this.state.t_dy=this.state.delta1):(this.state.t_dx=this.state.delta1,this.state.t_dy=this.state.delta0))},load0:function(){let t=this.state.count;for(let e=0;e<t;e++)this.state.v1x[e]=this.state.v0x[e],this.state.v1y[e]=this.state.v0y[e]},save1:function(){let t=this.state.count;for(let e=0;e<t;e++)this.state.v2x[e]=this.state.v1x[e],this.state.v2y[e]=this.state.v1y[e]},load1:function(){let t=this.state.count;for(let e=0;e<t;e++)this.state.v1x[e]=this.state.v2x[e],this.state.v1y[e]=this.state.v2y[e]},resolveXpos:function(t=!1){if(this.calc(t,1,this.state.x,this.state.v0x,this.state.v1x,this.state.v1y),t)return!0;this.save1(),this.resolveYpos(!0)&&this.attemptSelect(!1),this.load1(),this.resolveYneg(!0)&&this.attemptSelect(!1),this.load0()},resolveXneg:function(t=!1){if(this.calc(t,-1,this.state.x,this.state.v0x,this.state.v1x,this.state.v1y),t)return!0;this.save1(),this.resolveYpos(!0)&&this.attemptSelect(!1),this.load1(),this.resolveYneg(!0)&&this.attemptSelect(!1),this.load0()},resolveYpos:function(t=!1){if(this.calc(t,1,this.state.y,this.state.v0y,this.state.v1y,this.state.v1x),t)return!0;this.save1(),this.resolveXpos(!0)&&this.attemptSelect(!0),this.load1(),this.resolveXneg(!0)&&this.attemptSelect(!0),this.load0()},resolveYneg:function(t=!1){if(this.calc(t,-1,this.state.y,this.state.v0y,this.state.v1y,this.state.v1x),t)return!0;this.save1(),this.resolveXpos(!0)&&this.attemptSelect(!0),this.load1(),this.resolveXneg(!0)&&this.attemptSelect(!0),this.load0()},commit:function(){this.state.group.alive()&&(this.state.group.translate(this.state.dx,this.state.dy),this.state.group.clearFlags(qe.FLAG_EXCLUDE))},translate:function(t,e=null,i=0,n=0){if("number"==typeof e&&(n=i,i=e,e=null),!t)return;if(e||(e=t.group),!e.alive()||!t.alive())return;if(this.state.mask=t,this.state.group=e,this.state.dx=downscalef(upscale(i)),this.state.dy=downscalef(upscale(n)),!this.maskLayer||!t.visible())return this.commit();let s=this.truncationRules[t.type];if(!s&&(s=this.truncationRules[4294963200&t.type],!s))return this.commit(),this.scan(t,e);this.state.offs=e.getOffsets(this.state.dx,this.state.dy),this.state.bounds.set(t.bounds).translate(this.state.offs.x+this.state.dx,this.state.offs.y+this.state.dy),e.setFlags(qe.FLAG_EXCLUDE);let r=this.maskLayer.selectInRegion(this.state.bounds,this.flagsAnd,this.flagsValue);if(0===r.length)return r.free(),this.commit();let l=0,a=0;for(;;){let e=r.shift();if(null===e)break;let i=s[e.type];if(!i&&(i=s[4294963200&e.type],!i))continue;if(!1===i.callback||null!==i.callback&&!0!==i.callback&&!i.callback(t,e,i.context))continue;let n=Math.min(this.state.bounds.x2,e.bounds.x2)-Math.max(this.state.bounds.x1,e.bounds.x1),o=Math.min(this.state.bounds.y2,e.bounds.y2)-Math.max(this.state.bounds.y1,e.bounds.y1);this.state.v0x[l]=0,this.state.v0y[l]=0,Math.min(this.state.bounds.width(),e.bounds.width())!=n&&(this.state.x[l]=absmin(this.state.bounds.x2-e.bounds.x1,this.state.bounds.x1-e.bounds.x2),this.state.v0x[l]=1),Math.min(this.state.bounds.height(),e.bounds.height())!=o&&(this.state.y[l]=absmin(this.state.bounds.y2-e.bounds.y1,this.state.bounds.y1-e.bounds.y2),this.state.v0y[l]=1);let h=this.state.v0x[l]+this.state.v0y[l];a+=h,h>1&&(this.state.v0x[l]=h,this.state.v0y[l]=h),this.state.v1x[l]=this.state.v0x[l],this.state.v1y[l]=this.state.v0y[l],l++}if(r.free(),0==a)return this.commit(),this.scan(t,e);if(this.state.target=a,this.state.count=l,this.state.w2=null,this.resolveXpos(),this.resolveXneg(),this.resolveYpos(),this.resolveYneg(),null!==this.state.w2){let e=this.contactRules[t.type];if(e||(e=this.contactRules[4294963200&t.type]),e){for(this.state.bounds.set(t.bounds).translate(this.state.offs.x+this.state.dx-.5*this.state.t_dx,this.state.offs.y+this.state.dy-.5*this.state.t_dy),r=this.maskLayer.selectInRegion(this.state.bounds,this.flagsAnd,this.flagsValue);t.alive();){let i=r.shift();if(null===i)break;if(!i.alive())continue;let n=e[i.type];(n||(n=e[4294963200&i.type],n))&&n.callback(t,i,n.context)}r.free()}this.state.dx-=this.state.t_dx,this.state.dy-=this.state.t_dy}this.commit()},scan:function(t,e=null){if(e||(e=t.group),!e||!e.alive()||!t.alive())return;if(this.state.mask=t,this.state.group=e,!this.maskLayer||!t.visible())return;let i=this.contactRules[t.type];if(i||(i=this.contactRules[4294963200&t.type]),!i)return;e.setFlags(qe.FLAG_EXCLUDE);let n=this.maskLayer.selectInRegion(t.bounds,this.flagsAnd,this.flagsValue);for(e.clearFlags(qe.FLAG_EXCLUDE);t.alive();){let e=n.shift();if(null===e)break;if(!e.alive())continue;let s=i[e.type];(s||(s=i[4294963200&e.type],s))&&s.callback(t,e,s.context)}n.free()},
//!/class
//!namespace collider
//!enum Contact
Contact:{
//!LEFT
LEFT:1,
//!RIGHT
RIGHT:2,
//!HORIZONTAL
HORIZONTAL:3,
//!TOP
TOP:4,
//!BOTTOM
BOTTOM:8,
//!VERTICAL
VERTICAL:12}};
//!class collider
const ze=zt,Ke=He,Qe=Xe,je=We,Ze=Ve,$e=qe,Je=t,ti=e,ei=n,ii=Y,ni=A,si=k,ri=H,li=v,ai=h,oi=u,hi=U,ui=q,ci=W,di=N,fi=M,pi=Z,gi=L,mi=$,yi=_t,_i=vt,xi=p,vi=m,bi=_,Ei=St,wi=Nt,Ti=I,Ri=Mt,Ii=E,Pi=Bt,Ai=Xt,Si=Ot,ki=Gt,Fi=ue,Ci=Vt,Ni=de,Di=fe,Mi=Te,Li=ye,Bi=Re,Ui=ge,Oi=Ie,Hi=Pe,Xi=Ee,Wi=ot,Gi=xe,Yi=Se,Vi=Fe,qi=Ce,zi=Ne,Ki=Me,Qi=Le,ji=Be;var Zi=Ue;export{Je as Class,ti as Schema,ei as Template,ii as globals,ni as glx,si as glsl,ri as System,li as Timer,ai as Random,oi as KeyCode,hi as Canvas,ui as Perf,ci as Log,di as Shader,fi as ShaderProgram,pi as Framebuffer,gi as Texture,mi as Wrappers,yi as Resources,_i as Sound,xi as Recycler,vi as Linkable,bi as List,Ei as PriorityQueue,wi as Handler,Ti as Matrix,Ri as Rect,Ii as Vec2,Pi as TFunction,Ai as Bounds2,Si as Point2,ki as Easing,Fi as Anim,Ci as Boot,Ni as GridElement,Di as Grid,Mi as Scene,Li as Viewport,Bi as Updater,Ui as Container,Oi as SimpleContainer,Hi as GridContainer,Xi as Group,Wi as Drawable,Gi as Element,Yi as Mask,Vi as Label,qi as KeyboardHandler,zi as PointerHandler,Ki as ScreenControls,Qi as Button,ji as Stick,Zi as default};
//# sourceMappingURL=froxel.m.js.map
