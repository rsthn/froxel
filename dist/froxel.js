import{Class as t,Schema as e,Template as n,Rinn as s}from"rinn";var r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{};function a(t,e,i,n){Object.defineProperty(t,e,{get:i,set:n,enumerable:!0,configurable:!0})}const l=function(t,e){return 65535&(t^e)};var o=t.extend({seed:0,last:0,a:0,b:0,__ctor:function(t=3672614355){this.setSeed(t)},setSeed:function(t){return this.seed=t,this.a=t>>16&65535,this.b=t>>0&65535,this.last=this.a>>4&255|this.b<<4&65280,this},nextInt16:function(){let t=this.last;return t=function(t,e){return t+e&65535}(t,this.a),t=l(t,5397),this.a=l(this.a,20897),this.a=function(t,e){return t-e&65535}(this.a,this.b),this.b=l(this.b,6677),t=function(t,e){return 65535&(t<<e|t>>>16-e&(1<<e)-1)}(t,15&this.b),65535&(this.last=t)},nextInt8:function(){return 255&this.nextInt16()},nextFloat:function(){return this.nextInt16()/65535}}),
//!enum KeyCode
h={BACKSPACE:8,
//!BACKSPACE
TAB:9,
//!TAB
ENTER:13,
//!ENTER
SHIFT:16,
//!SHIFT
CTRL:17,
//!CTRL
ESC:27,
//!ESC
SPACE:32,
//!SPACE
PGUP:33,
//!PGUP
PGDN:34,
//!PGDN
END:35,
//!END
HOME:36,
//!HOME
INS:45,
//!INS
DEL:46,
//!DEL
LEFT:37,
//!LEFT
UP:38,
//!UP
RIGHT:39,
//!RIGHT
DOWN:40,
//!DOWN
NUM_PLUS:107,
//!NUM_PLUS
NUM_MINUS:109,
//!NUM_MINUS
NUM_ASTERISK:106,
//!NUM_ASTERISK
NUM_SLASH:111,
//!NUM_SLASH
NUM_DOT:110,
//!NUM_DOT
NUM_0:96,
//!NUM_0
NUM_1:97,
//!NUM_1
NUM_2:98,
//!NUM_2
NUM_3:99,
//!NUM_3
NUM_4:100,
//!NUM_4
NUM_5:101,
//!NUM_5
NUM_6:102,
//!NUM_6
NUM_7:103,
//!NUM_7
NUM_8:104,
//!NUM_8
NUM_9:105,
//!NUM_9
D0:48,
//!D0
D1:49,
//!D1
D2:50,
//!D2
D3:51,
//!D3
D4:52,
//!D4
D5:53,
//!D5
D6:54,
//!D6
D7:55,
//!D7
D8:56,
//!D8
D9:57,
//!D9
A:65,
//!A
B:66,
//!B
C:67,
//!C
D:68,
//!D
E:69,
//!E
F:70,
//!F
G:71,
//!G
H:72,
//!H
I:73,
//!I
J:74,
//!J
K:75,
//!K
L:76,
//!L
M:77,
//!M
N:78,
//!N
O:79,
//!O
P:80,
//!P
Q:81,
//!Q
R:82,
//!R
S:83,
//!S
T:84,
//!T
U:85,
//!U
V:86,
//!V
W:87,
//!W
X:88,
//!X
Y:89,
//!Y
Z:90};const u={};let c=0;const d={};r.Recycler=d;var f=d;
//!namespace Recycler
d.attachTo=function(t,e=8192,i=null){if(!t.prototype.className)throw new Error("Unable to attach recycler methods to an unnamed class.");if(!("__dtor"in t.prototype))throw new Error("Recycler: Class "+t.prototype.className+" requires `__dtor` method.");if(!("init"in t.prototype))throw new Error("Recycler: Class "+t.prototype.className+" requires `init` method.");null===i&&(i=int(.375*e)),u[t.prototype.className]=t,t.recyclerPool=[],t.recyclerPoolMax=e,t.prototype.objectId=0,t.recyclerNextObjectId=0,t.recyclerCreated=0,t.recyclerRecycled=0,t.recyclerMissed=0,t.recyclerLength=0,t.recyclerActive=0;let n=!1;t.preallocate=function(e=null){if(n)return;let s=null===e?i:Math.min(e,i);for(let e=0;e<s;e++)t.recyclerPool.push(new t),t.recyclerLength++,c++;n=!0},t.allocate=function(){let e;return this.recyclerLength?(e=this.recyclerPool[--this.recyclerLength],t.recyclerRecycled++):(e=new t,t.recyclerCreated++),t.recyclerActive++,e.objectId=++this.recyclerNextObjectId,this.recyclerNextObjectId&=2147483647,e},t.alloc=function(e=null,i=null,n=null,s=null,r=null,a=null,l=null,o=null,h=null,u=null){return t.allocate().init(e,i,n,s,r,a,l,o,h,u)},t.prototype.free=function(){return this.objectId<0?this:0==this.objectId?(console.error("ERROR: Already released instance of "+t.prototype.className),this):(this.__dtor(),this.objectId=0,t.recyclerLength>=e?t.recyclerMissed++:t.recyclerPool[t.recyclerLength++]=this,t.recyclerActive--,this)},t.prototype.lockInstance=function(t){return this.objectId=Math.abs(this.objectId),t&&(this.objectId=-this.objectId),this}},d.showStats=function(t=null){let e=u;if(console.log("Total Preallocated: "+c),!0!==t){if(null!==t){if("string"==typeof t){let e=u[t];return void console.debug(t+": "+(e.recyclerCreated/e.recyclerPoolMax*100).toFixed(1)+"%  =>  overhead="+e.recyclerCreated+", active="+e.recyclerActive+", array="+e.recyclerPool.length+", recycled="+e.recyclerRecycled+", in-recycler="+e.recyclerLength+", missed="+e.recyclerMissed+", space="+(e.recyclerPoolMax-e.recyclerLength))}e=t}console.group("Recycling Facilities");for(let t in e){let i=e[t];console.debug(t+": "+(i.recyclerCreated/i.recyclerPoolMax*100).toFixed(1)+"%  =>  overhead="+i.recyclerCreated+", active="+i.recyclerActive+", array="+i.recyclerPool.length+", recycled="+i.recyclerRecycled+", in-recycler="+i.recyclerLength+", missed="+i.recyclerMissed+", space="+(i.recyclerPoolMax-i.recyclerLength))}console.groupEnd()}else{console.group("Recycling Facilities");for(let t in e){let i=e[t];i.recyclerCreated&&console.debug(t+": "+(i.recyclerCreated/i.recyclerPoolMax*100).toFixed(1)+"%  =>  overhead="+i.recyclerCreated+", active="+i.recyclerActive+", array="+i.recyclerPool.length+", recycled="+i.recyclerRecycled+", in-recycler="+i.recyclerLength+", missed="+i.recyclerMissed+", space="+(i.recyclerPoolMax-i.recyclerLength))}console.groupEnd()}},d.createPool=function(t,e=8192,i=null){const n=t.prototype.className;if(!n)throw new Error("Unable to create pool sub-class on an unnamed class.");const s=t.extend({className:t.prototype.className,__ctor:function(){},init:function(t=null,e=null,i=null,s=null,r=null,a=null,l=null,o=null,h=null,u=null){return this._super[n].__ctor(t,e,i,s,r,a,l,o,h,u),this}});return d.attachTo(s,e,i),t.Pool=s,t},d.preallocate=function(t=null){c=0;for(let e in u)u[e].preallocate(t);return c};
//![import "./recycler"]
//!class Linkable
const p=t.extend({className:"Linkable",prev:null,next:null,value:null,__ctor:function(t){this.value=t,this.clear()},__dtor:function(){this.unlink()},clear:function(){return this.next=this.prev=null,this},linkAfter:function(t){this.prev=t,this.next=t?t.next:null,t&&(t.next&&(t.next.prev=this),t.next=this)},linkBefore:function(t){this.prev=t?t.prev:null,this.next=t,t&&(t.prev&&(t.prev.next=this),t.prev=this)},unlink:function(){return this.prev&&(this.prev.next=this.next),this.next&&(this.next.prev=this.prev),this.clear()}});
//!/class
//!namespace Linkable
//!namespace Pool
f.createPool(p,16384,6144);var m=p;
//![import "./linkable"]
//![import "./recycler"]
//!class List
const g=t.extend({className:"List",top:null,bottom:null,length:0,__ctor:function(){this.top=null,this.bottom=null,this.length=0},__dtor:function(){this.reset()},clone:function(){let t=g.Pool.alloc();for(let e=this.top;e;e=e.next)t.push(s.clone(e.value));return t},clear:function(){let t,e;for(t=this.top;t;t=e)e=t.next,dispose(t.free().value);return this.top=this.bottom=null,this.length=0,this},reset:function(){let t,e;for(t=this.top;null!=t;t=e)e=t.next,t.free();return this.top=this.bottom=null,this.length=0,this},first:function(){return null!==this.top?this.top.value:null},last:function(){return null!==this.bottom?this.bottom.value:null},getAt:function(t){let e=null;for(e=this.top;e&&t-- >0;e=e.next);return null!=e?e.value:null},getNodeAt:function(t){let e=null;for(e=this.top;e&&t--;e=e.next);return e},sgetNode:function(t){for(let e=this.top;e;e=e.next)if(e.value===t)return e;return null},remove:function(t){return null==t||m.isInstance(t)||(t=this.sgetNode(t)),t?(t.prev||(this.top=t.next),t.next||(this.bottom=t.prev),this.length--,t.free().value):null},insertBefore:function(t,e){if(!t)return this;let i=m.Pool.alloc(e);return i.linkBefore(t),t==this.top&&(this.top=i),this.length++,e},insertAfter:function(t,e){if(!t)return this;let i=m.Pool.alloc(e);return i.linkAfter(t),t==this.bottom&&(this.bottom=i),this.length++,e},unshift:function(t){let e=m.Pool.alloc(t);return e.linkBefore(this.top),this.bottom||(this.bottom=e),this.top=e,this.length++,t},shift:function(){let t=this.top;return t?((this.top=t.next)||(this.bottom=null),this.length--,t.free().value):null},push:function(t){let e=m.Pool.alloc(t);return e.linkAfter(this.bottom),this.top||(this.top=e),this.bottom=e,this.length++,t},pop:function(){let t=this.bottom;return t?((this.bottom=t.prev)||(this.top=null),this.length--,t.free().value):null},append:function(t){for(let e=t.top;e;e=e.next)this.push(e.value);return this},forEach:function(t,e=null){let i;for(let n=this.top;n;n=i)if(i=n.next,!1===t(n.value,n,this,e))return!1;return!0},forEachRev:function(t,e=null){let i;for(let n=this.bottom;n;n=i)if(i=n.prev,!1===t(n.value,n,this,e))return!1;return!0},find:function(t,e=null){for(let i=this.top;i;i=i.next)if(t(i.value,e))return i.value;return null},filter:function(t,e=null){let i=g.Pool.alloc();for(let n=this.top;n;n=n.next)t(n.value,e)&&i.push(n.value);return i},toArray:function(){let t=[];for(let e=this.top;e;e=e.next)t.push(e.value);return t}});
//!/class
//!namespace List
//!namespace Pool
f.createPool(g,16384,6144);var x=g;
//!class Timer
const y=function(t,e,i){this.callback=i,this.interval=e,this.vsync=t,this.handle=null,this.isRunning=!1,this.startTime=0,this.rTime=0,this.sTime=0,this.lTime=0,this.tDelta=0,this._onTimeout=()=>{this.onTimeout()},this._onTimeout_b=()=>{this.runNow()}};y.prototype.onTimeout=function(){if(!this.isRunning)return;this.rTime=hrnow()-this.startTime;let t=this.rTime-(this.sTime+this.interval);t<0?this.runAfter(-t):(this.sTime+=this.interval*(1+int(t/this.interval)),this.tDelta=t<0?this.interval:this.rTime-this.lTime,this.lTime=this.rTime,this.runAfter(this.sTime+this.interval-(hrnow()-this.startTime)),this.callback(this.tDelta,this))},y.prototype.start=function(t=!1,e=1){this.isRunning||(this.startTime=hrnow(),this.isRunning=!0,this.sTime=0,this.lTime=0,this.onStarted(),t&&this.callback(0,this),this.runAfter(this.interval*e))},y.prototype.runAfter=function(t){this.vsync?requestAnimationFrame(this._onTimeout_b):(this.handle&&clearTimeout(this.handle),this.handle=setTimeout(this._onTimeout,t))},y.prototype.runNow=function(){this.handle&&clearTimeout(this.handle),this.handle=setTimeout(this._onTimeout,0)},y.prototype.stop=function(){this.isRunning&&(this.handle&&(clearTimeout(this.handle),this.handle=null),this.isRunning=!1,this.onStopped())},y.prototype.onStarted=function(){},y.prototype.onStopped=function(){};var _=y;
//![import "../utils/recycler"]
//!class Vec2
const v=t.extend({className:"Vec2",x:0,y:0,__ctor:function(t=null,e=null){return this.set(t,e)},clone:function(){return v.Pool.alloc(this)},set:function(t,e=null){if(null===t)t=0,e=0;else if(null===e){let i=t;t=i.x,e=i.y}return this.x=t,this.y=e,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},zero:function(){return this.set(0,0)},isZero:function(){return 0==this.x&&0==this.y},equals:function(t,e=null){if(null===e){let i=t;t=i.x,e=i.y}return this.x==t&&this.y==e},neg:function(){return this.x=-this.x,this.y=-this.y,this},inv:function(){return this.x=1/this.x,this.y=1/this.y,this},abs:function(){return this.x=this.x<0?-this.x:this.x,this.y=this.y<0?-this.y:this.y,this},translate:function(t,e=null){if(null===e){let i=t;t=i.x,e=i.y}return this.x+=t,this.y+=e,this},rotate:function(t){let e=this.x*Math.cos(t)+this.y*Math.sin(t),i=this.y*Math.cos(t)-this.x*Math.sin(t);return this.x=e,this.y=i,this},add:function(t,e=null){if(null===e){let i=t;t=i.x,e=i.y}return this.x+=t,this.y+=e,this},sub:function(t,e=null){if(null===e){let i=t;t=i.x,e=i.y}return this.x-=t,this.y-=e,this},scale:function(t,e=null){if(null===e)if(v.isInstance(t)){let i=t;t=i.x,e=i.y}else e=t;return this.x*=t,this.y*=e,this},floor:function(){return this.x=int(this.x),this.y=int(this.y),this},fract:function(){return this.x=this.x-int(this.x),this.y=this.y-int(this.y),this},dot:function(t,e=null){if(null===e){let i=t;t=i.x,e=i.y}return this.x*t+this.y*e},magnitude:function(t=!1){return t?this.x*this.x+this.y*this.y:Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.isZero()?this:this.scale(1/this.magnitude())},majorAxis:function(){return Math.abs(this.x)>Math.abs(this.y)?this.y=0:this.x=0,this},minorAxis:function(){return Math.abs(this.x)<Math.abs(this.y)?this.y=0:this.x=0,this},sign:function(){return this.x=this.x?this.x<0?-1:1:0,this.y=this.y?this.y<0?-1:1:0,this},toString:function(){return`(${this.x}, ${this.y})`}});
//!/class
//!namespace Vec2
//!namespace Pool
f.createPool(v,4096,2048);var b=v;
//![import "../utils/recycler"]
//![import "./vec2"]
const w=new Float32Array(9).fill(0),E=new Float32Array(9).fill(0),T=t.extend({className:"Matrix",data:null,__ctor:function(t=null){null===this.data&&(this.data=new Float32Array(9)),null!==t?this.set(t):this.identity()},zero:function(){return this.data.fill(0),this},fill:function(t){return this.data.fill(t),this},set:function(t){if(T.isInstance(t))for(let e=0;e<9;e++)this.data[e]=t.data[e];else for(let e=0;e<9;e++)this.data[e]=t[e];return this},identity:function(t=null){return null===t&&(t=this.data),t.fill(0),t[0]=t[4]=t[8]=1,this},scalef:function(t){for(let e=0;e<9;e++)this.data[e]*=t;return this},clone:function(){return T.Pool.alloc(this)},append:function(t){t instanceof T&&(t=t.data);for(let t=0;t<9;t++)w[t]=this.data[t];return this.data[0]=t[0]*w[0]+t[1]*w[3]+t[2]*w[6],this.data[1]=t[0]*w[1]+t[1]*w[4]+t[2]*w[7],this.data[2]=t[0]*w[2]+t[1]*w[5]+t[2]*w[8],this.data[3]=t[3]*w[0]+t[4]*w[3]+t[5]*w[6],this.data[4]=t[3]*w[1]+t[4]*w[4]+t[5]*w[7],this.data[5]=t[3]*w[2]+t[4]*w[5]+t[5]*w[8],this.data[6]=t[6]*w[0]+t[7]*w[3]+t[8]*w[6],this.data[7]=t[6]*w[1]+t[7]*w[4]+t[8]*w[7],this.data[8]=t[6]*w[2]+t[7]*w[5]+t[8]*w[8],this},translate:function(t,e){if(0==t&&0==e)return this;for(let t=0;t<9;t++)w[t]=this.data[t];return this.data[6]=t*w[0]+e*w[3]+w[6],this.data[7]=t*w[1]+e*w[4]+w[7],this.data[8]=t*w[2]+e*w[5]+w[8],this},rotate:function(t){if(0==t)return this;this.identity(E);let e=Math.cos(t),i=Math.sin(t);return E[0]=e,E[1]=-i,E[3]=i,E[4]=e,this.append(E)},scale:function(t,e){return 1==t&&1==e?this:(this.identity(E),E[0]=t,E[4]=e,this.append(E))},applyTo:function(t,e=null){if(null===e){const i=t;t=i.x,e=i.y}let i=this.data[0]*t+this.data[3]*e+this.data[6],n=this.data[1]*t+this.data[4]*e+this.data[7];return b.Pool.alloc(i,n)},transpose:function(){w.fill(0);for(let t=0;t<3;t++)for(let e=0;e<3;e++)w[3*t+e]=this.data[3*e+t];for(let t=0;t<9;t++)this.data[t]=w[t];return this},det:function(){return this.data[0]*(this.data[4]*this.data[8]-this.data[5]*this.data[7])-this.data[1]*(this.data[3]*this.data[8]-this.data[5]*this.data[6])+this.data[2]*(this.data[3]*this.data[7]-this.data[4]*this.data[6])},adj:function(){throw new Error("NOT IMPLEMENTED")},inverse:function(){let t=this.det();return t?this.adj().scalef(1/t):null},toString:function(){return`[${this.data[0]}, ${this.data[3]}, ${this.data[6]}]\n[${this.data[1]}, ${this.data[4]}, ${this.data[7]}]\n[${this.data[2]}, ${this.data[5]}, ${this.data[8]}]\n`}});T.loadIdentity=function(t){t.fill(0),t[0]=t[4]=t[8]=1},
//!/class
//!namespace Matrix
//!namespace Pool
f.createPool(T,4096,1024);var k=T;
//![import "./globals"]
//!class Shader
const S=t.extend({id:null,type:0,sourceCode:null,shaderId:null,__ctor:function(t,e){this.id=t,this.type=e,this.sourceCode="",this.shaderId=null,S.put(t,this)},__dtor:function(){let t=B.gl;t&&(t.deleteShader(this.shaderId),S.remove(this.id))},source:function(t){return this.sourceCode+=t,this},compile:function(){let t=B.gl;t&&(this.shaderId=t.createShader(this.type===S.Type.VERTEX?t.VERTEX_SHADER:this.type===S.Type.FRAGMENT?t.FRAGMENT_SHADER:t.GEOMETRY_SHADER),t.shaderSource(this.shaderId,this.sourceCode),t.compileShader(this.shaderId))},getError:function(){let t=B.gl;return t?null===this.shaderId?"Shader has not been compiled.":t.getShaderInfoLog(this.shaderId):""}});
//!/class
S.shaders={},S.put=function(t,e){this.shaders[t]=e},S.get=function(t){return this.shaders[t]},S.remove=function(t){delete this.shaders[t]},
//!namespace Shader
//!enum Type
S.Type={VERTEX:0,
//!VERTEX
FRAGMENT:1,
//!FRAGMENT
GEOMETRY:2};var//!/enum
I=S;
//![import "./shader"]
//![import "./globals"]
//!class ShaderProgram
const P=t.extend({uniform_location_matrix:0,uniform_transform_matrix:0,uniform_texture_matrix:0,uniform_resolution:0,uniform_texture_size:0,uniform_frame_size:0,uniform_base_color:0,uniform_time:0,uniform_depth:0,uniform_scale:0,uniform_alpha:0,uniform_texture_0:0,attrib_location:0,id:null,shaders:null,programId:null,__ctor:function(t){this.id=t,this.shaders=[],this.programId=null,P.put(t,this)},__dtor:function(){let t=B.gl;if(!t)return this;t.deleteProgram(this.programId),P.remove(this.id)},attach:function(t){if("string"==typeof t&&(t=I.get(t)),!t)throw new Error("Unable to attach shader, invalid argument.");return this.shaders.push(t),this},bindLocations:function(t){t.bindAttribLocation(this.programId,0,"location")},loadLocations:function(t){this.uniform_location_matrix=t.getUniformLocation(this.programId,"m_location"),this.uniform_transform_matrix=t.getUniformLocation(this.programId,"m_transform"),this.uniform_texture_matrix=t.getUniformLocation(this.programId,"m_texture"),this.uniform_resolution=t.getUniformLocation(this.programId,"v_resolution"),this.uniform_texture_size=t.getUniformLocation(this.programId,"v_texture_size"),this.uniform_frame_size=t.getUniformLocation(this.programId,"v_frame_size"),this.uniform_base_color=t.getUniformLocation(this.programId,"v_base_color"),this.uniform_time=t.getUniformLocation(this.programId,"f_time"),this.uniform_depth=t.getUniformLocation(this.programId,"f_depth"),this.uniform_scale=t.getUniformLocation(this.programId,"f_scale"),this.uniform_alpha=t.getUniformLocation(this.programId,"f_alpha"),this.uniform_texture_0=t.getUniformLocation(this.programId,"texture0"),this.attrib_location=t.getAttribLocation(this.programId,"location")},link:function(){let t=B.gl;if(!t)return this;this.programId=t.createProgram();for(let e of this.shaders)t.attachShader(this.programId,e.shaderId);return this.bindLocations(t),t.linkProgram(this.programId),this.loadLocations(t),this},use:function(){let t=B.gl;t&&t.useProgram(this.programId)},getStatus:function(){let t=B.gl;return!t||t.getProgramParameter(this.programId,t.LINK_STATUS)},getError:function(){let t=B.gl;return t?null===this.programId?"Program has not been linked.":t.getProgramInfoLog(this.programId):""},getAllErrors:function(){let t=">> PROGRAM:\n"+this.getError();for(let e of this.shaders)t+="\n>> "+(e.type===I.Type.VERTEX?"vertex":"fragment").toUpperCase()+":\n"+e.getError();return t}});P.programs={},P.put=function(t,e){this.programs[t]=e},P.get=function(t){return this.programs[t]},P.remove=function(t){delete this.programs[t]};var R=P;
//![import "../math/matrix"]
//![import "./system"]
//![import "../utils/list"]
//![import "./shader-program"]
//![import "./shader"]
//![import "./globals"]
//![import "./log"]
//!namespace Canvas
//!type Options =
//!/type
//!/namespace
//!class Canvas
const A=function(t=null){let e={elem:null,gl:!1,background:"#000000",width:0,height:0,hidden:!0,absolute:!1,antialias:!1,...t};const i=!r.document;null==e.elem?(this.elem=i?s.clone(A.passThruCanvas):r.document.createElement("canvas"),r.document&&1!=e.hidden&&(r.document.body.appendChild(this.elem),!0===e.absolute&&(this.elem.style.position="absolute",this.elem.style.left="0",this.elem.style.top="0"))):this.elem=e.elem,this.elem.getContext&&(!0!==e.gl||i?(this.context=this.elem.getContext("2d",{desynchronized:!1}),this.gl=null):(this.gl=this.elem.getContext("webgl2",{desynchronized:!1,alpha:!1}),this.context=null,L.write(this.gl.getParameter(this.gl.VERSION)+", "+this.gl.getParameter(this.gl.SHADING_LANGUAGE_VERSION)),B.gl=this.gl),this.matrixStack=x.Pool.alloc(),this.alphaStack=x.Pool.alloc(),this.depthFlagStack=x.Pool.alloc(),this.shaderProgramStack=x.Pool.alloc(),this.matr=k.Pool.alloc(),this.transform=k.Pool.alloc(),this._globalScale=1,this._alpha=1,this._depthFlag=!0,this.shaderProgram=null,this.updateTransform(),this.strokeStyle("#fff"),this.fillStyle("#fff"),e.width&&e.height&&this.resize(e.width,e.height),null!==this.gl&&this.initGl(),this.antialias=e.antialias,this.setBackground(e.background))};A.passThruCanvas={parentNode:null,imageSmoothingEnabled:!0,style:{},width:960,height:540,getContext:function(t){return this},pushClip:function(){},popClip:function(){},scale:function(t,e){},rotate:function(t){},translate:function(t,e){},setTransform:function(t,e,i,n,s,r){},updateTransform:function(){},toDataURL:function(t,e){return""},beginPath:function(){},moveTo:function(t,e){},closePath:function(){},lineTo:function(){},rect:function(t,e,i,n){},fill:function(){},stroke:function(){},fillRect:function(t,e,i,n){},strokeRect:function(t,e,i,n){},clip:function(){},quadraticCurveTo:function(t,e,i,n){},bezierCurveTo:function(t,e,i,n,s,r){},arc:function(t,e,i,n,s,r){},arcTo:function(t,e,i,n,s){},fillText:function(t,e,i,n){},strokeText:function(t,e,i,n){},measureText:function(t){return{width:0}},createImageData:function(t,e){return{width:t,height:e}},getImageData:function(t,e,i,n){return{width:i,height:n,data:[]}},putImageData:function(t,e,i){},drawImage:function(t,e=0,i=0,n=null,s=null,r=null,a=null,l=null,o=null,h=null,u=null,c=null,d=null){},getBoundingClientRect:function(){return{left:0,top:0}}},A.prototype.initGl=function(){let t=this.gl;if(this.glDefaultProgram=new R("def"),new I("def-vert",I.Type.VERTEX).source("#version 300 es\n\t\tprecision highp float;\n\n\t\tuniform mat3 m_location;\n\t\tuniform mat3 m_transform;\n\t\tuniform mat3 m_texture;\n\n\t\tuniform vec2 v_resolution;\n\t\tuniform vec2 v_texture_size;\n\t\tuniform vec2 v_frame_size;\n\n\t\tuniform float f_time;\n\t\tuniform float f_depth;\n\n\t\tuniform sampler2D texture0;\n\n\t\tin vec2 location;\n\t\tout vec2 texcoords;\n\n\t\tvoid main()\n\t\t{\n\t\t\tgl_Position = vec4(((vec2(m_transform * m_location * vec3(location, 1.0)) / v_resolution)*2.0 - vec2(1.0, 1.0)) * vec2(1.0, -1.0), f_depth / 16777216.0, 1.0);\n\t\t\ttexcoords = vec2(m_texture * vec3(location, 1.0)) / v_texture_size;\n\t\t}\n\t").compile(),new I("def-frag",I.Type.FRAGMENT).source("#version 300 es\n\t\tprecision highp float;\n\n\t\tuniform sampler2D texture0;\n\t\tuniform float f_alpha;\n\t\tin vec2 texcoords;\n\n\t\tout vec4 color;\n\n\t\tvoid main()\n\t\t{\n\t\t\tcolor = texture(texture0, texcoords);\n\t\t\tcolor.a *= f_alpha;\n\n\t\t\tif (color.a == 0.0) discard;\n\t\t}\n\t").compile(),this.glRepeatProgram=new R("repeat"),new I("repeat-vert",I.Type.VERTEX).source("#version 300 es\n\t\tprecision highp float;\n\t\t\n\t\tuniform mat3 m_location;\n\t\tuniform mat3 m_transform;\n\t\tuniform mat3 m_texture;\n\t\t\n\t\tuniform vec2 v_resolution;\n\t\tuniform vec2 v_texture_size;\n\t\tuniform vec2 v_frame_size;\n\t\t\n\t\tuniform float f_time;\n\t\tuniform float f_depth;\n\t\t\n\t\tuniform sampler2D texture0;\n\t\t\n\t\tin vec2 location;\n\t\tout vec2 texcoords;\n\t\t\n\t\tout vec2 texoffs;\n\t\tout vec2 texsiz;\n\t\t\n\t\tvoid main()\n\t\t{\n\t\t\tgl_Position = vec4(((vec2(m_transform * m_location * vec3(location, 1.0)) / v_resolution)*2.0 - vec2(1.0, 1.0)) * vec2(1.0, -1.0), f_depth / 16777216.0, 1.0);\n\t\t\n\t\t\ttexcoords = vec2(\n\t\t\t\t(location.x*m_texture[0][0]/v_texture_size[0])*(m_location[0][0] / v_frame_size[0]),\n\t\t\t\t(location.y*m_texture[1][1]/v_texture_size[1])*(m_location[1][1] / v_frame_size[1])\n\t\t\t);\n\t\t\n\t\t\ttexoffs = vec2(m_texture[2][0]/v_texture_size[0], m_texture[2][1]/v_texture_size[1]);\n\t\t\ttexsiz = vec2(m_texture[0][0]/v_texture_size[0], m_texture[1][1]/v_texture_size[1]);\n\t\t}\n\t").compile(),new I("repeat-frag",I.Type.FRAGMENT).source("#version 300 es\n\t\tprecision highp float;\n\t\t\n\t\tuniform mat3 m_texture;\n\t\tuniform vec2 v_texture_size;\n\t\t\n\t\tuniform sampler2D texture0;\n\t\tuniform float f_alpha;\n\t\t\n\t\tin vec2 texcoords;\n\t\tin vec2 texoffs;\n\t\tin vec2 texsiz;\n\t\t\n\t\tout vec4 color;\n\t\t\n\t\tvoid main()\n\t\t{\n\t\t\tcolor = texture(texture0, mod(texcoords, texsiz) + texoffs);\n\t\t\n\t\t\tcolor.a *= f_alpha;\n\t\t\tif (color.a == 0.0) discard;\n\t\t}\n\t").compile(),this.glBlitProgram=new R("blit"),new I("blit-vert",I.Type.VERTEX).source("#version 300 es\n\t\tprecision highp float;\n\n\t\tuniform mat3 m_location;\n\t\tuniform mat3 m_texture;\n\t\tuniform vec2 v_resolution;\n\t\tuniform vec2 v_texture_size;\n\n\t\tuniform sampler2D texture0;\n\n\t\tin vec2 location;\n\t\tout vec2 texcoords;\n\n\t\tvoid main()\n\t\t{\n\t\t\tgl_Position = vec4(((vec2(m_location * vec3(location, 1.0)) / v_resolution)*2.0 - vec2(1.0, 1.0)) * vec2(1.0, 1.0), 0.0, 1.0);\n\t\t\ttexcoords = vec2(m_texture * vec3(location, 1.0)) / v_texture_size;\n\t\t}\n\t").compile(),new I("blit-frag",I.Type.FRAGMENT).source("#version 300 es\n\t\tprecision highp float;\n\n\t\tuniform sampler2D texture0;\n\t\tin vec2 texcoords;\n\n\t\tout vec4 color;\n\n\t\tvoid main()\n\t\t{\n\t\t\tcolor = texture(texture0, texcoords);\n\t\t}\n\t").compile(),this.glDefaultProgram.attach("def-vert"),this.glDefaultProgram.attach("def-frag"),this.glRepeatProgram.attach("repeat-vert"),this.glRepeatProgram.attach("repeat-frag"),this.glBlitProgram.attach("blit-vert"),this.glBlitProgram.attach("blit-frag"),this.glDefaultProgram.link(),this.glRepeatProgram.link(),this.glBlitProgram.link(),!this.glDefaultProgram.getStatus())throw new Error(this.glDefaultProgram.getAllErrors());if(!this.glRepeatProgram.getStatus())throw new Error(this.glRepeatProgram.getAllErrors());if(!this.glBlitProgram.getStatus())throw new Error(this.glBlitProgram.getAllErrors());this.setShaderProgram(this.glDefaultProgram);let e=this.attrib_location_buffer=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(this.shaderProgram.attrib_location),t.vertexAttribPointer(this.shaderProgram.attrib_location,2,t.FLOAT,t.FALSE,2*Float32Array.BYTES_PER_ELEMENT,0*Float32Array.BYTES_PER_ELEMENT),t.clearColor(0,0,0,1),t.enable(t.DEPTH_TEST),t.clearDepth(0),t.depthFunc(t.GEQUAL),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.m_location=new Float32Array(9).fill(0),this.m_texture=new Float32Array(9).fill(0),this.v_texture_size=new Float32Array(2).fill(0),this.v_frame_size=new Float32Array(2).fill(0),this.v_resolution=new Float32Array(2).fill(0),this.zvalue=0,k.loadIdentity(this.m_location),k.loadIdentity(this.m_texture),this.drawImage=function(t,e=0,i=0,n=null,s=null,r=null,a=null,l=null,o=null,h=null,u=null,c=null,d=null){if(!t.glTextureReady)return;let f=this.gl,p=this.shaderProgram;return null===h&&(h=t.width,u=t.height),null===c&&(c=t.targetWidth,d=t.targetHeight),f.uniform2fv(p.uniform_resolution,this.v_resolution),f.uniform1f(p.uniform_time,B.time),f.uniform1f(p.uniform_scale,this._globalScale),f.uniform1f(p.uniform_alpha,this._alpha),this.glActiveTextureId===t.glTextureId&&this.glActiveShader===p||(f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,t.glTextureId),f.uniform1i(p.uniform_texture_0,0),this.v_texture_size[0]=h,this.v_texture_size[1]=u,f.uniform2fv(p.uniform_texture_size,this.v_texture_size),this.v_frame_size[0]=c,this.v_frame_size[1]=d,f.uniform2fv(p.uniform_frame_size,this.v_frame_size),this.glActiveTextureId=t.glTextureId,this.glActiveShader=p),null===n?(this.m_location[0]=h,this.m_location[4]=u,this.m_location[6]=e,this.m_location[7]=i,this.m_texture[0]=h,this.m_texture[4]=u,this.m_texture[6]=0,this.m_texture[7]=0,f.uniformMatrix3fv(p.uniform_transform_matrix,!1,this.transform.data),f.uniformMatrix3fv(p.uniform_location_matrix,!1,this.m_location),f.uniformMatrix3fv(p.uniform_texture_matrix,!1,this.m_texture),f.uniform1f(p.uniform_depth,this.zvalue),void f.drawArrays(f.TRIANGLE_STRIP,0,4)):null===r?(this.m_location[0]=n,this.m_location[4]=s,this.m_location[6]=e,this.m_location[7]=i,this.m_texture[0]=h,this.m_texture[4]=u,this.m_texture[6]=0,this.m_texture[7]=0,f.uniformMatrix3fv(p.uniform_transform_matrix,!1,this.transform.data),f.uniformMatrix3fv(p.uniform_location_matrix,!1,this.m_location),f.uniformMatrix3fv(p.uniform_texture_matrix,!1,this.m_texture),f.uniform1f(p.uniform_depth,this.zvalue),void f.drawArrays(f.TRIANGLE_STRIP,0,4)):(this.m_location[0]=l,this.m_location[4]=o,this.m_location[6]=r,this.m_location[7]=a,this.m_texture[0]=n,this.m_texture[4]=s,this.m_texture[6]=e,this.m_texture[7]=i,f.uniformMatrix3fv(p.uniform_transform_matrix,!1,this.transform.data),f.uniformMatrix3fv(p.uniform_location_matrix,!1,this.m_location),f.uniformMatrix3fv(p.uniform_texture_matrix,!1,this.m_texture),f.uniform1f(p.uniform_depth,this.zvalue),void f.drawArrays(f.TRIANGLE_STRIP,0,4))},this.drawRect=function(t,e,i,n){let s=this.gl,r=this.shaderProgram;s.uniform2fv(r.uniform_resolution,this.v_resolution),s.uniform1f(r.uniform_time,B.time),s.uniform1f(r.uniform_scale,this._globalScale),s.uniform1f(r.uniform_alpha,this._alpha),this.glActiveTextureId=null,this.v_texture_size[0]=i,this.v_texture_size[1]=n,s.uniform2fv(r.uniform_texture_size,this.v_texture_size),this.m_location[0]=i,this.m_location[4]=n,this.m_location[6]=t,this.m_location[7]=e,this.m_texture[0]=i,this.m_texture[4]=n,this.m_texture[6]=0,this.m_texture[7]=0,s.uniformMatrix3fv(r.uniform_transform_matrix,!1,this.transform.data),s.uniformMatrix3fv(r.uniform_location_matrix,!1,this.m_location),s.uniformMatrix3fv(r.uniform_texture_matrix,!1,this.m_texture),s.uniform1f(r.uniform_depth,this.zvalue),s.drawArrays(s.TRIANGLE_STRIP,0,4)}},A.prototype.prepareImage=function(t){let e=this.gl;if(null==e)return!1;let i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8,t.width,t.height),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.width,t.height,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t.glTextureId=i,t.glTextureReady=!0,!0},A.prototype.setWrapRepeat=function(t){let e=this.gl;return null!=e&&t.glTextureReady?(e.bindTexture(e.TEXTURE_2D,t.glTextureId),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),t):t},A.prototype.applyConfig=function(){0==this.antialias?(null!=this.context&&(this.context.imageSmoothingEnabled=!1),this.elem.style.imageRendering="crisp-edges"):(null!=this.context&&(this.context.imageSmoothingEnabled=!0),this.elem.style.imageRendering="auto")},A.prototype.dispose=function(){this.elem.parentNode&&this.elem.parentNode.removeChild(this.elem),this.matrixStack.free(),this.alphaStack.free(),this.depthFlagStack.free(),this.shaderProgramStack.free(),this.matr=null,this.context=null,this.elem=null},A.prototype.setBackground=function(t){if(this.elem.style.background=t,this.backgroundColor=t,null!==this.gl){if(7!=t.length)throw new Error("Canvas.setBackground: color parameter should be CSS-style hex-rgb with 6 digits.");let e=parseInt(t.substr(1,2),16)/255,i=parseInt(t.substr(3,2),16)/255,n=parseInt(t.substr(5,2),16)/255;this.gl.clearColor(e,i,n,1)}},A.prototype.resize=function(t,e){let i=this.elem.getBoundingClientRect();t||(t=i.width),e||(e=i.height),this.elem.width=t,this.elem.height=e,this.width=this.elem.width,this.height=this.elem.height,this._width=int(this.width/this._globalScale),this._height=int(this.height/this._globalScale);let n=this.gl;return null!=n&&(n.enable(n.SCISSOR_TEST),n.scissor(0,0,this.width,this.height),n.viewport(0,0,this.width,this.height),this.v_resolution&&(this.v_resolution[0]=this.width,this.v_resolution[1]=this.height)),this.applyConfig(),this},A.prototype.globalScale=function(t){return this._globalScale=t,this._width=int(this.width/this._globalScale),this._height=int(this.height/this._globalScale),this.loadIdentity(),this.scale(t,t),this},A.prototype.flipped=function(t){return t?(this._width=int(this.height/this._globalScale),this._height=int(this.width/this._globalScale)):(this._width=int(this.width/this._globalScale),this._height=int(this.height/this._globalScale)),this.isFlipped=t,this},A.prototype.pushClip=function(){return this},A.prototype.popClip=function(){return null!=this.gl&&this.gl.scissor(0,0,this.width,this.height),this},A.prototype.toDataUrl=function(t="image/png",e=null){return this.elem.toDataURL(t,e)},A.prototype.toPngBase64=function(){return this.elem.toDataURL("image/png").substr(22)},A.prototype._contextAttribute=function(t,e=null){if(this.context)return null!==e?(this.context[t]=e,this):this.context[t]},A.prototype.fillStyle=function(t){return this._contextAttribute("fillStyle",t)},A.prototype.strokeStyle=function(t){return this._contextAttribute("strokeStyle",t)},A.prototype.lineCap=function(t){return this._contextAttribute("lineCap",t)},A.prototype.lineJoin=function(t){return this._contextAttribute("lineJoin",t)},A.prototype.lineWidth=function(t){return this._contextAttribute("lineWidth",t)},A.prototype.miterLimit=function(t){return this._contextAttribute("miterLimit",t)},A.prototype.shadowColor=function(t){return this._contextAttribute("shadowColor",t)},A.prototype.shadowOffsetX=function(t){return this._contextAttribute("shadowOffsetX",t)},A.prototype.shadowOffsetY=function(t){return this._contextAttribute("shadowOffsetY",t)},A.prototype.shadowBlur=function(t){return this._contextAttribute("shadowBlur",t)},A.prototype.font=function(t){return this._contextAttribute("font",t)},A.prototype.textAlign=function(t){return this._contextAttribute("textAlign",t)},A.prototype.textBaseline=function(t){return this._contextAttribute("textBaseline",t)},A.prototype.globalAlpha=function(t=null){return null===t?this._alpha:(this._alpha=t,this.alpha(1))},A.prototype.globalCompositeOperation=function(t){return this._contextAttribute("globalCompositeOperation",t)},A.prototype.updateTransform=function(){return this.setTransform(this.matr.data[0],this.matr.data[1],this.matr.data[3],this.matr.data[4],this.matr.data[6],this.matr.data[7]),this},A.prototype.setTransform=function(t,e,i,n,s,r){return null===this.context?(this.transform.data[0]=t,this.transform.data[1]=e,this.transform.data[2]=0,this.transform.data[3]=i,this.transform.data[4]=n,this.transform.data[5]=0,this.transform.data[6]=int(s),this.transform.data[7]=int(r),this.transform.data[8]=1,this):(this.context.setTransform(t,e,i,n,int(s),int(r)),this)},A.prototype.fillRect=function(t,e,i,n){return this.context.fillRect(t,e,i,n),this},A.prototype.strokeRect=function(t,e,i,n){return this.context.strokeRect(t,e,i,n),this},A.prototype.clearRect=function(t,e,i,n){return this.context.clearRect(t,e,i,n),this},A.prototype.beginPath=function(){return this.context.beginPath(),this},A.prototype.moveTo=function(t,e){return this.context.moveTo(t,e),this},A.prototype.closePath=function(){return this.context.closePath(),this},A.prototype.lineTo=function(t,e){return this.context.lineTo(t,e),this},A.prototype.rect=function(t,e,i,n){return this.context.rect(t,e,i,n),this},A.prototype.fill=function(t=null){return t&&this.fillStyle(t),this.context.fill(),this},A.prototype.stroke=function(t=null){return t&&this.strokeStyle(t),this.context.stroke(),this},A.prototype.clip=function(t,e,i,n){return null!==this.gl&&(t*=this._globalScale,e*=this._globalScale,i*=this._globalScale,n*=this._globalScale,this.isFlipped?this.gl.scissor(this.width-e-n-1,this.height-t-i-1,n,i):this.gl.scissor(t,this.height-e-n-1,i,n)),this},A.prototype.quadraticCurveTo=function(t,e,i,n){return this.context.quadraticCurveTo(t,e,i,n),this},A.prototype.bezierCurveTo=function(t,e,i,n,s,r){return this.context.bezierCurveTo(t,e,i,n,s,r),this},A.prototype.arc=function(t,e,i,n,s,r){return this.context.arc(t,e,i,n,s,r),this},A.prototype.arcTo=function(t,e,i,n,s){return this.context.arcTo(t,e,i,n,s),this},A.prototype.fillText=function(t,e,i,n=1e3){return this.context.fillText(t,e,i,n),this},A.prototype.strokeText=function(t,e,i,n=1e3){return this.context.strokeText(t,e,i,n),this},A.prototype.measureText=function(t){return this.context.measureText(t).width},A.prototype.createImageData=function(t,e){return this.context.createImageData(t,e)},A.prototype.getImageData=function(t,e,i,n){return this.context.getImageData(t,e,i,n)},A.prototype.putImageData=function(t,e,i){return this.context.putImageData(t,e,i),this},A.prototype.drawImage=function(t,e=0,i=0,n=null,s=null,r=null,a=null,l=null,o=null){if(null===n)this.context.drawImage(t,int(e),int(i));else if(null===r)this.context.drawImage(t,int(e),int(i),int(n),int(s));else{let h=int(n),u=int(s);if(!h||!u)return this;let c=int(l),d=int(o);if(!c||!d)return this;this.context.drawImage(t,int(e),int(i),h,u,int(r),int(a),c,d)}return this},A.prototype.clear=function(t=null){return null!=this.gl?(this.gl.clear(this.gl.DEPTH_BUFFER_BIT|this.gl.COLOR_BUFFER_BIT),this.glActiveTextureId=null,this):(t?this.globalCompositeOperation("source-over").globalAlpha(1).fillStyle(!0!==t?t:this.backgroundColor).fillRect(0,0,this._width,this._height):(this.elem.width=this.width,this.applyConfig()),this.updateTransform(),this)},A.prototype.start=function(){},A.prototype.end=function(){},A.prototype.flush=function(){let t=this.gl;null!==t&&(t.colorMask(!1,!1,!1,!0),t.clear(t.COLOR_BUFFER_BIT),t.colorMask(!0,!0,!0,!0))},A.prototype.blit=function(t,e,i,n=null){let s=this.gl;null!==s&&(n=n||this.glBlitProgram,this.setShaderProgram(n),s.disable(s.DEPTH_TEST),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,t),s.uniform1i(n.uniform_texture_0,0),s.uniform2fv(n.uniform_resolution,this.v_resolution),s.uniform1f(n.uniform_time,B.time),s.uniform1f(n.uniform_scale,this._globalScale),s.uniform1f(n.uniform_alpha,this._alpha),this.v_texture_size[0]=e,this.v_texture_size[1]=i,s.uniform2fv(n.uniform_texture_size,this.v_texture_size),this.m_location[0]=this.width,this.m_location[4]=this.height,this.m_location[6]=0,this.m_location[7]=0,this.m_texture[0]=this.width,this.m_texture[4]=this.height,this.m_texture[6]=0,this.m_texture[7]=0,s.uniformMatrix3fv(n.uniform_location_matrix,!1,this.m_location),s.uniformMatrix3fv(n.uniform_texture_matrix,!1,this.m_texture),s.drawArrays(s.TRIANGLE_STRIP,0,4),this.setShaderProgram(this.glDefaultProgram),s.enable(s.DEPTH_TEST))},A.prototype.reset=function(t=!1){return this.fillStyle("#000000").strokeStyle("#000000").lineCap("butt").lineJoin("miter").lineWidth("1").miterLimit("10").shadowColor("#000000").shadowOffsetX("0").shadowOffsetY("0").shadowBlur("0").globalAlpha("1.0").globalCompositeOperation("source-over"),t&&this.beginPath().closePath(),this},A.prototype.pushMatrix=function(){return this.matrixStack.push(this.matr),this.matr=this.matr.clone(),this},A.prototype.popMatrix=function(){return this.matr.free(),this.matr=this.matrixStack.pop(),this.updateTransform()},A.prototype.alpha=function(t){return this._alpha*=t,this.context&&null===this.gl&&(this.context.globalAlpha=this._alpha),this},A.prototype.pushAlpha=function(){return this.alphaStack.push(this.globalAlpha()),this},A.prototype.popAlpha=function(){return this.globalAlpha(this.alphaStack.pop()),this},A.prototype.setDepthFlag=function(t){let e=this.gl;null!==e&&(t?(e.enable(e.DEPTH_TEST),this._depthFlag=!0):(e.disable(e.DEPTH_TEST),this._depthFlag=!1))},A.prototype.getDepthFlag=function(){return this._depthFlag},A.prototype.pushDepthFlag=function(t=null){if(null!==t)return(t=!!t)!==this._depthFlag&&(this.depthFlagStack.push(this._depthFlag),this.setDepthFlag(t),!0);this.depthFlagStack.push(this._depthFlag)},A.prototype.popDepthFlag=function(){this.setDepthFlag(this.depthFlagStack.pop())},A.prototype.setShaderProgram=function(t){null!==this.gl&&(this.shaderProgram=t,this.shaderProgram.use())},A.prototype.getShaderProgram=function(){return this.shaderProgram},A.prototype.pushShaderProgram=function(t=null){if(null!==t)return t!==this.shaderProgram&&(this.shaderProgramStack.push(this.shaderProgram),this.setShaderProgram(t),!0);this.shaderProgramStack.push(this.shaderProgram)},A.prototype.popShaderProgram=function(){this.setShaderProgram(this.shaderProgramStack.pop())},A.prototype.loadIdentity=function(){return this.matr.identity(),this.updateTransform()},A.prototype.loadMatrix=function(t){return this.matr.set(t),this.updateTransform()},A.prototype.getMatrix=function(t=!1){return t?this.matr.clone():this.matr},A.prototype.appendMatrix=function(t){return this.matr.append(t),this.updateTransform()},A.prototype.scale=function(t,e,i){return i?(this.context.scale(t,e),this):(this.matr.scale(t,e),this.updateTransform())},A.prototype.rotate=function(t,e){return e?(this.context.rotate(t),this):(this.matr.rotate(t),this.updateTransform())},A.prototype.translate=function(t,e,i){return i?(this.context.translate(t,e),this):(this.matr.translate(t,e),this.updateTransform())},A.prototype.ellipse=function(t,e,i,n){var s=i/2*.5522848,r=n/2*.5522848,a=t+i-1,l=e+n-1,o=t+i/2,h=e+n/2;return this.beginPath().moveTo(t,h),this.bezierCurveTo(t,h-r,o-s,e,o,e),this.bezierCurveTo(o+s,e,a,h-r,a,h),this.bezierCurveTo(a,h+r,o+s,l,o,l),this.bezierCurveTo(o-s,l,t,h+r,t,h),this.closePath(),this},A.prototype.circle=function(t,e,i,n){return this.beginPath(),this.arc(t,e,i,0,2*Math.PI),this.closePath(),n&&this.stroke(n),this},A.prototype.line=function(t,e,i,n,s){return this.beginPath(),this.moveTo(t,e),this.lineTo(i,n),this.closePath(),s&&this.stroke(s),this},A.prototype.enablePointerEvents=function(){if(this.pointerHandler)return this;this.pointerScale={sx:1,sy:1},this.pointerOffset={x:0,y:0};var t=this,e={action:"",buttons:0,lbuttons:0,x:0,y:0,containedBy:function(t,e,i,n){return this.x>=t&&this.x<=t+i-1&&this.y>=e&&this.y<=e+n-1}};return this.pointerHandlers=[],this.pointerHandler=function(i,n){var s=this.elem.getBoundingClientRect();e.action=i,e.buttons=n.buttons,e.x=e.rx=int(n.clientX-s.left),e.y=e.ry=int(n.clientY-s.top),e.x=(e.x-t.pointerOffset.x-0*t.pointerScale.sx)/t.pointerScale.sx,e.y=(e.y-t.pointerOffset.y-0*t.pointerScale.sy)/t.pointerScale.sy,e.dragging=!1,e.buttons&&!e.lbuttons&&(e.sx=e.x,e.sy=e.y,e.ldx=e.ldy=0),e.buttons&&e.lbuttons&&(e.dragging=!0,e.dx=e.x-e.sx,e.dy=e.y-e.sy,e.ddx=e.dx-e.ldx,e.ddy=e.dy-e.ldy,e.ldx=e.dx,e.ldy=e.dy),e.lbuttons=e.buttons;for(var r=0;r<this.pointerHandlers.length&&!1!==this.pointerHandlers[r][1](e,this.pointerHandlers[r][2]);r++);},this.elem.onmousedown=function(e){t.pointerHandler("DOWN",e)},this.elem.onmouseup=function(e){t.pointerHandler("UP",e)},this.elem.onmousemove=function(e){t.pointerHandler("MOVE",e)},this},A.prototype.setPointerScale=function(t,e){return this.pointerScale={sx:t,sy:e},this},A.prototype.setPointerOffset=function(t,e){return this.pointerOffset={x:t,y:e},this},A.prototype.addPointerHandler=function(t,e){return this.enablePointerEvents(),this.pointerHandlers.push([this.pointerHandlers.length+"_"+int(1e6*Math.random()),t,e]),this.pointerHandlers[this.pointerHandlers.length-1][0]},A.prototype.removePointerHandler=function(t){if(this.pointerHandlers)for(var e=0;e<this.pointerHandlers.length;e++)if(this.pointerHandlers[e][0]==t){this.pointerHandlers.splice(e,1);break}},A.renderImage=function(t,e,i,n){let s=new A({width:t,height:e});i(s);let r=new Image;r.onload=()=>{M.renderer.prepareImage(r),n(r)},r.src=s.toDataUrl(),s.dispose()};var F=A;
//![import "./keycode"]
//![import "../utils/list"]
//![import "../utils/linkable"]
//![import "./timer"]
//![import "./canvas"]
//![import "./globals"]
//!namespace System
//!type Options =
//!/type
//!/namespace
//!class System
const N={flags:{renderingEnabled:!1,renderingPaused:!1},defaultOptions:{background:"#000000",gl:!0,log:!1,overdraw:!1,antialias:!0,orientation:0,fps:144,minFps:15,vsync:!0,screenWidth:null,screenHeight:null,extraScaleFactor:1,maxScaleFactor:null,fullscreen:!1},screenWidth:0,screenHeight:0,orientation:0,offsX:0,offsY:0,devicePixelRatio:1,backingStoreRatio:1,canvasPixelRatio:1,canvasScaleFactor:1,scaleFactor:1,initialMatrix:null,renderer:null,displayBuffer2:null,displayBuffer3:null,tempDisplayBuffer:null,keyState:{time:0,shift:!1,ctrl:!1,alt:!1,keyCode:0},pointerState:{},updateQueue:null,drawQueue:null,timeScale:1,frameInterval:0,fixedFrameInterval:0,maxFrameInterval:0,frameDelta:0,frameTime:0,frameNumber:0,perf:{startTime:0,lastTime:0,numFrames:0,numSamples:0,updateTimeTotal:0,drawTimeTotal:0,extraTimeTotal:0,fps:0,averageFps:0,averageUpdateTime:0,averageDrawTime:0,averageExtraTime:0},init:function(t=null){let e=this,i={...this.defaultOptions,...t};this.options=i,!1!==this.options.preallocate&&(!0===this.options.preallocate?f.preallocate():f.preallocate(this.options.preallocate)),i.screenWidth&&i.screenHeight&&"default"==i.orientation&&(i.orientation=i.screenWidth>i.screenHeight?"landscape":"portrait"),this.orientation=i.orientation,this.updateQueue=x.Pool.alloc(),this.drawQueue=x.Pool.alloc(),this.frameInterval=1e3/i.fps,this.maxFrameInterval=1e3/i.minFps,r.onresize=function(){e.onWindowResized()},this.frameTimer=new _(i.vsync,this.frameInterval,(t=>this.onFrame(t))),this.renderer=new F({gl:i.gl,elem:null,absolute:!0,hidden:!1,antialias:i.antialias,background:i.background}),this.displayBuffer2=new F({gl:!1,elem:null,absolute:!0,hidden:!1,antialias:i.antialias,background:"none"}),this.displayBuffer2.elem.style.pointerEvents="none",this.displayBuffer3=new F({gl:!1,elem:null,absolute:!0,hidden:!1,antialias:i.antialias,background:"none"}),this.displayBuffer3.elem.style.pointerEvents="none",this.tempDisplayBuffer=new F({hidden:!0,antialias:i.antialias}).resize(320,240);let n=this.renderer.elem;this.devicePixelRatio=r.devicePixelRatio||1,this.backingStoreRatio=!0===i.gl?1:this.renderer.context.webkitBackingStorePixelRatio||this.renderer.context.mozBackingStorePixelRatio||this.renderer.context.msBackingStorePixelRatio||this.renderer.context.oBackingStorePixelRatio||this.renderer.context.backingStorePixelRatio||1,this.canvasPixelRatio=this.devicePixelRatio/this.backingStoreRatio,N.onWindowResized(!0),r.onkeydown=function(t){if(t.target===r.document.body){if(e.keyState[t.keyCode])return!1;switch(e.keyState[t.keyCode]=!0,e.keyState.keyCode=t.keyCode,e.keyState.startTime=hrnow(),t.keyCode){case 16:e.keyState.shift=!0;break;case 17:e.keyState.ctrl=!0;break;case 18:e.keyState.alt=!0}return e.keyState.ctrl&&t.keyCode==h.TAB?(e.keyState[t.keyCode]=!1,!0):!1!==e.onKeyboardEvent(e.KeyboardEventType.KEY_DOWN,t.keyCode,e.keyState)&&void 0}},r.onkeyup=function(t){if(t.target===r.document.body){if(!e.keyState[t.keyCode])return!1;switch(e.keyState[t.keyCode]=!1,e.keyState.endTime=hrnow(),e.keyState.keyCode=t.keyCode,t.keyCode){case 16:e.keyState.shift=!1;break;case 17:e.keyState.ctrl=!1;break;case 18:e.keyState.alt=!1}return!1!==e.onKeyboardEvent(e.KeyboardEventType.KEY_UP,t.keyCode,e.keyState)&&void 0}};const s=function(t,e){return N.reverseRender?int(N.screenWidth-1-(e-N.offsY)/N.canvasScaleFactor):int((t-N.offsX)/N.canvasScaleFactor)},a=function(t,e){return N.reverseRender?int((t-N.offsX)/N.canvasScaleFactor):int((e-N.offsY)/N.canvasScaleFactor)};"ontouchstart"in r?(n.ontouchstart=function(t){t.preventDefault();let e=t.changedTouches;for(let t=0;t<e.length;t++){N.pointerState[e[t].identifier]||(N.pointerState[e[t].identifier]={id:e[t].identifier,isActive:!1,isDragging:!1,sx:0,sy:0,x:0,y:0,dx:0,dy:0,button:0,wheelDelta:0,wheelAccum:0});let i=N.pointerState[e[t].identifier];i.isActive=!0,i.isDragging=!1,i.button=1,i.startTime=hrnow(),i.x=i.sx=s(e[t].clientX,e[t].clientY),i.y=i.sy=a(e[t].clientX,e[t].clientY),N.onPointerEvent(N.PointerEventType.POINTER_DOWN,i,N.pointerState)}return!1},n.ontouchend=function(t){t.preventDefault();let e=t.changedTouches;for(let t=0;t<e.length;t++){if(!N.pointerState[e[t].identifier])continue;let i=N.pointerState[e[t].identifier];i.endTime=hrnow(),i.deltaTime=i.endTime-i.startTime,i.x=s(e[t].clientX,e[t].clientY),i.y=a(e[t].clientX,e[t].clientY),i.isDragging&&N.onPointerEvent(N.PointerEventType.POINTER_DRAG_STOP,i,N.pointerState),N.onPointerEvent(N.PointerEventType.POINTER_UP,i,N.pointerState),i.isActive=!1,i.isDragging=!1,i.button=0}return!1},n.ontouchcancel=function(t){t.preventDefault();let e=t.changedTouches;for(let t=0;t<e.length;t++){if(!N.pointerState[e[t].identifier])continue;let i=N.pointerState[e[t].identifier];i.x=s(e[t].clientX,e[t].clientY),i.y=a(e[t].clientX,e[t].clientY),N.onPointerEvent(i.isDragging?N.PointerEventType.POINTER_DRAG_STOP:N.PointerEventType.POINTER_UP,i,N.pointerState),i.isActive=!1,i.isDragging=!1,i.button=0}return!1},n.ontouchmove=function(t){t.preventDefault();let e=t.changedTouches;for(let t=0;t<e.length;t++){if(!N.pointerState[e[t].identifier])continue;let i=N.pointerState[e[t].identifier];i.isActive&&!i.isDragging&&(N.onPointerEvent(N.PointerEventType.POINTER_DRAG_START,i,N.pointerState),i.isDragging=!0),i.x=s(e[t].clientX,e[t].clientY),i.y=a(e[t].clientX,e[t].clientY),i.dx=i.x-i.sx,i.dy=i.y-i.sy,N.onPointerEvent(i.isDragging?N.PointerEventType.POINTER_DRAG_MOVE:N.PointerEventType.POINTER_MOVE,i,N.pointerState)}return!1}):(n.oncontextmenu=function(t){return t.preventDefault(),!1},n.onwheel=function(t){t.preventDefault(),N.pointerState[0]||(N.pointerState[0]={id:0,isActive:!1,isDragging:!1,sx:0,sy:0,x:0,y:0,dx:0,dy:0,button:0,wheelDelta:0,wheelAccum:0});let e=N.pointerState[0];return e.x=s(t.clientX,t.clientY),e.y=a(t.clientX,t.clientY),e.wheelDelta=t.deltaY,e.wheelAccum+=t.deltaY,N.onPointerEvent(N.PointerEventType.POINTER_WHEEL,e,N.pointerState),!1},n.onmousedown=function(t){t.preventDefault(),N.pointerState[0]||(N.pointerState[0]={id:0,isActive:!1,isDragging:!1,sx:0,sy:0,x:0,y:0,dx:0,dy:0,button:0,wheelDelta:0,wheelAccum:0});let e=N.pointerState[0];return e.isActive=!0,e.isDragging=!1,e.button=t.which,e.x=e.sx=s(t.clientX,t.clientY),e.y=e.sy=a(t.clientX,t.clientY),N.onPointerEvent(N.PointerEventType.POINTER_DOWN,e,N.pointerState),!1},n.onmouseup=function(t){if(t.preventDefault(),!N.pointerState[0])return!1;let e=N.pointerState[0];e.x=s(t.clientX,t.clientY),e.y=a(t.clientX,t.clientY),e.isDragging&&N.onPointerEvent(N.PointerEventType.POINTER_DRAG_STOP,e,N.pointerState),N.onPointerEvent(N.PointerEventType.POINTER_UP,e,N.pointerState),e.isActive=!1,e.isDragging=!1,e.button=0},n.onmousemove=function(t){if(t.preventDefault(),!N.pointerState[0])return!1;let e=N.pointerState[0];return e.isActive&&!e.isDragging&&(N.onPointerEvent(N.PointerEventType.POINTER_DRAG_START,e,N.pointerState),e.isDragging=!0),e.x=s(t.clientX,t.clientY),e.y=a(t.clientX,t.clientY),e.dx=e.x-e.sx,e.dy=e.y-e.sy,N.onPointerEvent(e.isDragging?N.PointerEventType.POINTER_DRAG_MOVE:N.PointerEventType.POINTER_MOVE,e,N.pointerState),!1}),!0===i.log&&L.enable()},time:function(){return this.frameTime},start:function(){this.onWindowResized(),this.flags.renderingPaused=!1,this.frameTimer.start()},stop:function(){this.flags.renderingPaused=!0,this.frameTimer.stop()},pause:function(){this.flags.renderingPaused=!0},resume:function(){this.flags.renderingPaused=!1,this.resetPerf()},onFrame:function(t){let e,i=hrnow();t>this.maxFrameInterval&&(t=this.maxFrameInterval),0!==this.fixedFrameInterval&&(t=this.fixedFrameInterval),this.flags.renderingEnabled&&!this.flags.renderingPaused?(t*=this.timeScale,this.frameDelta=t/1e3,this.frameTime+=this.frameDelta,B.time=this.frameTime,this.frameNumber++,e=hrnow(),this.update(this.frameDelta),this.perf.updateTimeTotal+=hrnow()-e,e=hrnow(),this.draw(),this.perf.drawTimeTotal+=hrnow()-e,this.perf.lastTime=i,this.perf.numFrames++,(t=this.perf.lastTime-this.perf.startTime)>1e3&&(this.perf.fps=int(1e3*this.perf.numFrames/t),this.perf.averageFps=int((this.perf.averageFps*this.perf.numSamples+this.perf.fps)/(this.perf.numSamples+1)),this.perf.averageUpdateTime=int((this.perf.averageUpdateTime*this.perf.numSamples+1e3*this.perf.updateTimeTotal/this.perf.numFrames)/(this.perf.numSamples+1)),this.perf.averageDrawTime=int((this.perf.averageDrawTime*this.perf.numSamples+1e3*this.perf.drawTimeTotal/this.perf.numFrames)/(this.perf.numSamples+1)),this.perf.averageExtraTime=int((this.perf.averageExtraTime*this.perf.numSamples+1e3*this.perf.extraTimeTotal/this.perf.numFrames)/(this.perf.numSamples+1)),this.perf.numSamples++,this.perf.startTime=i,this.perf.lastTime=i,this.perf.numFrames=0,this.perf.updateTimeTotal=0,this.perf.drawTimeTotal=0,this.perf.extraTimeTotal=0)):this.draw()},onWindowResized:function(t=!1){if("document"in r)this.options.fullscreen?(this._screenWidth=int(r.screen.width),this._screenHeight=int(r.screen.height)):(this._screenWidth=r.innerWidth,this._screenHeight=r.innerHeight);else if(this._screenWidth=this.options.screenWidth,this._screenHeight=this.options.screenHeight,null==this.options.screenWidth&&null==this.options.screenHeight)throw new Error("At least one screen dimension must be specified in headless mode.");this._screenWidth<this._screenHeight&&"landscape"==this.orientation||this._screenWidth>this._screenHeight&&"portrait"==this.orientation?(this.screenWidth=this._screenHeight,this.screenHeight=this._screenWidth,this.reverseRender=!0):(this.screenWidth=this._screenWidth,this.screenHeight=this._screenHeight,this.reverseRender=!1);let e=this.options.screenWidth,i=this.options.screenHeight;null!==e&&null!==i||(null===e&&null===i?(e=this.screenWidth,i=this.screenHeight):null===e?e=int(.5+this.screenWidth*(this.options.screenHeight/this.screenHeight)):null===i&&(i=int(.5+this.screenHeight*(this.options.screenWidth/this.screenWidth))));let n=e,s=i;"automatic"===this.orientation&&n&&s&&(n>s&&this.screenWidth<this.screenHeight||n<s&&this.screenWidth>this.screenHeight)&&(n=s,s=e),this.canvasScaleFactor=1,n&&s?this.canvasScaleFactor=Math.min(this.screenWidth/n,this.screenHeight/s):n?this.canvasScaleFactor=this.screenWidth/n:s&&(this.canvasScaleFactor=this.screenHeight/s);let a=this.screenWidth,l=this.screenHeight;if(n&&(this.screenWidth=n),s&&(this.screenHeight=s),this.offsX=int(.5*(a-this.screenWidth*this.canvasScaleFactor)),this.offsY=int(.5*(l-this.screenHeight*this.canvasScaleFactor)),this.reverseRender){let t=this.offsX;this.offsX=this.offsY,this.offsY=t}this.scaleFactor=this.canvasScaleFactor*this.canvasPixelRatio,this.scaleFactor=int(.7+this.scaleFactor),this.options.maxScaleFactor>0&&this.scaleFactor>this.options.maxScaleFactor&&(this.scaleFactor=this.options.maxScaleFactor),this.flags.renderingEnabled=!1,"document"in r&&(r.document.body.style.backgroundColor=this.renderer.backgroundColor),this.reverseRender?(this.renderer.resize(this.screenHeight*this.scaleFactor,this.screenWidth*this.scaleFactor),this.renderer.elem.style.width=int(this.screenHeight*this.canvasScaleFactor+.5)+"px",this.renderer.elem.style.height=int(this.screenWidth*this.canvasScaleFactor+.5)+"px",this.displayBuffer2.resize(this.screenHeight*this.scaleFactor,this.screenWidth*this.scaleFactor),this.displayBuffer2.elem.style.width=int(this.screenHeight*this.canvasScaleFactor+.5)+"px",this.displayBuffer2.elem.style.height=int(this.screenWidth*this.canvasScaleFactor+.5)+"px",this.displayBuffer3.resize(l,a),this.displayBuffer3.elem.style.width=l+"px",this.displayBuffer3.elem.style.height=a+"px"):(this.renderer.resize(this.screenWidth*this.scaleFactor,this.screenHeight*this.scaleFactor),this.renderer.elem.style.width=int(this.screenWidth*this.canvasScaleFactor+.5)+"px",this.renderer.elem.style.height=int(this.screenHeight*this.canvasScaleFactor+.5)+"px",this.displayBuffer2.resize(this.screenWidth*this.scaleFactor,this.screenHeight*this.scaleFactor),this.displayBuffer2.elem.style.width=int(this.screenWidth*this.canvasScaleFactor+.5)+"px",this.displayBuffer2.elem.style.height=int(this.screenHeight*this.canvasScaleFactor+.5)+"px",this.displayBuffer3.resize(a,l),this.displayBuffer3.elem.style.width=a+"px",this.displayBuffer3.elem.style.height=l+"px"),this.renderer.elem.style.marginLeft=this.offsX+"px",this.renderer.elem.style.marginTop=this.offsY+"px",this.displayBuffer2.elem.style.marginLeft=this.offsX+"px",this.displayBuffer2.elem.style.marginTop=this.offsY+"px",this.renderer.loadIdentity(),this.displayBuffer2.loadIdentity(),this.displayBuffer3.loadIdentity(),1!=this.scaleFactor&&(this.renderer.globalScale(this.scaleFactor),this.displayBuffer2.globalScale(this.scaleFactor)),this.reverseRender?(this.renderer.rotate(Math.PI/2),this.renderer.translate(-this.screenWidth,0),this.renderer.flipped(!0),this.displayBuffer2.rotate(Math.PI/2),this.displayBuffer2.translate(-this.screenWidth,0),this.displayBuffer2.flipped(!0),this.displayBuffer3.rotate(Math.PI/2),this.displayBuffer3.translate(-a,0),this.displayBuffer3.flipped(!0)):(this.renderer.flipped(!1),this.displayBuffer2.flipped(!1),this.displayBuffer3.flipped(!1)),this.scaleFactor*=this.options.extraScaleFactor,this.options.maxScaleFactor>0&&this.scaleFactor>this.options.maxScaleFactor&&(this.scaleFactor=this.options.maxScaleFactor),this.integerScaleFactor=int(this.scaleFactor+.5),this.resetPerf(),this.initialMatrix&&this.initialMatrix.free(),this.initialMatrix=this.renderer.getMatrix(!0),1!=t&&(this.flags.renderingEnabled=!0,this.onCanvasResized(this.screenWidth,this.screenHeight))},onCanvasResized:function(t,e){},resetPerf:function(){this.perf.startTime=hrnow(),this.perf.lastTime=hrnow(),this.perf.numFrames=0,this.perf.updateTimeTotal=0,this.perf.drawTimeTotal=0,this.perf.extraTimeTotal=0,this.perf.numSamples=0,this.perf.fps=0,this.perf.averageFps=0,this.perf.averageUpdateTime=0,this.perf.averageDrawTime=0,this.perf.averageExtraTime=0},updateQueueAdd:function(t){return this.updateQueue.push(t),this.updateQueue.bottom},updateQueueRemove:function(t){this.updateQueue.remove(m.isInstance(t)?t:this.updateQueue.sgetNode(t))},drawQueueAdd:function(t){return this.drawQueue.push(t),this.drawQueue.bottom},drawQueueRemove:function(t){this.drawQueue.remove(m.isInstance(t)?t:this.drawQueue.sgetNode(t))},queueAdd:function(t){this.updateQueue.push(t),this.drawQueue.push(t)},queueRemove:function(t){this.updateQueue.remove(this.updateQueue.sgetNode(t)),this.drawQueue.remove(this.drawQueue.sgetNode(t))},update:function(t){try{let e;for(let i=this.updateQueue.top;i;i=e)e=i.next,!1===i.value.update(t)&&this.updateQueueRemove(i)}catch(t){throw N.stop(),t}},draw:function(){null!==this.renderer.gl&&this.renderer.start(),this.options.overdraw||(this.renderer.clear(),this.displayBuffer2.clear(),this.displayBuffer3.clear());try{let t;for(let e=this.drawQueue.top;e;e=t)t=e.next,e.value.draw(this.renderer);null!==this.renderer.gl&&(this.renderer.flush(),this.renderer.end())}catch(t){throw N.stop(),t}},interpolate:function(t,e,i,n,s){let r={},a={},l=0;for(let e in t)r[e]=0,a[e]=t[e],l++;let o={update:function(o){for(let s in r){if(r[s]==i[s])continue;r[s]+=o,r[s]>=i[s]&&(r[s]=i[s],l--);let h=n[s](r[s]/i[s]);a[s]=(1-h)*t[s]+h*e[s]}if(s(a,0==l),0==l)return!1}};N.updateQueueAdd(o),o.update(0)},onKeyboardEvent:function(t,e,i){},onPointerEvent:function(t,e,i){},
//!/class
//!namespace System
//!enum KeyboardEventType
KeyboardEventType:{KEY_DOWN:1,KEY_UP:2},
//!/enum
//!enum PointerEventType
PointerEventType:{POINTER_DOWN:16,POINTER_UP:17,POINTER_MOVE:18,POINTER_DRAG_START:19,POINTER_DRAG_MOVE:20,POINTER_DRAG_STOP:21,POINTER_WHEEL:22}};var//!/enum
//!/namespace
M=N;
//![import "./system"]
//![import "../utils/list"]
//!namespace Log
const D={activated:!1,paused:!1,maxsize:30,data:x.Pool.alloc(),count:0,debugEcho:!1,color:"#fff",background:"#cf266a",vars:{},write:function(t){for(this.data.push(t),this.count++;this.data.length>this.maxsize;)this.data.shift();this.debugEcho&&console.debug(this.count+": "+t)},clear:function(){this.data.reset(),this.count=0},enable:function(t=0,e=0,i=9.5,n=!0,s=!0){if(this.activated)return;this.activated=!0,n||(e-=16);let r=e;M.drawQueueAdd({draw:function(){if(D.paused)return;let a=hrnow();const l=M.displayBuffer3;l.font("bold "+i+"pt Monospace"),l.textBaseline("top");let o="";e=r,!1!==n&&0!=M.perf.fps&&(o="fps: "+M.perf.fps+"/"+M.perf.averageFps+", update: "+M.perf.averageUpdateTime+", draw: "+M.perf.averageDrawTime+", extra: "+M.perf.averageExtraTime,D.background&&(l.fillStyle(D.background),l.fillRect(t-3,e-1,l.measureText(o)+6,i+5)),l.fillStyle(D.color),l.fillText(o,t,e)),o="";for(let t in D.vars)o+=t+": "+D.vars[t]+"  ";""!==o&&(e+=24,D.background&&(l.fillStyle(D.background),l.fillRect(t-3,e-1,l.measureText(o)+6,i+5)),l.fillStyle(D.color),l.fillText(o,t,e));let h=0;for(let n=D.data.top;n;n=n.next,h++)o=(s?"#"+(D.count-D.data.length+h+1)+": ":"> ")+n.value,D.background&&(l.fillStyle(D.background),l.fillRect(t-3,e-1+7+(i+5)*(h+1)-1,l.measureText(o)+6,i+5)),l.fillStyle(D.color),l.fillText(o,t,e-1+7+(i+5)*(h+1));a=hrnow()-a,M.perf.drawTimeTotal-=a,M.perf.extraTimeTotal+=a}})},pause:function(){this.paused=!0},resume:function(){this.paused=!1}};var L=D;
//![import "./random"]
//![import "./log"]
//![import "../flow/viewport"]
//!namespace globals
const O={gl:null,time:0,viewport:null,debugBounds:!1,rand0:new o,rand1:new o,rand2:new o};var B=O;
//!/namespace
//!declare global
r.px=function(t){return t*C.SCALE},r.dispose=function(t){if(t)return"free"in t?t.free():"dispose"in t?t.dispose():void("__dtor"in t&&t.__dtor())},"AudioContext"in r?(r.audioContext=new AudioContext({latencyHint:"interactive",sampleRate:44100}),L.write("AudioContext: baseLatency="+~~(1e3*r.audioContext.baseLatency)+" ms")):r.audioContext=null,r.fetchd=function(t,e){return new Promise(((i,n)=>{e||(e={}),"responseType"in e||(e.responseType="arraybuffer");var s=new XMLHttpRequest;s.open("GET",t,!0);for(let t in e)s[t]=e[t];s.onload=function(){i(s.response)},s.onerror=function(){n("Unable to fetch specified resource.")},s.send()}))},r.fetchAudioBuffer=function(t){return new Promise(((e,i)=>{r.audioContext?fetchd(t).then((t=>audioContext.decodeAudioData(t))).then((t=>e(t))).catch((t=>i(t))):i("AudioContext is not available.")}))},r.int=function(t){return t>>0},r.bool=function(t){return!0===t||!1===t?t:"true"==t||"false"!=t&&!!t},r.float=function(t){return parseFloat(t)},r.float2=function(t){return int(100*t)/100},r.float3=function(t){return int(1e3*t)/1e3},r.float4=function(t){return int(1e4*t)/1e4},r.rad=function(t){return t*Math.PI/180},r.deg=function(t){return t/Math.PI*180},r.rand=function(){return O.rand0.nextInt16()},r.randf=function(){return O.rand0.nextFloat()},r.randrf=function(t,e){let i=O.rand0.nextFloat();return i*e+(1-i)*t},r.randr=function(t,e){let i=O.rand0.nextFloat();return Math.round(i*e+(1-i)*t)},r.randtf=function(t,e,i){for(var n=[],s=0;s<i;s++)n.push(randrf(t,e));return n},r.hrnow=function(){return performance.now()},r.randvar=function(t,e){return function(){return randr(t,e)}},r.randitem=function(t,e=null,i=null){return null===e&&(e=0),null===i&&(i=t.length-1),function(){return t[randr(e,i)]}},r.getLineSegmentIntersection=function(t,e,i,n,s,r,a,l){if(t==s&&e==r&&i==a&&n==l)return 0;var o=n-e,h=i-t,u=l-r,c=a-s;if(0==o&&0==u){if(e!=r)return 2;var d=Math.max(t,s);return d>Math.min(i,a)?2:(d-t)/h}if(0==h&&0==c){if(t!=s)return 2;var f=Math.max(e,r);return f>Math.min(n,l)?2:(f-e)/o}if(0==h)return 0>(m=(u*(t-s)+c*(r-e))/(c*o))||m>1||0>(p=(t-s)/c)||p>1?2:m;var p,m,g=u*h-c*o;return 0==g||0>(p=(o*(s-t)+h*(e-r))/g)||p>1||0>(m=(c*p+s-t)/h)||m>1?2:m},r.lineSegmentIntersects=function(t,e,i,n,s,r,a,l){let o=getLineSegmentIntersection(t,e,i,n,s,r,a,l);return o>=0&&o<=1},r.rotatePoint=function(t,e,i){return{x:e*Math.cos(t)+i*Math.sin(t),y:i*Math.cos(t)-e*Math.sin(t)}},r.stepValue=function(t,e,i,n){return Math.round(n*(t-e)/(i-e))/n*(i-e)+e},r.alignValue=function(t,e){return Math.round(t/e)*e},r.FIXED_POINT_BITS=8,r.upscale=function(t){return t*(1<<FIXED_POINT_BITS)>>0},r.downscale=function(t){return t>>FIXED_POINT_BITS},r.downscalef=function(t){return t/(1<<FIXED_POINT_BITS)},r.falign=function(t){return downscalef(upscale(t))},r.absmin=function(t,e){return Math.abs(t)<Math.abs(e)?t:e},r.absmax=function(t,e){return Math.abs(t)>Math.abs(e)?t:e};
//!class Perf
const U=function(t,e=null){this.data=[],this.accumSize=t,this.expectedValue=e,this.lastFeed=0,this.lastUpdate=0,this.stdSum=0,this.stdCount=0};var H=U;U.prototype.begin=function(){this.startTime=performance.now()},U.prototype.end=function(){this.feed(performance.now()-this.startTime)},U.prototype.feed=function(t){this.data.push(t),this.lastFeed++,this.data.length==this.accumSize&&(this.report(),this.data=[])},U.prototype.update=function(){let t=null,e=null,i=0,n=0;for(let n=0;n<this.data.length;n++)t=null===t?this.data[n]:Math.min(t,this.data[n]),e=null===e?this.data[n]:Math.max(e,this.data[n]),i+=this.data[n];i/=this.data.length;let s=null!==this.expectedValue?this.expectedValue:i;for(let t=0;t<this.data.length;t++)n+=Math.pow(this.data[t]-s,2);return n=Math.sqrt(n/this.data.length),this.stdSum+=n,this.stdCount++,this.min=t,this.max=e,this.avg=i,this.std=n,this.lastUpdate=this.lastFeed,this},U.prototype.report=function(t=255){let e="";return this.lastUpdate!=this.lastFeed&&this.update(),t&U.Flags.SAMPLES&&(e+="n: "+this.stdCount),t&U.Flags.MIN&&(e+=(""!=e?", ":"")+"min: "+this.min),t&U.Flags.MAX&&(e+=(""!=e?", ":"")+"max: "+this.max),t&U.Flags.AVG&&(e+=(""!=e?", ":"")+"avg: "+this.avg.toFixed(2)),t&U.Flags.EXPECTED&&(e+=(""!=e?", ":"")+(void 0!==this.expectedValue?"e: "+this.expectedValue:"")),t&U.Flags.STDDEV&&(e+=(""!=e?", ":"")+"stddev: "+this.std.toFixed(2)),t&U.Flags.AVG_STDDEV&&(e+=(""!=e?", ":"")+"avg_stddev: "+(this.stdSum/this.stdCount).toFixed(2)),e},
//!/class
//!namespace Perf
//!enum Flags
U.Flags={SAMPLES:1,
//!SAMPLES
MIN:2,
//!MIN
MAX:4,
//!MAX
AVG:8,
//!AVG
EXPECTED:16,
//!EXPECTED
STDDEV:32,
//!STDDEV
AVG_STDDEV:64,
//!AVG_STDDEV
ALL:255};//!/enum
//![import "./globals"]
//![import "./system"]
const G=t.extend({framebufferId:null,attachments:null,attachmentTypes:null,width:0,height:0,drawBuffers:null,drawBufferIds:null,__ctor:function(t=null,e=null){null!==B.gl&&(null===X[0]&&V(B.gl),this.framebufferId=B.gl.createFramebuffer(),this.drawBuffers=[],this.drawBufferIds=[],this.width=t||M.renderer.width,this.height=e||M.renderer.height,this.attachments=new Array(G.MAX_ATTACHMENT_POINTS).fill(null),this.attachmentTypes=new Array(G.MAX_ATTACHMENT_POINTS).fill(null))},__dtor:function(){let t=B.gl;if(null!==t){for(let e=0;e<this.attachments.length;e++)null!==this.attachments[e]&&(this.attachmentTypes[e]===G.TEXTURE?t.deleteTexture(this.attachments[e]):t.deleteRenderbuffer(this.attachments[e]));t.deleteFramebuffer(this.frameBufferId)}},attach:function(t,e,i=null){let n=B.gl;if(null===n)return;null===i&&(i=t<G.DEPTH?G.TEXTURE:G.RENDERBUFFER),this.attachments[t]=e,this.attachmentTypes[t]=i,t<G.DEPTH&&-1===this.drawBuffers.indexOf(t)&&(this.drawBuffers.push(t),this.drawBufferIds.push(X[t]));let s=n.getParameter(n.FRAMEBUFFER_BINDING);switch(n.bindFramebuffer(n.FRAMEBUFFER,this.framebufferId),i){case G.TEXTURE:n.framebufferTexture2D(n.FRAMEBUFFER,X[t],n.TEXTURE_2D,e,0);break;case G.RENDERBUFFER:n.framebufferRenderbuffer(n.FRAMEBUFFER,X[t],n.RENDERBUFFER,e)}n.bindFramebuffer(n.FRAMEBUFFER,s)},createColorBuffer:function(t,e=null,i=null){let n=B.gl;if(null===n)return null;null===e&&(e=this.width),null===i&&(i=this.height);let s=n.createTexture();return n.bindTexture(n.TEXTURE_2D,s),n.texStorage2D(n.TEXTURE_2D,1,n.RGBA8,e,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),this.attach(t,s),s},createDepthBuffer:function(t=null,e=null){let i=B.gl;if(null===i)return null;null===t&&(t=this.width),null===e&&(e=this.height);let n=i.createRenderbuffer();return i.bindRenderbuffer(i.RENDERBUFFER,n),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT24,t,e),this.attach(G.DEPTH,n),n},createStencilBuffer:function(t=null,e=null){let i=B.gl;if(null===i)return null;null===t&&(t=this.width),null===e&&(e=this.height);let n=i.createTexture();return i.bindTexture(i.TEXTURE_2D,n),i.texStorage2D(i.TEXTURE_2D,1,i.DEPTH_STENCIL,t,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),this.attach(G.DEPTH_STENCIL,n),n},getTexture:function(t){return this.attachmentTypes[t]!==G.TEXTURE?null:this.attachments[t]},getRenderBuffer:function(t){return this.attachmentTypes[t]!==G.RENDERBUFFER?null:this.attachments[t]},bind:function(){let t=B.gl;null!==t&&(t.bindFramebuffer(t.FRAMEBUFFER,this.framebufferId),t.drawBuffers(this.drawBufferIds),t.viewport(0,0,this.width,this.height))},unbind:function(){let t=B.gl;null!==t&&(t.bindFramebuffer(t.FRAMEBUFFER,null),t.drawBuffers(W),t.viewport(0,0,M.renderer.width,M.renderer.height))},isComplete:function(){let t=B.gl;if(null===t)return!0;let e=t.getParameter(t.FRAMEBUFFER_BINDING);t.bindFramebuffer(t.FRAMEBUFFER,this.framebufferId);let i=t.checkFramebufferStatus(t.FRAMEBUFFER);return t.bindFramebuffer(t.FRAMEBUFFER,e),i===t.FRAMEBUFFER_COMPLETE}});G.TEXTURE=1,G.RENDERBUFFER=2,G.COLOR0=0,G.COLOR1=1,G.COLOR2=2,G.COLOR3=3,G.COLOR4=4,G.COLOR5=5,G.COLOR6=6,G.COLOR7=7,G.DEPTH=8,G.STENCIL=9,G.DEPTH_STENCIL=10,G.MAX_ATTACHMENT_POINTS=11;const X=new Array(G.MAX_ATTACHMENT_POINTS).fill(null),W=new Array(1).fill(null),V=function(t){W[0]=t.BACK,X[G.COLOR0]=t.COLOR_ATTACHMENT0,X[G.COLOR1]=t.COLOR_ATTACHMENT1,X[G.COLOR2]=t.COLOR_ATTACHMENT2,X[G.COLOR3]=t.COLOR_ATTACHMENT3,X[G.COLOR4]=t.COLOR_ATTACHMENT4,X[G.COLOR5]=t.COLOR_ATTACHMENT5,X[G.COLOR6]=t.COLOR_ATTACHMENT6,X[G.COLOR7]=t.COLOR_ATTACHMENT7,X[G.DEPTH]=t.DEPTH_ATTACHMENT,X[G.STENCIL]=t.STENCIL_ATTACHMENT,X[G.DEPTH_STENCIL]=t.DEPTH_STENCIL_ATTACHMENT};var z=G,Y={};a(Y,"Drawable",(function(){return rt})),a(Y,"Placeholder",(function(){return at})),a(Y,"Spritesheet",(function(){return lt})),a(Y,"SpritesheetAnimation",(function(){return ot})),a(Y,"SpriteFont",(function(){return ht})),a(Y,"Sound",(function(){return ut})),a(Y,"SoundArray",(function(){return ct}));
//![import "../system/system"]
//![import "../system/canvas"]
//![import "../system/log"]
const q={};var Q=q;let K=!1;
//!class Resources
Object.assign(q,{integerScaling:!0,pixelated:!1,original:!1,config:function(t=null){null!=t&&Object.assign(this,t)},load:function(t,e,i,n,a){if(!n){n=Object.keys(t);for(let e in n)"__loaded"in t[n[e]]||(t[n[e]].__clone=s.clone(t[n[e]]));a=0}for(;a<n.length&&"__loaded"in t[n[a]];)a++;if(e&&e(a,n.length,a/n.length,n[a]),a==n.length)return void(i&&i(t));let l=t[n[a]];switch(l.resName=n[a],l.type){case"image":l.data=new Image,l.data.onload=function(){var s=l.data.width/l.data.height;l.scale&&(l.width=int(l.data.width*l.scale),l.height=int(l.data.height*l.scale)),l.width||l.height?l.width&&!l.height?l.height=int(l.width/s):!l.width&&l.height&&(l.width=int(s*l.height)):(l.width=l.data.width,l.height=l.data.height),l.owidth=l.data.width,l.oheight=l.data.height,null!==l.pixelated&&l.hasOwnProperty("pixelated")||(l.pixelated=q.pixelated),null!==l.original&&l.hasOwnProperty("original")||(l.original=q.original),l.data.width==l.width&&l.data.height==l.height||!0===l.original||(l.data=q.resizeImage(l,l.width*(l.pixelated?M.integerScaleFactor:M.scaleFactor),l.height*(l.pixelated?M.integerScaleFactor:M.scaleFactor),l.pixelated,!0)),l.rscale=l.data.width/l.width,l.data.targetWidth=l.width,l.data.targetHeight=l.height,M.tempDisplayBuffer.drawImage(l.data,0,0),M.renderer.prepareImage(l.data),q.onLoaded(t,n[a]),q.load(t,e,i,n,a+1)},l.data.onerror=function(){console.error("Error: Unable to load: "+l.resName)},l.data.src=l.src+"?r="+Math.random();break;case"images":var o=(u=l.src).indexOf("#"),h=(c=u.lastIndexOf("#"))-o+1;if(-1==o)return void console.error("Unable to load: "+l.resName+"\nError: The 'src' attribute requires one or more '#' marks.");if(!l.count)return void console.error("Unable to load: "+l.resName+"\nError: The 'count' attribute was not found.");l._i=0,l.data=[],(d=function(){if(l._i==l.count)return q.onLoaded(t,n[a]),void q.load(t,e,i,n,a+1);var s={type:"image",width:l.width,height:l.height,scale:l.scale};s.src=l.src.substr(0,o)+(l._i++/Math.pow(10,h)).toFixed(h).substr(2)+l.src.substr(c+1),s.data=new Image,s.resName=l.resName+"#"+(l._i-1),s.data.onload=function(){var t=s.data.width/s.data.height;s.scale&&(s.width=int(s.data.width*s.scale),s.height=int(s.data.height*s.scale)),s.width||s.height?s.width&&!s.height?s.height=int(s.width/t):!s.width&&s.height&&(s.width=int(t*s.height)):(s.width=s.data.width,s.height=s.data.height),1==l._i&&(l.owidth=s.data.width,l.oheight=s.data.height),null!==l.pixelated&&l.hasOwnProperty("pixelated")||(l.pixelated=q.pixelated),null!==l.original&&l.hasOwnProperty("original")||(l.original=q.original),s.data.width==s.width&&s.data.height==s.height||!0===s.original||(s.data=q.resizeImage(s,s.width*(l.pixelated?M.integerScaleFactor:M.scaleFactor),s.height*(l.pixelated?M.integerScaleFactor:M.scaleFactor),l.pixelated,!0)),s.rscale=s.data.width/s.width,s.data.targetWidth=s.width,s.data.targetHeight=s.height,1==l._i&&(l.width=s.width,l.height=s.height,l.rscale=s.rscale),M.tempDisplayBuffer.drawImage(s.data,0,0),M.renderer.prepareImage(s.data),l.data.push(s),d()},s.data.onerror=function(){console.error("Error: Unable to load: "+s.resName)},s.data.src=s.src+"?r="+Math.random()})();break;case"audio":if(l.track||(l.track="sfx"),r.plugins&&r.plugins.NativeAudio&&"sfx"==l.track){K||(L.write("ENGINE_NATIVEAUDIO"),K=!0),l.engine=Y.Sound.ENGINE_NATIVEAUDIO,l.data="snd_"+a,r.plugins.NativeAudio.preloadSimple(l.data,l.src,(function(){q.onLoaded(t,n[a]),q.load(t,e,i,n,a+1)}),(function(t){console.error("Error: Unable to load (sfx): "+l.resName+"\n"+t)}));break}if(r.audioContext){K||(L.write("ENGINE_WEBAUDIO"),K=!0),l.engine=Y.Sound.ENGINE_WEBAUDIO,fetchAudioBuffer(l.src+"?r="+Math.random()).then((s=>{l.data=s,q.onLoaded(t,n[a]),q.load(t,e,i,n,a+1)})).catch((t=>{console.error("Error: Unable to load: "+l.resName)}));break}K||(L.write("ENGINE_HTML5"),K=!0),l.data=new Audio,l.engine=Y.Sound.ENGINE_HTML5,l.data.oncanplaythrough=function(){q.onLoaded(t,n[a]),q.load(t,e,i,n,a+1)},l.data.onerror=function(){console.error("Error: Unable to load: "+l.resName)},l.data.src=l.src+"?r="+Math.random();break;case"audios":var u,c,d;o=(u=l.src).indexOf("#"),h=(c=u.lastIndexOf("#"))-o+1;if(-1==o)return void console.error("Unable to load: "+l.resName+"\nError: The 'src' attribute requires one or more '#' marks.");if(!l.count)return void console.error("Unable to load: "+l.resName+"\nError: The 'count' attribute was not found.");l._i=0,l.data=[],(d=function(){if(l._i==l.count)return q.onLoaded(t,n[a]),void q.load(t,e,i,n,a+1);var s={type:"audio",track:l.track};return s.src=l.src.substr(0,o)+(l._i++/Math.pow(10,h)).toFixed(h).substr(2)+l.src.substr(c+1),s.resName=l.resName+"#"+(l._i-1),s.track||(s.track="sfx"),r.plugins&&r.plugins.NativeAudio&&"sfx"==s.track?(s.engine=Y.Sound.ENGINE_NATIVEAUDIO,s.data="snd_"+a+"_"+l._i,void r.plugins.NativeAudio.preloadSimple(s.data,s.src,(function(){l.data.push(s),d()}),(function(t){console.error("Error: Unable to load (sfx): "+s.resName+"\n"+t)}))):r.audioContext?(s.engine=Y.Sound.ENGINE_WEBAUDIO,void fetchAudioBuffer(s.src+"?r="+Math.random()).then((t=>{s.data=t,l.data.push(s),d()})).catch((t=>{console.error("Error: Unable to load: "+s.resName)}))):(s.data=new Audio,s.engine=Y.Sound.ENGINE_HTML5,s.data.oncanplaythrough=function(){l.data.push(s),d()},s.data.onerror=function(){console.error("Error: Unable to load: "+s.resName)},void(s.data.src=s.src+"?r="+Math.random()))})();break;case"json":fetchd(l.src+"?r="+Math.random(),{responseType:"json"}).then((function(s){l.data=s,q.onLoaded(t,n[a]),q.load(t,e,i,n,a+1)})).catch((function(t){console.error("Error: Unable to load: "+l.resName+". Error: "+t)}));break;case"data":fetchd(l.src+"?r="+Math.random()).then((function(s){l.data=s,q.onLoaded(t,n[a]),q.load(t,e,i,n,a+1)})).catch((function(t){console.error("Error: Unable to load: "+l.resName+". Error: "+t)}));break;case"text":fetchd(l.src+"?r="+Math.random()).then((function(s){l.data=String.fromCharCode.apply(null,new Uint8Array(s)),q.onLoaded(t,n[a]),q.load(t,e,i,n,a+1)})).catch((function(t){console.error("Error: Unable to load: "+l.resName+". Error: "+t)}));break;case"object":l.data={},q.onLoaded(t,n[a]),q.load(t,e,i,n,a+1)}},unload:function(t){throw new Error("IMPLEMENTED UNLOAD!")},onLoaded:function(t,e){var i=t[e];i.wrapper&&i.wrapper in Y&&(t[e]=new Y[i.wrapper](i),t[e].__loaded=!0)},resizeImage:function(t,e,i,n,s){var r=t.data.width,a=t.data.height;if(e=int(e),i=int(i),r==e&&a==i)return t.data;if(!this.integerScaling&&n&&(n=null),n){if(int(e/r)>0){var l,o=int(e/r+.9),h=(e=o*r)/r,u=(i=o*a)/a;m=new F({hidden:!0,antialias:!1}).resize(e,i);(l=new F({hidden:!0,antialias:!1}).resize(r,a)).drawImage(t.data,0,0);for(var c=0;c<a;c++)for(var d=l.getImageData(0,c,r,1).data,f=0,p=0;p<r&&f<d.length;p++,f+=4)m.fillStyle("rgba("+d[f]+","+d[f+1]+","+d[f+2]+","+d[f+3]/255+")"),m.fillRect(p*h,c*u,h,u);return l.dispose(),m.elem}return this.resizeImage(t,e,i,null,s)}for((l=new F({hidden:!0,antialias:n=null!==n}).resize(r,a)).drawImage(t.data,0,0);;){var m,g=r>>1,x=a>>1;if(g<=e||x<=i)break;(m=new F({hidden:!0,antialias:n}).resize(g,x)).drawImage(l.elem,0,0,g,x),l.dispose(),r=g,a=x,l=m}return(m=new F({hidden:!0,antialias:n}).resize(e,i)).drawImage(l.elem,0,0,e,i),l.dispose(),s&&dispose(t.data),m.elem},flipImageHorz:function(t){var e=new F({hidden:!0}).resize(t.data.width,t.data.height);return e.translate(t.data.width,0),e.scale(-1,1),e.drawImage(t.data,0,0),e.elem},showDownload:function(t,e){var i=document.createElement("a");i.href=e,i.style.display="none",i.download=t,i.target="_blank",document.body.appendChild(i),i.click(),document.body.removeChild(i)},showFilePicker:function(t,e,i){var n=document.createElement("input");n.type="file",n.accept=e,n.style.display="none",n.multiple=t,document.body.appendChild(n),n.onchange=function(){i(n.files)},document.body.onfocus=function(){document.body.onfocus=null,document.body.removeChild(n)},n.click()},loadAsDataURL:function(t,e){var i=new FileReader;i.onload=function(t){e(t.target.result)},i.readAsDataURL(t)},loadAsText:function(t,e){var i=new FileReader;i.onload=function(t){e(t.target.result)},i.readAsText(t)},loadAsArrayBuffer:function(t,e){var i=new FileReader;i.onload=function(t){e(t.target.result)},i.readAsArrayBuffer(t)},loadAllAsDataURL:function(t,e){var i=[];if(t&&t.length){var n=function(s){s!=t.length?q.loadAsDataURL(t[s],(function(e){i.push({name:t[s].name,size:t[s].size,url:e}),n(s+1)})):e(i)};n(0)}else e(i)}});var//![import "./resources"]
j=t.extend({className:"Drawable",width:null,height:null,__ctor:function(t){if("image"!=t.type)throw new Error("Resource is not an image.");this.width=t.width,this.height=t.height,this.r=t,this.r.wrapper=this},draw:function(t,e=0,i=0,n=null,s=null){t.drawImage(this.r.data,0,0,this.r.data.width,this.r.data.height,e,i,n||this.r.width,s||this.r.height,null,null,this.width,this.height)},getImage:function(){return this.r.data},getDrawable:function(){return this}});Q.Image=function(t,e=null){return{type:"image",wrapper:"Drawable",src:t,pixelated:null,...e}};var//![import "../system/canvas"]
//![import "./resources"]
Z=t.extend({className:"Placeholder",width:null,height:null,__ctor:function(t){if("object"!=t.type)throw new Error("Resource is not an object.");this.width=t.width,this.height=t.height,this.r=t,this.r.wrapper=this,this.data=null,F.renderImage(t.width,t.height,(e=>{e.fillStyle(this.r.color),e.fillRect(0,0,t.width,t.height)}),(t=>{this.data=t}))},draw:function(t,e=0,i=0,n=null,s=null){this.data&&t.drawImage(this.data,0,0,this.data.width,this.data.height,e,i,n||this.width,s||this.height)},getImage:function(){return this.data},getDrawable:function(){return this}});Q.Placeholder=function(t,e,i="#ff0000",n=null){return{type:"object",wrapper:"Placeholder",width:t,height:e,color:i,...n}};var//![import "../system/canvas"]
$=t.extend({className:"Spritesheet",width:0,height:0,numCols:0,numFrames:0,drawableCache:null,__ctor:function(t){if("image"!=t.type&&"images"!=t.type)throw new Error("Resource is not a sprite sheet.");var e,i;if("image"==t.type){if(!(t.config.sheetWidth||t.config.numFrames&&t.config.frameWidth))throw new Error(t.resName+": required sheetWidth or numFrames+frameWidth");t.config.sheetWidth||(t.config.sheetWidth=t.width),t.config.frameHeight||(t.config.frameHeight=t.data.height),e=t.data.width/t.config.sheetWidth,i=t.width/t.config.sheetWidth}else t.config||(t.config={}),t.config.frameWidth||(t.config.frameWidth=t.data[0].width),t.config.frameHeight||(t.config.frameHeight=t.data[0].height),e=t.data[0].data.width/t.config.frameWidth,i=t.data[0].width/t.config.frameWidth;this.frameWidth=t.config.frameWidth*e,this.frameHeight=t.config.frameHeight*e,this.width=t.config.frameWidth*i,this.height=t.config.frameHeight*i,"image"==t.type?(this.numCols=int(t.data.width/this.frameWidth),this.numRows=Math.ceil(t.data.height/this.frameHeight),this.numFrames=t.config.numFrames||this.numCols*this.numRows):(this.numCols=this.numRows=0,this.numFrames=t.data.length),this.drawableCache={},this.r=t,this.r.wrapper=this},drawFrame:function(t,e,i,n,s=0,r=0){if(!(n<0||n>=this.numFrames))if(s||(s=this.width),r||(r=this.height),0!=this.numCols){var a=int(n/this.numCols)*this.frameHeight,l=n%this.numCols*this.frameWidth;t.drawImage(this.r.data,l,a,this.frameWidth,this.frameHeight,e,i,s,r,null,null,this.width,this.height)}else t.drawImage(this.r.data[n].data,0,0,this.frameWidth,this.frameHeight,e,i,s,r,null,null,this.width,this.height)},getFrame:function(t,e=null){let i;if(i=null!==e?e*this.numCols+t:t,i<0||i>=this.numFrames)throw new Error("frameIndex out of range");return this.drawableCache[i]||(this.drawableCache[i]={width:this.width,height:this.height,frameIndex:i,spritesheet:this,draw:function(t,e=0,i=0,n=0,s=0){t.drawFrame(this.spritesheet,e,i,this.frameIndex,n,s)},getImage:function(){return this.spritesheet.r.data},getDrawable:function(){return this}}),this.drawableCache[i]},getImage:function(){return this.r.data},getDrawable:function(){return this.getFrame(0)}});F.prototype.drawFrame=function(t,e,i,n,s,r){t.drawFrame(this,e,i,n,s,r)};const J=t.extend({className:"Animation",width:null,height:null,seq:null,seq_i:0,trans:null,trans_i:0,trans_t:null,queue:null,fps:0,frameSeconds:0,time:0,frameNumber:-1,finished:!1,_paused:!1,finishedCallback:null,finishedCallbackHandler:null,finishedCallbackContext:null,frameCallback:null,__ctor:function(t,e,i){this.anim=t,this.queue=x.Pool.alloc(),this.seq=e,this.seq_i=0,this.trans=null,this.trans_i=0,this.trans_t=null,this.width=t.width,this.height=t.height,this.frameNumber=-1,this.finished=!1,this._paused=!1,this.finishedCallback=null,this.finishedCallbackHandler=null,this.finishedCallbackContext=null,this.frameCallback=null,this.fps=i,this.setFps(this.seq.fps||this.fps)},__dtor:function(){this.queue.free(),this.finishedCallbackHandler&&this.finishedCallbackHandler.free(),this.finishedCallbackContext&&this.finishedCallbackContext.free()},setFps:function(t){return this.frameSeconds=1/t,this.time=0,this},paused:function(t=null){return null===t?this._paused:(this._paused=t,this)},setInitialDelay:function(t){return this.time=-t,this},onFinished:function(t){return this.finishedCallback=t,this},then:function(t,e=null){return!1===t&&this.finishedCallback===this.thenCallback&&(this.finishedCallbackHandler.clear(),this.finishedCallbackContext.clear()),t?(this.finishedCallback!==this.thenCallback&&(this.finishedCallback=this.thenCallback,this.finishedCallbackHandler=x.Pool.alloc(),this.finishedCallbackContext=x.Pool.alloc()),this.finishedCallbackHandler.push(t),this.finishedCallbackContext.push(e),this):this},thenCallback:function(){if(!this.finishedCallbackHandler.length)return!1;let t=this.finishedCallbackContext.shift();this.finishedCallbackHandler.shift()(this,t)},onFrame:function(t){return this.frameCallback=t,this},setFrame:function(t){return this.seq_i=int(t)%this.seq.group.length,this},getFrame:function(t){return!0===t?this.seq_i/(this.seq.group.length-1):this.seq_i},getLength:function(){return this.seq.group.length},draw:function(t,e=0,i=0,n=0,s=0){if(this.time<0)return this._paused||(this.time+=this.frameNumber===M.frameNumber?0:M.frameDelta,this.frameNumber=M.frameNumber),void(this.time>0&&(this.time=0));if(this.seq_i===this.seq.group.length){let r=this.seq.group[this.seq_i-1];if(null!=t)for(let a=0;a<r.length;a++)t.drawFrame(this.anim,e,i,r[a],n,s);return}let r=this.seq.group[this.seq_i];if(null!=t)for(let a=0;a<r.length;a++)t.drawFrame(this.anim,e,i,r[a],n,s);if(this._paused||(this.time+=this.frameNumber===M.frameNumber?0:M.frameDelta,this.frameNumber=M.frameNumber),this.time>=this.frameSeconds){const t=this.seq_i;this.time-=this.frameSeconds,this.seq_i++,this.seq_i===this.seq.group.length&&(null!=this.trans?(++this.trans_i===this.trans.length?(this.trans=null,this.seq=this.trans_t):this.seq=this.trans[this.trans_i],this.setFps(this.seq.fps||this.fps),this.seq_i=0,this.time=0,this.finished=!1):(this.seq.loop?this.seq_i=0:(this.finished=!0,this.finishedCallback&&!1===this.finishedCallback(this)&&(this.finishedCallback=null)),this.queue.length&&this.use(this.queue.shift(),!0))),this.frameCallback&&!1===this.frameCallback(t,this.seq.group.length-1,this)&&(this.frameCallback=null)}},getImage:function(){return this.anim.getImage()},getDrawable:function(){return this},advance:function(){this.paused(!1),this.draw(null,0,0)},getSequenceName:function(){return(null===this.trans?this.seq:this.trans_t).name},use:function(t,e=!1){let i=null===this.trans?this.seq:this.trans_t;return!(i.name===t&&!this.finished&&!0!==e)&&(i.trans&&i.trans[t]?(this.trans_t=this.anim.a.seq[t],this.trans=i.trans[t],this.trans_i=0,this.seq=this.trans[this.trans_i]):(!0===e&&(this.trans=null),this.seq=this.anim.a.seq[t]),this.setFps(this.seq.fps||this.fps),this.seq_i=0,this.time=0,this.finished=!1,!0)},play:function(t){return this.use(t),this},setQueue:function(t){if(!x.isInstance(t))throw new Error("setQueue: Parameter must be an instance of List");null!=this.queue&&this.queue.clear().free(),this.queue=t,this.use(this.queue.shift(),!0)},enqueue:function(t,e=!1){let i=null===this.trans?this.seq:this.trans_t,n=this.queue.length>0?this.queue[this.queue.length-1]:i.name;return i.name===t&&i.loop?this:n!==t||e?i.loop||this.finished?(this.use(t,!0),this):(this.queue.push(t),this):this}});f.createPool(J);var tt=$.extend({className:"SpritesheetAnimation",defaultDrawable:null,sharedAnim:null,r:null,a:null,__ctor:function(t){if(!t.anim)throw new Error("Animation descriptors not found.");this._super.Spritesheet.__ctor(t),this.r=t,this.r.wrapper=this;let e=this.a=this.r.anim;if(e.initialized)return;if(e.def||(e.def="def"),e.seq||(e.seq={}),!e.seq[e.def]&&("def"==e.def||"defloop"==e.def)){let t={loop:"def"!=e.def,group:[]};for(let e=0;e<this.numFrames;e++)t.group.push([e]);e.seq[e.def]=t}if(!e.seq[e.def])throw new Error("Undefined default sequence: "+e.def);e.fps||(e.fps=25),e.def=e.seq[e.def];let i=0;for(let t in e.seq)if(e.seq[t].name=t,e.seq[t].loop||(e.seq[t].loop=!1),"string"==typeof e.seq[t].group){let n,s,r;if(-1!=e.seq[t].group.indexOf(" ")){n=e.seq[t].group.split(" "),e.seq[t].group=[];for(let i in n)e.seq[t].group.push([int(n[i])])}else if(-1!=e.seq[t].group.indexOf("-"))if(r=e.seq[t].group.split("-"),n=int(r[0]),s=int(r[1]),e.seq[t].group=[],n<s)for(r=n;r<=s;r++)e.seq[t].group.push([r]);else for(r=n;r>=s;r--)e.seq[t].group.push([r]);else for(n=int(e.seq[t].group),e.seq[t].group=[];n--;)e.seq[t].group.push([i++]);e.seq[t].count=e.seq[t].group.length}if(e.trans)for(let t in e.trans){e.seq[t].trans=e.trans[t];for(let i in e.trans[t])for(let n=0;n<e.trans[t][i].length;n++){let s=e.trans[t][i][n];if(!e.seq[s])throw new Error("Undefined sequence: "+s);e.trans[t][i][n]=e.seq[s]}}e.initialized=!0},getSharedAnimation:function(t=null){return null===this.sharedAnim?(this.sharedAnim=J.Pool.alloc(this,t?this.a.seq[t]:this.a.def,this.a.fps),this.sharedAnim.lockInstance(!0),this.sharedAnim):this.sharedAnim.play(t||this.a.def.name)},getAnimation:function(t=null,e=null){return J.Pool.alloc(this,t?this.a.seq[t]:this.a.def,e||this.a.fps)},getSequence:function(t){return this.a.seq[t]},getImage:function(){return this.r.data},getDrawable:function(){return null===this.defaultDrawable&&(this.defaultDrawable=this.getAnimation()),this.defaultDrawable}}),//![import "../system/canvas"]
et=t.extend({__ctor:function(t){if("image"!=t.type||!t.font)throw new Error("Resource is not a sprite font.");t.font.sheetWidth||(t.font.sheetWidth=t.width);let e=t.data.width/t.font.sheetWidth,i=t.width/t.font.sheetWidth;this.r_charWidth=t.font.charWidth*e,this.r_charHeight=t.font.charHeight*e,this.charWidth=t.font.charWidth*i,this.charHeight=t.font.charHeight*i,this.paddingX=(t.font.paddingX||0)*i,this.paddingY=(t.font.paddingY||0)*i,this.spacingX=(t.font.spacingX||0)*i,this.spacingY=(t.font.spacingY||0)*i,this.reverseDraw=t.font.reverseDraw||!1;let n=int(t.font.sheetWidth/t.font.charWidth);this.r=t,this.r.wrapper=this;let s=t.font.charset.length,r=0,a=0;for(this.charTable={};r<s;){let e=0;for(let i=0;i<n&&r<s;i++){let i=t.font.charset[r++];this.charTable[i]={hidden:!1,x:e,y:a,charWidth:this.charWidth,r_charWidth:this.r_charWidth,spacingX:0},e+=this.r_charWidth}a+=this.r_charHeight}if(" "in this.charTable||(this.charTable[" "]={hidden:!0,charWidth:int(2*(this.charWidth+this.paddingX)/3),r_charWidth:this.r_charWidth,spacingX:0}),t.font.widths){s=t.font.widths.length;for(let e=0;e<s;e+=2){let n=t.font.widths[e+1]*i,s=t.font.widths[e];"number"==typeof s&&(s=String.fromCharCode(s));for(let t=0;t<s.length;t++)s[t]in this.charTable&&(this.charTable[s[t]].spacingX=n-this.charTable[s[t]].charWidth)}}},drawText:function(t,e,i,n){let s=n.length,r=-2*this.paddingX+this.spacingX;if(e-=this.paddingX,i-=this.paddingY,this.reverseDraw){for(let t=0;t<s-1;t++){let i=this.charTable[n[t]];i&&(e+=i.charWidth+r)}for(let a=s-1;a>=0;a--){let s=this.charTable[n[a]];s&&(s.hidden||t.drawImage(this.r.data,s.x,s.y,s.r_charWidth,this.r_charHeight,e,i,s.charWidth,this.charHeight,null,null,s.charWidth,this.charHeight),e-=s.charWidth+r+s.spacingX)}}else for(let a=0;a<s;a++){let s=this.charTable[n[a]];s&&(s.hidden||t.drawImage(this.r.data,s.x,s.y,s.r_charWidth,this.r_charHeight,e,i,s.charWidth,this.charHeight,null,null,s.charWidth,this.charHeight),e+=s.charWidth+r+s.spacingX)}},measureWidth:function(t){let e=t.length,i=0,n=-2*this.paddingX+this.spacingX;for(let s=0;s<e;s++){let e=this.charTable[t[s]];e&&(i+=e.charWidth+n+e.spacingX)}return i},measureHeight:function(t){return this.charHeight-2*this.paddingY+this.spacingY},getImage:function(){return this.r.data}});F.prototype.drawText=function(t,e,i,n){t.drawText(this,e,i,n)},F.prototype.drawTextAligned=function(t,e,i,n,s,r,a,l){0==r?e+=n-t.measureWidth(l)>>1:r<0?e=e-r-1:r>0&&(e=e+n-r+1-t.measureWidth(l)),0==a?i+=s-t.measureHeight(l)>>1:a<0?i=i-a-1:a>0&&(i=i+s-a+1-t.measureHeight(l)),t.drawText(this,e,i,l)},F.prototype.drawTextAligned2=function(t,e,i,n,s){this.drawTextAligned(t,e.x1,e.y1,e.width(),e.height(),i,n,s)};
//![import "./resources"]
const it=t.extend({r:null,__ctor:function(t){if("audio"!=t.type)throw new Error("Resource is not audio.");this.r=t,this.r.wrapper=this,this.track=it[this.r.track.toUpperCase()]},play:function(t,e){return it.play(this,t,e)},playLoop:function(t,e){return it.playLoop(this,t,e)}});it.ENGINE_HTML5=1,it.ENGINE_WEBAUDIO=2,it.ENGINE_NATIVEAUDIO=3,Object.assign(it,{MASTER:{enabled:!0,volume:1},SFX:{enabled:!0,volume:1},MUSIC:{enabled:!0,volume:.8},VOICE:{enabled:!0,volume:1},MAX_POOL_SIZE:100,pool:[],active:[],register:function(t){t.registered||(t.registered=!0,this.active.push(t))},unregister:function(t){if(t.registered){t.registered=!1;var e=it.active.indexOf(t);-1!=e&&it.active.splice(e,1)}},updateNode:function(t,e){switch(t.snd.r.engine){case it.ENGINE_WEBAUDIO:return this.updateNode_webaudio(t,e);case it.ENGINE_NATIVEAUDIO:return this.updateNode_nativeaudio(t,e)}return this.updateNode_audio(t,e)},alloc_webaudio:function(t){t.gainNode=audioContext.createGain(),t.gainNode.gain.value=0,t.gainNode.connect(audioContext.destination),t.res=audioContext.createBufferSource(),t.res.buffer=t.snd.r.data,t.res.loop=!1,t.res.connect(t.gainNode),t.res.node=t},free_webaudio:function(t){t.res&&(t.gainNode.disconnect(),t.res=null,t.gainNode=null)},alloc_nativeaudio:function(t){t.res=!0},free_nativeaudio:function(t){t.res=!1},alloc_audio:function(t){return this.pool.length?item=this.pool.pop():item=t.cloneNode(),item._src=t.src,item},free_audio:function(t){this.pool.length!=this.MAX_POOL_SIZE&&this.pool.push(t)},updateNode_webaudio:function(t,e){if(!t)return null;var i=it.MASTER.volume*t.snd.track.volume*t.volume;switch(e){case"play":if(t.playing)break;t.res||it.alloc_webaudio(t),t.playTime=hrnow(),t.playing=!0,t.pause=!1,t.res.onended=it.onended_webaudio,t.gainNode.gain.value=i;try{t.res.start(0,t.startTime/1e3)}catch(e){return it.free_webaudio(t),null}it.register(t);break;case"setvolume":if(!t.res)break;t.gainNode.gain.value=i;break;case"stop":if(!t.playing&&t.paused){t.startTime=0,t.paused=!1,it.free_webaudio(t),t.callback&&t.callback();break}if(!t.res)break;t.startTime=0,t.playing=!1,t.pause=!1,t.res.onended=null,it.unregister(t),t.res.stop(),it.free_webaudio(t),t.callback&&t.callback();break;case"pause":if(!t.playing||!t.res)break;t.startTime+=hrnow()-t.playTime,t.playing=!1,t.pause=!0,t.res.onended=null,it.unregister(t),t.res.stop(),it.free_webaudio(t);break;case"softstop":if(!t.playing&&t.paused){t.startTime=0,t.paused=!1;break}if(!t.playing||!t.res)break;t.startTime=0,t.playing=!1,t.pause=!1,t.res.loop=!1}return t},onended_webaudio:function(t){var e=t.currentTarget.node;if(e.playing&&0!=e.loop)return it.free_webaudio(e),-1!=e.loop&&e.loop--,e.startTime=0,e.playing=!1,e.pause=!1,void it.updateNode_webaudio(e,"play");e.res.onended=null,e.res.volume=0,it.updateNode_webaudio(e,"stop")},updateNode_nativeaudio:function(t,e){if(!t)return null;switch(e){case"play":if(t.playing)break;t.res||it.alloc_nativeaudio(t),t.playing=!0,t.pause=!1;try{r.plugins.NativeAudio.play(t.snd.r.data,null,null,(function(){it.onended_nativeaudio(t)}))}catch(e){return it.free_nativeaudio(t),null}it.register(t);break;case"setvolume":case"pause":case"softstop":break;case"stop":if(!t.res)break;t.playing=!1,t.pause=!1,it.unregister(t),r.plugins.NativeAudio.stop(t.snd.r.data,null),it.free_nativeaudio(t),t.callback&&t.callback()}return t},onended_nativeaudio:function(t){it.updateNode_nativeaudio(t,"stop")},updateNode_audio:function(t,e){if(!t)return null;var i=it.MASTER.volume*t.snd.track.volume*t.volume;switch(e){case"play":if(t.playing)break;t.res||(t.res=it.alloc_audio(t.snd.r.data),t.res.node=t,t.res.src=t.res._src),t.playTime=hrnow(),t.playing=!0,t.pause=!1,t.res.onended=it.onended_audio,t.res.currentTime=t.startTime/1e3,t.res.volume=i;try{t.res.play()}catch(e){return it.free_audio(t.res),t.res=null,null}it.register(t);break;case"setvolume":if(!t.res)break;t.res.volume=i;break;case"stop":if(!t.playing&&t.paused){t.startTime=0,t.paused=!1,it.free_audio(t.res),t.res=null,t.callback&&t.callback();break}if(!t.res)break;t.startTime=0,t.playing=!1,t.pause=!1,it.unregister(t),t.res.pause(),it.free_audio(t.res),t.res=null,t.callback&&t.callback();break;case"pause":if(!t.playing||!t.res)break;t.startTime+=hrnow()-t.playTime,t.playing=!1,t.pause=!0,it.unregister(t),t.res.pause();break;case"softstop":if(!t.playing&&t.paused){t.startTime=0,t.paused=!1;break}if(!t.playing||!t.res)break;t.startTime=0,t.playing=!1,t.pause=!1}return t},onended_audio:function(t){var e=t.currentTarget.node;if(e.playing&&0!=e.loop)return-1!=e.loop&&e.loop--,e.startTime=0,e.playing=!1,e.pause=!1,void it.updateNode_audio(e,"play");e.res.onended=null,e.res.volume=0,it.updateNode_audio(e,"stop")},enableTrack:function(t){t&&(t.enabled=!0)},disableTrack:function(t){t&&(t.enabled=!1)},setVolume:function(t,e){t&&(t.volume=e)},createNode:function(t,e){var i={};return i.startVolume=e,i.volume=e,i.snd=t,i.loop=0,i.playing=!1,i.paused=!1,i.startTime=0,i.playTime=0,i.callback=null,i.timer=null,i.res=null,i},play:function(t,e,i){if(!this.MASTER.enabled||!t||!t.track.enabled)return null;i=null!=i?i:1;var n=this.createNode(t,i);return n.callback=e,this.updateNode(n,"play")},playLoop:function(t,e,i){if(!this.MASTER.enabled||!t||!t.track.enabled)return null;i=null!=i?i:1;var n=this.createNode(t,i);return n.callback=e,n.loop=-1,this.updateNode(n,"play")},stop:function(t,e){return t?(e&&!0!==e&&(t.callback=e),this.updateNode(t,!0===e?"stop":"softstop")):null},pause:function(t){return t?this.updateNode(t,"pause"):null},resume:function(t){return t?this.updateNode(t,"play"):null},fadeOut:function(t,e,i){if(t)if(t.playing&&!t.timer){var n=hrnow();t.startVolume=t.volume,t.timer=setInterval((function(){var s=(hrnow()-n)/e;s>1&&(s=1),t.volume=t.startVolume*(1-s),it.updateNode(t,"setvolume"),1==s&&(clearInterval(t.timer),t.timer=null,!0===i?it.updateNode(t,"stop"):it.updateNode(t,"pause"),i&&!0!==i&&i())}),50)}else i&&i()},fadeIn:function(t,e,i){if(t)if(t.playing||t.timer)i&&i();else{var n=hrnow();t.volume=0,this.updateNode(t,"play"),t.timer=setInterval((function(){var s=(hrnow()-n)/e;s>1&&(s=1),t.volume=t.startVolume*s,it.updateNode(t,"setvolume"),1==s&&(clearInterval(t.timer),t.timer=null,i&&i())}),50)}}}),Q.Audio=function(t,e=null){return{type:"audio",wrapper:"Sound",src:t,...e}};var nt=it,//![import "./sound.js"]
st=t.extend({r:null,__ctor:function(t){if("audios"!=t.type)throw new Error("Resource is not audios.");this.r=t,this.r.wrapper=this,this.r.track||(this.r.track="sfx"),this.r.mode||(this.r.mode="random"),this.track=nt[this.r.track.toUpperCase()],this.sounds=[],this.lastIndex=-1;for(var e=0;e<this.r.data.length;e++)this.sounds.push(new nt(Object.assign(this.r.data[e],{track:this.r.track})))},getRandomSound:function(){return"random"==this.r.mode?this.sounds[randr(0,this.sounds.length-1)]:(this.lastIndex=++this.lastIndex%this.sounds.length,this.sounds[this.lastIndex])},play:function(t,e){return nt.play(this.getRandomSound(),t,e)},playLoop:function(t,e){return nt.playLoop(this.getRandomSound(),t,e)},playAt:function(t,e,i){return nt.play(this.sounds[t%this.sounds.length],e,i)},playLoopAt:function(t,e,i){return nt.playLoop(this.sounds[t%this.sounds.length],e,i)}});const rt=j,at=Z,lt=$,ot=tt,ht=et,ut=nt,ct=st;var//!class PriorityQueue
dt=t.extend({className:"PriorityQueue",queue:null,queueKeys:null,order:null,__ctor:function(){this.queue={},this.queueKeys=[]},add:function(t){if(null==t)return null;if(!("priority"in t))throw new Error("PriorityQueue (add): Object has no `priority` property.");return t.priority in this.queue||(this.queue[t.priority]={is_dirty:!1,list:[]},this.queueKeys.push(t.priority),this.order=Object.keys(this.queue).sort(((t,e)=>t-e))),-1===this.queue[t.priority].list.indexOf(t)&&this.queue[t.priority].list.push(t),t},remove:function(t){if(null==t)return null;if(!("priority"in t))throw new Error("PriorityQueue (remove): Object has no `priority` property.");if(!(t.priority in this.queue))return t;let e=this.queue[t.priority].list.indexOf(t);return-1===e||(this.queue[t.priority].is_dirty=!0,this.queue[t.priority].list[e]=null),t},cleanup:function(){for(let t=0;t<this.queueKeys.length;t++){let e=this.queue[this.queueKeys[t]];if(e.is_dirty){for(let t=0;t<e.list.length;t++)null==e.list[t]&&e.list.splice(t--,1);e.is_dirty=!1}}},forEach:function(t){let e=!1,i=!1;for(let n=0;!i&&n<this.order.length;n++){let s=this.queue[this.order[n]].list;for(let n=0;!i&&n<s.length;n++)null!=s[n]&&!1===t(s[n])&&(i=!0),null==s[n]&&(e=!0)}e&&this.cleanup()},forEachRev:function(t){let e=!1,i=!1;for(let n=this.order.length-1;!i&&n>=0;n--){let s=this.queue[this.order[n]].list;for(let n=s.length-1;!i&&n>=0;n--)null!=s[n]&&!1===t(s[n])&&(i=!0),null==s[n]&&(e=!0)}e&&this.cleanup()},forEachAsync:function(t,e=null){let i=this,n=!1,s=!1,r=-1,a=-1,l=null,o=function(){a++,!s&&a<l.length?(null!=l[a]&&!1===t(l[a],o)&&(s=!0),null==l[a]&&(n=!0),s&&o()):h()},h=function(){r++,!s&&r<i.order.length?(l=i.queue[i.order[r]].list,a=-1,o()):(n&&i.cleanup(),e&&e())};h()},forEachRevAsync:function(t){alert("NOT IMPLEMENTED: forEachRevAsync")}});
//![import "./recycler"]
//!class Callback
const ft=t.extend({className:"Callback",callback:null,context:null,arg1:null,arg2:null,arg3:null,arg4:null,prev:null,next:null,__ctor:function(t,e=null,i=null,n=null,s=null,r=null){this.callback=t,this.context=e,this.arg1=i,this.arg2=n,this.arg3=s,this.arg4=r,this.prev=null,this.next=null},__dtor:function(){this.callback=null,this.context=null,this.arg1=null,this.arg2=null,this.arg3=null,this.arg4=null,this.prev=null,this.next=null},isEqual:function(t=null,e=null,i=null,n=null,s=null,r=null){return null!==t&&ft.isInstance(t)?t===this:(null===t||this.callback===t)&&((null===e||this.context===e)&&((null===i||this.arg1===i)&&((null===n||this.arg2===n)&&((null===s||this.arg3===s)&&(null===r||this.arg4===r)))))},exec:function(t){return null===this.callback||this.callback(t,this.context,this.arg1,this.arg2,this.arg3,this.arg4)}});
//!/class
//!namespace Callback
//!namespace Pool
f.createPool(ft,16384,6144);var pt=ft;
//![import "./recycler"]
//![import "./callback"]
//!class Handler
const mt=t.extend({className:"Handler",host:null,top:null,bottom:null,__ctor:function(t=null){return this.host=t,this.top=null,this.bottom=null,this},__dtor:function(){this.remove()},add:function(t,e=null,i=null,n=null,s=null,r=null){let a=pt.isInstance(t)?t:pt.Pool.alloc(t,e,i,n,s,r);return a.prev=this.bottom,null!==this.bottom&&(this.bottom.next=a),this.bottom=a,null===this.top&&(this.top=a),a},unlink:function(t){t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),this.top===t&&(this.top=t.next),this.bottom===t&&(this.bottom=t.prev),t.prev=null,t.next=null,dispose(t)},remove:function(t=null,e=null,i=null,n=null,s=null,r=null){if(null!==t&&pt.isInstance(t))return this.unlink(t),this;let a=this.top;for(;null!==a;){let l=a.next;a.isEqual(t,e,i,n,s,r)&&this.unlink(a),a=l}return this},find:function(t,e=null,i=null,n=null,s=null,r=null){let a=this.top;for(;null!==a;){if(a.isEqual(t,e,i,n,s,r))return a;a=a.next}return null},exec:function(){let t=this.top;for(;null!==t;){let e=t.next;!1===t.exec(this.host)&&this.unlink(t),t=e}},execf:function(t=null,e=null,i=null,n=null,s=null,r=null){let a=this.top;for(;null!==a;){let l=a.next;if(a.isEqual(t,e,i,n,s,r)){!1===a.exec(this.host)&&this.unlink(a);break}a=l}},execc:function(t){!1===t.exec(this.host)&&this.unlink(t)}});
//!/class
//!namespace Handler
//!namespace Pool
f.createPool(mt,16384,6144);var gt=mt;
//![import "../utils/recycler"]
//![import "./vec2"]
//!class Rect
const xt=t.extend({className:"Rect",cx:0,cy:0,x1:0,y1:0,x2:0,y2:0,__ctor:function(t=null,e=null,i=null,n=null){return null===t?(this.x1=this.y1=this.x2=this.y2=this.cx=this.cy=0,this):null===i?(this.set(0,0,0,0),this.resize(t,e),this):this.set(t,e,i,n)},__dtor:function(){},clone:function(){return xt.Rool.alloc(this.x1,this.y1,this.x2,this.y2)},zero:function(){return this.cx=0,this.cy=0,this.x1=0,this.y1=0,this.x2=0,this.y2=0,this},reset:function(){return this.cx=null,this.cy=null,this.x1=null,this.y1=null,this.x2=null,this.y2=null,this},extendWithPoint:function(t,e=null){if(null===e){const i=t;t=i.x,e=i.y}return(null===this.x1||t<this.x1)&&(this.x1=t),(null===this.y1||e<this.y1)&&(this.y1=e),(null===this.x2||t>this.x2)&&(this.x2=t),(null===this.y2||e>this.y2)&&(this.y2=e),this.cx=(this.x1+this.x2)/2,this.cy=(this.y1+this.y2)/2,this},translate:function(t,e){return this.x1+=t,this.y1+=e,this.x2+=t,this.y2+=e,this.cx+=t,this.cy+=e,this},centerAt:function(t,e,i=!1){return 1==i&&(t=this.x1+t*(this.x2-this.x1),e=this.y1+e*(this.y2-this.y1)),this.translate(t-this.cx,e-this.cy)},set:function(t,e=null,i=null,n=null){if(null===e){const s=t;t=s.x1,e=s.y1,i=s.x2,n=s.y2}return this.cx=(t+i)/2,this.cy=(e+n)/2,this.x1=t,this.y1=e,this.x2=i,this.y2=n,this},equals:function(t,e=null,i=null,n=null){if(null===e){const s=t;t=s.x1,e=s.y1,i=s.x2,n=s.y2}return t==this.x1&&i==this.x2&&e==this.y1&&n==this.y2},contains:function(t,e=null,i=null,n=null){if(null===e){const s=t;t=s.x1,e=s.y1,i=s.x2,n=s.y2}return t==Math.max(this.x1,t)&&e==Math.max(this.y1,e)&&i==Math.min(this.x2,i)&&n==Math.min(this.y2,n)},setAsUnion:function(t,e=null,i=null,n=null){if(null===e){const s=t;t=s.x1,e=s.y1,i=s.x2,n=s.y2}return this.x1=Math.min(this.x1,t),this.y1=Math.min(this.y1,e),this.x2=Math.max(this.x2,i),this.y2=Math.max(this.y2,n),this},intersects:function(t,e=null,i=null,n=null){if(null===e){const s=t;t=s.x1,e=s.y1,i=s.x2,n=s.y2}let s=Math.max(this.x1,t),r=Math.max(this.y1,e),a=Math.min(this.x2,i),l=Math.min(this.y2,n);return Math.max(0,l-r)*Math.max(0,a-s)>0},setAsIntersection:function(t,e=null,i=null,n=null){if(null===e){const s=t;t=s.x1,e=s.y1,i=s.x2,n=s.y2}return this.x1=Math.max(this.x1,t),this.y1=Math.max(this.y1,e),this.x2=Math.min(this.x2,i),this.y2=Math.min(this.y2,n),Math.max(0,this.y2-this.y1)*Math.max(0,this.x2-this.x1)>0},resize:function(t,e,i=!1,n=!1){return 1==n&&(t*=this.x2-this.x1,e*=this.y2-this.y1),1==i?(this.x2=this.x1+t,this.y2=this.y1+e):(t/=2,e/=2,this.x1=this.cx-t,this.y1=this.cy-e,this.x2=this.cx+t,this.y2=this.cy+e),this},resizeBy:function(t,e,i=!1){return 1==i?(this.x2+=t,this.y2+=e):(t/=2,e/=2,this.x1-=t,this.y1-=e,this.x2+=t,this.y2+=e),this},width:function(){return this.x2-this.x1},height:function(){return this.y2-this.y1},ncx:function(){return(this.cx-this.x1)/(this.x2-this.x1)},ncy:function(){return(this.cy-this.y1)/(this.y2-this.y1)},isRight:function(){return this.x1<=this.x2&&this.y1<=this.y2},containsPoint:function(t,e,i=0){return this.x1-i<=t&&t<=this.x2+i&&this.y1-i<=e&&e<=this.y2+i},area:function(t){return t?this.isRight()?(this.y2-this.y1)*(this.x2-this.x1):0:(this.y2-this.y1)*(this.x2-this.x1)},floor:function(){return this.x1=Math.floor(this.x1),this.y1=Math.floor(this.y1),this.x2=Math.floor(this.x2),this.y2=Math.floor(this.y2),this.cx=Math.floor(this.cx),this.cy=Math.floor(this.cy),this},ceil:function(){return this.x1=Math.ceil(this.x1),this.y1=Math.ceil(this.y1),this.x2=Math.ceil(this.x2),this.y2=Math.ceil(this.y2),this.cx=Math.ceil(this.cx),this.cy=Math.ceil(this.cy),this},toString:function(){return"("+this.x1.toFixed(2)+", "+this.y1.toFixed(2)+", "+this.x2.toFixed(2)+", "+this.y2.toFixed(2)+")"},flatten:function(){return[this.x1,this.y1,this.x2,this.y2]},unflatten:function(t){return this.set(t[0],t[1],t[2],t[3]),this}});
//!/class
//!namespace Rect
//!namespace Pool
f.createPool(xt,4096,2048);var yt=xt;
//!class TFunction
const _t=t.extend({className:"TFunction",t:null,y:null,f:null,__ctor:function(t=0){this.reset(t)},reset:function(t=0){return this.t=[0],this.y=[t],this.f=[null],this},copyFrom:function(t,e,i){if(this.t=[],this.y=[],this.f=[],null==e&&null==i){for(let e=0;e<t.t.length;e++)this.t.push(t.t[e]),this.y.push(t.y[e]),this.f.push(t.f[e]);return this}null==e&&(e=t.t[0]),null==i&&(i=t.t[t.t.length-1]),e<t.t[0]&&(e=t.t[0]);let n=t.find(e),s=t.find(i);if(null==n)return null;if(null==s)return null;t.t[n]!=e&&(this.set(e,t.getAt(e),t.f[n]),n++);for(let e=n;e<=s;e++)this.set(t.t[e],t.y[e],t.f[e]);if(t.t[s]!=i){let e=(i-t.t[s])/Math.ceil(Math.log(i-t.t[s])),n=this.t[this.t.length-1];for(e<=0&&(e=1),e=i-n;n!=i;)n+e>i&&(e=i-n),n+=e,this.set(float4(n),t.getAt(n),t.f[s])}return this},clone:function(t,e){return(new _t).copyFrom(this,t,e)},endTime:function(t=0){return this.t[this.t.length-1]+t},startTime:function(t=0){return this.t[0]+t},find:function(t){if(t<this.t[0])return null;const e=this.t.length;for(let i=1;i<e;i++)if(t<this.t[i])return i-1;return e-1},set:function(t,e,i=null){let n=this.find(t);return null!=n&&(this.t[n]==t?(this.y[n]=e,null!=i&&(this.f[n]=i)):(n++,this.t.splice(n,0,t),this.y.splice(n,0,e),this.f.splice(n,0,i)),!0)},get:function(){return this.y[this.y.length-1]},getAt:function(t){let e=this.find(t);if(null==e)return 0;let i=e+1;if(this.t[e]==t||i>=this.t.length||this.y[e]==this.y[i]||null==this.f[e])return this.y[e];if(null==this.f[e])return this.y[e];let n=t,s=this.t[e],r=this.t[i],a=this.y[e],l=this.y[i];return t=(n-s)/(r-s),(t=this.f[e](t))*l+(1-t)*a},integral:function(t=null,e=null,i=0){null==t&&(t=this.t[0]),null==e&&(e=this.t[this.t.length-1]),t<this.t[0]&&(t=this.t[0]);let n=1;if(t>e){let i;i=t,t=e,e=i,n=-1}let s=i;for(let i=t;i<e;){let t=this.find(i);if(null==t)return 0;let n=t+1,r=Math.max(this.t[t],i),a=Math.min(n<this.t.length?this.t[n]:e,e),l=this.getAt(r),o=a-r,h=this.getAt(a)-l;null==this.f[t]?s+=l*o:s+=.5*h*(a+r)-r*h+l*o,i+=o}return n*s},second_integral:function(t=null,e=null,i=0){null==t&&(t=this.t[0]),null==e&&(e=this.t[this.t.length-1]);let n=_t.Temp1.copyFrom(this,this.t[0],t).integrate(i).integral();return _t.Temp2.copyFrom(this,this.t[0],e).integrate(i).integral()-n},integrate:function(t=0){let e=[];e.push(t);for(let t=1;t<this.t.length;t++)e.push(e[t-1]+this.integral(this.t[t-1],this.t[t]));return this.y=e,this},accumulate:function(t=0){this.y[0]+=t;for(let t=1;t<this.t.length;t++)this.y[t]+=this.y[t-1];return this},chopLeft:function(t){return this.t.splice(0,t),this.f.splice(0,t),this.y.splice(0,t),this},chopRight:function(t){return this.t.splice(t+1,this.t.length-t-1),this.f.splice(t+1,this.f.length-t-1),this.y.splice(t+1,this.y.length-t-1),this},map:function(t){for(let e=0;e<this.y.length;e++)this.y[e]=t(this.y[e],this.t[e],e);return this},toString:function(t=0){let e="",i=10;const n=function(t,e,i){for(t=t.toString(),null==i&&(i=" "),i=i[0];t.length<e;)t+=i;return t};e+="\n",e+=n(" Time",i)+" "+n(" Value",i)+" "+n(" Integral",i)+"\n",e+=n("",i,"-")+" "+n("",i,"-")+" "+n("",i,"-")+"\n";for(let s=0;s<this.t.length;s++)e+=n(" "+float4(this.t[s]),i)+" "+n(" "+float4(this.y[s]),i)+" "+n(" "+float4(this.integral(this.t[0],this.t[s],t)),i)+"\n";return e}});_t.Temp1=new _t,_t.Temp2=new _t;var vt=_t;
//![import "../utils/recycler"]
//![import "./vec2"]
//!class Point2
const bt=t.extend({className:"Point2",ux:0,uy:0,x:0,y:0,__ctor:function(t=null,e=null){return this.set(t,e)},downscale:function(){return this.x=downscale(this.ux),this.y=downscale(this.uy),this},clone:function(){return bt.Pool.alloc(this)},set:function(t,e=null,i=!1){return null===t?(t=0,e=0):null===e?bt.isInstance(t)?(e=t.uy,t=t.ux):(e=upscale(t.y),t=upscale(t.x)):i||(t=upscale(t),e=upscale(e)),this.ux=t,this.uy=e,this.downscale(this)},setX:function(t){return this.ux=upscale(t),this.downscale(this)},setY:function(t){return this.uy=upscale(t),this.downscale(this)},zero:function(){return this.set(0,0)},isZero:function(){return 0==this.x&&0==this.y},equals:function(t,e=null){return null===e?bt.isInstance(t)?(e=t.y,t=t.x):(e=int(t.y),t=int(t.x)):(t=int(t),e=int(e)),this.x==t&&this.y==e},add:function(t,e=null,i=!1){return null===e?bt.isInstance(t)?(e=t.uy,t=t.ux):(e=upscale(t.y),t=upscale(t.x)):i||(t=upscale(t),e=upscale(e)),this.ux+=t,this.uy+=e,this.downscale()},sub:function(t,e,i=!1){return null===e?bt.isInstance(t)?(e=t.uy,t=t.ux):(e=upscale(t.y),t=upscale(t.x)):i||(t=upscale(t),e=upscale(e)),this.ux-=t,this.uy-=e,this.downscale()},toString:function(){return`(${this.x}, ${this.y})`}});
//!/class
//!namespace Point2
//!namespace Pool
f.createPool(bt,2048,1024);var wt=bt;
//![import "../utils/recycler"]
//![import "./point2"]
//![import "./rect"]
//!class Bounds2
const Et=t.extend({className:"Bounds2",cx:0,cy:0,x1:0,y1:0,x2:0,y2:0,ucx:0,ucy:0,ux1:0,uy1:0,ux2:0,uy2:0,__ctor:function(t=null,e=null,i=null,n=null,s=!1){return null===t?(this.ux1=this.uy1=this.ux2=this.uy2=this.ucx=this.ucy=0,this.downscale()):null!==e&&null===i?this.set(0,0,0,0).resize(t,e):this.set(t,e,i,n,s)},downscale:function(){return this.x1=downscale(this.ux1),this.y1=downscale(this.uy1),this.x2=downscale(this.ux2),this.y2=downscale(this.uy2),this.cx=downscale(this.ucx),this.cy=downscale(this.ucy),this},trunc:function(){return this.ux1=upscale(this.x1),this.uy1=upscale(this.y1),this.ux2=upscale(this.x2),this.uy2=upscale(this.y2),this.ucx=upscale(this.cx),this.ucy=upscale(this.cy),this},clone:function(){return Et.Pool.alloc(this.ux1,this.uy1,this.ux2,this.uy2,!0)},zero:function(){return this.ux1=0,this.uy1=0,this.ux2=0,this.uy2=0,this.ucx=0,this.ucy=0,this.downscale()},reset:function(){return this.ux1=null,this.uy1=null,this.ux2=null,this.uy2=null,this.ucx=null,this.ucy=null,this.x1=null,this.y1=null,this.x2=null,this.y2=null,this.cx=null,this.cy=null,this},translate:function(t,e=null,i=!1){return null===e?wt.isInstance(t)?(e=t.uy,t=t.ux):(e=upscale(t.y),t=upscale(t.x)):i||(t=upscale(t),e=upscale(e)),this.ux1+=t,this.uy1+=e,this.ux2+=t,this.uy2+=e,this.ucx+=t,this.ucy+=e,this.downscale()},set:function(t,e=null,i=null,n=null,s=!1){return null===e?Et.isInstance(t)?(n=t.uy2,i=t.ux2,e=t.uy1,t=t.ux1):(n=upscale(t.y2),i=upscale(t.x2),e=upscale(t.y1),t=upscale(t.x1)):s||(t=upscale(t),e=upscale(e),i=upscale(i),n=upscale(n)),this.ux1=t,this.uy1=e,this.ux2=i,this.uy2=n,this.ucx=t+i>>1,this.ucy=e+n>>1,this.downscale()},add:function(t,e=null,i=null,n=null,s=!1){return null===e?Et.isInstance(t)?(n=t.uy2,i=t.ux2,e=t.uy1,t=t.ux1):(n=upscale(t.y2),i=upscale(t.x2),e=upscale(t.y1),t=upscale(t.x1)):s||(t=upscale(t),e=upscale(e),i=upscale(i),n=upscale(n)),this.ux1+=t,this.uy1+=e,this.ux2+=i,this.uy2+=n,this.ucx+=t+i>>1,this.ucy+=e+n>>1,this.downscale()},equals:function(t,e=null,i=null,n=null){return null===e?Et.isInstance(t)?(n=t.y2,i=t.x2,e=t.y1,t=t.x1):(n=int(t.y2),i=int(t.x2),e=int(t.y1),t=int(t.x1)):(t=int(t),e=int(e),i=int(i),n=int(n)),t==this.x1&&i==this.x2&&e==this.y1&&n==this.y2},contains:function(t,e=null,i=null,n=null){return null===e?Et.isInstance(t)?(n=t.y2,i=t.x2,e=t.y1,t=t.x1):(n=int(t.y2),i=int(t.x2),e=int(t.y1),t=int(t.x1)):(t=int(t),e=int(e),i=int(i),n=int(n)),t==Math.max(this.x1,t)&&e==Math.max(this.y1,e)&&i==Math.min(this.x2,i)&&n==Math.min(this.y2,n)},setAsUnion:function(t,e=null,i=null,n=null){if(null===e){if(Et.isInstance(t))return this.setAsUnion(t.ux1,t.uy1,!0),this.setAsUnion(t.ux2,t.uy2,!0),this;if(yt.isInstance(t))return this.setAsUnion(t.x1,t.y1),this.setAsUnion(t.x2,t.y2),this;wt.isInstance(t)?(e=t.uy,t=t.ux):(e=upscale(t.y),t=upscale(t.x))}else{if(null!==n)return this.setAsUnion(t,e),this.setAsUnion(i,n),this;!0!==i&&(t=upscale(t),e=upscale(e))}return(null===this.ux1||t<this.ux1)&&(this.ux1=t),(null===this.uy1||e<this.uy1)&&(this.uy1=e),(null===this.ux2||t>this.ux2)&&(this.ux2=t),(null===this.uy2||e>this.uy2)&&(this.uy2=e),this.ucx=this.ux1+this.ux2>>1,this.ucy=this.uy1+this.uy2>>1,this.downscale()},intersects:function(t,e=null,i=null,n=null){null===e?Et.isInstance(t)?(n=t.y2,i=t.x2,e=t.y1,t=t.x1):(n=int(t.y2),i=int(t.x2),e=int(t.y1),t=int(t.x1)):(t=int(t),e=int(e),i=int(i),n=int(n));let s=Math.max(this.x1,t),r=Math.max(this.y1,e),a=Math.min(this.x2,i),l=Math.min(this.y2,n);return Math.max(0,l-r)*Math.max(0,a-s)>0},setAsIntersection:function(t,e=null,i=null,n=null){return null===e?Et.isInstance(t)?(n=t.y2,i=t.x2,e=t.y1,t=t.x1):(n=int(t.y2),i=int(t.x2),e=int(t.y1),t=int(t.x1)):(t=int(t),e=int(e),i=int(i),n=int(n)),this.ux1=upscale(Math.max(this.x1,t)),this.uy1=upscale(Math.max(this.y1,e)),this.ux2=upscale(Math.min(this.x2,i)),this.uy2=upscale(Math.min(this.y2,n)),this.ucx=this.ux1+this.ux2>>1,this.ucy=this.uy1+this.uy2>>1,this.downscale(),Math.max(0,this.uy2-this.uy1)*Math.max(0,this.ux2-this.ux1)>0},resize:function(t,e,i=!1){return t=upscale(t),e=upscale(e),!0===i?(this.ux2=this.ux1+t,this.uy2=this.uy1+e,this.ucx=this.ux1+this.ux2>>1,this.ucy=this.uy1+this.uy2>>1):(t>>=1,e>>=1,this.ux1=this.ucx-t,this.uy1=this.ucy-e,this.ux2=this.ucx+t,this.uy2=this.ucy+e),this.downscale()},resizeBy:function(t,e,i=!1){return t=upscale(t),e=upscale(e),!0===i?(this.ux2+=t,this.uy2+=e,this.ucx=this.ux1+this.ux2>>1,this.ucy=this.uy1+this.uy2>>1):(t>>=1,e>>=1,this.ux1-=t,this.uy1-=e,this.ux2+=t,this.uy2+=e),this.downscale()},width:function(){return this.x2-this.x1},height:function(){return this.y2-this.y1},isForward:function(){return this.ux1<=this.ux2&&this.uy1<=this.uy2},containsPoint:function(t,e,i=0){return t=upscale(t),e=upscale(e),i=upscale(i),this.ux1-i<=t&&t<=this.ux2+i&&this.uy1-i<=e&&e<=this.uy2+i},area:function(t=!1){return t?this.isForward()?(this.y2-this.y1)*(this.x2-this.x1):0:(this.y2-this.y1)*(this.x2-this.x1)},toString:function(){return"("+this.x1+", "+this.y1+", "+this.x2+", "+this.y2+")"},flatten:function(){return[this.ux1,this.uy1,this.ux2,this.uy2]},unflatten:function(t){return this.ux1=t[0],this.uy1=t[1],this.ux2=t[2],this.uy2=t[3],this.ucx=this.ux1+this.ux2>>1,this.ucy=this.uy1+this.uy2>>1,this.downscale()}});
//!/class
//!namespace Rect
//!namespace Pool
f.createPool(Et,8192,3072);var Tt=Et;
//!namespace Easing
const kt={//!namespace Linear
Linear:{IN:function(t){return t},OUT:function(t){return t},IN_OUT:function(t){return t}},
//!/namespace
//!namespace Back
Back:{k:1.70158,IN:function(t,e=null){return null===e&&(e=kt.Back.k),t*t*((e+1)*t-e)},OUT:function(t,e=null){return 1-kt.Back.IN(1-t,e)},IN_OUT:function(t,e=null){return t<.5?kt.Back.IN(2*t,e)/2:kt.Back.OUT(2*(t-.5),e)/2+.5}},
//!/namespace
//!namespace Bounce
Bounce:{getConst:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},IN:function(t){return 1-kt.Bounce.getConst(1-t)},OUT:function(t){return kt.Bounce.getConst(t)},IN_OUT:function(t){return t<.5?(1-kt.Bounce.getConst(1-2*t))/2:kt.Bounce.getConst(2*(t-.5))/2+.5}},
//!/namespace
//!namespace Circ
Circ:{IN:function(t){return 1-Math.sqrt(1-t*t)},OUT:function(t){return 1-kt.Circ.IN(1-t)},IN_OUT:function(t){return t<.5?kt.Circ.IN(2*t)/2:kt.Circ.OUT(2*(t-.5))/2+.5}},
//!/namespace
//!namespace Cubic
Cubic:{IN:function(t){return t*t*t},OUT:function(t){return 1-kt.Cubic.IN(1-t)},IN_OUT:function(t){return t<.5?kt.Cubic.IN(2*t)/2:kt.Cubic.OUT(2*(t-.5))/2+.5}},
//!/namespace
//!namespace Expo
Expo:{IN:function(t){return Math.pow(2,12*(t-1))},OUT:function(t){return 1-Math.pow(2,-12*t)},IN_OUT:function(t){return(t*=2)<1?Math.pow(2,12*(t-1))/2:(2-Math.pow(2,-12*(t-1)))/2}},
//!/namespace
//!namespace Power
Power:{IN:function(t,e=12){return Math.pow(t,e)},OUT:function(t,e=12){return 1-kt.Power.IN(1-t,e)},IN_OUT:function(t,e=12){return t<.5?kt.Power.IN(2*t,e)/2:kt.Power.OUT(2*(t-.5),e)/2+.5}},
//!/namespace
//!namespace Quad
Quad:{IN:function(t){return t*t},OUT:function(t){return 1-kt.Quad.IN(1-t)},IN_OUT:function(t){return t<.5?kt.Quad.IN(2*t)/2:kt.Quad.OUT(2*(t-.5))/2+.5}},
//!/namespace
//!namespace Quartic
Quartic:{IN:function(t){return t*t*t*t},OUT:function(t){return 1-kt.Quartic.IN(1-t)},IN_OUT:function(t){return t<.5?kt.Quartic.IN(2*t)/2:kt.Quartic.OUT(2*(t-.5))/2+.5}},
//!/namespace
//!namespace Quintic
Quintic:{IN:function(t){return t*t*t*t*t},OUT:function(t){return 1-kt.Quintic.IN(1-t)},IN_OUT:function(t){return t<.5?kt.Quintic.IN(2*t)/2:kt.Quintic.OUT(2*(t-.5))/2+.5}},
//!/namespace
//!namespace Sine
Sine:{IN:function(t){return 1-Math.sin(1.5708*(1-t))},OUT:function(t){return Math.sin(1.5708*t)},IN_OUT:function(t){return(Math.cos(3.1416*t)-1)/-2}},
//!/namespace
//!namespace Step
Step:{IN:function(t){return 1!=t?0:1},OUT:function(t){return 1!=t?0:1},IN_OUT:function(t){return 1!=t?0:1}}};var St=kt;
//![import "../utils/priority-queue"]
//!class Boot
const It={modules:new dt,register:function(t){return this.modules.add(t)},unregister:function(t){this.modules.remove(t),this.modules.cleanup()},startup:function(t=null){this.modules.forEachAsync(((t,e)=>{!1!==t.onStartup(e)&&e()}),t)},shutdown:function(t=null){this.modules.forEachAsyncRev(((t,e)=>{!1!==t.onShutdown(e)&&e()}),t)}};
//!/class
//!namespace Boot
//!interface Module
It.Module=t.extend({className:"Module",priority:5,__ctor:function(){It.register(this)},__dtor:function(){It.unregister(this)},onStartup:function(t){},onShutdown:function(t){}});var//!/interface
//!/namespace
Pt=It;
//!class sys
const Rt={initialized:!1,screenWidth:0,screenHeight:0,renderer:null,time:0,dt:0,update:null,draw:null,options:{gl:!0,log:!1,antialias:!1,background:"#000000",orientation:"automatic",screenWidth:null,screenHeight:null,fps:144,minFps:24,preallocate:!0},init:function(t){return new Promise(((e,i)=>{if(this.initialized)return e();Object.assign(this.options,t),Q.config({pixelated:!this.antialias}),M.init(this.options),M.updateQueueAdd({update:function(t){Rt.time=M.frameTime,Rt.dt=t,Rt.update.host=t,Rt.update.exec()}}),M.drawQueueAdd({draw:function(t){Rt.draw.host=t,Rt.draw.exec()}}),Pt.startup((function(){M.start(),Rt.screenWidth=M.screenWidth,Rt.screenHeight=M.screenHeight,Rt.renderer=M.renderer,Rt.update=gt.Pool.alloc(),Rt.draw=gt.Pool.alloc(),Rt.initialized=!0,e()}))}))}};var At=Rt;
//!class Block
const Ct=t.extend({className:"Anim:Block",commands:null,first:!0,current:!1,time:0,init:function(){return this.commands=x.Pool.alloc(),this.reset(0),this},__dtor:function(){this.clear(),this.commands.free()},add:function(t){return this.commands.push(t),t},clone:function(){let t=Ct.alloc();for(let e=this.commands.top;null!==e;e=e.next)t.commands.push(e.value.clone());return t},clear:function(){return this.commands.clear(),this.reset(0),this},reset:function(t=0){return this.first=!0,this.current=null,this.time=t,this},restart:function(){return this.first=!0,this},isFinished:function(){return!0===this.first&&(this.current=this.commands.top,this.first=!1),null===this.current},update:function(t){for(;!this.isFinished();){let e=this.current.value.update(t,this);if(!0!==e)return e;this.current=this.current.next}return!0}});f.attachTo(Ct,8192);var Ft=Ct;
//!class Command
const Nt=t.extend({className:"Anim:Command",op:null,started:!1,field:null,value:null,duration:0,_duration:0,count:0,_count:0,startValue:0,_startValue:0,endValue:0,_endValue:0,easing:null,_cur:null,_last:null,block:null,blocks:null,table:null,snd:null,fn:null,init:function(t,e){return this.op=t,this.started=!1,this.block=null,this.blocks=null,this.table=null,this.snd=null,this.fn=null,!1!==e&&t.init(this,!1),this},__dtor:function(){null!==this.block&&this.block.clear().free(),null!==this.blocks&&this.blocks.clear().free()},clone:function(){let t=Nt.alloc(this.op,!1);if(t.field=this.field,t.value=this.value,t.duration=this.duration,t.count=this.count,t.startValue=this.startValue,t.endValue=this.endValue,t.easing=this.easing,t.table=this.table,t.snd=this.snd,t.fn=this.fn,null!==this.block&&(t.block=this.block.clone()),null!==this.blocks){t.blocks=x.Pool.alloc();for(let e=this.blocks.top;null!==e;e=e.next)t.blocks.push(e.value.clone())}return t},ready:function(){this.op.init(this,!0)},update:function(t,e){return this.op.update(t,e,this)}});f.attachTo(Nt);var Mt=Nt,Dt={init:function(t,e=!1){if(!e)return t.block=Ft.alloc(),void(t.blocks=x.Pool.alloc());let i;for(;null!=(i=t.block.commands.shift());){let e=Ft.alloc();e.add(i),t.blocks.push(e)}t.block.free(),t.block=null},update:function(t,e,i){if(!1===i.started){for(let t=i.blocks.top;null!==t;t=t.next)t.value.reset(e.time);i.started=!0}let n=e.time,s=0,r=0;for(let e=i.blocks.top;null!==e;e=e.next){let i=e.value.update(t);!0===i?s++:null===i&&r++,e.value.time>n&&(n=e.value.time)}return s+r==i.blocks.length&&(i.started=!1,e.time=n,!0)}},Lt={init:function(t,e=!1){e||(t.block=Ft.alloc())},update:function(t,e,i){!1===i.started&&(i.block.reset(e.time),i.started=!0);let n=i.block.update(t);return!0!==n?n:(i.started=!1,e.time=i.block.time,!0)}},Ot={init:function(t,e=!1){e||(t.block=Ft.alloc())},update:function(t,e,i){!1===i.started&&(i.block.reset(e.time),i._count=i.count,i.started=!0);let n=i.block.update(t);return!0!==n?n:i._count<=1?(i.started=!1,e.time=i.block.time,!0):(i.block.restart(),i._count--,!1)}},Bt={init:function(t,e=!1){},update:function(t,e,i){return t.setValue(i.field,t.getValue(i.field,i.value)),!0}},Ut={init:function(t,e=!1){},update:function(t,e,i){return e.restart(),!0}},Ht={init:function(t,e=!1){},update:function(t,e,i){return!1===i.started&&(i._duration="string"===s.typeOf(i.duration)?t.getValue(i.duration):i.duration,i.started=!0),!(t.time<e.time+i._duration)&&(i.started=!1,e.time+=i._duration,!0)}},Gt={init:function(t,e=!1){},update:function(t,e,i){!1===i.started&&(i._startValue=t.getValue(i.field,i.startValue),i._duration="string"===s.typeOf(i.duration)?t.getValue(i.duration):i.duration,i.started=!0),i._endValue=t.getValue(i.field,i.endValue,i._startValue);let n=1;return t.time<e.time+i._duration&&(n=(t.time-e.time)/i._duration),i.easing&&1!=n?t.setValue(i.field,i.easing(n)*(i._endValue-i._startValue)+i._startValue):t.setValue(i.field,n*(i._endValue-i._startValue)+i._startValue),1==n&&(i.started=!1,e.time+=i._duration,!0)}},Xt={init:function(t,e=!1){},update:function(t,e,n){!1===n.started&&(n._duration="string"===s.typeOf(n.duration)?t.getValue(n.duration):n.duration,n._last=null,n.started=!0);let r=1;if(t.time<e.time+n._duration&&(r=(t.time-e.time)/n._duration),n.easing&&1!=r?n._cur=int(n.easing(r)*n.count):n._cur=int(r*n.count),n._cur!=n._last){let e=t.getValue(n.field);for(;;){if(int(Math.random()*(n.endValue-n.startValue+1))+n.startValue!=e)break}t.setValue(n.field,i),n._last=n._cur}return 1==r&&(n.started=!1,e.time+=n._duration,!0)}},Wt={init:function(t,e=!1){if(!e)return;let i=[];for(let e=0;e<t.count;e++)i.push(e%(t.endValue-t.startValue+1)+t.startValue);for(let e=t.count>>2;e>0;e--){let e=int(Math.random()*t.count),n=int(Math.random()*t.count),s=i[n];i[n]=i[e],i[e]=s}t.table=i},update:function(t,e,i){!1===i.started&&(i._duration="string"===s.typeOf(i.duration)?t.getValue(i.duration):i.duration,i.started=!0);let n,r=1;return t.time<e.time+i._duration&&(r=(t.time-e.time)/i._duration),n=i.easing&&1!=r?i.easing(r)*(i.count-1):r*(i.count-1),t.setValue(i.field,i.table[int((n+i.count)%i.count)]),1==r&&(i.started=!1,e.time+=i._duration,!0)}};
//!class Anim
const Vt=t.extend({className:"Anim",initialData:null,data:null,blockStack:null,cmdStack:null,timeScale:1,block:null,time:0,paused:!1,finished:!1,running:!1,finishedCallback:null,finishedCallbackHandler:null,finishedCallbackContext:null,autoDispose:!1,__ctor:function(){return this.initialData={},this.data={},this.block=Ft.alloc(),this.blockStack=x.Pool.alloc(),this.cmdStack=x.Pool.alloc(),this.running=!1,this.autoDispose=!1,this.finishedCallback=null,this.finishedCallbackHandler=null,this.finishedCallbackContext=null,this.reset()},__dtor:function(){this.block.free(),this.blockStack.clear().free(),this.cmdStack.clear().free(),null!==this.finishedCallbackHandler&&(this.finishedCallbackHandler.free(),this.finishedCallbackHandler=null),null!==this.finishedCallbackContext&&(this.finishedCallbackContext.free(),this.finishedCallbackContext=null)},copyTo:function(t){return t.clear(),dispose(t.block),t.block=this.block.clone(),t.initialData=this.initialData,t.reset()},clone:function(t=!1){let e=new Vt;return e.autoDispose=t,this.copyTo(e),e},onFinished:function(t){return this.finishedCallback=t,this},then:function(t,e=null){return t?(this.finishedCallback!==this.thenCallback&&(this.finishedCallback=this.thenCallback,null===this.finishedCallbackHandler?(this.finishedCallbackHandler=x.Pool.alloc(),this.finishedCallbackContext=x.Pool.alloc()):(this.finishedCallbackHandler.reset(),this.finishedCallbackContext.reset())),this.finishedCallbackHandler.push(t),this.finishedCallbackContext.push(e),this):this},thenCallback:function(){if(!this.finishedCallbackHandler.length)return!1;let t=this.finishedCallbackContext.shift();this.finishedCallbackHandler.shift()(this,t)},clear:function(){return this.blockStack.clear(),this.cmdStack.clear(),this.block.clear(),this.paused=!1,this.finished=!1,this.time=0,this.timeScale=1,null!==this.finishedCallbackHandler&&(this.finishedCallbackHandler.free(),this.finishedCallbackHandler=null),null!==this.finishedCallbackContext&&(this.finishedCallbackContext.free(),this.finishedCallbackContext=null),this.finishedCallback=null,this},reset:function(){return this.blockStack.clear(),this.cmdStack.clear(),this.block.reset(),this.paused=!1,this.finished=!1,this.time=0,this.timeScale=1,Object.assign(this.data,this.initialData),this},initial:function(t=null){return null!==t&&(this.initialData=t),Object.assign(this.data,this.initialData),this},speed:function(t){return this.timeScale=t>0?t:1,this},output:function(t){return this.data=t,this},pause:function(){return this.paused||(this.paused=!0),this},resume:function(){return this.finished=!1,this.paused=!1,this.running||this.run(!1),this},run:function(t=!0){return this.running||(1==t&&this.reset(),At.update.add(this.update,this),this.running=!0),this},setValue:function(t,e){let i=this.data;if("string"!=typeof t)if("function"==typeof t)t(this,e);else{let n=0;for(;null!==i&&n<t.length-1;)i=i[t[n++]];i[t[n]]=e}else i[t]=e},getValue:function(t,e=null,i=null){let n=this.data;if("string"!=typeof t)if("function"==typeof t)n=t(this,null);else{let e=0;for(;null!==n&&e<t.length;)n=n[t[e++]]}else n=n[t];if(null===e&&(e=n),null===i&&(i=n),"string"==typeof e)switch(e[0]){case"+":e=i+Number(e.substr(1));break;case"-":e=i-Number(e.substr(1));break;default:e=Number(e)}else"function"==typeof e&&(e=e(n,i,this));return e},update:function(t,e=null){if(null===e&&(e=this),e.paused||e.block.isFinished())return e.running=!1,!1;if(e.time+=t*e.timeScale*Vt.timeScale,!0!==e.block.update(e))return!0;let i=e.finished,n=e.block.length,s=e.block;return e.finished=!0,i||null===e.finishedCallback||(!1===e.finishedCallback(e.data,e)&&(e.finishedCallback=null),e.block===s&&e.block.length==n)?(e.running=!1,e.autoDispose&&dispose(e),!1):(e.resume(),!0)},prepareFieldName:function(t){return"function"==typeof t?t:-1!=t.indexOf(".")?t.split("."):t},parallel:function(){let t=this.block.add(Mt.alloc(Dt));return this.blockStack.push(this.block),this.cmdStack.push(t),this.block=t.block,this},serial:function(){let t=this.block.add(Mt.alloc(Lt));return this.blockStack.push(this.block),this.cmdStack.push(t),this.block=t.block,this},repeat:function(t){let e=this.block.add(Mt.alloc(Ot));return e.count=t,this.blockStack.push(this.block),this.cmdStack.push(e),this.block=e.block,this},end:function(){return this.cmdStack.pop().ready(),this.block=this.blockStack.pop(),this},set:function(t,e){let i=this.block.add(Mt.alloc(Bt));return i.field=this.prepareFieldName(t),i.value=e,this},restart:function(){return this.block.add(Mt.alloc(Ut)),this},wait:function(t){return this.block.add(Mt.alloc(Ht)).duration=t,this},range:function(t,e,i,n,s=null){let r=this.block.add(Mt.alloc(Gt));return r.field=this.prepareFieldName(t),r.duration=e,r.startValue=i,r.endValue=n,r.easing=s,this},rangeTo:function(t,e,i,n=null){let s=this.block.add(Mt.alloc(Gt));return s.field=this.prepareFieldName(t),s.duration=e,s.startValue=null,s.endValue=i,s.easing=n,this},rand:function(t,e,i,n,s,r=null){let a=this.block.add(Mt.alloc(Xt));return a.field=this.prepareFieldName(t),a.duration=e,a.count=i,a.startValue=n,a.endValue=s,a.easing=r,this},randt:function(t,e,i,n,s,r){let a=this.block.add(Mt.alloc(Wt));return a.field=this.prepareFieldName(t),a.duration=e,a.count=i,a.startValue=n,a.endValue=s,a.easing=r,a.ready(),this},play:function(t){return this.block.add(Mt.alloc(PLAY)).snd=t,this},exec:function(t){return this.block.add(Mt.alloc(EXEC)).fn=t,this},_bounds_x1:function(t,e){if(null===e)return t.data.bounds.x1;t.data.translate(int(e)-t.data.bounds.x1,0)},_bounds_y1:function(t,e){if(null===e)return t.data.bounds.y1;t.data.translate(0,int(e)-t.data.bounds.y1)},setX:function(t){return this.set(this._bounds_x1,t)},setY:function(t){return this.set(this._bounds_y1,t)},position:function(t,e){return this.set(this._bounds_x1,t).set(this._bounds_y1,e)},translateX:function(t,e,i){return this.range(this._bounds_x1,t,null,(e<0?"-":"+")+Math.abs(e),i)},translateY:function(t,e,i){return this.range(this._bounds_y1,t,null,(e<0?"-":"+")+Math.abs(e),i)},translate:function(t,e,i,n,s=null){return this.parallel().range(this._bounds_x1,t,null,(e<0?"-":"+")+Math.abs(e),n).range(this._bounds_y1,t,null,(i<0?"-":"+")+Math.abs(i),s||n).end()},moveTo:function(t,e,i,n,s=null){return this.parallel().range(this._bounds_x1,t,null,e,n).range(this._bounds_y1,t,null,i,s||n).end()},moveX:function(t,e,i=null){return this.range(this._bounds_x1,t,null,e,i)},moveY:function(t,e,i=null){return this.range(this._bounds_y1,t,null,e,i)},scaleX:function(t,e,i){return this.range("sx",t,null,e,i)},scaleY:function(t,e,i){return this.range("sy",t,null,e,i)},scale:function(t,e,i,n,s=null){return this.parallel().range("sx",t,null,e,n).range("sy",t,null,i,s||n).end()},rotate:function(t,e,i){return this.range("angle",t,null,(e<0?"-":"+")+Math.abs(e),i)}});Vt.timeScale=1,Vt.speed=function(t){Vt.timeScale=t>0?t:1},f.createPool(Vt,8192);var zt=Vt;
//![import "../math/bounds2"]
//![import "../utils/handler"]
//!class GridElement
const Yt=t.extend({className:"GridElement",id:null,bounds:null,flags:0,data:null,ext:null,container:null,_grid_remove_node:null,remover:null,__ctor:function(t,e,i,n){this.bounds=Tt.Pool.alloc(),this.bounds.translate(t,e),this.bounds.resize(i,n,!0),this.flags=Yt.ALIVE|Yt.VISIBLE|Yt.DIRTY|Yt.DEPTH_FLAG,this.data=null,this.ext=null,this.remover=gt.Pool.alloc(this)},__dtor:function(){this.alive(!1),null!==this.data&&(dispose(this.data),this.data=null),this.remover.exec(),this.remover.free(),this.bounds.free()},setId:function(t){return this.id=t,this},setFlags:function(t){return this.flags|=t,this},clearFlags:function(t){return this.flags&=~t,this},getFlags:function(t,e=null){return null===e?(this.flags&t)===t:(this.flags&t)===e},setData:function(t){return this.data=t,this},getData:function(){return this.data},setExt:function(t){return this.ext=t,this},getExt:function(){return this.ext},visible:function(t=null){return null===t?!!(this.flags&Yt.VISIBLE):(this.flags&=~Yt.VISIBLE,t&&(this.flags|=Yt.VISIBLE),this)},alive:function(t=null){return null===t?!!(this.flags&Yt.ALIVE):(this.flags&=~Yt.ALIVE,t&&(this.flags|=Yt.ALIVE),this)},dirty:function(t=null){return null===t?!!(this.flags&Yt.DIRTY):(this.flags&=~Yt.DIRTY,t&&(this.flags|=Yt.DIRTY),this)},depthFlagEnabled:function(t=null){return null===t?!!(this.flags&Yt.DEPTH_FLAG_ENABLED):(this.flags&=~Yt.DEPTH_FLAG_ENABLED,t&&(this.flags|=Yt.DEPTH_FLAG_ENABLED),this)},depthFlag:function(t=null){return null===t?!!(this.flags&Yt.DEPTH_FLAG):(this.flags&=~Yt.DEPTH_FLAG,t&&(this.flags|=Yt.DEPTH_FLAG),this)},remove:function(){return this.remover.exec(),this},sync:function(){return null!==this.container&&this.getFlags(Yt.ALIVE|Yt.DIRTY)?(this.container.sync(this),this):this},resize:function(t,e){return this.flags|=Yt.DIRTY,this.bounds.resize(t,e,!0),this},resizeBy:function(t,e){return this.resize(this.bounds.width()+t,this.bounds.height()+e)},translate:function(t,e,i=!1){return this.flags|=Yt.DIRTY,this.bounds.translate(t,e,i),this},setPosition:function(t,e=null){return null===e&&(e=t.y,t=t.x),this.translate(upscale(t)-this.bounds.ux1,upscale(e)-this.bounds.uy1,!0)}});Yt.ALIVE=1,Yt.VISIBLE=2,Yt.DIRTY=4,Yt.DEPTH_FLAG_ENABLED=8,Yt.DEPTH_FLAG=16,Yt.USERDEF=256,Yt.LAST_FLAG=128,Yt.allocFlag=function(){let t=Yt.LAST_FLAG;if(1073741824===t)throw new Error("allocFlag: out of bit space to allocate another flag");return t<<=1,Yt.LAST_FLAG=t,t};var qt=Yt;
//![import "./grid-element"]
//![import "../utils/list"]
//!class Grid
var Qt=t.extend({className:"Grid",grid:null,count:0,offsx:0,offsy:0,kx:0,ky:0,stride:0,verifyIntersection:!0,__ctor:function(t,e,i,n=null){t=1<<Math.ceil(Math.log2(t)),e=1<<Math.ceil(Math.log2(e)),this.offsx=t>>1,this.offsy=e>>1,null===n&&(n=i),i=Math.floor(Math.log2(i)),n=Math.floor(Math.log2(n)),this.kx=i,this.ky=n;let s=t>>i,r=e>>n;s||(i=Math.log2(t),s=1),r||(n=Math.log2(e),r=1),this.grid=new Array(s*r).fill(null),this.stride=s},__dtor:function(){this.clear(),this.grid=null},clear:function(){for(let t=0;t<this.grid.length;t++){if(null===this.grid[t])continue;let e;for(;null!==(e=this.grid[t].shift());)e.remover.remove(this._remove,this),e.container=null,dispose(e);this.grid[t].free(),this.grid[t]=null}this.count=0},reset:function(){for(let t=0;t<this.grid.length;t++){if(null===this.grid[t])continue;let e;for(;null!==(e=this.grid[t].shift());)e.remover.remove(this._remove,this),e.container=null;this.grid[t].free(),this.grid[t]=null}this.count=0},add:function(t){if(!qt.isInstance(t))throw new Error("argument must be a GridElement");let e=int(t.bounds.y1+this.offsy>>this.ky)*this.stride+int(t.bounds.x1+this.offsx>>this.kx);return!(e<0||e>=this.grid.length)&&(null===this.grid[e]&&(this.grid[e]=x.Pool.alloc()),this.grid[e].push(t),this.count++,t.container=this,t._grid_remove_node=t.remover.add(this._remove,this,e,this.grid[e].bottom),!0)},_remove:function(t,e,i,n){return e.grid[i].remove(n),e.count--,t.container=null,!1},remove:function(t){return t.remover.execc(this._grid_remove_node),t},sync:function(t){t.clearFlags(qt.DIRTY);let e=t._grid_remove_node,i=int(t.bounds.y1+this.offsy>>this.ky)*this.stride+int(t.bounds.x1+this.offsx>>this.kx);return i<0||i>=this.grid.length?(t.remover.execc(e),!1):(e.arg1===i||(this.grid[e.arg1].remove(e.arg2),null===this.grid[i]&&(this.grid[i]=x.Pool.alloc()),this.grid[i].push(t),e.arg1=i,e.arg2=this.grid[i].bottom),!0)},forEachInRegion:function(t,e,i,n,s){let r=(t.y1+this.offsy-(1<<this.ky-1)>>this.ky)*this.stride,a=(t.y2+this.offsy+(1<<this.ky-1)>>this.ky)*this.stride,l=t.x1+this.offsx-(1<<this.kx-1)>>this.kx,o=t.x2+this.offsx+(1<<this.kx-1)>>this.kx,h=this.grid.length-1;r<0&&(r=0),a<0&&(a=0),l<0&&(l=0),o<0&&(o=0),r>h&&(r=h),a>h&&(a=h),l>h&&(l=h),o>h&&(o=h);for(let u=r;u<=a;u+=this.stride)for(let c=l;c<=o;c++){let d=u+c;if(!(d>h||null===this.grid[d]))for(let h=this.grid[d].top;h;h=h.next)if(h.value.getFlags(e,i)&&(!this.verifyIntersection||!(u<=r+1||c<=l+1||u>=a-1||c>=o-1)||h.value.bounds.intersects(t))&&!1===n(h.value,s))return}},selectInRegion:function(t,e,i){let n=(t.y1+this.offsy-(1<<this.ky-1)>>this.ky)*this.stride,s=(t.y2+this.offsy+(1<<this.ky-1)>>this.ky)*this.stride,r=t.x1+this.offsx-(1<<this.kx-1)>>this.kx,a=t.x2+this.offsx+(1<<this.kx-1)>>this.kx,l=this.grid.length-1;n<0&&(n=0),s<0&&(s=0),r<0&&(r=0),a<0&&(a=0),n>l&&(n=l),s>l&&(s=l),r>l&&(r=l),a>l&&(a=l);let o=x.Pool.alloc();for(let h=n;h<=s;h+=this.stride)for(let u=r;u<=a;u++){let c=h+u;if(!(c>l||null===this.grid[c]))for(let l=this.grid[c].top;l;l=l.next)l.value.getFlags(e,i)&&(this.verifyIntersection&&(h<=n+1||u<=r+1||h>=s-1||u>=a-1)&&!l.value.bounds.intersects(t)||o.push(l.value))}return o},countInRegion:function(t,e,i){let n=(t.y1+this.offsy-(1<<this.ky-1)>>this.ky)*this.stride,s=(t.y2+this.offsy+(1<<this.ky-1)>>this.ky)*this.stride,r=t.x1+this.offsx-(1<<this.kx-1)>>this.kx,a=t.x2+this.offsx+(1<<this.kx-1)>>this.kx,l=this.grid.length-1;n<0&&(n=0),s<0&&(s=0),r<0&&(r=0),a<0&&(a=0),n>l&&(n=l),s>l&&(s=l),r>l&&(r=l),a>l&&(a=l);let o=0;for(let h=n;h<=s;h+=this.stride)for(let u=r;u<=a;u++){let c=h+u;if(!(c>l||null===this.grid[c]))for(let l=this.grid[c].top;l;l=l.next)l.value.getFlags(e,i)&&(this.verifyIntersection&&(h<=n+1||u<=r+1||h>=s-1||u>=a-1)&&!l.value.bounds.intersects(t)||o++)}return o},selectFirst:function(t,e,i){let n=(t.y1+this.offsy-(1<<this.ky-1)>>this.ky)*this.stride,s=(t.y2+this.offsy+(1<<this.ky-1)>>this.ky)*this.stride,r=t.x1+this.offsx-(1<<this.kx-1)>>this.kx,a=t.x2+this.offsx+(1<<this.kx-1)>>this.kx,l=this.grid.length-1;n<0&&(n=0),s<0&&(s=0),r<0&&(r=0),a<0&&(a=0),n>l&&(n=l),s>l&&(s=l),r>l&&(r=l),a>l&&(a=l);for(let o=n;o<=s;o+=this.stride)for(let h=r;h<=a;h++){let u=o+h;if(!(u>l||null===this.grid[u]))for(let l=this.grid[u].top;l;l=l.next)if(l.value.getFlags(e,i)&&(!this.verifyIntersection||!(o<=n+1||h<=r+1||o>=s-1||h>=a-1)||l.value.bounds.intersects(t)))return l.value}return null}});
//!class Container
const Kt=t.extend({className:"Container",viewportBounds:null,width:0,height:0,zvalue:0,scene:null,flags:0,g:null,elementCount:0,drawCount:0,__ctor:function(t=32768,e=32768){this.width=t,this.height=e,this.flags=Kt.VISIBLE|Kt.DEPTH_FLAG},__dtor:function(){},visible:function(t=null){return null===t?!!(this.flags&Kt.VISIBLE):(this.flags&=~Kt.VISIBLE,t&&(this.flags|=Kt.VISIBLE),this)},depthFlag:function(t=null){return null===t?!!(this.flags&Kt.DEPTH_FLAG):(this.flags&=~Kt.DEPTH_FLAG,t&&(this.flags|=Kt.DEPTH_FLAG),this)},setViewportBounds:function(t){return this.viewportBounds=t,this},drawElement:function(t,e){return e.drawCount++,t.draw(e.g)},syncZ:function(t){t.__zvalue=this.zvalue+(t._zvalue+t.bounds.y2&262143)},sync:function(t){throw new Error("Container::sync not implemented")},clear:function(){throw new Error("Container::clear not implemented")},reset:function(){throw new Error("Container::reset not implemented")},add:function(t){throw new Error("Container::add not implemented")},remove:function(t){throw new Error("Container::remove not implemented")},draw:function(t){if(!this.visible())return;let e=t.pushDepthFlag(this.flags&Kt.DEPTH_FLAG);t.zvalue=this.zvalue,this.drawCount=-1,this.g=t,this.render(),e&&t.popDepthFlag()},render:function(){throw new Error("Container::render not implemented")}});Kt.VISIBLE=1,Kt.DEPTH_FLAG=2;var jt=Kt;
//![import "../math/point2"]
//![import "../math/bounds2"]
//![import "../math/rect"]
//![import "../system/canvas"]
//!class Viewport
const Zt=t.extend({className:"Viewport",width:0,initialWidth:0,height:0,initialHeight:0,sx:0,sy:0,x:0,y:0,centerRatioX:0,centerRatioY:0,offset:null,container:null,focusFactorX:0,focusFactorY:0,focusRect:null,focusOffsX:0,focusOffsY:0,focusAxisX:!0,focusAxisY:!0,flags:0,scale:1,globalScale:1,bounds:null,padding:null,focusBounds:null,screenBounds:null,tmpPoint:null,__ctor:function(t,e,i,n,s,r){this.focusFactorX=.4,this.focusFactorY=.4,this.focusRect=null,this.sx=t,this.sy=e,this.width=this.initialWidth=i,this.height=this.initialHeight=n,this.x=0,this.y=0,this.bounds=Tt.Pool.alloc(),this.padding=null,this.focusBounds=Tt.Pool.alloc(),this.screenBounds=Tt.Pool.alloc(),this.container=Tt.Pool.alloc(),this.offset=wt.Pool.alloc(),this.flags=Zt.ENABLED,this.tmpPoint=wt.Pool.alloc(),this.setContainerBounds(-s>>1,-r>>1,s>>1,r>>1),this.updateScreenBounds(),this.updateBounds()},__dtor:function(){this.bounds.free(),this.focusBounds.free(),this.screenBounds.free(),this.container.free(),this.tmpPoint.free(),null!==this.padding&&this.padding.free()},enabled:function(t=null){return null===t?!!(this.flags&Zt.ENABLED):(this.flags&=~Zt.ENABLED,t&&(this.flags|=Zt.ENABLED),this)},topLeft:function(t=null){return null===t?!!(this.flags&Zt.TOP_LEFT):(this.flags&=~Zt.TOP_LEFT,t&&(this.flags|=Zt.TOP_LEFT),this)},setContainerBounds:function(t,e=null,i=null,n=null){return null===e&&(n=t.y2,i=t.x2,e=t.y1,t=t.x1),this.width=this.initialWidth,this.height=this.initialHeight,this.width>i-t&&(this.width=i-t),this.height>n-e&&(this.height=n-e),this.container.set(t,e,i,n),this},setPadding:function(t,e=null,i=null,n=null){return null===this.padding&&(this.padding=Tt.Pool.alloc()),null===e&&(i=n=t,t=e=-t),this.padding.set(t,e,i,n),this},updateBounds:function(t=!1){let e,i,n,s,r,a,l,o;e=this.width>>1,i=this.height>>1,n=e/this.scale,s=i/this.scale,r=this.x-n+this.offset.x,a=this.y-s+this.offset.y,l=this.x+n+this.offset.x,o=this.y+s+this.offset.y,t&&(r<this.container.x1?this.offset.setX(this.container.x1-this.x+n):l>this.container.x2&&this.offset.setX(this.container.x2-this.x-n),a<this.container.y1?this.offset.setY(this.container.y1-this.y+s):o>this.container.y2&&this.offset.setY(this.container.y2-this.y-s),r=this.x-n+this.offset.x,a=this.y-s+this.offset.y,l=this.x+n+this.offset.x,o=this.y+s+this.offset.y),this.bounds.set(r,a,l,o),null!==this.padding&&this.bounds.add(this.padding),this.focusBounds.set(this.x-(this.focusFactorX*e+this.centerRatioX*e)/this.scale,this.y-(this.focusFactorY*i+this.centerRatioY*i)/this.scale,this.x+(this.focusFactorX*e+this.centerRatioX*e)/this.scale,this.y+(this.focusFactorY*i+this.centerRatioY*i)/this.scale)},updateScreenBounds:function(){this.screenBounds.set(this.sx,this.sy,this.sx+this.width,this.sy+this.height)},resize:function(t,e){return this.width=this.initialWidth=t,this.height=this.initialHeight=e,this.updateScreenBounds(),this.updateBounds(),this},resizeBy:function(t,e){return this.width+=t,this.height+=e,this.initialWidth=this.width,this.initialHeight=this.height,this.updateScreenBounds(),this.updateBounds(),this},setPosition:function(t,e){return this.x=t,this.y=e,this.offset.set(0,0),this.updateBounds(),this},setOffsets:function(t,e){return this.offset.set(t,e),this.updateBounds(),this},setScale:function(t){return this.scale=t,this.updateScreenBounds(),this.updateBounds(),this},getScale:function(){return this.scale},setGlobalScale:function(t){return this.globalScale=t,this},getGlobalScale:function(){return this.globalScale},setCenter:function(t,e){return this.centerRatioX=t,this.centerRatioY=e,this},translate:function(t,e,i=!1){return this.offset.add(t,e),this.updateBounds(i),this},setScreenPosition:function(t,e){return this.sx=t,this.sy=e,this.updateScreenBounds(),this},getX:function(t=!1){return this.x+(t?0:this.offset.x)},getY:function(t=!1){return this.y+(t?0:this.offset.y)},getOffsetX:function(){return this.offset.x},getOffsetY:function(){return this.offset.y},getWidth:function(){return this.width},getHeight:function(){return this.height},focusX:function(t,e=null,i=null){null===i&&(i=this.focusFactorX),null===e&&(e=t);let n=this.width>>1,s=this.x-int((i*n+this.centerRatioX*n)/this.scale),r=this.x+int((i*n+this.centerRatioX*n)/this.scale);s==r&&(t=e=t+e>>1);let a=this.x;return t<s?a+=t-s:e>r&&(a+=e-r),s=a-n,r=a+n,s<this.container.x1&&(a=this.container.x1+n),r>this.container.x2&&(a=this.container.x2-n),this.x=a,this},focusY:function(t,e=null,i=null){null===i&&(i=this.focusFactorY),null===e&&(e=t);let n=this.height>>1,s=this.y-int((i*n+this.centerRatioY*n)/this.scale),r=this.y+int((i*n+this.centerRatioY*n)/this.scale);s==r&&(t=e=t+e>>1);let a=this.y;return t<s?a+=t-s:e>r&&(a+=e-r),s=a-n,r=a+n,s<this.container.y1&&(a=this.container.y1+n),r>this.container.y2&&(a=this.container.y2-n),this.y=a,this},update:function(t=0){null!==this.focusRect&&(this.focusAxisX&&this.focusX(this.focusRect.x1+this.focusOffsX,this.focusRect.x2+this.focusOffsX),this.focusAxisY&&this.focusY(this.focusRect.y1+this.focusOffsY,this.focusRect.y2+this.focusOffsY),this.updateBounds())},updateForced:function(t=0){null!==this.focusRect&&(this.focusX(this.focusRect.x1+this.focusOffsX,this.focusRect.x2+this.focusOffsX),this.focusY(this.focusRect.y1+this.focusOffsY,this.focusRect.y2+this.focusOffsY),this.updateBounds())},setFocusRect:function(t,e=0,i=0){return this.focusRect=t,this.focusOffsX=e,this.focusOffsY=i,this.update(0),this},setFocusOffsets:function(t,e){return this.focusOffsX=t,this.focusOffsY=e,this},setFocusAxes:function(t,e){return this.focusAxisX=t,this.focusAxisY=e,this},setFocusFactor:function(t,e){return this.focusFactorX=t,this.focusFactorY=void 0===e?t:e,this},applyClip:function(t){t.clip(this.screenBounds.x1,this.screenBounds.y1,this.screenBounds.width(),this.screenBounds.height())},applyTransform:function(t){this.flags&Zt.TOP_LEFT?t.translate(this.screenBounds.x1,this.screenBounds.y1):t.translate(this.screenBounds.cx,this.screenBounds.cy),1!=this.scale&&t.scale(this.scale,this.scale),1!=this.globalScale&&t.scale(this.globalScale,this.globalScale),this.flags&Zt.TOP_LEFT?t.translate(-this.bounds.x1,-this.bounds.y1):t.translate(-this.bounds.cx,-this.bounds.cy),t.updateTransform()},toWorldSpace:function(t,e=null,i=!1){let n,s;return null!==e&&!0!==e||(i=!0===e,e=t.y,t=t.x),this.flags&Zt.TOP_LEFT?(n=this.screenBounds.x1,s=this.screenBounds.y1,i?(t=(t-int(n))/this.scale+int(this.bounds.x1),e=(e-int(s))/this.scale+int(this.bounds.y1)):(t=(t-n)/this.scale+this.bounds.x1,e=(e-s)/this.scale+this.bounds.y1)):(n=this.screenBounds.cx,s=this.screenBounds.cy,i?(t=(t-int(n))/this.scale+int(this.bounds.cx),e=(e-int(s))/this.scale+int(this.bounds.cy)):(t=(t-n)/this.scale+this.bounds.cx,e=(e-s)/this.scale+this.bounds.cy)),this.tmpPoint.set(t,e)},toScreenSpace:function(t,e=null,i=!1){let n,s;return null!==e&&!0!==e||(i=!0===e,e=t.y,t=t.x),this.flags&Zt.TOP_LEFT?(n=this.screenBounds.x1,s=this.screenBounds.y1,i?(t=(t-int(this.bounds.x1))*this.scale+int(n),e=(e-int(this.bounds.y1))*this.scale+int(s)):(t=(t-this.bounds.x1)*this.scale+n,e=(e-this.bounds.y1)*this.scale+s)):(n=this.screenBounds.cx,s=this.screenBounds.cy,i?(t=(t-int(this.bounds.cx))*this.scale+int(n),e=(e-int(this.bounds.cy))*this.scale+int(s)):(t=(t-this.bounds.cx)*this.scale+n,e=(e-this.bounds.cy)*this.scale+s)),this.tmpPoint.set(t,e)}});Zt.ENABLED=1,Zt.TOP_LEFT=2;var $t=Zt;
//![import "./grid-element"]
//![import "../system/globals"]
//![import "../utils/recycler"]
//![import "./idrawable"]
//!class Element extends GridElement
const Jt=qt.extend({className:"Element",group:null,img:null,debugBounds:!1,_zvalue:0,__zvalue:0,_alpha:1,_shaderProgram:null,_uniformSetter:null,__ctor:function(t,e,i=null,n=null,s=null){null===i&&(i=n=0),null===n&&(i=(s=i).width,n=s.height),this._super.GridElement.__ctor(t,e,i,n),this.img=null!==s?s.getDrawable():s,this.group=null,this.debugBounds=!1,this._zvalue=0,this.__zvalue=0,this._alpha=1,this._shaderProgram=null},__dtor:function(){null!==this.img&&(dispose(this.img),this.img=null),this._super.GridElement.__dtor()},destroyLater:function(){this.alive()&&(null!==this.container?this.container.scene.disposeLater(this):dispose(this))},alpha:function(t=null){return null===t?this._alpha:(this._alpha=t,this)},zvalue:function(t=null){return null===t?this._zvalue:(this._zvalue=t,this)},shaderProgram:function(t=!1){return!1===t?this._shaderProgram:(this._shaderProgram=t,this)},uniformSetter:function(t){return this._uniformSetter=t,this},draw:function(t){let e=null!==this._shaderProgram&&t.pushShaderProgram(this._shaderProgram),i=!!this.depthFlagEnabled()&&t.pushDepthFlag(this.depthFlag());if(null!==this._shaderProgram&&null!==this._uniformSetter&&null!==t.gl&&this._uniformSetter(this,t.gl,t.getShaderProgram()),t.zvalue=this.__zvalue,1!=this._alpha&&(t.pushAlpha(),t.alpha(this._alpha)),this.render(t),i&&t.popDepthFlag(),e&&t.popShaderProgram(),1!=this._alpha&&t.popAlpha(),B.debugBounds||this.debugBounds){let e=M.displayBuffer2;e.pushMatrix(),e.loadMatrix(t.getMatrix()),e.fillStyle(1===this.debugBounds?"rgba(255,255,0,0.5)":"rgba(0,255,255,0.5)"),e.fillRect(this.bounds.x1,this.bounds.y1,this.bounds.width(),this.bounds.height()),e.popMatrix()}},render:function(t){this.img.draw(t,this.bounds.x1,this.bounds.y1,this.bounds.width(),this.bounds.height())}});
//!/class
//!namespace Element
//!namespace Pool
f.createPool(Jt);var te=Jt;
//![import "./element"]
//![import "../utils/list"]
//![import "../math/point2"]
//![import "../utils/recycler"]
const ee=wt.Pool.alloc(),ie=te.extend({className:"Group",children:null,ref:null,__ctor:function(t=null){this._super.Element.__ctor(0,0,0,0),this.children=x.Pool.alloc(),this.bounds.reset(),this.ref=wt.Pool.alloc(),this.setId(t)},__dtor:function(){this.clear(),this.children.free(),this.ref.free(),this._super.Element.__dtor()},destroyLater:function(){if(!this.alive())return;let t;for(;null!=(t=this.children.shift());)t.remover.remove(this._remove,this),t.group=null,t.destroyLater();this._super.Element.destroyLater()},clear:function(){let t;for(;null!=(t=this.children.shift());)t.remover.remove(this._remove,this),t.group=null,dispose(t);return this},reset:function(){let t;for(;null!=(t=this.children.shift());)t.remover.remove(this._remove,this),t.group=null;return this},addChild:function(t){if(!t)return t;let e=null===this.bounds.x1;return(e||t.bounds.x1<this.bounds.x1)&&this.ltranslate(t.bounds.x1-this.bounds.x1,0),(e||t.bounds.y1<this.bounds.y1)&&this.ltranslate(0,t.bounds.y1-this.bounds.y1),(e||t.bounds.x2>this.bounds.x2)&&this.resizeBy(t.bounds.x2-this.bounds.x2,0),(e||t.bounds.y2>this.bounds.y2)&&this.resizeBy(0,t.bounds.y2-this.bounds.y2),this.children.push(t),null!==t.id&&(this[t.id]=t),t.group=this,t.remover.add(this._remove,this,this.children.bottom),t},getChild:function(t){return this[t]||null},_remove:function(t,e,i){return e.children.remove(i),t.group=null,null!==t.id&&(e[t.id]=null),!1},removeChild:function(t){return t&&t.group===this?(t.remover.execf(this._remove,this),t):t},sync:function(){for(let t=this.children.top;t;t=t.next)t.value.sync();return this._super.Element.sync()},ltranslate:function(t,e,i=!1){return this._super.Element.translate(t,e,i)},translate:function(t,e,i=!1){let n=this.bounds.x1,s=this.bounds.y1;this._super.Element.translate(t,e,i),this.ref.add(t,e,i),n=this.bounds.x1-n,s=this.bounds.y1-s;for(let t=this.children.top;t;t=t.next)t.value.translate(n,s);return this},getOffsets:function(t,e,i=!1){ee.set(this.bounds.ux1,this.bounds.uy1,!0);let n=ee.x,s=ee.y;return ee.add(t,e,i),n=ee.x-n,s=ee.y-s,ee.set(n,s),ee.x-=t,ee.y-=e,ee},setFlags:function(t){for(let e=this.children.top;e;e=e.next)e.value.setFlags(t);return this._super.Element.setFlags(t)},clearFlags:function(t){for(let e=this.children.top;e;e=e.next)e.value.clearFlags(t);return this._super.Element.clearFlags(t)},visible:function(t=null){if(null===t)return this._super.Element.visible();for(let e=this.children.top;e;e=e.next)e.value.visible(t);return this._super.Element.visible(t)},render:function(t){}});
//!class Group extends Element
//!/class
//!namespace Group
//!namespace Pool
f.createPool(ie);var ne=ie;
//![import "./container"]
//![import "./viewport"]
//![import "./group"]
//![import "../math/bounds2"]
//![import "../utils/list"]
//![import "../utils/handler"]
//![import "../system/globals"]
//!class Scene
const se=t.extend({className:"Scene",minWidth:null,minHeight:null,maxWidth:null,maxHeight:null,containers:null,viewports:null,viewportBounds:null,groupList:null,groups:null,disposalQueue:null,fupdater:null,updater:null,synchronizer:null,lupdater:null,destroyer:null,dt:0,flags:0,drawCount:0,scene:null,zvalue:null,__ctor:function(t){this.containers=[],this.zvalue=(3&t)<<22,this.viewports=[],this.viewportBounds=Tt.Pool.alloc(),this.groupList=x.Pool.alloc(),this.groups={},this.disposalQueue=x.Pool.alloc(),this.fupdater=gt.Pool.alloc(this),this.updater=gt.Pool.alloc(this),this.synchronizer=gt.Pool.alloc(this),this.lupdater=gt.Pool.alloc(this),this.destroyer=gt.Pool.alloc(this),this.flags=se.VISIBLE,this.scene=this},__dtor:function(){let t;for(this.disposeQueued(),this.disposalQueue.free(),this.destroyer.exec(),this.destroyer.free(),this.fupdater.free(),this.updater.free(),this.synchronizer.free(),this.lupdater.free();null!==(t=this.groupList.shift());)t.remover.remove(this._remove,this),t.container=null,dispose(t);for(t=0;t<this.containers.length;t++)this.containers[t]&&(this.containers[t].scene=null,dispose(this.containers[t]),this.containers[t]=null);for(t=0;t<this.viewports.length;t++)this.viewports[t]&&(dispose(this.viewports[t]),this.viewports[t]=null);this.viewportBounds.free(),this.groupList.free()},clear:function(){let t;for(this.disposeQueued();null!==(t=this.groupList.shift());)t.remover.remove(this._remove,this),t.container=null,dispose(t);for(t=0;t<this.containers.length;t++)this.containers[t]&&this.containers[t].clear()},visible:function(t=null){return null===t?!!(this.flags&se.VISIBLE):(this.flags&=~se.VISIBLE,t&&(this.flags|=se.VISIBLE),this)},setContainer:function(t,e){if(t<0)return this;if(t&=15,null===e)return this.containers[t].scene=null,this.containers[t]=null,this;if(!jt.isInstance(e))throw new Error("Scene: Unable to set container at index "+t+": argument is not a Container");return(null===this.minWidth||e.width<this.minWidth)&&(this.minWidth=e.width),(null===this.minHeight||e.height<this.minHeight)&&(this.minHeight=e.height),(null===this.maxWidth||e.width>this.maxWidth)&&(this.maxWidth=e.width),(null===this.maxHeight||e.height>this.maxHeight)&&(this.maxHeight=e.height),e.scene=this,e.zvalue=this.zvalue+(t<<18),this.containers[t]=e,this},getContainer:function(t){return t<0||t>=this.containers.length?null:this.containers[t]},setViewport:function(t,e){if(t<0)return this;if(null!==e&&!$t.isInstance(e))throw new Error("Scene: Unable to set viewport at index "+t+": argument is not a Viewport.");return this.viewports[t]=e,this},getViewport:function(t){return t<0||t>=this.viewports.length?null:this.viewports[t]},disposeLater:function(t){t.alive()&&(this.disposalQueue.push(t),t.alive(!1))},disposeQueued:function(){let t;for(;null!==(t=this.disposalQueue.shift());)dispose(t)},addGroup:function(t){if(!ne.isInstance(t))throw new Error("argument must be a Group");return this.groupList.push(t),null!==t.id&&(this.groups[t.id]=t),t.container=this,t.remover.add(this._removeGroup,this,this.groupList.bottom),!0},_removeGroup:function(t,e,i){return t.container=null,e.groupList.remove(i),null!==t.id&&(e.groups[t.id]=null),!1},removeGroup:function(t){return t.remover.execf(this._remove,this),t},sync:function(t){return!0},draw:function(t){if(this.visible())if(this.drawCount=0,this.viewports.length)for(let e=0;e<this.viewports.length;e++){let i=this.viewports[e];i&&i.enabled()&&(B.viewport=i,t.pushClip(),t.pushMatrix(),i.applyClip(t),i.applyTransform(t),this.viewportBounds.set(i.bounds),this.drawContainers(t,this.viewportBounds),t.popMatrix(),t.popClip())}else this.drawContainers(t,null)},drawContainers:function(t,e){try{for(let i=0;i<this.containers.length;i++)this.containers[i]&&(this.containers[i].setViewportBounds(e),this.containers[i].draw(t),this.drawCount+=this.containers[i].drawCount)}catch(t){if("FRAME_END"!==t.message)throw t}},updateViewports:function(){for(let t=0;t<this.viewports.length;t++)this.viewports[t]&&this.viewports[t].update(this.dt)},update:function(t){this.dt=t,this.fupdater.exec(),this.updater.exec(),this.disposeQueued(),this.synchronizer.exec(),this.updateViewports(),this.lupdater.exec()}});se.VISIBLE=1;var re=se;
//![import "../utils/list"]
//![import "./element"]
//!class Updater
var ae=t.extend({className:"Updater",scene:null,list:null,__update:null,__context:null,__preupdate:null,__postupdate:null,__ctor:function(t,e=null,i=null){this.list=x.Pool.alloc(),this.scene=t,this.__update=e,this.__context=i,this.__preupdate=null,this.__postupdate=null,this.scene.updater.add(this._update,this),this.scene.synchronizer.add(this._sync,this),this.scene.destroyer.add(this._destroy,this)},__dtor:function(){let t;for(this.scene.updater.remove(this._update,this),this.scene.synchronizer.remove(this._sync,this),this.scene.destroyer.remove(this._destroy,this);null!==(t=this.list.shift());)t.remover.remove(this._remove,this);this.list.free()},_destroy:function(t,e){dispose(e)},reset:function(){for(;null!==(i=this.list.shift());)i.remover.remove(this._remove,this);return this},clear:function(){for(;null!==(i=this.list.shift());)i.remover.remove(this._remove,this),dispose(i);return this},preUpdate:function(t){return this.__preupdate=t,this},postUpdate:function(t){return this.__postupdate=t,this},add:function(t){if(!te.isInstance(t))throw new Error("argument must be an Element");return this.list.push(t),t.remover.add(this._remove,this,this.list.bottom),!0},_remove:function(t,e,i){return e.list.remove(i),!1},remove:function(t){return t.remover.execf(this._remove,this),t},_sync:function(t,e){for(let t=e.list.top;t;t=t.next)t.value.sync()},_update:function(t,e){e.update(t.dt)},update:function(t){if(null!==this.__preupdate&&this.__preupdate(this.list,t,this.__context),null!==this.__update){let e=null;for(let i=this.list.top;i;i=e)e=i.next,!1===this.__update(i.value,t,this.__context)&&this.remove(i.value)}null!==this.__postupdate&&this.__postupdate(this.list,t,this.__context)}}),//![import "./container"]
//![import "./grid-element"]
//![import "./element"]
//![import "../utils/list"]
//!class SimpleContainer extends Container
le=jt.extend({className:"SimpleContainer",list:null,__ctor:function(t,e){this._super.Container.__ctor(t,e),this.list=x.Pool.alloc()},__dtor:function(){this.clear(),this.list.free(),this._super.Container.__dtor()},sync:function(t){return this.syncZ(t),!0},clear:function(){let t;for(;null!==(t=this.list.shift());)t.remover.remove(this._remove,this),t.container=null,dispose(t);this.elementCount=0},reset:function(){let t;for(;null!==(t=this.list.shift());)t.remover.remove(this._remove,this),t.container=null;this.elementCount=0},add:function(t){if(!te.isInstance(t))throw new Error("argument must be an Element");return this.list.push(t),this.elementCount++,t.container=this,t.remover.add(this._remove,this,this.list.bottom),this.syncZ(t),!0},_remove:function(t,e,i){return e.list.remove(i),e.elementCount--,t.container=null,!1},remove:function(t){return t.remover.execf(this._remove,this),t},render:function(){let t=qt.ALIVE|qt.VISIBLE;for(let e=this.list.top;e&&(!e.value.getFlags(t)||!1!==this.drawElement(e.value,this));e=e.next);}}),//![import "./container"]
//![import "./grid"]
//![import "./grid-element"]
//![import "./element"]
//![import "../system/globals"]
//![import "../system/system"]
//!class GridContainer extends Container
oe=jt.extend({className:"GridContainer",grid:null,debugBounds:!1,__ctor:function(t=32768,e=32768,i=64,n=null){this._super.Container.__ctor(t,e),this.grid=new Qt(t,e,i,n)},__dtor:function(){this.clear(),this._super.Container.__dtor()},sync:function(t){return this.syncZ(t),this.grid.sync(t)},clear:function(){this.grid.clear()},reset:function(){this.grid.reset()},add:function(t){if(!te.isInstance(t))throw new Error("argument must be an Element");return!!this.grid.add(t)&&(t.container=this,this.elementCount=this.grid.count,this.syncZ(t),!0)},remove:function(t){return this.grid.remove(t),this.elementCount=this.grid.count,t},render:function(){if(this.grid.forEachInRegion(this.viewportBounds,qt.ALIVE|qt.VISIBLE,qt.ALIVE|qt.VISIBLE,this.drawElement,this),!this.debugBounds||null===this.viewportBounds)return;let t=M.displayBuffer2;t.pushMatrix(),t.loadMatrix(this.g.getMatrix());let e=(this.viewportBounds.y1+this.grid.offsy-(1<<this.grid.ky-1)>>this.grid.ky)*this.grid.stride,i=(this.viewportBounds.y2+this.grid.offsy+(1<<this.grid.ky-1)>>this.grid.ky)*this.grid.stride,n=this.viewportBounds.x1+this.grid.offsx-(1<<this.grid.kx-1)>>this.grid.kx,s=this.viewportBounds.x2+this.grid.offsx+(1<<this.grid.kx-1)>>this.grid.kx;e=(int(e/this.grid.stride)<<this.grid.ky)-this.grid.offsy,i=(int(i/this.grid.stride)<<this.grid.ky)-this.grid.offsy+(1<<this.grid.ky),n=(n<<this.grid.kx)-this.grid.offsx,s=(s<<this.grid.kx)-this.grid.offsx+(1<<this.grid.kx),t.fillStyle("rgba(255,0,0,0.2)"),t.fillRect(n,e,s-n+1,i-e+1),e=this.viewportBounds.y1,i=this.viewportBounds.y2,n=this.viewportBounds.x1,s=this.viewportBounds.x2,t.lineWidth(1/M.canvasScaleFactor),t.strokeStyle("#fff"),t.strokeRect(n,e,s-n+1,i-e+1),t.lineWidth(1/M.canvasScaleFactor),t.strokeStyle("#008");for(let e=B.viewport.container.y1+this.grid.offsy;e<B.viewport.container.y2+this.grid.offsy;e+=1<<this.grid.ky)for(let i=B.viewport.container.x1+this.grid.offsx;i<B.viewport.container.x2+this.grid.offsx;i+=1<<this.grid.kx)t.strokeRect(i-this.grid.offsx,e-this.grid.offsy,1<<this.grid.kx,1<<this.grid.ky);t.popMatrix()},forEachInRegion:function(t,e,i,n,s){this.grid.forEachInRegion(t,e,i,n,s)},selectInRegion:function(t,e,i){return this.grid.selectInRegion(t,e,i)},countInRegion:function(t,e,i){return this.grid.countInRegion(t,e,i)},selectFirst:function(t,e,i){return this.grid.selectFirst(t,e,i)}});
//![import "./element"]
//![import "../system/system"]
//![import "../utils/recycler"]
//!class Mask extends Element
const he=te.extend({className:"Mask",type:0,__ctor:function(t,e,i,n,s){this._super.Element.__ctor(e,i,n,s),this.type=t},draw:function(t){let e=M.displayBuffer2;e.pushMatrix(),e.loadMatrix(t.getMatrix()),e.fillStyle("rgba(255,0,255,0.3)"),e.fillRect(this.bounds.x1,this.bounds.y1,this.bounds.width(),this.bounds.height()),e.popMatrix()}});
//!/class
//!namespace Mask
//!namespace Pool
f.createPool(he);var ue=he;
//![import "./element"]
//![import "../utils/recycler"]
//!class Label extends Element
const ce=te.extend({className:"Label",text:null,font:null,_dirty:!1,textWidth:null,textHeight:null,_align:-1,_valign:-1,textOffsetX:null,textOffsetY:null,__ctor:function(t,e,i,n){this._super.Element.__ctor(t,e,4,4),this.text=n,this.font=i,this._align=-1,this._valign=-1,this._dirty=!0},align:function(t){return this._align===t||(this._align=t,this.textOffsetX=null),this},valign:function(t){return this._valign===t||(this._valign=t,this.textOffsetY=null),this},setText:function(t){return this.text===t||(this.text=t,this._dirty=!0),this},setFont:function(t){return this.font===t||(this.font=t,this._dirty=!0),this},update:function(){this._dirty&&(this.textWidth=this.font.measureWidth(this.text),this.textHeight=this.font.measureHeight(this.text),this.textOffsetX=null,this.textOffsetY=null,this._dirty=!1),null===this.textOffsetX&&(this._align<0?this.textOffsetX=0:0===this._align?this.textOffsetX=-this.textWidth>>1:this.textOffsetX=-this.textWidth),null===this.textOffsetY&&(this._valign<0?this.textOffsetY=0:0===this._valign?this.textOffsetY=-this.textHeight>>1:this.textOffsetY=-this.textHeight)},render:function(t){this.update(),this.font.drawText(t,this.bounds.x1+this.textOffsetX,this.bounds.y1+this.textOffsetY,this.text)}});
//!/class
//!namespace Label
//!namespace Pool
f.createPool(ce);var de=ce,//![import "../utils/priority-queue"]
//![import "./boot"]
//![import "../system/system"]
//!namespace KeyboardHandler
//!interface EventHandler
//!/interface
//!/namespace
//!class KeyboardHandler
fe=Pt.Module.create({handlers:null,__ctor:function(){const t=this;this._super.Module.__ctor(),this.handlers=new dt,this._callOnKeyboardEvent=function(e){return t.callOnKeyboardEvent(e)}},register:function(t){try{this.handlers.add(t),"init"in t&&t.init()}catch(t){throw new Error("KeyboardHandler (register): "+t.message)}return t},unregister:function(t){try{this.handlers.remove(t),this.handlers.cleanup()}catch(t){throw new Error("KeyboardHandler (unregister): "+t.message)}},callOnKeyboardEvent:function(t){return t.onKeyboardEvent(this._action,this._keyCode,this._keyState)},onStartup:function(){M.onKeyboardEvent=(t,e,i)=>{this._action=t,this._keyCode=e,this._keyState=i,this.handlers.forEach(this._callOnKeyboardEvent)}},onShutdown:function(){M.onKeyboardEvent=null}}),//![import "../utils/priority-queue"]
//![import "./boot"]
//![import "../system/system"]
//!namespace PointerHandler
//!interface EventHandler
//!/interface
//!/namespace
//!class PointerHandler
pe=Pt.Module.create({handlers:null,__ctor:function(){const t=this;this._super.Module.__ctor(),this.handlers=new dt,this._callOnPointerEvent=function(e){return t.callOnPointerEvent(e)}},register:function(t){try{this.handlers.add(t),"init"in t&&t.init()}catch(t){throw new Error("PointerHandler (register): "+t.message)}return t},unregister:function(t){try{this.handlers.remove(t),this.handlers.cleanup()}catch(t){throw new Error("PointerHandler (unregister): "+t.message)}},callOnPointerEvent:function(t){return t.onPointerEvent(this._action,this._p,this._pointers)},onStartup:function(){M.onPointerEvent=(t,e,i)=>{this._action=t,this._p=e,this._pointers=i,this.handlers.forEach(this._callOnPointerEvent)}},onShutdown:function(){M.onPointerEvent=null}});
//![import "./keyboard-handler"]
//![import "./pointer-handler"]
//![import "../system/system"]
const me={priority:5,list:[],dummy:{},hoverEnabled:!1,zindexEnabled:!1,lastFrame:0,add:function(t){this.zindexEnabled&&!("zindex"in t)&&(t.zindex=0),-1===this.list.indexOf(t)&&this.list.push(t)},remove:function(t){var e=this.list.indexOf(t);-1!==e&&this.list.splice(e,1)},setHoverEnabled:function(t){this.hoverEnabled=t},setZIndexEnabled:function(t){this.zindexEnabled=t},findTarget:function(t,e,i){if(this.zindexEnabled&&this.lastFrame!=M.frameNumber){let t=this.list[0].zindex;for(let e of this.list){if(e.zindex>t){this.list=this.list.sort(((t,e)=>e.zindex-t.zindex));break}t=e.zindex}this.lastFrame=M.frameNumber}for(let n=0;n<this.list.length;n++)if(this.list[n]&&(null==i||!1!==i(this.list[n]))&&this.list[n].containsPoint(t,e))return this.list[n];return null},filterHover:function(t){return"hover"in t},onPointerEvent:function(t,e,i){let n=!0,s=null;switch(t){case M.PointerEventType.POINTER_DOWN:null!=e._ref&&(s=e._ref,e._ref=null,s.pointerDeactivate(e)),s=this.findTarget(e.x,e.y),null!=s&&((e._ref=s).pointerActivate(e),n=!1);break;case M.PointerEventType.POINTER_DRAG_START:null!=e._ref&&(n=!1);break;case M.PointerEventType.POINTER_DRAG_MOVE:this.hoverEnabled&&(null!=e._refh?e._refh.containsPoint(e.x,e.y)||(s=e._refh,e._refh=null,s.hover(!1,e),s=this.findTarget(e.x,e.y,this.filterHover),null!=s&&(e._refh=s).hover(!0,e)):(s=this.findTarget(e.x,e.y,this.filterHover),null!=s&&(e._refh=s).hover(!0,e))),null!=e._ref?e._ref.containsPoint(e.x,e.y)||1==e._ref.focusLock?(e._ref.pointerUpdate(e.x,e.y,e),n=!1):(s=e._ref,e._ref=null,s.pointerDeactivate(e),s=this.findTarget(e.x,e.y),null!=s&&((e._ref=s).pointerActivate(e),n=!1)):(s=this.findTarget(e.x,e.y),null!=s&&((e._ref=s).pointerActivate(e),n=!1));break;case M.PointerEventType.POINTER_MOVE:if(this.hoverEnabled&&(null!=e._refh?e._refh.containsPoint(e.x,e.y)||(s=e._refh,e._refh=null,s.hover(!1,e),s=this.findTarget(e.x,e.y,this.filterHover),null!=s&&(e._refh=s).hover(!0,e)):(s=this.findTarget(e.x,e.y,this.filterHover),null!=s&&(e._refh=s).hover(!0,e))),null==e._ref)break;e._ref.containsPoint(e.x,e.y)||1==e._ref.focusLock?(e._ref.pointerUpdate(e.x,e.y,e),n=!1):(s=e._ref,e._ref=null,s.pointerDeactivate(e));break;case M.PointerEventType.POINTER_DRAG_STOP:null!=e._ref&&(n=!1);break;case M.PointerEventType.POINTER_UP:null!=e._ref&&(s=e._ref,e._ref=null,s.pointerDeactivate(e),n=!1)}return n},onKeyboardEvent:function(t,e,i){switch(t){case M.KeyboardEventType.KEY_DOWN:for(let t=0;t<this.list.length&&(!this.list[t]||!this.list[t].keyboardEvents||!1!==this.list[t].keyDown(e,i));t++);break;case M.KeyboardEventType.KEY_UP:for(let t=0;t<this.list.length&&(!this.list[t]||!this.list[t].keyboardEvents||!1!==this.list[t].keyUp(e,i));t++);}}};pe.register(me),fe.register(me);var ge=me,//![import "./group.js"]
//![import "./mask.js"]
//![import "./screen-controls.js"]
//!class Button extends Group
xe=ne.extend({focusLock:!1,keyboardEvents:!0,isPressed:!1,wasPressed:!1,unpressedImg:null,pressedImg:null,keyCode:null,hitbox:0,_onButtonDown:null,_onButtonUp:null,_onTap:null,_onChange:null,__ctor:function(t,e,i,n=null,s=null){this._super.Group.__ctor(),this.unpressedImg=n,this.pressedImg=s||n,this.hitbox=new ue(0,e,i,n?n.width:16,n?n.height:16).visible(!1),this.addChild(this.hitbox),t.add(this.hitbox),t.add(this),this._onButtonDown=null,this._onButtonUp=null,this._onTap=null,this._onChange=this._default_onChange,ge.add(this)},__dtor:function(){this._super.Group.__dtor(),ge.remove(this)},setImage:function(t,e=null){return this.unpressedImg=t,this.pressedImg=e||t,this},setKeyCode:function(t){return this.keyCode=t,this},reset:function(){this._onChange(this.isPressed=!1,this.wasPressed=!1,this)},render:function(t){this.isPressed&&this.pressedImg?this.pressedImg.draw(t,this.bounds.x1,this.bounds.y1):!this.isPressed&&this.unpressedImg&&this.unpressedImg.draw(t,this.bounds.x1,this.bounds.y1)},pointerUpdate:function(t,e,i){},setStatus:function(t){return this.isPressed&&t||!this.isPressed&&!t||(this.updateStatus(t),this._onChange(this.isPressed,this.wasPressed,this)),this},updateStatus:function(t=null){return this.wasPressed=this.isPressed,this.isPressed=null===t?this.isPressed:t,this},pointerActivate:function(t){this.setStatus(!0)},pointerDeactivate:function(t){this.setStatus(!1)},containsPoint:function(t,e){return!!this.visible()&&this.hitbox.bounds.containsPoint(t,e)},_default_onChange:function(t,e,i){t!=e&&(t&&this._onButtonDown?this._onButtonDown():!t&&this._onButtonUp&&this._onButtonUp()),!t&&e&&this._onTap&&this._onTap()},keyDown:function(t,e){if(t===this.keyCode)return this.pointerActivate(),!1},keyUp:function(t,e){if(t===this.keyCode)return this.pointerDeactivate(),!1},onChange:function(t){return this._onChange=null===t?this._default_onChange:t,this},onButtonDown:function(t){return this._onButtonDown=t,this},onButtonUp:function(t){return this._onButtonUp=t,this},onTap:function(t){return this._onTap=t,this}}),//![import "./group"]
//![import "./mask"]
//![import "./screen-controls"]
//![import "../system/keycode"]
//!class Stick extends Group
ye=ne.extend({focusLock:!1,keyboardEvents:!0,isPressed:!1,wasPressed:!1,unpressedImg:null,pressedImg:null,unpressedImgInner:null,pressedImgInner:null,angleSteps:0,radiusSteps:0,rdirx:0,rdiry:0,dirx:0,diry:0,magnitude:0,angle:0,frdirx:0,frdiry:0,fdirx:0,fdiry:0,fmagnitude:0,fangle:0,dispx:0,dispy:0,radius:0,maxRadius:0,deadZoneX:0,deadZoneY:0,hitbox:0,__ctor:function(t,e,i,n,s,r,a=null,l=null){this._super.Group.__ctor(),this.unpressedImg=s,this.pressedImg=a||s,this.unpressedImgInner=r,this.pressedImgInner=l||r,this.maxRadius=n,this.deadZoneX=0,this.deadZoneY=0,this.hitbox=new ue(0,e,i,s.width,s.height).visible(!1),this.addChild(this.hitbox),t.add(this.hitbox),t.add(this),ge.add(this)},__dtor:function(){this._super.Group.__dtor(),ge.remove(this)},visible:function(t=null){return this._super.Element.visible(t)},setImage:function(t,e=null){return this.unpressedImg=t,this.pressedImg=e||t,this},setImageInner:function(t,e=null){return this.unpressedImgInner=t,this.pressedImgInner=e||t,this},setAngleSteps:function(t){return this.angleSteps=t,this},setRadiusSteps:function(t){return this.radiusSteps=t,this},setDeadZone:function(t,e){return this.deadZoneX=t,this.deadZoneY=e,this},reset:function(){this.dispx=0,this.dispy=0,this.rdirx=0,this.rdiry=0,this.dirx=0,this.diry=0,this.magnitude=0,this.onChange(this.dirx,this.diry,this.magnitude,this.angle)},render:function(t){this.isPressed?(this.pressedImg.draw(t,this.bounds.x1,this.bounds.y1),this.pressedImgInner.draw(t,this.bounds.x1+this.dispx,this.bounds.y1+this.dispy)):(this.unpressedImg.draw(t,this.bounds.x1,this.bounds.y1),this.unpressedImgInner.draw(t,this.bounds.x1,this.bounds.y1))},pointerUpdate:function(t,e){let i=t-this.bounds.cx,n=e-this.bounds.cy;if(this.angle=Math.atan2(-n,i),this.radius=Math.sqrt(i*i+n*n),this.radius>this.maxRadius&&(this.radius=this.maxRadius),this.angleSteps){let t=2*Math.PI/this.angleSteps;this.angle=int((this.angle+Math.PI+t/2)/t)*t-Math.PI}if(this.radiusSteps){let t=this.maxRadius/this.radiusSteps;this.radius=int((this.radius+t/2)/t)*t}this.rdirx=Math.min(1,Math.max(i/this.maxRadius,-1)),this.rdiry=Math.min(1,Math.max(n/this.maxRadius,-1)),this.dispx=this.radius*Math.cos(this.angle),this.dispy=this.radius*-Math.sin(this.angle),this.radius>0?(this.dirx=this.dispx/this.radius,this.diry=this.dispy/this.radius,this.magnitude=this.radius/this.maxRadius):(this.dirx=0,this.diry=0,this.magnitude=0),Math.abs(this.rdirx)<this.deadZoneX&&(this.rdirx=0,this.dirx=0),Math.abs(this.rdiry)<this.deadZoneY&&(this.rdiry=0,this.diry=0),this.onChange(this.dirx,this.diry,this.magnitude,this.angle)},pointerActivate:function(t){this.wasPressed=this.isPressed,this.isPressed=1,this.pointerUpdate(t.x,t.y)},pointerDeactivate:function(t){this.wasPressed=this.isPressed,this.isPressed=0,this.reset()},containsPoint:function(t,e){return!!this.visible()&&this.hitbox.bounds.containsPoint(t,e)},setDirection:function(t,e,i=.1,n=.1){return Math.abs(t)<i&&(t=0),Math.abs(e)<n&&(e=0),this.wasPressed=this.isPressed,this.isPressed=0==t&&0==e?0:1,this.pointerUpdate(this.bounds.cx+t*this.maxRadius,this.bounds.cy+e*this.maxRadius),!1},freezeState:function(t=!1){return this.frdirx=t?0!=this.rdirx?this.rdirx:this.frdirx:this.rdirx,this.frdiry=t?0!=this.rdiry?this.rdiry:this.frdiry:this.rdiry,this.fdirx=t?0!=this.dirx?this.dirx:this.fdirx:this.dirx,this.fdiry=t?0!=this.diry?this.diry:this.fdiry:this.diry,this.fmagnitude=t?0!=this.magnitude?this.magnitude:this.fmagnitude:this.magnitude,this.fangle=t?0!=this.angle?this.angle:this.fangle:this.angle,this},keyDown:function(t,e){let i=0,n=0;if(!0===e[h.UP]&&(n=-this.maxRadius),!0===e[h.LEFT]&&(i=-this.maxRadius),!0===e[h.DOWN]&&(n=this.maxRadius),!0===e[h.RIGHT]&&(i=this.maxRadius),t===h.UP||t===h.LEFT||t===h.DOWN||t===h.RIGHT)return i=this.bounds.cx+i,n=this.bounds.cy+n,this.wasPressed=this.isPressed,this.isPressed=1,this.pointerUpdate(i,n),!1},keyUp:function(t,e){let i=0,n=0;if(!0===e[h.UP]&&(n=-this.maxRadius),!0===e[h.LEFT]&&(i=-this.maxRadius),!0===e[h.DOWN]&&(n=this.maxRadius),!0===e[h.RIGHT]&&(i=this.maxRadius),t===h.UP||t===h.LEFT||t===h.DOWN||t===h.RIGHT)return this.pointerUpdate(this.bounds.cx+i,this.bounds.cy+n),0===i&&0===n&&(this.wasPressed=this.isPressed,this.isPressed=0),!1},onChange:function(t,e,i,n){}}),_e={};a(_e,"sys",(function(){return Pe})),a(_e,"world",(function(){return Re})),a(_e,"r",(function(){return Ae})),a(_e,"res",(function(){return Ce})),a(_e,"input",(function(){return Fe})),a(_e,"collider",(function(){return Ne}));const ve={SCENE_MAIN:0,SCENE_HUD:1,LAYER_BG0:0,LAYER_BG1:1,LAYER_BG2:2,LAYER_BG3:3,LAYER_BG4:4,LAYER_MAIN:5,LAYER_FG0:6,LAYER_FG1:7,LAYER_FG2:8,LAYER_FG3:9,LAYER_FG4:10,LAYER_MASK:11,LAYER_HUD_BG0:0,LAYER_HUD_BG1:1,LAYER_HUD_MAIN:2,LAYER_HUD_FG0:3,LAYER_HUD_FG1:4,_scenes:[],activeScene:null,_viewports:[],activeViewport:null,activeContainer:null,activeGroup:null,lastGroup:null,lastElement:null,bounds:Tt.Pool.alloc(),init:function(t=32768,e=32768,i=null,n=null){null===i&&(i=Math.max(t,e)/512),i<16&&(i=16),null!==n&&n<16&&(n=16),this.bounds.zero().resize(t,e),this.createScene(ve.SCENE_MAIN),this.setContainer(ve.LAYER_BG0,new oe(t,e,i,n)),this.setContainer(ve.LAYER_BG1,new oe(t,e,i,n)),this.setContainer(ve.LAYER_BG2,new oe(t,e,i,n)),this.setContainer(ve.LAYER_BG3,new oe(t,e,i,n)),this.setContainer(ve.LAYER_BG4,new oe(t,e,i,n)),this.setContainer(ve.LAYER_MAIN,new oe(t,e,i,n)),this.setContainer(ve.LAYER_FG0,new oe(t,e,i,n)),this.setContainer(ve.LAYER_FG1,new oe(t,e,i,n)),this.setContainer(ve.LAYER_FG2,new oe(t,e,i,n)),this.setContainer(ve.LAYER_FG3,new oe(t,e,i,n)),this.setContainer(ve.LAYER_FG4,new oe(t,e,i,n)),this.setContainer(ve.LAYER_MASK,new oe(t,e,i,n)),this.getContainer(ve.LAYER_MASK).visible(!1),this.createViewport(0),this.createScene(ve.SCENE_HUD),this.setContainer(ve.LAYER_HUD_BG0,new le(At.screenWidth,At.screenHeight)),this.setContainer(ve.LAYER_HUD_BG1,new le(At.screenWidth,At.screenHeight)),this.setContainer(ve.LAYER_HUD_MAIN,new le(At.screenWidth,At.screenHeight)),this.setContainer(ve.LAYER_HUD_FG0,new le(At.screenWidth,At.screenHeight)),this.setContainer(ve.LAYER_HUD_FG1,new le(At.screenWidth,At.screenHeight))},createScene:function(t){this._scenes[t]&&(M.queueRemove(this._scenes[t]),r.dispose(this._scenes[t])),this._scenes[t]=new re(t),M.queueAdd(this._scenes[t]),this.selectScene(t)},getScene:function(t=null){return null===t?this.activeScene:t<0||t>=this._scenes.length?null:this._scenes[t]},selectScene:function(t){return!(t<0||t>=this._scenes.length||!this._scenes[t])&&(this.activeScene=this._scenes[t],this.activeContainer=null,!0)},createViewport:function(t){if(null===this.activeScene)throw new Error("createViewport: use `selectScene` first to select the active scene.");this._viewports[t]&&(r.dispose(this._viewports[t]),this.activeScene.setViewport(t,null)),this._viewports[t]=new $t(0,0,At.screenWidth,At.screenHeight,this.activeScene.maxWidth,this.activeScene.maxHeight),this.activeScene.setViewport(t,this._viewports[t]),this.selectViewport(t)},getViewport:function(t=null){return null===t?this.activeViewport:t<0||t>=this._viewports.length?null:this._viewports[t]},selectViewport:function(t){return!(t<0||t>=this._viewports.length||!this._viewports[t])&&(this.activeViewport=this._viewports[t],!0)},setContainer:function(t,e){if(null===this.activeScene)throw new Error("setContainer: use `selectScene` first to select the active scene.");return this.activeScene.setContainer(t,e),e},getContainer:function(t=null,e=!1){if(null===t){if(null===this.activeContainer&&e)throw new Error("getContainer: container index not specified and default container not set.");return this.activeContainer}if(null===this.activeScene)throw new Error("getContainer: use `selectScene` first to select the active scene.");let i=this.activeScene.getContainer(t);if(null===i&&e)throw new Error("getContainer: container index out of bounds.");return i},selectContainer:function(t){return this.activeContainer=this.getContainer(t,!0),null!==this.activeContainer},createGroup:function(t=null){if(null===this.activeScene)throw new Error("createGroup: use selectScene first to select the active scene.");return this.activeGroup=ne.Pool.alloc(t),this.activeScene.addGroup(this.activeGroup),this.activeGroup},endGroup:function(t=null,e=null){return null!==t&&this.activeGroup.translate(t,e),this.lastGroup=this.activeGroup,this.activeGroup=null,this.lastGroup.sync()},createElement:function(t,e,i,n=null,s=null){"string"!=typeof t&&(s=n,n=i,i=e,e=t,t=null);let r=this.getContainer(s),a=te.Pool.alloc(e,i,n);return r.add(a.setId(t)),null!==this.activeGroup&&this.activeGroup.addChild(a),this.lastElement=a,a},createMask:function(t,e=null,i=null,n=null,s=null,r=null,a=null){"string"!=typeof t&&(a=r,r=s,s=n,n=i,i=e,e=t,t=null);let l=this.getContainer(a||ve.LAYER_MASK);if(null===i){if(null===this.activeGroup)throw new Error("createMask: create a group first to use automatic masks");i=this.activeGroup.bounds.x1,n=this.activeGroup.bounds.y1,s=this.activeGroup.bounds.width(),r=this.activeGroup.bounds.height()}let o=ue.Pool.alloc(e,i,n,s,r);return l.add(o.setId(t)),null!==this.activeGroup&&this.activeGroup.addChild(o),o},createLabel:function(t,e,i,n,s,r=null){"string"!=typeof t&&(r=s,s=n,n=i,i=e,e=t,t=null);let a=this.getContainer(r),l=de.Pool.alloc(e,i,n,s);return a.add(l.setId(t)),null!==this.activeGroup&&this.activeGroup.addChild(l),this.lastElement=l,l},createUpdater:function(t=null,e=null){if(null===this.activeScene)throw new Error("createUpdater: use selectScene first to select the active scene.");return new ae(this.activeScene,t,e)}};var be=ve;var we={};
//!class res
var Ee={load:function(t=null){return new Promise((function(e,i){Q.load(we,(function(e,i,n,s){t&&t(n,s)}),(function(){e()}))}))},get:function(t){return we[t]},__resIdMustNotExist:function(t){if(t in we)throw new Error("Resource identifier `"+t+"` is already in use")},placeholder:function(t,e,i,n){return this.__resIdMustNotExist(t),we[t]={type:"object",wrapper:"Placeholder",color:e,width:i,height:n}},image:function(t,e,i=null){return this.__resIdMustNotExist(t),we[t]={type:"image",wrapper:"Drawable",src:e,pixelated:null,...i}},images:function(t,e,i,n=null,s=null,r=null,a=null){return this.__resIdMustNotExist(t),we[t]={type:"images",wrapper:"Spritesheet",src:e,pixelated:null,count:i,width:n,height:s,config:{frameWidth:n,frameHeight:s,...r},...a}},spritesheet:function(t,e,i,n,s=0,r=null,a=null){return this.__resIdMustNotExist(t),we[t]={type:"image",wrapper:"Spritesheet",src:e,pixelated:null,config:{frameWidth:i,frameHeight:n,numFrames:s,...r},...a}},animation:function(t,e,i,n,s=null,r=null,a=null){return this.__resIdMustNotExist(t),we[t]={type:"image",wrapper:"SpritesheetAnimation",src:e,config:{frameWidth:i,frameHeight:n,numFrames:s,...r},anim:{def:null,fps:15,seq:{},trans:{}},...a,fps:function(t){return this.anim.fps=t,this},seq:function(t,e,i,n=null){return this.anim.seq[t]={loop:e,group:i},null!==n&&(this.anim.seq[t].fps=n),this},trans:function(t,e,i){return t in this.anim.trans||(this.anim.trans[t]={}),this.anim.trans[t][e]=i,this},def:function(t){return this.anim.def=t,this}}},spritefont:function(t,e,i,n,s,r=null,a=null){return this.__resIdMustNotExist(t),we[t]={type:"image",wrapper:"SpriteFont",src:e,font:{charWidth:i,charHeight:n,charset:s,...r},...a}},json:function(t,e,i=null){return this.__resIdMustNotExist(t),we[t]={type:"json",src:e,...i}},data:function(t,e,i=null){return this.__resIdMustNotExist(t),we[t]={type:"data",src:e,...i}},text:function(t,e,i=null){return this.__resIdMustNotExist(t),we[t]={type:"text",src:e,...i}},sfx:function(t,e,i=null){return this.__resIdMustNotExist(t),we[t]={type:"audio",wrapper:"Sound",src:e,track:"sfx",...i}},sfxm:function(t,e,i,n="sequential"){return this.__resIdMustNotExist(t),we[t]={type:"audios",wrapper:"SoundArray",src:e,count:i,track:"sfx",mode:n}},music:function(t,e,i=null){return this.__resIdMustNotExist(t),we[t]={type:"audio",wrapper:"Sound",src:e,track:"music",...i}}};var Te=t.extend({sticks:null,buttons:null,scene:null,container:null,_visible:!0,__ctor:function(t,e){this.sticks={},this.buttons={},this.scene=t,this.layer=t.getContainer(e),this.layer.depthFlag(!1)},addStick:function(t,e,i,n,s,r=0){0==r&&(r=n.width-s.width);let a=new ye(this.layer,e,i,r,n,s);return this.sticks[t]=a,this[t]=a,a},addButton:function(t,e,i,n=null,s=null){let r=new xe(this.layer,e,i,n,s);return this.buttons[t]=r,this[t]=r,r},visible:function(t=null){if(null===t)return this._visible;this._visible=t;for(let e in this.sticks)this.sticks[e].visible(t);for(let e in this.buttons)this.buttons[e].visible(t);return this},showMasks:function(t){for(let e in this.sticks)this.sticks[e].hitbox.visible(t);for(let e in this.buttons)this.buttons[e].hitbox.visible(t);return this}});const ke={_gamepads:[],activeGamepad:null,lastButton:null,lastStick:null,cursor:{_enabled:null,_handler:null,_element:null,pointer:null,element:function(t=!1){return!1===t?this._element:(this._element=t,this)},native:function(t){t||"none"===At.renderer.elem.style.cursor?t&&"none"===At.renderer.elem.style.cursor&&At.renderer.elem.style.removeProperty("cursor"):At.renderer.elem.style.cursor="none"},enabled:function(t=null){return null===t?this._enabled:(this._enabled===t||(this._enabled=t,!0===t?(null!==this._element&&(At.renderer.elem.style.cursor="none"),pe.register(this.pointerHandler)):(At.renderer.elem.style.removeProperty("cursor"),pe.unregister(this.pointerHandler))),this)},handler:function(t){return this._handler=t,this},pointerHandler:{priority:50,onPointerEvent:function(t,e,i){ke.cursor._enabled&&(ke.cursor.pointer=e,null!==ke.cursor._element&&ke.cursor._element.setPosition(e.x,e.y),null!==ke.cursor._handler&&ke.cursor._handler(t,e))}}},createGamepad:function(t,e=null){return e=null!==e?e:be.LAYER_HUD_MAIN,be.selectScene(be.SCENE_HUD),be.selectContainer(e),this._gamepads[t]=new Te(be.activeScene,e),this.selectGamepad(t),this.activeGamepad},getGamepad:function(t){return t<0||t>=this._gamepads.length?null:this._gamepads[t]||null},selectGamepad:function(t){return this.activeGamepad=this.getGamepad(t),!0},debugGamepad:function(t,e){if(null!==t)this._gamepads[t].debug(e);else for(let t=0;t<this._gamepads.length;t++)this._gamepads[t]&&this.debugGamepad(t,e)},stick:function(t,e,i,n,s,r=0){if(null===this.activeGamepad)throw new Error("input.addStick: use input.selectGamepad first to select the active gamepad.");return this.lastStick=this.activeGamepad.addStick(t,e,i,n,s,r)},button:function(t,e,i,n,s=null){if(null===this.activeGamepad)throw new Error("input.addButton: use input.selectGamepad first to select the active gamepad.");return this.lastButton=this.activeGamepad.addButton(t,e,i,n,s)}};var Se=ke;const Ie={FLAG_EXCLUDE:qt.allocFlag(),contactRules:{},truncationRules:{},scene:null,maskLayer:null,fupdater:null,lupdater:null,flagsAnd:0,flagsValue:0,state:{contact:Tt.Pool.alloc(),flags:0,dx:0,dy:0,bounds:Tt.Pool.alloc(),x:new Array(32).fill(0),y:new Array(32).fill(0),v0x:new Array(32).fill(0),v0y:new Array(32).fill(0),v1x:new Array(32).fill(0),v1y:new Array(32).fill(0),v2x:new Array(32).fill(0),v2y:new Array(32).fill(0),count:0,target:0,v0:0,w0:0,delta0:0,v1:0,w1:0,delta1:0,w2:0,t_dx:0,t_dy:0},enable:function(t=null,e=null){this.scene=be.getScene(t||be.SCENE_MAIN),this.maskLayer=this.scene.getContainer(e||be.LAYER_MASK),this.flagsAnd=qt.ALIVE|qt.VISIBLE|Ie.FLAG_EXCLUDE,this.flagsValue=qt.ALIVE|qt.VISIBLE,this.scene.fupdater.add(this.firstUpdate,this),this.scene.lupdater.add(this.lastUpdate,this),this.fupdater=gt.Pool.alloc(this),this.lupdater=gt.Pool.alloc(this)},disable:function(){this.scene.fupdater.remove(this.update,this),this.maskLayer=null,this.fupdater.free(),this.lupdater.free()},firstUpdate:function(t,e){e.fupdater.exec()},lastUpdate:function(t,e){e.lupdater.exec()},later:{run:function(t,e,i,n,s){Ie.fupdater.add(this._run,t,e,i,n,s)},setVisible:function(t,e){Ie.fupdater.add(this._setVisible,t,e)},setValue:function(t,e,i){Ie.fupdater.add(this._setValue,t,e,i)},setFlags:function(t,e){Ie.fupdater.add(this._setFlags,t,e)},clearFlags:function(t,e){Ie.fupdater.add(this._clearFlags,t,e)},_run:function(t,e,i,n,s,r){return i(t,e,n,s,r),!1},_setVisible:function(t,e,i){return e.visible(i),!1},_setValue:function(t,e,i,n){return e[i]=n,!1},_setFlags:function(t,e,i){return e.setFlags(i),!1},_clearFlags:function(t,e,i){return e.clearFlags(i),!1}},
//!}
contact:function(t,e,i,n=null){return t in this.contactRules||(this.contactRules[t]={}),this.contactRules[t][e]={callback:i,context:n},this},truncate:function(t,e,i=null,n=null){return t in this.truncationRules||(this.truncationRules[t]={}),this.truncationRules[t][e]={callback:i,context:n},this},getContactFlags:function(t,e){this.state.contact.set(t).setAsIntersection(e);let i=this.state.contact;return this.state.flags=0,this.state.numFlags=0,i.x1==e.x1&&(this.state.flags|=Ie.Contact.LEFT,this.state.numFlags++),i.x2==e.x2&&(this.state.flags|=Ie.Contact.RIGHT,this.state.numFlags++),i.y1==e.y1&&(this.state.flags|=Ie.Contact.TOP,this.state.numFlags++),i.y2==e.y2&&(this.state.flags|=Ie.Contact.BOTTOM,this.state.numFlags++),this.state.flags},calc:function(t,e,i,n,s,r){let a=this.state.count,l=null,o=0;if(e>0)for(let t=0;t<a;t++)!n[t]||!s[t]||i[t]<0||((null===l||i[t]>l)&&(l=i[t]),s[t]=r[t]=0,o+=n[t]);else for(let t=0;t<a;t++)!n[t]||!s[t]||i[t]>0||((null===l||i[t]<l)&&(l=i[t]),s[t]=r[t]=0,o+=n[t]);null===l&&(l=0),t?(this.state.v0=o,this.state.w0=Math.abs(l),this.state.delta0=l):(this.state.v1=o,this.state.w1=Math.abs(l),this.state.delta1=l)},attemptSelect:function(t){this.state.v1+this.state.v0===this.state.target&&(null===this.state.w2||this.state.w1+this.state.w0<this.state.w2)&&(this.state.w2=this.state.w1+this.state.w0,t?(this.state.t_dx=this.state.delta0,this.state.t_dy=this.state.delta1):(this.state.t_dx=this.state.delta1,this.state.t_dy=this.state.delta0))},load0:function(){let t=this.state.count;for(let e=0;e<t;e++)this.state.v1x[e]=this.state.v0x[e],this.state.v1y[e]=this.state.v0y[e]},save1:function(){let t=this.state.count;for(let e=0;e<t;e++)this.state.v2x[e]=this.state.v1x[e],this.state.v2y[e]=this.state.v1y[e]},load1:function(){let t=this.state.count;for(let e=0;e<t;e++)this.state.v1x[e]=this.state.v2x[e],this.state.v1y[e]=this.state.v2y[e]},resolveXpos:function(t=!1){if(this.calc(t,1,this.state.x,this.state.v0x,this.state.v1x,this.state.v1y),t)return!0;this.save1(),this.resolveYpos(!0)&&this.attemptSelect(!1),this.load1(),this.resolveYneg(!0)&&this.attemptSelect(!1),this.load0()},resolveXneg:function(t=!1){if(this.calc(t,-1,this.state.x,this.state.v0x,this.state.v1x,this.state.v1y),t)return!0;this.save1(),this.resolveYpos(!0)&&this.attemptSelect(!1),this.load1(),this.resolveYneg(!0)&&this.attemptSelect(!1),this.load0()},resolveYpos:function(t=!1){if(this.calc(t,1,this.state.y,this.state.v0y,this.state.v1y,this.state.v1x),t)return!0;this.save1(),this.resolveXpos(!0)&&this.attemptSelect(!0),this.load1(),this.resolveXneg(!0)&&this.attemptSelect(!0),this.load0()},resolveYneg:function(t=!1){if(this.calc(t,-1,this.state.y,this.state.v0y,this.state.v1y,this.state.v1x),t)return!0;this.save1(),this.resolveXpos(!0)&&this.attemptSelect(!0),this.load1(),this.resolveXneg(!0)&&this.attemptSelect(!0),this.load0()},commit:function(){this.state.group.alive()&&(this.state.group.translate(this.state.dx,this.state.dy),this.state.group.clearFlags(Ie.FLAG_EXCLUDE))},translate:function(t,e=null,i=0,n=0){if("number"==typeof e&&(n=i,i=e,e=null),!t)return;if(e||(e=t.group),!e.alive()||!t.alive())return;if(this.state.mask=t,this.state.group=e,this.state.dx=downscalef(upscale(i)),this.state.dy=downscalef(upscale(n)),!this.maskLayer||!t.visible())return this.commit();let s=this.truncationRules[t.type];if(!s&&(s=this.truncationRules[4294963200&t.type],!s))return this.commit(),this.scan(t,e);this.state.offs=e.getOffsets(this.state.dx,this.state.dy),this.state.bounds.set(t.bounds).translate(this.state.offs.x+this.state.dx,this.state.offs.y+this.state.dy),e.setFlags(Ie.FLAG_EXCLUDE);let r=this.maskLayer.selectInRegion(this.state.bounds,this.flagsAnd,this.flagsValue);if(0===r.length)return r.free(),this.commit();let a=0,l=0;for(;;){let e=r.shift();if(null===e)break;let i=s[e.type];if(!i&&(i=s[4294963200&e.type],!i))continue;if(!1===i.callback||null!==i.callback&&!0!==i.callback&&!i.callback(t,e,i.context))continue;let n=Math.min(this.state.bounds.x2,e.bounds.x2)-Math.max(this.state.bounds.x1,e.bounds.x1),o=Math.min(this.state.bounds.y2,e.bounds.y2)-Math.max(this.state.bounds.y1,e.bounds.y1);this.state.v0x[a]=0,this.state.v0y[a]=0,Math.min(this.state.bounds.width(),e.bounds.width())!=n&&(this.state.x[a]=absmin(this.state.bounds.x2-e.bounds.x1,this.state.bounds.x1-e.bounds.x2),this.state.v0x[a]=1),Math.min(this.state.bounds.height(),e.bounds.height())!=o&&(this.state.y[a]=absmin(this.state.bounds.y2-e.bounds.y1,this.state.bounds.y1-e.bounds.y2),this.state.v0y[a]=1);let h=this.state.v0x[a]+this.state.v0y[a];l+=h,h>1&&(this.state.v0x[a]=h,this.state.v0y[a]=h),this.state.v1x[a]=this.state.v0x[a],this.state.v1y[a]=this.state.v0y[a],a++}if(r.free(),0==l)return this.commit(),this.scan(t,e);if(this.state.target=l,this.state.count=a,this.state.w2=null,this.resolveXpos(),this.resolveXneg(),this.resolveYpos(),this.resolveYneg(),null!==this.state.w2){let e=this.contactRules[t.type];if(e||(e=this.contactRules[4294963200&t.type]),e){for(this.state.bounds.set(t.bounds).translate(this.state.offs.x+this.state.dx-.5*this.state.t_dx,this.state.offs.y+this.state.dy-.5*this.state.t_dy),r=this.maskLayer.selectInRegion(this.state.bounds,this.flagsAnd,this.flagsValue);;){let i=r.shift();if(null===i)break;let n=e[i.type];(n||(n=e[4294963200&i.type],n))&&n.callback(t,i,n.context)}r.free()}this.state.dx-=this.state.t_dx,this.state.dy-=this.state.t_dy}this.commit()},scan:function(t,e=null){if(e||(e=t.group),!e.alive()||!t.alive())return;if(this.state.mask=t,this.state.group=e,!this.maskLayer||!t.visible())return;let i=this.contactRules[t.type];if(i||(i=this.contactRules[4294963200&t.type]),!i)return;e.setFlags(Ie.FLAG_EXCLUDE);let n=this.maskLayer.selectInRegion(t.bounds,this.flagsAnd,this.flagsValue);for(e.clearFlags(Ie.FLAG_EXCLUDE);;){let e=n.shift();if(null===e)break;let s=i[e.type];(s||(s=i[4294963200&e.type],s))&&s.callback(t,e,s.context)}n.free()},
//!/class
//!namespace collider
//!enum Contact
Contact:{
//!LEFT
LEFT:1,
//!RIGHT
RIGHT:2,
//!HORIZONTAL
HORIZONTAL:3,
//!TOP
TOP:4,
//!BOTTOM
BOTTOM:8,
//!VERTICAL
VERTICAL:12}};
//!class collider
const Pe=At,Re=be,Ae=we,Ce=Ee,Fe=Se,Ne=Ie,Me=t,De=e,Le=n,Oe=B,Be=M,Ue=_,He=o,Ge=h,Xe=F,We=H,Ve=L,ze=I,Ye=R,qe=z,Qe=Y,Ke=Q,je=nt,Ze=f,$e=m,Je=x,ti=dt,ei=gt,ii=k,ni=yt,si=b,ri=vt,ai=Tt,li=wt,oi=St,hi=zt,ui=Pt,ci=qt,di=Qt,fi=re,pi=$t,mi=ae,gi=jt,xi=le,yi=oe,_i=ne,vi=te,bi=ue,wi=de,Ei=fe,Ti=pe,ki=ge,Si=xe,Ii=ye;var Pi=_e;export{Me as Class,De as Schema,Le as Template,Oe as globals,Be as System,Ue as Timer,He as Random,Ge as KeyCode,Xe as Canvas,We as Perf,Ve as Log,ze as Shader,Ye as ShaderProgram,qe as Framebuffer,Qe as Wrappers,Ke as Resources,je as Sound,Ze as Recycler,$e as Linkable,Je as List,ti as PriorityQueue,ei as Handler,ii as Matrix,ni as Rect,si as Vec2,ri as TFunction,ai as Bounds2,li as Point2,oi as Easing,hi as Anim,ui as Boot,ci as GridElement,di as Grid,fi as Scene,pi as Viewport,mi as Updater,gi as Container,xi as SimpleContainer,yi as GridContainer,_i as Group,vi as Element,bi as Mask,wi as Label,Ei as KeyboardHandler,Ti as PointerHandler,ki as ScreenControls,Si as Button,Ii as Stick,Pi as default};
//# sourceMappingURL=froxel.js.map
