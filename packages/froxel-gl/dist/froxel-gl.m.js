import{Mat3 as t,Vec4 as e}from"froxel-math";var i="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},r=s;function s(t,e,i){this.gl=t,this.vertexShader=t.createShader(t.VERTEX_SHADER),t.shaderSource(this.vertexShader,e),t.compileShader(this.vertexShader),this.fragmentShader=t.createShader(t.FRAGMENT_SHADER),t.shaderSource(this.fragmentShader,i),t.compileShader(this.fragmentShader),this.program=t.createProgram(),t.attachShader(this.program,this.vertexShader),t.attachShader(this.program,this.fragmentShader)}s.prototype.linkProgram=function(){for(let t in s.attribLocations)this.gl.bindAttribLocation(this.program,s.attribLocations[t],t);if(this.gl.linkProgram(this.program),this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))return this.gl.deleteShader(this.vertexShader),this.gl.deleteShader(this.fragmentShader),this;let t=this.gl.getShaderInfoLog(this.vertexShader),e=this.gl.getShaderInfoLog(this.fragmentShader);throw Error(t?"• Vertex Shader:\n"+t+"\n":""+e?"• Fragment Shader:\n"+e:"")},s.prototype.bindAttribLocation=function(t,e){return this.gl.bindAttribLocation(this.program,t,e),this},s.attribLocations=new Map,s.bindAttribLocation=function(t,e){return this.attribLocations[e]=t,this},s.bindAttribLocations=function(t){for(let e in t)this.attribLocations[e]=t[e];return this},s.prototype.useProgram=function(){this.gl.useProgram(this.program)},s.prototype.getUniformLocation=function(t){return this.gl.getUniformLocation(this.program,t)},s.prototype.getUniformLocations=function(t){let e={};for(let i of t)e[i]=this.getUniformLocation(i);return e},s.prototype.getUniformOffsets=function(t){let e={},i=this.gl.getUniformIndices(this.program,t),r=this.gl.getActiveUniforms(this.program,i,this.gl.UNIFORM_OFFSET);for(let s in t)e[t[s]]={index:i[s],offset:r[s]};return e},s.prototype.getUniformBlockIndex=function(t){return this.gl.getUniformBlockIndex(this.program,t)},s.prototype.getUniformBlockIndices=function(t){let e={};for(let i of t)e[i]=this.getUniformBlockIndex(i);return e},s.prototype.uniformBlockBinding=function(t,e){return"string"==typeof t&&(t=this.getUniformBlockIndex(t)),this.gl.uniformBlockBinding(this.program,t,e)};class h{gl;target;usage;buffer;constructor(t,e,i){this.gl=t,this.target=e,this.usage=i,this.buffer=t.createBuffer()}bindBuffer(){return this.gl.bindBuffer(this.target,this.buffer),this}unbindBuffer(){return this.gl.bindBuffer(this.target,null),this}bufferData(t,e=0){return this.bindBuffer(),this.gl.bufferData(this.target,t,this.usage,e),this}allocate(t){return this.bindBuffer(),this.gl.bufferData(this.target,t,this.usage),this}bufferSubData(t,e,i=0,r=0){return this.bindBuffer(),this.gl.bufferSubData(this.target,t,e,i,r||e.length),this}deleteBuffer(){this.gl.deleteBuffer(this.buffer)}}class a extends h{constructor(t,e){super(t,t.ARRAY_BUFFER,e)}}class o extends h{constructor(t,e){super(t,t.ELEMENT_ARRAY_BUFFER,e)}}var n=l;function l(t){this.gl=t,this.vertexArray=t.createVertexArray()}l.prototype.bindVertexArray=function(){this.gl.bindVertexArray(this.vertexArray)},l.prototype.unbindVertexArray=function(){this.gl.bindVertexArray(null)};class p{gl;texture;width;height;targetWidth;targetHeight;scale;filterType;wrapMode;mipmapLevels;allocated;constructor(t,e,i,r=null,s=null){this.gl=t,this.texture=t.createTexture(),this.width=e,this.height=i,this.targetWidth=r??e,this.targetHeight=s??i,this.scale=this.width/this.targetWidth,this.allocated=!1,this.mipmapLevels=0,this.wrapMode="CLAMP_TO_EDGE",this.filterType="LINEAR"}bindTexture(){return this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),!1!==this.allocated||(this.allocated=null,this.allocate()),this}allocate(){return!0===this.allocated||(this.allocated=!0,this.bindTexture().applyFilter().applyWrap(),this.mipmapLevels>0?this.gl.texStorage2D(this.gl.TEXTURE_2D,this.mipmapLevels,this.gl.RGBA8,this.width,this.height):this.gl.texStorage2D(this.gl.TEXTURE_2D,1,this.gl.RGBA8,this.width,this.height)),this}applyFilter(t=!1){t&&this.bindTexture();let e=this.gl.LINEAR,i=this.gl.LINEAR;return"NEAREST"===this.filterType&&(e=i=this.gl.NEAREST),this.mipmapLevels>0&&(e=this.gl.LINEAR_MIPMAP_LINEAR,"NEAREST"===this.filterType&&(e=this.gl.NEAREST_MIPMAP_LINEAR)),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,i),this}applyWrap(t=!1){t&&this.bindTexture();let e=this.gl.CLAMP_TO_EDGE;return"REPEAT"===this.wrapMode?e=this.gl.REPEAT:"MIRRORED_REPEAT"===this.wrap&&(e=this.gl.MIRRORED_REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,e),this}setFilter(t){return this.filterType=t,!0===this.allocated?this.applyFilter(!0):this}setWrapMode(t){return this.wrapMode=t,!0===this.allocated?this.applyWrap(!0):this}setMipmapLevels(t){return!0===this.allocated||(this.mipmapLevels=Math.max(0,t)),this}upload(t,e=0,i=0){return this.bindTexture(),this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,e,i,Math.min(t.width,this.width),Math.min(t.height,this.height),this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.mipmapLevels>0&&this.gl.generateMipmap(this.gl.TEXTURE_2D),this}}var g=m;let c={fullscreen:!0,stencil:!1,background:"000000",width:960,height:540,orientation:"automatic",antialias:!0,scaleFactorMax:0,scaleFactorOffs:.7},u=[],d=!1;function f(t){let e=t.options.width,r=t.options.height;if(t.options.fullscreen&&"document"in i)e=Math.floor(i.innerWidth),r=Math.floor(i.innerHeight);else if(null===t.options.width&&null===t.options.height)throw Error("At least one screen dimension must be specified in headless mode.");let s=e,h=r,a=!1;(e<r&&"landscape"===t.options.orientation||e>r&&"portrait"===t.options.orientation)&&(s=r,h=e,a=!0);let o=t.options.width,n=t.options.height;(null===o||null===n)&&(null===o&&null===n?(o=s,n=h):null===o?o=Math.floor(.5+s*(t.options.height/h)):n=Math.floor(.5+h*(t.options.width/s)));let l=o,p=n;"automatic"===t.options.orientation&&l&&p&&(l>p&&s<h||l<p&&s>h)&&(l=n,p=o);let g=1;l&&p?g=Math.min(s/l,h/p):l?g=s/l:p&&(g=h/p);let c=s,u=h;l&&(s=l),p&&(h=p);let d=Math.floor((c-s*g)*.5),f=Math.floor((u-h*g)*.5);if(a){let t=d;d=f,f=t}let m=g*i.devicePixelRatio;m=Math.floor(t.options.scaleFactorOffs+m),t.options.scaleFactorMax>0&&m>t.options.scaleFactorMax&&(m=t.options.scaleFactorMax),t.options.fullscreen&&"document"in i&&(i.document.body.style.backgroundColor=t.canvas.style.backgroundColor),t.resize(s,h,!1),a?(t.canvas.style.width=Math.floor(h*g+.5)+"px",t.canvas.style.height=Math.floor(s*g+.5)+"px"):(t.canvas.style.width=Math.floor(s*g+.5)+"px",t.canvas.style.height=Math.floor(h*g+.5)+"px"),t.canvas.style.marginLeft=d+"px",t.canvas.style.marginTop=f+"px",t.globalScale=m,t.isFlipped=a,t.u.transform.identity(),t.u.transform.scale(m,m),a&&(t.u.transform.rotate(Math.PI/2),t.u.transform.translate(-s,0)),t.updateViewport()}function m(t=null){d||(i.onresize=function(){for(let t of u)f(t)},d=!0),this.init({...c,...t}),u.push(this)}m.prototype.dispose=function(){u.splice(u.indexOf(this),1)},m.prototype.gl=null,m.prototype.u=null,m.prototype.canvas=null,m.prototype.width=0,m.prototype.height=0,m.prototype.physWidth=0,m.prototype.physHeight=0,m.prototype.isFlipped=!1,m.prototype.globalScale=1,m.prototype.init=function(i){if(this.canvas=document.createElement("canvas"),this.options=i,!i.fullscreen&&(!i.width||!i.height))throw Error("Option `width` or `height` is missing while `fullscreen` is `false`.");if(6!=i.background.length)throw Error("Option `background` should be a 6-digit hex RGB (i.e. 000000).");for(let t in this.canvas.style.imageRendering=i.antialias?"auto":"crisp-edges",this.canvas.style.backgroundColor="#"+i.background,i.fullscreen&&(this.canvas.style.position="absolute",this.canvas.style.left="0px",this.canvas.style.top="0px"),this.gl=this.canvas.getContext("webgl2",{desynchronized:!1,preserveDrawingBuffer:!1,alpha:!1,stencil:i.stencil}),this.gl){let e=this.gl[t];switch(typeof e){case"function":this[t]=e.bind(this.gl);break;case"number":this[t]=e}}console.log(this.getParameter(this.VERSION)+", "+this.getParameter(this.SHADING_LANGUAGE_VERSION)),this.u={changed:!0,transform:t.alloc(),projection:t.alloc(),resolution:e.alloc()},this.clearColor(parseInt(i.background.substring(0,2),16)/255,parseInt(i.background.substring(2,4),16)/255,parseInt(i.background.substring(4,6),16)/255,1),this.colorMask(!0,!0,!0,!0),this.enable(this.DEPTH_TEST),this.clearDepth(0),this.depthFunc(this.GEQUAL),this.enable(this.BLEND),this.pixelStorei(this.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.blendEquationSeparate(this.FUNC_ADD,this.FUNC_ADD),this.blendFunc(this.ONE,this.ONE_MINUS_SRC_ALPHA),this.enable(this.SCISSOR_TEST),f(this)},m.prototype.resize=function(t,e,i=!0){this.width=t,this.height=e,i&&this.updateViewport()},m.prototype.updateViewport=function(){this.physWidth=this.canvas.width=Math.floor((this.isFlipped?this.height:this.width)*this.globalScale),this.physHeight=this.canvas.height=Math.floor((this.isFlipped?this.width:this.height)*this.globalScale),this.scissor(0,0,this.physWidth,this.physHeight),this.viewport(0,0,this.physWidth,this.physHeight),this.u.resolution.set(this.physWidth,this.physHeight,this.isFlipped?this.physHeight:this.physWidth,this.isFlipped?this.physWidth:this.physHeight),this.u.changed=!0},m.prototype.createShaderProgram=function(t,e){return new r(this,t,e)},m.prototype.createVertexArrayObject=function(){return new n(this)},m.prototype.createVertexBuffer=function(t){return new a(this,t)},m.prototype.createElementBuffer=function(t){return new o(this,t)},m.prototype.createTextureObject=function(t,e,i=null,r=null){return new p(this,t,e,i,r)},m.loadImage=function(t){return new Promise((e,i)=>{let r=new Image;r.onload=()=>e(r),r.onerror=()=>i("Unable to load image: "+t),r.src=t})},m.prototype.loadTextureFromUrl=async function(t,e=0){let i=await m.loadImage(t),r=this.createTextureObject(i.width,i.height);return r.setMipmapLevels(e),r.upload(i),r};class b extends h{bindingIndex;constructor(t,e){super(t,t.UNIFORM_BUFFER,e)}bindBufferBase(t){return this.gl.bindBufferBase(this.target,this.bindingIndex=t,this.buffer),this}}export{g as WebGLCanvas,r as ShaderProgram,h as Buffer,a as VertexBuffer,o as ElementBuffer,b as UniformBuffer,n as VertexArrayObject,p as TextureObject};
//# sourceMappingURL=froxel-gl.m.js.map
