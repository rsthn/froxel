import{Mat4 as t,Vec4 as e}from"froxel-math";var i="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{};class r{gl;target;usage;buffer;byteLength;source;constructor(t,e,i){this.gl=t,this.target=e,this.usage=i,this.buffer=t.genBuffer(),this.byteLength=null,this.source=null}bindBuffer(){return this.gl.state.buffer[this.target]===this||(this.gl.bindBuffer(this.target,this.buffer),this.gl.state.buffer[this.target]=this),this}unbindBuffer(){return this.gl.bindBuffer(this.target,null),this.gl.state.buffer[this.target]=null,this}allocate(t){return this.bindBuffer(),this.gl.bufferData(this.target,t,this.usage),this.byteLength=t,this}bufferData(t,e=0){return this.bindBuffer(),this.gl.bufferData(this.target,t,this.usage,e),this.byteLength=this.gl.getBufferParameter(this.target,this.gl.BUFFER_SIZE),this}bufferSubData(t,e,i=0,r=0){return this.bindBuffer(),this.gl.bufferSubData(this.target,t,e,i,r||e.length),this}deleteBuffer(){this.gl.deleteBuffer(this.buffer)}bufferSource(t){return null===this.byteLength&&this.bufferData(t),this.source=t,this}update(t=0,e=0){return null!==this.source&&this.bufferSubData(t,this.source,t,e),this}}class s extends r{bindingIndex;constructor(t,e){super(t,t.UNIFORM_BUFFER,e)}bufferIndex(t){return this.gl.bindBufferBase(this.target,this.bindingIndex=t,this.buffer),this}}class h{gl;vertexShader;fragmentShader;geometryShader;program;cache;constructor(t,e,i,r=null){this.gl=t,e.startsWith("#version")||(e="#version 300 es\nprecision highp float;\n"+e),this.vertexShader=t.createShader(t.VERTEX_SHADER),t.shaderSource(this.vertexShader,e),t.compileShader(this.vertexShader),i.startsWith("#version")||(i="#version 300 es\nprecision highp float;\n"+i),this.fragmentShader=t.createShader(t.FRAGMENT_SHADER),t.shaderSource(this.fragmentShader,i),t.compileShader(this.fragmentShader),null!==r?(r.startsWith("#version")||(r="#version 300 es\nprecision highp float;\n"+r),this.geometryShader=t.createShader(t.GEOMETRY_SHADER),t.shaderSource(this.geometryShader,r),t.compileShader(this.geometryShader)):this.geometryShader=null,this.program=t.createProgram(),t.attachShader(this.program,this.vertexShader),t.attachShader(this.program,this.fragmentShader),this.geometryShader&&t.attachShader(this.program,this.geometryShader),this.cache={u:{},b:{},a:{}},this.linkProgram()}static attribLocations=new Map;static bindAttribLocation(t,e){if("string"==typeof t)throw Error("bindAttribLocation: attribLocation should be a number");h.attribLocations[e]=t}static bindAttribLocations(t){for(let e in t)h.attribLocations[e]=t[e]}linkProgram(){for(let t in h.attribLocations)this.gl.bindAttribLocation(this.program,h.attribLocations[t],t);if(this.gl.linkProgram(this.program),this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))return this.gl.deleteShader(this.vertexShader),this.gl.deleteShader(this.fragmentShader),this.geometryShader&&this.gl.deleteShader(this.geometryShader),this;let t=this.gl.getShaderInfoLog(this.vertexShader),e=this.gl.getShaderInfoLog(this.fragmentShader),i=this.geometryShader?this.gl.getShaderInfoLog(this.geometryShader):"";throw Error(t?"• Vertex Shader:\n"+t+"\n":""+i?"• Geometry Shader:\n"+i+"\n":""+e?"• Fragment Shader:\n"+e:"")}bindAttribLocation(t,e){return this.gl.bindAttribLocation(this.program,t,e),this}getAttribLocation(t){return t in this.cache.u||(this.cache.a[t]=this.gl.getAttribLocation(this.program,t)),this.cache.a[t]}getAttribLocations(t){let e={};for(let i of t)e[i]=this.getAttribLocation(i);return e}useProgram(){return this.gl.state.program===this||(this.gl.useProgram(this.program),this.gl.state.program=this),this}getUniformLocation(t){return t in this.cache.u||(this.cache.u[t]=this.gl.getUniformLocation(this.program,t)),this.cache.u[t]}getUniformLocations(t){let e={};for(let i of t)e[i]=this.getUniformLocation(i);return e}getUniformOffsets(t){let e={},i=this.gl.getUniformIndices(this.program,t),r=this.gl.getActiveUniforms(this.program,i,this.gl.UNIFORM_OFFSET);for(let s in t)e[t[s]]={index:i[s],offset:r[s]};return e}getUniformBlockIndex(t){return t in this.cache.b||(this.cache.b[t]=this.gl.getUniformBlockIndex(this.program,t)),this.cache.b[t]}getUniformBlockIndices(t){let e={};for(let i of t)e[i]=this.getUniformBlockIndex(i);return e}bindUniformBlock(t,e){return"string"==typeof t&&(t=this.getUniformBlockIndex(t)),e instanceof s&&(e=e.bindingIndex),this.gl.uniformBlockBinding(this.program,t,e)}}class a extends r{stride;constructor(t,e){super(t,t.ARRAY_BUFFER,e)}bufferStride(t){return this.stride=t,this}attribPointer(t,e,i,r=0){return this.bindBuffer(),this.gl.vertexAttribPointer(t,e,this.gl[i],!1,this.stride,r),this}enableAttrib(t){return this.bindBuffer(),this.gl.enableVertexAttribArray(t),this}disableAttrib(t){return this.bindBuffer(),this.gl.disableVertexAttribArray(t),this}}class o extends r{constructor(t,e){super(t,t.ELEMENT_ARRAY_BUFFER,e)}}var n=l;function l(t){this.gl=t,this.vertexArray=t.genVertexArray()}l.prototype.bindVertexArray=function(){return this.gl.state.vertexArray===this||(this.gl.bindVertexArray(this.vertexArray),this.gl.state.vertexArray=this),this},l.prototype.unbindVertexArray=function(){return this.gl.bindVertexArray(null),this.gl.state.vertexArray=null,this};class g{gl;texture;width;height;targetWidth;targetHeight;scale;filterType;wrapMode;mipmapLevels;allocated;constructor(t,e,i,r=null,s=null){this.gl=t,this.texture=t.genTexture(),this.width=e,this.height=i,this.targetWidth=r??e,this.targetHeight=s??i,this.scale=this.width/this.targetWidth,this.allocated=!1,this.mipmapLevels=0,this.wrapMode="CLAMP_TO_EDGE",this.filterType="LINEAR"}bindTexture(){return this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),!1!==this.allocated||(this.allocated=null,this.allocate()),this}allocate(){return!0===this.allocated||(this.allocated=!0,this.bindTexture().applyFilter().applyWrap(),this.mipmapLevels>0?this.gl.texStorage2D(this.gl.TEXTURE_2D,this.mipmapLevels,this.gl.RGBA8,this.width,this.height):this.gl.texStorage2D(this.gl.TEXTURE_2D,1,this.gl.RGBA8,this.width,this.height)),this}applyFilter(t=!1){t&&this.bindTexture();let e=this.gl.LINEAR,i=this.gl.LINEAR;return"NEAREST"===this.filterType&&(e=i=this.gl.NEAREST),this.mipmapLevels>0&&(e=this.gl.LINEAR_MIPMAP_LINEAR,"NEAREST"===this.filterType&&(e=this.gl.NEAREST_MIPMAP_LINEAR)),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,i),this}applyWrap(t=!1){t&&this.bindTexture();let e=this.gl.CLAMP_TO_EDGE;return"REPEAT"===this.wrapMode?e=this.gl.REPEAT:"MIRRORED_REPEAT"===this.wrap&&(e=this.gl.MIRRORED_REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,e),this}setFilter(t){return this.filterType=t,!0===this.allocated?this.applyFilter(!0):this}setWrapMode(t){return this.wrapMode=t,!0===this.allocated?this.applyWrap(!0):this}setMipmapLevels(t){return!0===this.allocated||(this.mipmapLevels=Math.max(0,t)),this}upload(t,e=0,i=0){return this.bindTexture(),this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,e,i,Math.min(t.width,this.width),Math.min(t.height,this.height),this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.mipmapLevels>0&&this.gl.generateMipmap(this.gl.TEXTURE_2D),this}activeTexture(t){return this.gl.activeTexture(this.gl.TEXTURE0+(15&t)),this.bindTexture(),this}}var u=m;let d={fullscreen:!0,stencil:!1,background:"000000",width:960,height:540,orientation:"automatic",antialias:!0,scaleFactorMax:0,scaleFactorOffs:.7},c=[],p=!1;function f(t){let e=t.options.width,r=t.options.height;if(t.options.fullscreen&&"document"in i)e=Math.floor(i.innerWidth),r=Math.floor(i.innerHeight);else if(null===t.options.width&&null===t.options.height)throw Error("At least one screen dimension must be specified in headless mode.");let s=e,h=r,a=!1;(e<r&&"landscape"===t.options.orientation||e>r&&"portrait"===t.options.orientation)&&(s=r,h=e,a=!0);let o=t.options.width,n=t.options.height;(null===o||null===n)&&(null===o&&null===n?(o=s,n=h):null===o?o=Math.floor(.5+s*(t.options.height/h)):n=Math.floor(.5+h*(t.options.width/s)));let l=o,g=n;"automatic"===t.options.orientation&&l&&g&&(l>g&&s<h||l<g&&s>h)&&(l=n,g=o);let u=1;l&&g?u=Math.min(s/l,h/g):l?u=s/l:g&&(u=h/g);let d=s,c=h;l&&(s=l),g&&(h=g);let p=Math.floor((d-s*u)*.5),f=Math.floor((c-h*u)*.5);if(a){let t=p;p=f,f=t}let m=u*i.devicePixelRatio;m=Math.floor(t.options.scaleFactorOffs+m),t.options.scaleFactorMax>0&&m>t.options.scaleFactorMax&&(m=t.options.scaleFactorMax),t.options.fullscreen&&"document"in i&&(i.document.body.style.backgroundColor=t.element.style.backgroundColor),t.resize(s,h,!1),a?(t.element.style.width=Math.floor(h*u+.5)+"px",t.element.style.height=Math.floor(s*u+.5)+"px"):(t.element.style.width=Math.floor(s*u+.5)+"px",t.element.style.height=Math.floor(h*u+.5)+"px"),t.element.style.marginLeft=p+"px",t.element.style.marginTop=f+"px",t.globalScale=m,t.isFlipped=a,t.u.initial.identity(),t.u.initial.scale(m,m,m),a&&(t.u.initial.rotateZ(Math.PI/2),t.u.initial.translate(-s,0,0)),t.updateViewport()}function m(t=null){p||(i.onresize=function(){for(let t of c)f(t)},p=!0),this.init({...d,...t}),c.push(this)}m.prototype.dispose=function(){c.splice(c.indexOf(this),1)},m.prototype.gl=null,m.prototype.state=null,m.prototype.u=null,m.prototype.element=null,m.prototype.width=0,m.prototype.height=0,m.prototype.physWidth=0,m.prototype.physHeight=0,m.prototype.isFlipped=!1,m.prototype.globalScale=1;let b={createTexture:"genTexture",createBuffer:"genBuffer",createVertexArray:"genVertexArray"};m.prototype.init=function(i){if(this.element=document.createElement("canvas"),this.options=i,!i.fullscreen&&(!i.width||!i.height))throw Error("Option `width` or `height` is missing while `fullscreen` is `false`.");if(6!=i.background.length)throw Error("Option `background` should be a 6-digit hex RGB (i.e. 000000).");for(let t in this.element.style.imageRendering=i.antialias?"auto":"crisp-edges",this.element.style.backgroundColor="#"+i.background,i.fullscreen&&(this.element.style.position="absolute",this.element.style.left="0px",this.element.style.top="0px"),this.gl=this.element.getContext("webgl2",{desynchronized:!1,preserveDrawingBuffer:!1,alpha:!1,stencil:i.stencil}),this.gl){let e=this.gl[t];switch(typeof e){case"function":t in b&&(t=b[t]),this[t]=e.bind(this.gl);break;case"number":this[t]=e}}console.log(this.getParameter(this.VERSION)+", "+this.getParameter(this.SHADING_LANGUAGE_VERSION)),this.state={program:null,buffer:{},vertexArray:null},this.u={changed:!0,initial:t.alloc(),view:t.alloc(),projection:t.alloc(),resolution:e.alloc()},this.clearColor(parseInt(i.background.substring(0,2),16)/255,parseInt(i.background.substring(2,4),16)/255,parseInt(i.background.substring(4,6),16)/255,1),this.colorMask(!0,!0,!0,!0),this.enable(this.DEPTH_TEST),this.clearDepth(1),this.depthFunc(this.LEQUAL),this.enable(this.BLEND),this.pixelStorei(this.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.blendEquationSeparate(this.FUNC_ADD,this.FUNC_ADD),this.blendFunc(this.ONE,this.ONE_MINUS_SRC_ALPHA),this.enable(this.SCISSOR_TEST),f(this)},m.prototype.resize=function(t,e,i=!0){this.width=t,this.height=e,i&&this.updateViewport()},m.prototype.updateViewport=function(){this.physWidth=this.element.width=Math.floor((this.isFlipped?this.height:this.width)*this.globalScale),this.physHeight=this.element.height=Math.floor((this.isFlipped?this.width:this.height)*this.globalScale),this.scissor(0,0,this.physWidth,this.physHeight),this.viewport(0,0,this.physWidth,this.physHeight),this.u.resolution.set(this.physWidth,this.physHeight,this.isFlipped?this.physHeight:this.physWidth,this.isFlipped?this.physWidth:this.physHeight),this.u.changed=!0},m.prototype.createShaderProgram=function(t,e,i=null){return new h(this,t,e,i)},m.prototype.createVertexArray=function(){return new n(this)},m.prototype.createBuffer=function(t,e){return new r(this,this[t],this[e])},m.prototype.createVertexBuffer=function(t){return new a(this,this[t])},m.prototype.createElementBuffer=function(t){return new o(this,this[t])},m.prototype.createUniformBuffer=function(t){return new s(this,this[t])},m.prototype.createTexture=function(t,e,i=null,r=null){return new g(this,t,e,i,r)},m.loadImage=function(t){return new Promise((e,i)=>{let r=new Image;r.onload=()=>e(r),r.onerror=()=>i("Unable to load image: "+t),r.src=t})},m.prototype.loadTextureFromUrl=async function(t,e=0){let i=await m.loadImage(t),r=this.createTexture(i.width,i.height);return r.setMipmapLevels(e),r.upload(i),r};export{u as WebGLCanvas,h as ShaderProgram,r as Buffer,a as VertexBuffer,o as ElementBuffer,s as UniformBuffer,n as VertexArray,g as Texture};
//# sourceMappingURL=froxel-gl.m.js.map
