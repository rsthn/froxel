import{Vec4 as t,Mat4 as e}from"froxel-math";var i="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{};class r{gl;target;usage;buffer;constructor(t,e,i){this.gl=t,this.target=e,this.usage=i,this.buffer=t.genBuffer()}bindBuffer(){return this.gl.bindBuffer(this.target,this.buffer),this}unbindBuffer(){return this.gl.bindBuffer(this.target,null),this}bufferData(t,e=0){return this.bindBuffer(),this.gl.bufferData(this.target,t,this.usage,e),this}allocate(t){return this.bindBuffer(),this.gl.bufferData(this.target,t,this.usage),this}bufferSubData(t,e,i=0,r=0){return this.bindBuffer(),this.gl.bufferSubData(this.target,t,e,i,r||e.length),this}deleteBuffer(){this.gl.deleteBuffer(this.buffer)}}class s extends r{bindingIndex;constructor(t,e){super(t,t.UNIFORM_BUFFER,e)}bindBufferBase(t){return this.gl.bindBufferBase(this.target,this.bindingIndex=t,this.buffer),this}}var h=o;function o(t,e,i){this.gl=t,this.vertexShader=t.createShader(t.VERTEX_SHADER),t.shaderSource(this.vertexShader,e),t.compileShader(this.vertexShader),this.fragmentShader=t.createShader(t.FRAGMENT_SHADER),t.shaderSource(this.fragmentShader,i),t.compileShader(this.fragmentShader),this.program=t.createProgram(),t.attachShader(this.program,this.vertexShader),t.attachShader(this.program,this.fragmentShader)}o.prototype.linkProgram=function(){for(let t in o.attribLocations)this.gl.bindAttribLocation(this.program,o.attribLocations[t],t);if(this.gl.linkProgram(this.program),this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))return this.gl.deleteShader(this.vertexShader),this.gl.deleteShader(this.fragmentShader),this;let t=this.gl.getShaderInfoLog(this.vertexShader),e=this.gl.getShaderInfoLog(this.fragmentShader);throw Error(t?"• Vertex Shader:\n"+t+"\n":""+e?"• Fragment Shader:\n"+e:"")},o.prototype.bindAttribLocation=function(t,e){return this.gl.bindAttribLocation(this.program,t,e),this},o.attribLocations=new Map,o.bindAttribLocation=function(t,e){return this.attribLocations[e]=t,this},o.bindAttribLocations=function(t){for(let e in t)this.attribLocations[e]=t[e];return this},o.prototype.useProgram=function(){this.gl.useProgram(this.program)},o.prototype.getUniformLocation=function(t){return this.gl.getUniformLocation(this.program,t)},o.prototype.getUniformLocations=function(t){let e={};for(let i of t)e[i]=this.getUniformLocation(i);return e},o.prototype.getUniformOffsets=function(t){let e={},i=this.gl.getUniformIndices(this.program,t),r=this.gl.getActiveUniforms(this.program,i,this.gl.UNIFORM_OFFSET);for(let s in t)e[t[s]]={index:i[s],offset:r[s]};return e},o.prototype.getUniformBlockIndex=function(t){return this.gl.getUniformBlockIndex(this.program,t)},o.prototype.getUniformBlockIndices=function(t){let e={};for(let i of t)e[i]=this.getUniformBlockIndex(i);return e},o.prototype.uniformBlockBinding=function(t,e){return"string"==typeof t&&(t=this.getUniformBlockIndex(t)),e instanceof s&&(e=e.bindingIndex),this.gl.uniformBlockBinding(this.program,t,e)};class n extends r{constructor(t,e){super(t,t.ARRAY_BUFFER,e)}}class a extends r{constructor(t,e){super(t,t.ELEMENT_ARRAY_BUFFER,e)}}var l=p;function p(t){this.gl=t,this.vertexArray=t.genVertexArray()}p.prototype.bindVertexArray=function(){this.gl.bindVertexArray(this.vertexArray)},p.prototype.unbindVertexArray=function(){this.gl.bindVertexArray(null)};class g{gl;texture;width;height;targetWidth;targetHeight;scale;filterType;wrapMode;mipmapLevels;allocated;constructor(t,e,i,r=null,s=null){this.gl=t,this.texture=t.genTexture(),this.width=e,this.height=i,this.targetWidth=r??e,this.targetHeight=s??i,this.scale=this.width/this.targetWidth,this.allocated=!1,this.mipmapLevels=0,this.wrapMode="CLAMP_TO_EDGE",this.filterType="LINEAR"}bindTexture(){return this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),!1!==this.allocated||(this.allocated=null,this.allocate()),this}allocate(){return!0===this.allocated||(this.allocated=!0,this.bindTexture().applyFilter().applyWrap(),this.mipmapLevels>0?this.gl.texStorage2D(this.gl.TEXTURE_2D,this.mipmapLevels,this.gl.RGBA8,this.width,this.height):this.gl.texStorage2D(this.gl.TEXTURE_2D,1,this.gl.RGBA8,this.width,this.height)),this}applyFilter(t=!1){t&&this.bindTexture();let e=this.gl.LINEAR,i=this.gl.LINEAR;return"NEAREST"===this.filterType&&(e=i=this.gl.NEAREST),this.mipmapLevels>0&&(e=this.gl.LINEAR_MIPMAP_LINEAR,"NEAREST"===this.filterType&&(e=this.gl.NEAREST_MIPMAP_LINEAR)),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,i),this}applyWrap(t=!1){t&&this.bindTexture();let e=this.gl.CLAMP_TO_EDGE;return"REPEAT"===this.wrapMode?e=this.gl.REPEAT:"MIRRORED_REPEAT"===this.wrap&&(e=this.gl.MIRRORED_REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,e),this}setFilter(t){return this.filterType=t,!0===this.allocated?this.applyFilter(!0):this}setWrapMode(t){return this.wrapMode=t,!0===this.allocated?this.applyWrap(!0):this}setMipmapLevels(t){return!0===this.allocated||(this.mipmapLevels=Math.max(0,t)),this}upload(t,e=0,i=0){return this.bindTexture(),this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,e,i,Math.min(t.width,this.width),Math.min(t.height,this.height),this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.mipmapLevels>0&&this.gl.generateMipmap(this.gl.TEXTURE_2D),this}activeTexture(t){return this.gl.activeTexture(this.gl.TEXTURE0+(15&t)),this.bindTexture(),this}}var u=b;let d={fullscreen:!0,stencil:!1,background:"000000",width:960,height:540,orientation:"automatic",antialias:!0,scaleFactorMax:0,scaleFactorOffs:.7},f=[],c=!1;function m(t){let e=t.options.width,r=t.options.height;if(t.options.fullscreen&&"document"in i)e=Math.floor(i.innerWidth),r=Math.floor(i.innerHeight);else if(null===t.options.width&&null===t.options.height)throw Error("At least one screen dimension must be specified in headless mode.");let s=e,h=r,o=!1;(e<r&&"landscape"===t.options.orientation||e>r&&"portrait"===t.options.orientation)&&(s=r,h=e,o=!0);let n=t.options.width,a=t.options.height;(null===n||null===a)&&(null===n&&null===a?(n=s,a=h):null===n?n=Math.floor(.5+s*(t.options.height/h)):a=Math.floor(.5+h*(t.options.width/s)));let l=n,p=a;"automatic"===t.options.orientation&&l&&p&&(l>p&&s<h||l<p&&s>h)&&(l=a,p=n);let g=1;l&&p?g=Math.min(s/l,h/p):l?g=s/l:p&&(g=h/p);let u=s,d=h;l&&(s=l),p&&(h=p);let f=Math.floor((u-s*g)*.5),c=Math.floor((d-h*g)*.5);if(o){let t=f;f=c,c=t}let m=g*i.devicePixelRatio;m=Math.floor(t.options.scaleFactorOffs+m),t.options.scaleFactorMax>0&&m>t.options.scaleFactorMax&&(m=t.options.scaleFactorMax),t.options.fullscreen&&"document"in i&&(i.document.body.style.backgroundColor=t.element.style.backgroundColor),t.resize(s,h,!1),o?(t.element.style.width=Math.floor(h*g+.5)+"px",t.element.style.height=Math.floor(s*g+.5)+"px"):(t.element.style.width=Math.floor(s*g+.5)+"px",t.element.style.height=Math.floor(h*g+.5)+"px"),t.element.style.marginLeft=f+"px",t.element.style.marginTop=c+"px",t.globalScale=m,t.isFlipped=o,t.u.initial.identity(),t.u.initial.scale(m,m,m),o&&(t.u.initial.rotateZ(Math.PI/2),t.u.initial.translate(-s,0,0)),t.updateViewport()}function b(t=null){c||(i.onresize=function(){for(let t of f)m(t)},c=!0),this.init({...d,...t}),f.push(this)}b.prototype.dispose=function(){f.splice(f.indexOf(this),1)},b.prototype.gl=null,b.prototype.u=null,b.prototype.element=null,b.prototype.width=0,b.prototype.height=0,b.prototype.physWidth=0,b.prototype.physHeight=0,b.prototype.isFlipped=!1,b.prototype.globalScale=1;let E={createTexture:"genTexture",createBuffer:"genBuffer",createVertexArray:"genVertexArray"};b.prototype.init=function(i){if(this.element=document.createElement("canvas"),this.options=i,!i.fullscreen&&(!i.width||!i.height))throw Error("Option `width` or `height` is missing while `fullscreen` is `false`.");if(6!=i.background.length)throw Error("Option `background` should be a 6-digit hex RGB (i.e. 000000).");for(let t in this.element.style.imageRendering=i.antialias?"auto":"crisp-edges",this.element.style.backgroundColor="#"+i.background,i.fullscreen&&(this.element.style.position="absolute",this.element.style.left="0px",this.element.style.top="0px"),this.gl=this.element.getContext("webgl2",{desynchronized:!1,preserveDrawingBuffer:!1,alpha:!1,stencil:i.stencil}),this.gl){let e=this.gl[t];switch(typeof e){case"function":t in E&&(t=E[t]),this[t]=e.bind(this.gl);break;case"number":this[t]=e}}console.log(this.getParameter(this.VERSION)+", "+this.getParameter(this.SHADING_LANGUAGE_VERSION)),this.u={changed:!0,resolution:t.alloc(),initial:e.alloc(),view:e.alloc(),projection:e.alloc(),mvp:e.alloc()},this.clearColor(parseInt(i.background.substring(0,2),16)/255,parseInt(i.background.substring(2,4),16)/255,parseInt(i.background.substring(4,6),16)/255,1),this.colorMask(!0,!0,!0,!0),this.enable(this.DEPTH_TEST),this.clearDepth(-1),this.depthFunc(this.GEQUAL),this.enable(this.BLEND),this.pixelStorei(this.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.blendEquationSeparate(this.FUNC_ADD,this.FUNC_ADD),this.blendFunc(this.ONE,this.ONE_MINUS_SRC_ALPHA),this.enable(this.SCISSOR_TEST),m(this)},b.prototype.resize=function(t,e,i=!0){this.width=t,this.height=e,i&&this.updateViewport()},b.prototype.updateViewport=function(){this.physWidth=this.element.width=Math.floor((this.isFlipped?this.height:this.width)*this.globalScale),this.physHeight=this.element.height=Math.floor((this.isFlipped?this.width:this.height)*this.globalScale),this.scissor(0,0,this.physWidth,this.physHeight),this.viewport(0,0,this.physWidth,this.physHeight),this.u.resolution.set(this.physWidth,this.physHeight,this.isFlipped?this.physHeight:this.physWidth,this.isFlipped?this.physWidth:this.physHeight),this.u.changed=!0},b.prototype.createShaderProgram=function(t,e){return new h(this,t,e)},b.prototype.createVertexArray=function(){return new l(this)},b.prototype.createBuffer=function(t,e){return new r(this,t,e)},b.prototype.createVertexBuffer=function(t){return new n(this,t)},b.prototype.createElementBuffer=function(t){return new a(this,t)},b.prototype.createUniformBlockBuffer=function(t){return new s(this,t)},b.prototype.createTexture=function(t,e,i=null,r=null){return new g(this,t,e,i,r)},b.loadImage=function(t){return new Promise((e,i)=>{let r=new Image;r.onload=()=>e(r),r.onerror=()=>i("Unable to load image: "+t),r.src=t})},b.prototype.loadTextureFromUrl=async function(t,e=0){let i=await b.loadImage(t),r=this.createTexture(i.width,i.height);return console.log(r),r.setMipmapLevels(e),r.upload(i),r};export{u as WebGLCanvas,h as ShaderProgram,r as Buffer,n as VertexBuffer,a as ElementBuffer,s as UniformBlockBuffer,l as VertexArray,g as Texture};
//# sourceMappingURL=froxel-gl.m.js.map
